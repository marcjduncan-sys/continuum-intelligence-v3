<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Continuum Intelligence  --  Independent Cross-Domain Equity Research</title>
    <meta name="description" content="Cross-domain equity research built by former institutional practitioners. Evidence-driven analysis using the Analysis of Competing Hypotheses framework.">
    <meta property="og:title" content="Continuum Intelligence  --  Independent Cross-Domain Equity Research">
    <meta property="og:description" content="Evidence-driven equity analysis across 10 domains. Built by former UBS and Goldman Sachs executives.">
    <meta property="og:type" content="website">
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.sheetjs.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net;
        style-src 'self' 'unsafe-inline';
        font-src 'self';
        connect-src 'self' https://imaginative-vision-production-16cb.up.railway.app https://query1.finance.yahoo.com https://query2.finance.yahoo.com;
        img-src 'self' data:;
        frame-ancestors 'none';
    ">
    <!-- Self-hosted fonts: Latin subset, variable WOFF2 (~200 KB vs ~650 KB CDN) -->
    <link rel="preload" href="fonts/inter-latin.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="fonts/source-serif-4-latin.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="stylesheet" href="css/fonts.css">
    <link rel="stylesheet" href="css/personalisation.css">
    <style>
/* ============================================================
   CONTINUUM INTELLIGENCE  --  DESIGN SYSTEM
   ============================================================ */

/* --- Accessibility Utilities --- */
.skip-link {
    position: absolute;
    top: -100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--accent-teal, #1A9E8F);
    color: #FFFFFF;
    padding: 12px 24px;
    font-size: 14px;
    font-weight: 600;
    z-index: 10000;
    border-radius: 0 0 8px 8px;
    text-decoration: none;
    transition: top 0.15s ease;
}
.skip-link:focus {
    top: 0;
    outline: 3px solid #FFFFFF;
    outline-offset: 2px;
}
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

/* --- Global Focus Indicator (A3) --- */
*:focus-visible {
    outline: 3px solid var(--accent-teal, #1A9E8F);
    outline-offset: 2px;
}

/* --- Reduced Motion (A13) --- */
@media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* --- Reset & Base --- */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
    /* Background */
    --bg-page: #0B1220;
    --bg-surface: #111C2E;
    --bg-surface-alt: #162236;
    --bg-header: #0E3A42;
    --bg-elevated: #1A2740;
    --bg-card: #131F33;

    /* Text */
    --text-primary: #E8EDF4;
    --text-secondary: #8B9AB8;
    --text-muted: #7A8FAD;

    /* Brand */
    --accent-teal: #22B8A7;
    --accent-sage: #4A9E7E;
    --accent-gold: #C9A96E;

    /* Semantic */
    --signal-red: #D45555;
    --signal-amber: #D4A03C;
    --signal-green: #3DAA6D;
    --signal-blue: #4A8ECC;

    /* Borders */
    --border: #1E3050;
    --border-light: #253A58;

    /* Typography */
    --font-ui: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    --font-narrative: 'Source Serif 4', Georgia, 'Times New Roman', serif;
    --font-data: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;

    /* Spacing */
    --space-xs: 4px;
    --space-sm: 8px;
    --space-md: 16px;
    --space-lg: 24px;
    --space-xl: 32px;
    --space-2xl: 48px;
    --space-3xl: 64px;

    /* Sizing */
    --max-width: 1240px;
    --nav-height: 56px;
}

/* Light theme overrides */
[data-theme="light"] {
    --bg-page: #F5F6F8;
    --bg-surface: #FFFFFF;
    --bg-surface-alt: #F0F1F4;
    --bg-header: #E8F5F3;
    --bg-elevated: #FFFFFF;
    --bg-card: #FFFFFF;
    --text-primary: #1A1F2E;
    --text-secondary: #4A5568;
    --text-muted: #718096;
    --border: #E2E8F0;
    --border-light: #CBD5E0;
    --accent-teal: #0E8A7D;
    --accent-sage: #38815E;
    --signal-red: #C53030;
    --signal-amber: #B7791F;
    --signal-green: #2F855A;
    --signal-blue: #2B6CB0;
}
/* Light theme  --  component overrides */
[data-theme="light"] .site-nav {
    background: rgba(245, 246, 248, 0.95);
}
[data-theme="light"] .site-nav.scrolled {
    background: rgba(245, 246, 248, 0.98);
    box-shadow: 0 2px 20px rgba(0,0,0,0.08);
}
/* Cards & containers */
[data-theme="light"] .featured-card { background: #FFFFFF; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
[data-theme="light"] .featured-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
[data-theme="light"] .evidence-card { background: #FFFFFF; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
[data-theme="light"] .hyp-card { background: #FFFFFF; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
[data-theme="light"] .verdict-section { background: var(--bg-surface-alt); }
[data-theme="light"] .verdict-inner { box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
[data-theme="light"] .callout { background: #F7F8FA; }
/* Heroes & banners */
[data-theme="light"] .hero { background: linear-gradient(135deg, #E8F5F3 0%, #EBF4FF 50%, #F5F6F8 100%); }
[data-theme="light"] .report-hero { background: linear-gradient(135deg, #E8F5F3 0%, #EBF4FF 100%); }
[data-theme="light"] .snap-hero { background: linear-gradient(135deg, #E8F5F3 0%, #EBF4FF 100%); }
[data-theme="light"] .risk-skew-bar { background: var(--bg-surface-alt); }
[data-theme="light"] .rh-spec-section { background: var(--bg-surface-alt); }
/* Navigation & sections */
[data-theme="light"] .section-nav { background: #FFFFFF; border-bottom: 1px solid #E2E8F0; }
[data-theme="light"] .section-nav a { color: var(--text-muted); }
[data-theme="light"] .section-nav a.active { color: var(--accent-teal); border-bottom-color: var(--accent-teal); }
/* Tables */
[data-theme="light"] .identity-table td { background: #F7F8FA; }
[data-theme="light"] .evidence-table thead th,
[data-theme="light"] .gaps-table thead th,
[data-theme="light"] .disc-table thead th,
[data-theme="light"] .identity-table thead th { background: #E8F5F3; }
[data-theme="light"] .ta-ma-table td,
[data-theme="light"] .ta-inflection-table td,
[data-theme="light"] .ta-rp-table td { border-color: #E2E8F0; }
/* Brand & nav */
[data-theme="light"] .nav-brand-text { color: #1A1F2E; }
[data-theme="light"] .brand-green { color: #2E8B57; }
/* Charts */
[data-theme="light"] .ta-chart-container { background: #FFFFFF; border-color: #E2E8F0; }
[data-theme="light"] .ta-chart-static-badge { background: #F0F1F4; color: #4A5568; }
/* Skew badges */
[data-theme="light"] .skew-badge.downside { background: rgba(197, 48, 48, 0.12); }
[data-theme="light"] .skew-badge.upside { background: rgba(47, 133, 90, 0.12); }
[data-theme="light"] .skew-badge.balanced { background: rgba(183, 121, 31, 0.12); }
/* Snapshot specifics */
[data-theme="light"] .snap-sb-segment { text-shadow: none; }
/* Footer */
[data-theme="light"] .site-footer { background: #FFFFFF; }
[data-theme="light"] .footer-bottom { color: var(--text-muted); }
/* Hypothesis sidebar */
[data-theme="light"] .hyp-sidebar { background: #FFFFFF; }
/* Sector tag on hero */
[data-theme="light"] .rh-sector-tag { background: rgba(14, 138, 125, 0.08); border-color: rgba(14, 138, 125, 0.15); }

/* Thesis Comparator Light Theme */
[data-theme="light"] .tc-card { background: #FFFFFF; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
[data-theme="light"] .tc-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
[data-theme="light"] .tc-card.selected { border-color: var(--accent-teal); background: rgba(14, 138, 125, 0.05); }
[data-theme="light"] .tc-input { background: #FFFFFF; border-color: #E2E8F0; color: var(--text-primary); }
[data-theme="light"] .tc-input:focus { border-color: var(--accent-teal); }
[data-theme="light"] .tc-input::placeholder { color: #A0AEC0; }
[data-theme="light"] .tc-banner { background: #FFFFFF; }
[data-theme="light"] .tc-banner.n1 { background: rgba(47, 133, 90, 0.08); }
[data-theme="light"] .tc-banner.n2 { background: rgba(183, 121, 31, 0.08); }
[data-theme="light"] .tc-banner.n3 { background: rgba(197, 48, 48, 0.08); }
[data-theme="light"] .tc-banner.n4 { background: rgba(43, 108, 176, 0.08); }
[data-theme="light"] .tc-map { background: #FFFFFF; }
[data-theme="light"] .tc-analysis { background: #FFFFFF; }
[data-theme="light"] .tc-evidence-col { background: #F7F8FA; }
[data-theme="light"] .tc-row { border-color: #E2E8F0; }
[data-theme="light"] .tc-stance.supports { background: rgba(47, 133, 90, 0.12); color: var(--signal-green); }
[data-theme="light"] .tc-stance.contradicts { background: rgba(197, 48, 48, 0.12); color: var(--signal-red); }
[data-theme="light"] .tc-stance.neutral { background: rgba(113, 128, 150, 0.12); color: var(--text-muted); }

html { scroll-behavior: smooth; }
body {
    font-family: var(--font-ui);
    background: var(--bg-page);
    color: var(--text-primary);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    min-height: 100vh;
    transition: background 0.3s, color 0.3s;
}
a { color: var(--accent-teal); text-decoration: none; transition: color 0.2s; }
a:hover { color: var(--accent-sage); }

/* Theme toggle button */
.theme-toggle {
    display: flex; align-items: center; justify-content: center;
    width: 32px; height: 32px; border: 1px solid var(--border);
    border-radius: 6px; background: transparent; cursor: pointer;
    color: var(--text-muted); transition: color 0.2s, border-color 0.2s, background 0.2s;
    margin-left: var(--space-sm);
}
.theme-toggle:hover { color: var(--text-primary); border-color: var(--text-secondary); background: var(--bg-elevated); }
.theme-toggle svg { width: 16px; height: 16px; }
.theme-toggle .icon-sun { display: none; }
.theme-toggle .icon-moon { display: block; }
[data-theme="light"] .theme-toggle .icon-sun { display: block; }
[data-theme="light"] .theme-toggle .icon-moon { display: none; }

/* --- Navigation --- */
.site-nav {
    position: fixed; top: 0; left: 0; right: 0; z-index: 100;
    background: rgba(11, 18, 32, 0.92);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    height: var(--nav-height);
    transition: background 0.3s, box-shadow 0.3s;
}
.site-nav.scrolled {
    background: rgba(11, 18, 32, 0.98);
    box-shadow: 0 2px 20px rgba(0,0,0,0.3);
}
.nav-inner {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 0 var(--space-lg);
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.nav-brand {
    display: flex; align-items: center; gap: 10px;
    cursor: pointer;
    text-decoration: none;
}
.nav-brand-text {
    font-size: 0.8rem; font-weight: 700;
    letter-spacing: 0.14em; text-transform: uppercase;
    color: var(--text-primary);
}
.brand-green { color: #3DAA6D; }
.nav-links { display: flex; align-items: center; gap: var(--space-lg); }
.nav-links a {
    font-size: 0.75rem; font-weight: 500;
    letter-spacing: 0.04em; text-transform: uppercase;
    color: var(--text-secondary);
    padding: 6px 0;
    border-bottom: 2px solid transparent;
    transition: color 0.2s, border-color 0.2s;
}
.nav-links a:hover, .nav-links a.active {
    color: var(--text-primary);
    border-bottom-color: var(--accent-teal);
}

/* --- Page Container --- */
.page { display: none; min-height: calc(100vh - var(--nav-height)); padding-top: 96px; }
.page.active { display: block; }
.page-inner {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 0 var(--space-lg);
}

/* --- Footer --- */
.site-footer {
    background: var(--bg-surface);
    border-top: 1px solid var(--border);
    padding: var(--space-2xl) 0;
    margin-top: var(--space-3xl);
}
.footer-inner {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 0 var(--space-lg);
}
.footer-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding-bottom: var(--space-lg);
    border-bottom: 1px solid var(--border);
    gap: var(--space-xl);
    flex-wrap: wrap;
}
.footer-brand-name {
    font-size: 0.7rem; font-weight: 700;
    letter-spacing: 0.14em; text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: var(--space-sm);
}
.footer-tagline {
    font-family: var(--font-narrative);
    font-size: 0.85rem; color: var(--text-secondary);
    max-width: 320px;
}
.footer-links { display: flex; gap: var(--space-2xl); }
.footer-links-col h4 {
    font-size: 0.6rem; font-weight: 700;
    letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: var(--space-sm);
}
.footer-links-col a {
    display: block; font-size: 0.78rem;
    color: var(--text-secondary);
    margin-bottom: var(--space-xs);
}
.footer-bottom {
    padding-top: var(--space-lg);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--space-md);
}
.footer-disclaimer {
    font-size: 0.65rem; line-height: 1.7;
    color: var(--text-muted);
    max-width: 700px;
}
.footer-meta {
    font-family: var(--font-data);
    font-size: 0.6rem;
    color: var(--text-muted);
}

/* --- Hero Section --- */
.hero {
    padding: var(--space-xl) 0 var(--space-md);
    text-align: center;
}
.hero-tagline {
    font-size: 0.7rem; font-weight: 600;
    letter-spacing: 0.15em; text-transform: uppercase;
    color: var(--accent-teal);
    margin-bottom: var(--space-md);
}
.hero-title {
    font-family: var(--font-narrative);
    font-size: 2.4rem; font-weight: 700;
    color: var(--text-primary);
    line-height: 1.2;
    margin-bottom: var(--space-md);
}
.hero-subtitle {
    font-size: 1rem;
    color: var(--text-secondary);
    max-width: 600px;
    margin: 0 auto var(--space-lg);
    line-height: 1.6;
}
.hero-cred {
    font-size: 0.72rem;
    color: var(--text-muted);
    font-style: italic;
}

/* --- Section Headers --- */
.section-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-sm);
    border-bottom: 1px solid var(--border);
}
.section-title {
    font-size: 0.7rem; font-weight: 700;
    letter-spacing: 0.12em; text-transform: uppercase;
    color: var(--text-muted);
}
.section-link {
    font-size: 0.7rem; font-weight: 500;
    color: var(--accent-teal);
}

/* --- Home Page Stock Search --- */
#page-home .home-search {
    position: relative;
    display: flex;
    align-items: center;
}
#page-home .home-search-wrap {
    position: relative;
    display: flex;
    align-items: center;
}
#page-home .home-search-icon {
    position: absolute;
    left: 8px;
    width: 13px; height: 13px;
    color: var(--text-muted);
    pointer-events: none;
}
#page-home .home-search-input {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 5px;
    padding: 5px 10px 5px 28px;
    font-size: 0.72rem;
    color: var(--text-primary);
    width: 180px;
    outline: none;
    transition: border-color 0.15s, width 0.2s;
}
#page-home .home-search-input::placeholder { color: var(--text-muted); }
#page-home .home-search-input:focus {
    border-color: var(--accent-teal);
    width: 220px;
}
#page-home .home-search-results {
    position: absolute;
    right: 0;
    top: calc(100% + 6px);
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 6px;
    min-width: 240px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    z-index: 200;
    display: none;
    overflow: hidden;
}
#page-home .home-search-result {
    padding: 9px 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    border-bottom: 1px solid var(--border);
}
#page-home .home-search-result:last-child { border-bottom: none; }
#page-home .home-search-result:hover { background: var(--bg-hover, rgba(0,200,117,0.06)); }
#page-home .home-search-result-ticker {
    font-family: var(--font-data);
    font-size: 0.72rem;
    font-weight: 700;
    color: var(--accent-teal);
    min-width: 56px;
}
#page-home .home-search-result-name {
    font-size: 0.68rem;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
#page-home .home-search-empty {
    padding: 10px 14px;
    font-size: 0.68rem;
    color: var(--text-muted);
}

/* --- Featured Report Cards --- */
.featured-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-sm);
    margin-bottom: var(--space-xl);
}
.featured-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px var(--space-md);
    cursor: pointer;
    transition: border-color 0.2s, transform 0.2s, box-shadow 0.2s;
    position: relative;
    overflow: hidden;
}
.featured-card:hover {
    border-color: var(--accent-teal);
    transform: translateY(-2px);
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
}
.featured-card::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0;
    height: 3px;
}
.featured-card.skew-downside::before { background: var(--signal-red); }
.featured-card.skew-upside::before { background: var(--signal-green); }
.featured-card.skew-balanced::before { background: var(--signal-amber); }
.fc-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-xs);
}
.fc-ticker {
    font-size: 1.1rem; font-weight: 800;
    letter-spacing: -0.01em;
    color: var(--text-primary);
}
.fc-company {
    font-size: 0.78rem;
    color: var(--text-secondary);
    margin-bottom: 1px;
}
.fc-sector {
    font-size: 0.58rem; font-weight: 600;
    letter-spacing: 0.06em; text-transform: uppercase;
    color: var(--text-muted);
}
.fc-price {
    font-family: var(--font-data);
    font-size: 1.2rem; font-weight: 700;
    text-align: right;
}
.fc-metrics {
    display: flex; gap: var(--space-md);
    margin-bottom: var(--space-xs);
    padding-bottom: var(--space-xs);
    border-bottom: 1px solid var(--border);
}
.fc-metric-label {
    font-size: 0.55rem; font-weight: 600;
    letter-spacing: 0.06em; text-transform: uppercase;
    color: var(--text-muted);
}
.fc-metric-value {
    font-family: var(--font-data);
    font-size: 0.82rem; font-weight: 600;
    color: var(--text-secondary);
}
.fc-skew {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}
.skew-badge {
    font-family: var(--font-data);
    font-size: 0.7rem; font-weight: 700;
    letter-spacing: 0.04em;
    padding: 3px 10px;
    border-radius: 3px;
}
.skew-badge.downside {
    background: rgba(212, 85, 85, 0.12);
    color: var(--signal-red);
    border: 1px solid rgba(212, 85, 85, 0.25);
}
.skew-badge.upside {
    background: rgba(61, 170, 109, 0.12);
    color: var(--signal-green);
    border: 1px solid rgba(61, 170, 109, 0.25);
}
.skew-badge.balanced {
    background: rgba(212, 160, 60, 0.12);
    color: var(--signal-amber);
    border: 1px solid rgba(212, 160, 60, 0.25);
}

/* --- Coverage Table: Thesis Skew Bar --- */
.skew-cell {
    display: flex;
    align-items: center;
    gap: 8px;
    position: relative;
}
.skew-bar-track {
    width: 60px;
    height: 8px;
    border-radius: 4px;
    overflow: hidden;
    display: flex;
    flex-shrink: 0;
    background: var(--bg-elevated);
}
.skew-bar-bull {
    height: 100%;
    background: var(--signal-green);
    transition: width 0.3s ease;
}
.skew-bar-bear {
    height: 100%;
    background: var(--signal-red);
    transition: width 0.3s ease;
}
.skew-score {
    font-family: var(--font-data);
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 0.02em;
    min-width: 32px;
    text-align: right;
}
.skew-score.positive { color: var(--signal-green); }
.skew-score.negative { color: var(--signal-red); }
.skew-score.neutral { color: var(--signal-amber); }

/* Skew Tooltip */
.skew-tooltip {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 100;
    margin-top: 6px;
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px 14px;
    min-width: 240px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.25);
    pointer-events: none;
}
.skew-cell:hover .skew-tooltip { display: block; }
.skew-tooltip-title {
    font-family: var(--font-data);
    font-size: 0.6rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 6px;
}
.skew-tooltip-row {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 3px 0;
    font-size: 0.75rem;
    color: var(--text-secondary);
}
.skew-tooltip-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    flex-shrink: 0;
}
.skew-tooltip-dot.up { background: var(--signal-green); }
.skew-tooltip-dot.down { background: var(--signal-red); }
.skew-tooltip-dot.neutral { background: var(--signal-amber); }
.skew-tooltip-weight {
    font-family: var(--font-data);
    font-weight: 700;
    min-width: 28px;
    text-align: right;
    margin-left: auto;
}
.skew-tooltip-rationale {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--border);
    font-size: 0.7rem;
    color: var(--text-muted);
    line-height: 1.4;
}

/* Coverage Table Sortable Headers */
.coverage-table thead th.sortable {
    cursor: pointer;
    user-select: none;
    position: relative;
}
.coverage-table thead th.sortable:hover {
    color: var(--text-primary);
}
.sort-arrow {
    font-size: 0.55rem;
    margin-left: 3px;
    opacity: 0.4;
}
.sort-arrow.active { opacity: 1; color: var(--accent-sage); }

.fc-skew-rationale {
    font-size: 0.72rem;
    color: var(--text-secondary);
    line-height: 1.4;
}
.fc-date {
    font-family: var(--font-data);
    font-size: 0.6rem;
    color: var(--text-muted);
    margin-top: var(--space-md);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    flex-wrap: wrap;
}

/* --- Freshness Badges --- */
.freshness-badge {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    font-family: var(--font-data);
    font-size: 0.55rem;
    font-weight: 600;
    letter-spacing: 0.04em;
    padding: 2px 6px;
    border-radius: 3px;
    text-transform: uppercase;
    white-space: nowrap;
}
.freshness-badge.fb-ok {
    background: rgba(61, 170, 109, 0.12);
    color: var(--signal-green);
    border: 1px solid rgba(61, 170, 109, 0.25);
}
.freshness-badge.fb-moderate {
    background: rgba(212, 160, 60, 0.12);
    color: var(--signal-amber);
    border: 1px solid rgba(212, 160, 60, 0.25);
}
.freshness-badge.fb-high {
    background: rgba(212, 85, 85, 0.12);
    color: var(--signal-red);
    border: 1px solid rgba(212, 85, 85, 0.25);
}
.freshness-badge.fb-critical {
    background: rgba(212, 85, 85, 0.2);
    color: var(--signal-red);
    border: 1px solid rgba(212, 85, 85, 0.4);
    animation: pulse-badge 2s ease-in-out infinite;
}
@keyframes pulse-badge {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}
.catalyst-tag {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    font-family: var(--font-data);
    font-size: 0.55rem;
    font-weight: 500;
    padding: 2px 6px;
    border-radius: 3px;
    background: rgba(74, 142, 204, 0.12);
    color: var(--signal-blue);
    border: 1px solid rgba(74, 142, 204, 0.25);
    white-space: nowrap;
}
.catalyst-tag.ct-imminent {
    background: rgba(212, 160, 60, 0.15);
    color: var(--signal-amber);
    border-color: rgba(212, 160, 60, 0.3);
}

/* --- Coverage Table --- */
.coverage-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: var(--space-lg);
}
.coverage-table thead th {
    font-size: 0.6rem; font-weight: 700;
    letter-spacing: 0.08em; text-transform: uppercase;
    color: var(--text-muted);
    padding: var(--space-sm) var(--space-md);
    text-align: left;
    border-bottom: 1px solid var(--border);
}
.coverage-table tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
    cursor: pointer;
}
.coverage-table tbody tr:hover { background: var(--bg-surface-alt); }
.coverage-table tbody tr.stub { opacity: 0.6; cursor: default; }
.coverage-table tbody tr.stub:hover { background: transparent; }
.coverage-table tbody td {
    padding: 10px var(--space-md);
    font-size: 0.82rem;
    color: var(--text-secondary);
    vertical-align: middle;
}
.coverage-table .td-ticker {
    font-family: var(--font-data);
    font-weight: 700;
    color: var(--text-primary);
}
.coverage-table .td-price {
    font-family: var(--font-data);
    font-weight: 600;
}
.coverage-table .td-date {
    font-family: var(--font-data);
    font-size: 0.72rem;
    color: var(--text-muted);
}
.coming-soon {
    font-size: 0.6rem; font-weight: 600;
    letter-spacing: 0.06em; text-transform: uppercase;
    color: var(--text-muted);
    background: var(--bg-elevated);
    padding: 2px 8px;
    border-radius: 3px;
}

/* --- Report Page: Header --- */
.report-hero {
    background: var(--bg-header);
    padding: var(--space-md) 0;
    margin-top: calc(-1 * var(--nav-height));
    padding-top: calc(var(--nav-height) + var(--space-md));
}
.report-hero-inner,
.nfi-alert-inner {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 0 var(--space-lg);
}
.report-back {
    font-size: 0.7rem; font-weight: 500;
    color: var(--text-muted);
    margin-bottom: var(--space-xs);
    display: inline-block;
}
.report-back:hover { color: var(--text-primary); }
/* Report page: prev/next stock navigation bar */
.rh-stock-nav-bar {
    background: var(--bg-card);
    border-bottom: 1px solid var(--border);
}
.rh-stock-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 6px var(--space-lg);
}
.rh-stock-nav a {
    font-family: var(--font-data);
    font-size: 0.72rem;
    font-weight: 600;
    color: var(--accent-teal);
    letter-spacing: 0.04em;
    text-transform: uppercase;
}
.rh-stock-nav a:hover { color: var(--text-primary); }
.rh-main {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--space-xl);
    flex-wrap: wrap;
}
.rh-left { flex: 1; min-width: 280px; }
.rh-type {
    font-size: 0.6rem; font-weight: 600;
    letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--accent-sage);
    margin-bottom: var(--space-xs);
}
.rh-ticker {
    font-size: 2.2rem; font-weight: 800;
    letter-spacing: -0.02em;
    color: var(--text-primary);
    line-height: 1.1;
    margin-bottom: 4px;
}
.rh-company {
    font-size: 1rem; font-weight: 400;
    color: var(--text-secondary);
    margin-bottom: var(--space-sm);
}
.rh-sector-tag {
    display: inline-block;
    font-size: 0.58rem; font-weight: 600;
    letter-spacing: 0.06em; text-transform: uppercase;
    color: var(--accent-sage);
    background: rgba(74, 158, 126, 0.12);
    padding: 3px 10px;
    border-radius: 3px;
    border: 1px solid rgba(74, 158, 126, 0.2);
}
.rh-company-desc {
    font-family: var(--font-body);
    font-size: 0.92rem;
    color: var(--text-secondary);
    line-height: 1.55;
    max-width: 640px;
    margin-top: var(--space-sm);
}
.rh-right { text-align: right; flex-shrink: 0; }
.rh-price {
    font-family: var(--font-data);
    font-size: 2rem; font-weight: 700;
    color: var(--text-primary);
    line-height: 1;
    margin-bottom: var(--space-sm);
}
.rh-price-currency {
    font-size: 0.9rem; font-weight: 400;
    color: var(--text-muted);
}
.rh-metrics {
    display: flex; gap: var(--space-lg);
    justify-content: flex-end;
}
.rh-metric { text-align: right; }
.rh-metric-label {
    font-size: 0.5rem; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.06em;
    color: var(--text-muted);
}
.rh-metric-value {
    font-family: var(--font-data);
    font-size: 0.82rem; font-weight: 600;
    color: var(--text-secondary);
}
.rh-metric-value.premium { color: var(--accent-gold); }
.rh-metric-value.negative { color: var(--signal-red); }
.rh-metric-value.positive { color: var(--signal-green); }

/* --- Report Page: Spec Sections (1.2"1.5) --- */
.rh-spec-section {
    background: var(--bg-surface-alt);
    border-bottom: 1px solid var(--border);
}
.rh-spec-block {
    padding: var(--space-sm) 0;
    border-top: 1px solid var(--border);
}
.rh-spec-label {
    font-size: 0.55rem;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: var(--space-xs);
    display: inline;
}
.rh-spec-text {
    font-size: 0.88rem;
    line-height: 1.6;
    color: var(--text-secondary);
    margin-top: var(--space-xs);
}

/* 1.2 Embedded Thesis */
.rh-embedded-thesis .rh-spec-text {
    font-family: var(--font-serif);
    color: var(--text-primary);
}

/* 1.3 Position in Range */
.rh-position-range { padding-bottom: 0; }
.pir-bar-wrap {
    position: relative;
    margin-top: var(--space-xs);
    padding: 25px 0 42px;
}
.pir-bar {
    position: relative;
    height: 12px;
    background: linear-gradient(to right, var(--signal-red), var(--signal-amber), var(--signal-green));
    border-radius: 6px;
    margin: 0 16px;
}
.pir-world {
    position: absolute;
    transform: translateX(-50%);
    text-align: center;
    top: 14px;
}
.pir-world-tick {
    position: absolute;
    top: -14px;
    left: 50%;
    transform: translateX(-50%);
    width: 1px;
    height: 14px;
    background: rgba(138,154,184,0.4);
    margin: 0;
}
.pir-world-price {
    font-family: var(--font-data);
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-secondary);
    white-space: nowrap;
}
.pir-world-label {
    font-size: 0.58rem;
    color: var(--text-muted);
    white-space: nowrap;
    margin-top: 2px;
}
.pir-current {
    position: absolute;
    transform: translateX(-50%);
    top: -24px;
    text-align: center;
    display: flex;
    flex-direction: column-reverse;
    align-items: center;
}
.pir-current-dot {
    font-size: 0.7rem;
    color: var(--accent-teal);
    line-height: 1;
}
.pir-current-label {
    font-family: var(--font-data);
    font-size: 0.72rem;
    font-weight: 700;
    color: var(--accent-teal);
    white-space: nowrap;
    margin-bottom: 2px;
}
.pir-note {
    display: none;
}

/* 1.4 Valuation Range */
.vr-block { padding-bottom: 0; }
.vr-title-row { display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-xs); }
.vr-badge {
    font-size: 0.55rem; font-weight: 800; letter-spacing: 0.1em; text-transform: uppercase;
    padding: 2px 7px; border-radius: 3px;
}
.vr-badge.amber { background: rgba(212,160,60,0.15); color: var(--signal-amber); }
.vr-badge.neutral { background: rgba(0,0,0,0.08); color: var(--text-muted); }
.vr-badge.positive { background: rgba(61,170,109,0.15); color: var(--signal-green); }
.vr-bar-wrap { position: relative; padding: 25px 0 42px; margin-top: var(--space-xs); }
.vr-bar {
    position: relative; height: 12px; border-radius: 6px; margin: 0 16px;
    background: linear-gradient(to right, var(--signal-red) 0%, var(--signal-amber) 40%, var(--signal-green) 100%);
}
.vr-marker {
    position: absolute; transform: translateX(-50%); top: 14px;
    text-align: center; font-size: 0.6rem; color: var(--text-muted);
    white-space: nowrap;
}
.vr-marker-price { font-family: var(--font-data); font-size: 0.7rem; font-weight: 600; color: var(--text-secondary); }
.vr-marker-label { font-size: 0.58rem; color: var(--text-muted); margin-top: 2px; }
.vr-marker::before {
    content: ''; position: absolute; top: -14px; left: 50%; transform: translateX(-50%);
    width: 1px; height: 14px; background: rgba(138,154,184,0.4);
}
.vr-current {
    position: absolute; transform: translateX(-50%); top: -24px;
    text-align: center; white-space: nowrap;
    font-family: var(--font-data); font-size: 0.72rem; font-weight: 700; color: var(--accent-teal);
}
.vr-current::after {
    content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
    width: 1px; height: 10px; background: var(--accent-teal);
}
.vr-stats {
    display: flex; gap: var(--space-md); flex-wrap: wrap;
    font-size: 0.65rem; color: var(--text-muted); margin-top: var(--space-xs);
}
.vr-stats span { white-space: nowrap; }
.vr-stats .pos { color: var(--signal-green); }
.vr-stats .neg { color: var(--signal-red); }

/* 1.4 Skew Indicator */
.rh-skew-indicator { display: flex; flex-wrap: wrap; align-items: baseline; gap: 6px; }
.rh-skew-indicator .rh-spec-text { flex-basis: 100%; margin-top: 4px; }
.rh-skew-value {
    font-family: var(--font-data);
    font-size: 0.8rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    padding: 2px 8px;
    border-radius: 3px;
}
.rh-skew-down { color: var(--signal-red); background: rgba(239,68,68,0.08); }
.rh-skew-up   { color: var(--signal-green); background: rgba(34,184,167,0.08); }
.rh-skew-balanced { color: var(--signal-amber); background: rgba(245,158,11,0.08); }

/* 1.5 Next Decision Point */
.ndp-event {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-top: var(--space-xs);
    margin-bottom: 2px;
}
.ndp-date { color: var(--text-muted); font-weight: 400; }

/* --- Report Page: Sparkline --- */
.rh-sparkline {
    margin-bottom: var(--space-xs);
    line-height: 0;
    display: flex;
    justify-content: flex-end;
}
.rh-sparkline svg {
    width: 380px;
    height: 120px;
}

/* --- Report Page: Risk Skew Bar --- */
.risk-skew-bar {
    background: var(--bg-surface);
    padding: var(--space-md) 0;
    border-bottom: 1px solid var(--border);
}
.rsb-inner {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 0 var(--space-lg);
    display: flex;
    align-items: center;
    gap: var(--space-md);
}
.rsb-label {
    font-size: 0.55rem; font-weight: 700;
    letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--text-muted);
}
.rsb-rationale {
    font-size: 0.82rem;
    color: var(--text-secondary);
    flex: 1;
}

/* --- Report Page: Verdict --- */
.verdict-section {
    background: var(--bg-surface);
    border-bottom: 3px solid var(--accent-sage);
    padding: var(--space-lg) 0;
}
.verdict-inner {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 0 var(--space-lg);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-xl);
    flex-wrap: wrap;
}
.verdict-text {
    font-family: var(--font-narrative);
    font-size: 0.95rem; font-weight: 600;
    color: var(--accent-gold);
    line-height: 1.5;
    flex: 1;
    min-width: 300px;
}
.verdict-scores {
    display: flex; gap: var(--space-md);
    flex-shrink: 0;
}
.vs-item { text-align: center; min-width: 60px; }
.vs-label {
    font-size: 0.5rem; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.04em;
    color: var(--text-muted);
    margin-bottom: 2px;
}
.vs-score {
    font-family: var(--font-data);
    font-size: 1.1rem; font-weight: 700;
}
.vs-direction {
    font-size: 0.5rem; font-weight: 600;
    color: var(--text-muted);
}

/* --- Report Page: Signal Bars --- */
.signal-bars-section {
    background: var(--bg-surface-alt);
    border-bottom: 1px solid var(--border);
}
[data-theme="light"] .signal-bars-section { background: var(--bg-surface-alt); }
.sb-row {
    display: flex; align-items: flex-start; gap: 10px;
    padding: 8px 0; border-bottom: 1px solid var(--border);
    min-height: 36px;
}
.sb-row:last-child { border-bottom: none; }
.sb-indicator {
    width: 10px; height: 10px; border-radius: 2px; flex-shrink: 0; margin-top: 3px;
}
.sb-indicator.critical, .sb-indicator.downside { background: var(--signal-red); }
.sb-indicator.positive, .sb-indicator.upside { background: var(--signal-green); }
.sb-indicator.neutral { background: var(--text-muted); }
.sb-indicator.amber { background: var(--signal-amber); }
.sb-row-label {
    font-size: 0.55rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--text-muted); width: 148px; flex-shrink: 0; padding-top: 2px;
}
.sb-badge {
    font-size: 0.6rem; font-weight: 800; letter-spacing: 0.06em; text-transform: uppercase;
    padding: 2px 8px; border-radius: 3px; flex-shrink: 0; white-space: nowrap;
}
.sb-badge.critical { background: rgba(212,85,85,0.15); color: var(--signal-red); }
.sb-badge.downside { background: rgba(212,85,85,0.15); color: var(--signal-red); }
.sb-badge.upside { background: rgba(61,170,109,0.15); color: var(--signal-green); }
.sb-badge.positive { background: rgba(61,170,109,0.15); color: var(--signal-green); }
.sb-badge.neutral { background: rgba(0,0,0,0.08); color: var(--text-muted); }
.sb-badge.amber { background: rgba(212,160,60,0.15); color: var(--signal-amber); }
[data-theme="light"] .sb-badge.neutral { background: rgba(0,0,0,0.06); }
.sb-items {
    display: flex; align-items: center; gap: 6px; flex-wrap: wrap; flex: 1; padding-top: 2px;
}
.sb-item { font-size: 0.78rem; color: var(--text-secondary); font-family: var(--font-data); }
.sb-item.pos { color: var(--signal-green); }
.sb-item.neg { color: var(--signal-red); }
.sb-sep { color: var(--border); font-size: 0.78rem; }
.sb-company-body { flex: 1; }
.sb-score-line { display: flex; align-items: center; gap: var(--space-sm); margin-bottom: 4px; }
.sb-score { font-family: var(--font-data); font-size: 1rem; font-weight: 800; }
.sb-score.neg { color: var(--signal-red); }
.sb-score.pos { color: var(--signal-green); }
.sb-score.neutral { color: var(--signal-amber); }
.sb-score-track {
    width: 80px; height: 10px; border-radius: 5px; overflow: hidden; display: flex;
    background: var(--bg-elevated);
}
.sb-desc { font-size: 0.72rem; color: var(--text-secondary); margin-bottom: 6px; line-height: 1.4; }
.sb-hyp-chips { display: flex; gap: 6px; flex-wrap: wrap; }
.sb-hyp-chip {
    font-size: 0.58rem; font-weight: 700; letter-spacing: 0.04em; text-transform: uppercase;
    border: 1px solid var(--border); border-radius: 3px; padding: 2px 7px; color: var(--text-muted);
    white-space: nowrap;
}
.sb-hyp-chip.downside { border-color: rgba(212,85,85,0.4); color: var(--signal-red); }
.sb-hyp-chip.upside { border-color: rgba(61,170,109,0.4); color: var(--signal-green); }
.sb-hyp-chip .chip-pct { font-weight: 800; margin-left: 3px; }

/* Report-scoped lighter bar colours */
.signal-bars-section .skew-bar-bull,
.risk-skew-bar .skew-bar-bull {
    background: #5BC88A;
}
.signal-bars-section .skew-bar-bear,
.risk-skew-bar .skew-bar-bear {
    background: #E87A7A;
}
[data-theme="light"] .signal-bars-section .skew-bar-bull,
[data-theme="light"] .risk-skew-bar .skew-bar-bull {
    background: #6DD49A;
}
[data-theme="light"] .signal-bars-section .skew-bar-bear,
[data-theme="light"] .risk-skew-bar .skew-bar-bear {
    background: #E88A8A;
}

/* --- Report Page: Section Nav --- */
.section-nav {
    background: var(--bg-page);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: var(--nav-height);
    z-index: 50;
}
.section-nav-inner {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 0 var(--space-lg);
    display: flex;
    gap: var(--space-xs);
    overflow-x: auto;
}
.section-nav a {
    font-size: 0.68rem; font-weight: 600;
    letter-spacing: 0.04em; text-transform: uppercase;
    color: var(--text-muted);
    padding: 12px var(--space-md);
    border-bottom: 2px solid transparent;
    white-space: nowrap;
    transition: color 0.2s, border-color 0.2s;
}
.section-nav a:hover { color: var(--text-secondary); }
.section-nav a.active {
    color: var(--accent-teal);
    border-bottom-color: var(--accent-teal);
}
.sections-float-toggle {
    position: fixed;
    bottom: 2rem;
    left: 2rem;
    z-index: 200;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.65rem;
    font-weight: 700;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--text-primary);
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 8px 16px;
    cursor: pointer;
    white-space: nowrap;
    box-shadow: 0 4px 16px rgba(0,0,0,0.25);
    transition: box-shadow 0.2s, border-color 0.2s, color 0.2s;
}
.sections-float-toggle:hover { border-color: var(--accent-teal); color: var(--accent-teal); box-shadow: 0 4px 20px rgba(0,0,0,0.35); }

/* --- Report Sections --- */
.report-content {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: var(--space-xl) var(--space-lg);
}
/* --- Refresh controls --- */
.refresh-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: var(--space-sm);
}
.btn-refresh {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-family: var(--font-data);
    font-size: 0.68rem;
    font-weight: 600;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    color: var(--accent-teal);
    background: rgba(74, 158, 126, 0.10);
    border: 1px solid rgba(74, 158, 126, 0.25);
    border-radius: 4px;
    padding: 5px 14px;
    cursor: pointer;
    transition: all 0.2s;
}
.btn-refresh:hover { background: rgba(74, 158, 126, 0.20); color: var(--text-primary); }
.btn-refresh:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
.btn-refresh .refresh-icon {
    display: inline-block;
    transition: transform 0.3s;
}
.btn-refresh.refreshing .refresh-icon {
    animation: spin 1s linear infinite;
}
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
.refresh-timestamp {
    font-family: var(--font-data);
    font-size: 0.62rem;
    color: var(--text-muted);
    letter-spacing: 0.02em;
}
.refresh-progress {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
}
.progress-bar {
    width: 120px;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
}
.progress-fill {
    height: 100%;
    width: 0%;
    background: var(--accent-teal);
    border-radius: 2px;
    transition: width 0.5s ease;
}
.progress-label {
    font-family: var(--font-data);
    font-size: 0.6rem;
    color: var(--accent-sage);
    letter-spacing: 0.02em;
}

.report-section {
    margin-bottom: var(--space-2xl);
    scroll-margin-top: calc(var(--nav-height) + 50px);
}
.rs-number {
    font-family: var(--font-data);
    font-size: 0.6rem; font-weight: 600;
    color: var(--accent-teal);
    letter-spacing: 0.08em; text-transform: uppercase;
    margin-bottom: var(--space-xs);
}
.rs-title {
    font-family: var(--font-narrative);
    font-size: 1.3rem; font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0;
}
.rs-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-md);
    cursor: pointer;
    padding-bottom: var(--space-sm);
    margin-bottom: var(--space-md);
    border-bottom: 2px solid var(--accent-teal);
    user-select: none;
}
.rs-header-text { flex: 1; min-width: 0; }
.rs-toggle {
    flex-shrink: 0;
    background: none;
    border: 1px solid var(--border);
    cursor: pointer;
    color: var(--text-muted);
    padding: 4px 6px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    margin-top: 2px;
    transition: color 0.2s, border-color 0.2s;
}
.rs-toggle:hover { color: var(--accent-teal); border-color: var(--accent-teal); }
.rs-toggle svg {
    width: 14px; height: 14px;
    transition: transform 0.25s ease;
}
.report-section.collapsed .rs-toggle svg {
    transform: rotate(-90deg);
}
.rs-body {
    overflow: hidden;
}
.report-section.collapsed .rs-body {
    display: none;
}
.page:not(.active) .sections-float-toggle {
    display: none;
}
.rs-subtitle {
    font-size: 0.88rem; font-weight: 700;
    color: var(--accent-teal);
    margin-top: var(--space-lg);
    margin-bottom: var(--space-sm);
}
.rs-text {
    font-size: 0.88rem; line-height: 1.7;
    color: var(--text-secondary);
    margin-bottom: var(--space-md);
}
.rs-text strong { color: var(--text-primary); font-weight: 600; }
.key-stat {
    font-family: var(--font-data);
    font-weight: 600;
    color: var(--accent-teal);
}
.key-stat.down {
    color: var(--signal-red);
}
.key-stat.up {
    color: var(--signal-green);
}

/* --- Sticky Hypothesis Sidebar (desktop) --- */
@media (min-width: 1200px) {
    .report-content {
        display: grid;
        grid-template-columns: 1fr 220px;
        gap: var(--space-xl);
        max-width: 1340px;
    }
    .report-main {
        min-width: 0;
    }
    .hyp-sidebar {
        position: sticky;
        top: calc(var(--nav-height) + 60px);
        align-self: start;
        height: fit-content;
        max-height: calc(100vh - var(--nav-height) - 80px);
        overflow-y: auto;
    }
    /* Align hero, skew bar, verdict, and section nav with the grid main column */
    .report-hero-inner,
    .rsb-inner,
    .nfi-alert-inner,
    .verdict-inner,
    .section-nav-inner {
        max-width: 1340px;
        padding-right: calc(var(--space-lg) + 220px + var(--space-xl));
    }
}
@media (max-width: 1199px) {
    .hyp-sidebar { display: none; }
    .report-main { min-width: 0; }
}
.hyp-sidebar {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: var(--space-md);
}
.hs-stock-id {
    margin-bottom: var(--space-sm);
    padding-bottom: var(--space-sm);
    border-bottom: 1px solid var(--border);
}
.hs-stock-ticker {
    font-family: var(--font-data);
    font-size: 0.85rem;
    font-weight: 700;
    color: var(--text-primary);
    letter-spacing: 0.02em;
}
.hs-stock-name {
    font-size: 0.68rem;
    color: var(--text-muted);
    line-height: 1.3;
    margin-top: 2px;
}
.hs-title {
    font-size: 0.55rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-xs);
    border-bottom: 1px solid var(--border);
}
.hs-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: 6px 0;
    border-bottom: 1px solid rgba(30,48,80,0.4);
}
.hs-item:last-child { border-bottom: none; }
.hs-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}
.hs-dot.dir-up { background: var(--signal-green); }
.hs-dot.dir-down { background: var(--signal-red); }
.hs-dot.dir-neutral { background: var(--signal-amber); }
.hs-label {
    font-size: 0.7rem;
    color: var(--text-secondary);
    flex: 1;
    line-height: 1.3;
}
.hs-score {
    font-family: var(--font-data);
    font-size: 0.75rem;
    font-weight: 700;
    min-width: 32px;
    text-align: right;
}
.hs-score.dir-up { color: var(--signal-green); }
.hs-score.dir-down { color: var(--signal-red); }
.hs-score.dir-neutral { color: var(--signal-amber); }
.hs-bar {
    width: 100%;
    height: 3px;
    background: var(--bg-elevated);
    border-radius: 2px;
    margin-top: 4px;
    overflow: hidden;
}
.hs-bar-fill {
    height: 100%;
    border-radius: 2px;
}
.hs-skew {
    margin-top: var(--space-md);
    padding-top: var(--space-sm);
    border-top: 1px solid var(--border);
    text-align: center;
}
.hs-skew-label {
    font-size: 0.5rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-muted);
    margin-bottom: 4px;
}

/* ── Sidebar: Price row ── */
.hs-price-row {
    display: flex;
    align-items: baseline;
    gap: 6px;
    margin-top: 2px;
}
.hs-price {
    font-family: var(--font-data);
    font-size: 0.85rem;
    font-weight: 700;
    color: var(--text-primary);
}
.hs-change-badge {
    font-family: var(--font-data);
    font-size: 0.6rem;
    font-weight: 600;
    padding: 1px 5px;
    border-radius: 3px;
}
.hs-change-badge.pos { background: rgba(72,187,120,0.12); color: var(--signal-green); }
.hs-change-badge.neg { background: rgba(245,101,101,0.12); color: var(--signal-red); }

/* ── Sidebar: Section headings ── */
.hs-section-head {
    font-size: 0.5rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-top: var(--space-md);
    margin-bottom: var(--space-xs);
    padding-bottom: var(--space-xs);
    border-bottom: 1px solid var(--border);
}
.hs-subhead {
    font-size: 0.48rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-muted);
    margin-top: var(--space-sm);
    margin-bottom: 4px;
}

/* ── Sidebar: Overall Skew row ── */
.hs-overall-skew {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 0;
    border-bottom: 1px solid rgba(30,48,80,0.4);
}
.hs-skew-dir {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
}
.hs-skew-dir.upside   { color: var(--signal-green); }
.hs-skew-dir.downside { color: var(--signal-red); }
.hs-skew-dir.balanced { color: var(--signal-amber); }
.hs-skew-score {
    font-family: var(--font-data);
    font-size: 0.75rem;
    font-weight: 700;
}
.hs-skew-score.upside   { color: var(--signal-green); }
.hs-skew-score.downside { color: var(--signal-red); }
.hs-skew-score.balanced { color: var(--signal-amber); }

/* ── Sidebar: Environment rows (Macro/Sector) ── */
.hs-env-row {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: 5px 0;
    border-bottom: 1px solid rgba(30,48,80,0.4);
}
.hs-env-row:last-child { border-bottom: none; }
.hs-env-label {
    font-size: 0.68rem;
    color: var(--text-secondary);
    flex: 1;
}
.hs-env-score {
    font-family: var(--font-data);
    font-size: 0.7rem;
    font-weight: 600;
    min-width: 28px;
    text-align: right;
}

/* ── Sidebar: Company metric rows (P/E, Rev Growth) ── */
.hs-company-row {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: 5px 0;
    border-bottom: 1px solid rgba(30,48,80,0.4);
}
.hs-company-row:last-child { border-bottom: none; }
.hs-company-label {
    font-size: 0.68rem;
    color: var(--text-secondary);
    flex: 1;
}
.hs-company-value {
    font-family: var(--font-data);
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-primary);
}

/* ── Sidebar: Valuation Range ── */
.hs-val-section {
    margin-top: var(--space-sm);
}
.hs-val-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 6px;
}
.hs-val-zone {
    font-size: 0.5rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    padding: 1px 6px;
    border-radius: 3px;
}
.hs-val-zone.amber   { background: rgba(201,169,110,0.15); color: var(--signal-amber); }
.hs-val-zone.green   { background: rgba(72,187,120,0.12);  color: var(--signal-green); }
.hs-val-zone.red     { background: rgba(245,101,101,0.12); color: var(--signal-red); }
.hs-val-levels {
    display: flex;
    justify-content: space-between;
    font-family: var(--font-data);
    font-size: 0.58rem;
    color: var(--text-muted);
    margin-bottom: 4px;
}
.hs-val-levels span { text-align: center; }
.hs-val-bar {
    width: 100%;
    height: 5px;
    border-radius: 3px;
    background: linear-gradient(90deg, var(--signal-red), var(--signal-amber) 40%, var(--signal-green));
    position: relative;
    margin-bottom: 6px;
}
.hs-val-marker {
    position: absolute;
    top: -3px;
    width: 3px;
    height: 11px;
    background: var(--text-primary);
    border-radius: 1px;
    transform: translateX(-50%);
}
.hs-val-distances {
    display: flex;
    justify-content: space-between;
    font-family: var(--font-data);
    font-size: 0.55rem;
}
.hs-val-distances .pos { color: var(--signal-green); }
.hs-val-distances .neg { color: var(--signal-red); }

/* --- Evidence Domain Cards --- */
.evidence-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 6px;
    margin-bottom: var(--space-md);
    overflow: hidden;
}
.ec-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md) var(--space-lg);
    cursor: pointer;
    transition: background 0.15s;
}
.ec-header:hover { background: var(--bg-surface-alt); }
.ec-title {
    font-weight: 700;
    font-size: 0.88rem;
    color: var(--text-primary);
}
.ec-header-right {
    display: flex; align-items: center; gap: var(--space-sm);
}
.ec-epistemic {
    font-size: 0.55rem; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.06em;
    padding: 2px 8px; border-radius: 3px;
}
.ep-motivated { background: rgba(212, 160, 60, 0.15); color: var(--signal-amber); }
.ep-statutory { background: rgba(61, 170, 109, 0.15); color: var(--signal-green); }
.ep-consensus { background: rgba(74, 142, 204, 0.15); color: var(--signal-blue); }
.ep-independent { background: rgba(140, 100, 200, 0.15); color: #8B6CC1; }
.ep-objective { background: rgba(26, 158, 143, 0.15); color: var(--accent-teal); }
.ep-behavioural { background: rgba(212, 160, 60, 0.12); color: var(--accent-gold); }
.ep-peerreviewed { background: rgba(140, 100, 200, 0.12); color: #8B6CC1; }
.ep-noise { background: rgba(86, 104, 130, 0.2); color: var(--text-muted); }
.ec-toggle {
    font-size: 0.7rem; color: var(--text-muted);
    transition: transform 0.3s;
}
.ec-toggle.open { transform: rotate(180deg); }
.ec-body {
    padding: 0 var(--space-lg) var(--space-lg);
    display: none;
}
.ec-body.open { display: block; }
.ec-finding {
    font-size: 0.82rem; line-height: 1.7;
    color: var(--text-secondary);
    margin-bottom: var(--space-md);
}
.ec-finding strong { color: var(--text-primary); }
.ec-tension {
    background: rgba(212, 160, 60, 0.06);
    border-left: 2px solid var(--signal-amber);
    padding: var(--space-sm) var(--space-md);
    border-radius: 0 4px 4px 0;
    margin-bottom: var(--space-md);
}
.ec-tension-label {
    font-size: 0.55rem; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.06em;
    color: var(--signal-amber);
    margin-bottom: 2px;
}
.ec-tension p {
    font-size: 0.78rem; line-height: 1.6;
    color: var(--text-secondary); margin: 0;
}
.ec-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: var(--space-sm);
    border-top: 1px solid var(--border);
    flex-wrap: wrap; gap: var(--space-sm);
}
.ec-tags { display: flex; gap: 4px; flex-wrap: wrap; }
.ec-tag {
    font-size: 0.52rem; font-weight: 600;
    padding: 2px 6px; border-radius: 2px;
}
.ec-tag.supports { background: rgba(61,170,109,0.12); color: var(--signal-green); }
.ec-tag.contradicts { background: rgba(212,85,85,0.12); color: var(--signal-red); }
.ec-tag.neutral { background: rgba(86,104,130,0.15); color: var(--text-muted); }
.ec-tag.strong { background: rgba(61,170,109,0.2); color: var(--signal-green); font-weight: 700; }
.ec-source {
    font-size: 0.6rem; color: var(--text-muted);
    font-style: italic;
}

/* --- Evidence Alignment Table --- */
.evidence-table {
    width: 100%;
    border-collapse: collapse;
    margin: var(--space-lg) 0;
    font-size: 0.78rem;
}
.evidence-table thead th {
    background: var(--bg-header);
    color: var(--text-primary);
    font-size: 0.6rem; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.06em;
    padding: var(--space-sm) var(--space-md);
    text-align: left;
}
.evidence-table tbody td {
    padding: var(--space-sm) var(--space-md);
    border-bottom: 1px solid var(--border);
    color: var(--text-secondary);
    vertical-align: middle;
}
.evidence-table tbody tr:nth-child(even) { background: var(--bg-surface-alt); }
.evidence-table tbody td:first-child {
    font-weight: 600; color: var(--text-primary);
}
.et-up { color: var(--signal-green); font-weight: 700; }
.et-down { color: var(--signal-red); font-weight: 700; }
.et-strong { color: var(--signal-green); font-weight: 800; }
.et-neutral { color: var(--text-muted); }

/* --- Hypothesis Cards --- */
.hyp-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: var(--space-lg);
    margin-bottom: var(--space-md);
}
.hyp-card.dir-up { border-left: 4px solid var(--signal-green); }
.hyp-card.dir-down { border-left: 4px solid var(--signal-red); }
.hyp-card.dir-neutral { border-left: 4px solid var(--signal-amber); }
/* N1 prominence  --  dominant hypothesis visually highlighted */
.hyp-card.dominant {
    border-width: 2px;
    border-left-width: 5px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    position: relative;
}
.hyp-card.dominant::after {
    content: 'DOMINANT';
    position: absolute; top: var(--space-sm); right: var(--space-sm);
    font-size: 0.55rem; font-weight: 700; letter-spacing: 0.1em;
    padding: 2px 8px; border-radius: 3px;
    background: rgba(0, 0, 0, 0.04); color: var(--text-muted);
}
.hc-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-md);
}
.hc-title {
    font-family: var(--font-narrative);
    font-size: 1.05rem; font-weight: 700;
    color: var(--text-primary);
}
.hc-status {
    font-size: 0.55rem; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.06em;
    padding: 3px 10px; border-radius: 3px;
    white-space: nowrap;
}
.hc-status.priced { background: rgba(61,170,109,0.1); color: var(--signal-green); }
.hc-status.accumulating { background: rgba(212,160,60,0.1); color: var(--signal-amber); }
.hc-status.active { background: rgba(212,85,85,0.1); color: var(--signal-red); }
.hc-status.minimal { background: var(--bg-elevated); color: var(--text-muted); }
.hc-score-row {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin-bottom: var(--space-md);
}
.hc-score-number {
    font-family: var(--font-data);
    font-size: 1.6rem; font-weight: 800;
    min-width: 48px;
}
.dir-up .hc-score-number { color: var(--signal-green); }
.dir-down .hc-score-number { color: var(--signal-red); }
.dir-neutral .hc-score-number { color: var(--signal-amber); }
.hc-score-bar {
    flex: 1; height: 6px;
    background: var(--bg-elevated);
    border-radius: 3px; overflow: hidden;
}
.hc-score-fill { height: 100%; border-radius: 3px; }
.dir-up .hc-score-fill { background: var(--signal-green); }
.dir-down .hc-score-fill { background: var(--signal-red); }
.dir-neutral .hc-score-fill { background: var(--signal-amber); }
.hc-score-meta {
    font-size: 0.7rem; color: var(--text-muted);
    white-space: nowrap;
}
.hc-desc {
    font-size: 0.82rem; line-height: 1.6;
    color: var(--text-secondary);
    margin-bottom: var(--space-md);
}
.hc-subtitle {
    font-size: 0.65rem; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.04em;
    color: var(--text-muted);
    margin-top: var(--space-md);
    margin-bottom: var(--space-xs);
}
.hc-list {
    list-style: none; padding: 0;
}
.hc-list li {
    font-size: 0.78rem; color: var(--text-secondary);
    padding: 3px 0 3px 16px;
    position: relative; line-height: 1.5;
}
.hc-list li::before {
    content: '';
    position: absolute; left: 0; top: 9px;
    width: 5px; height: 5px; border-radius: 50%;
}
.hc-list.supports li::before { background: var(--signal-green); }
.hc-list.contradicts li::before { background: var(--signal-red); }
.hc-list.requires li::before { background: var(--accent-teal); border-radius: 0; }
.hc-list li strong { color: var(--text-primary); }

/* --- Callout Boxes --- */
.callout {
    background: rgba(26, 158, 143, 0.06);
    border-left: 3px solid var(--accent-teal);
    padding: var(--space-md) var(--space-lg);
    margin: var(--space-md) 0;
    border-radius: 0 4px 4px 0;
}
.callout.warn {
    background: rgba(212, 160, 60, 0.06);
    border-left-color: var(--signal-amber);
}
.callout.critical {
    background: rgba(212, 85, 85, 0.06);
    border-left-color: var(--signal-red);
}
.callout.positive {
    background: rgba(61, 170, 109, 0.06);
    border-left-color: var(--signal-green);
}
.callout-label {
    font-size: 0.6rem; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.08em;
    margin-bottom: var(--space-xs);
    color: var(--accent-teal);
}
.callout.warn .callout-label { color: var(--signal-amber); }
.callout.critical .callout-label { color: var(--signal-red); }
.callout.positive .callout-label { color: var(--signal-green); }
.callout p {
    font-size: 0.82rem; line-height: 1.6;
    color: var(--text-secondary); margin: 0;
}
.callout p strong { color: var(--text-primary); }

/* Overcorrection banner  --  v3 framework amber alert */
.overcorrection-banner {
    background: rgba(212, 160, 60, 0.08);
    border: 1px solid var(--signal-amber);
    border-left: 4px solid var(--signal-amber);
    border-radius: var(--radius);
    padding: var(--space-sm) var(--space-md);
    margin: var(--space-md) 0;
}
.overcorrection-banner .oc-label {
    font-size: 0.6rem; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.08em;
    color: var(--signal-amber); margin-bottom: var(--space-xs);
}
.overcorrection-banner .oc-message {
    font-size: 0.82rem; line-height: 1.5;
    color: var(--text-secondary); margin: 0;
}
.overcorrection-banner .oc-review {
    font-size: 0.72rem; color: var(--text-muted);
    margin-top: var(--space-xs);
}
.overcorrection-banner.confirmed {
    border-color: var(--signal-green);
    background: rgba(72, 199, 142, 0.06);
}
.overcorrection-banner.confirmed .oc-label { color: var(--signal-green); }

/* --- Narrative Timeline Chart --- */
.narrative-timeline-section {
    margin-top: var(--space-lg);
}
.nt-chart-container {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: var(--space-md);
    margin-bottom: var(--space-md);
    position: relative;
}
.nt-chart-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: var(--space-sm);
}
.nt-chart-title {
    font-family: var(--font-ui);
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-muted);
}
.nt-chart-badge {
    font-family: var(--font-data); font-size: 0.55rem; font-weight: 700;
    letter-spacing: 0.08em; color: var(--text-muted); background: var(--bg-elevated);
    padding: 2px 8px; border-radius: 3px; border: 1px solid var(--border);
}
.nt-chart-canvas-wrap {
    position: relative;
    height: 320px;
}
.nt-chart-canvas-wrap canvas {
    width: 100% !important;
    height: 100% !important;
}
.nt-chart-loading {
    display: flex; align-items: center; justify-content: center;
    height: 320px; color: var(--text-muted); font-family: var(--font-ui);
    font-size: 0.75rem; gap: var(--space-sm);
}
.nt-chart-loading .spinner {
    width: 18px; height: 18px; border: 2px solid var(--border);
    border-top-color: var(--accent-teal); border-radius: 50%;
    animation: spin 0.8s linear infinite;
}
.nt-chart-empty {
    display: flex; align-items: center; justify-content: center;
    height: 200px; color: var(--text-muted); font-family: var(--font-ui);
    font-size: 0.8rem; text-align: center;
}
.nt-flip-legend {
    display: flex; flex-wrap: wrap; gap: var(--space-sm);
    margin-top: var(--space-sm); padding-top: var(--space-sm);
    border-top: 1px solid var(--border);
}
.nt-flip-item {
    font-family: var(--font-data); font-size: 0.65rem;
    color: var(--text-muted); display: flex; align-items: center; gap: 4px;
}
.nt-flip-marker {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--signal-amber); display: inline-block;
}
.nt-flip-marker.oc { background: var(--signal-red); }
[data-theme="light"] .nt-chart-container { background: #FFFFFF; border-color: #E2E8F0; }

/* --- Tripwire Cards --- */
.tw-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: var(--space-md) var(--space-lg);
    margin-bottom: var(--space-md);
}
.tw-card.tw-resolved {
    opacity: 0.6;
    border-left: 3px solid var(--text-muted);
}
.tw-card.tw-resolved .tw-date::after {
    content: ' \2713';
    color: var(--signal-green);
}
.tw-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
}
.tw-date {
    font-family: var(--font-data);
    font-size: 0.72rem; font-weight: 700;
    color: var(--accent-gold);
}
.tw-name {
    font-size: 0.68rem; font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.04em;
}
.tw-conditions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-md);
}
.tw-condition {
    background: var(--bg-elevated);
    border-radius: 4px;
    padding: var(--space-sm) var(--space-md);
}
.tw-cond-if {
    font-size: 0.68rem; font-weight: 600;
    margin-bottom: var(--space-xs);
}
.tw-cond-if.positive { color: var(--signal-green); }
.tw-cond-if.negative { color: var(--signal-red); }
.tw-cond-if.resolved { color: var(--text-muted); font-style: italic; }
.tw-cond-then {
    font-size: 0.72rem; color: var(--text-secondary);
    line-height: 1.4;
}
.tw-source {
    font-size: 0.6rem; color: var(--text-muted);
    font-style: italic;
    margin-top: var(--space-sm);
}

/* --- Gaps Table --- */
.gaps-table {
    width: 100%;
    border-collapse: collapse;
    margin: var(--space-md) 0;
    font-size: 0.78rem;
}
.gaps-table thead th {
    background: var(--bg-header);
    color: var(--text-primary);
    font-size: 0.6rem; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.06em;
    padding: var(--space-sm) var(--space-md);
    text-align: left;
}
.gaps-table tbody td {
    padding: var(--space-sm) var(--space-md);
    border-bottom: 1px solid var(--border);
    color: var(--text-secondary);
}
.gaps-table tbody tr:nth-child(even) { background: var(--bg-surface-alt); }
.gap-dot {
    display: inline-block;
    width: 8px; height: 8px;
    border-radius: 50%;
    margin-right: 6px;
    vertical-align: middle;
}
.gap-dot.full { background: var(--signal-green); }
.gap-dot.good { background: var(--accent-sage); }
.gap-dot.partial { background: var(--signal-amber); }
.gap-dot.limited { background: var(--text-muted); }

/* --- Discriminates Table --- */
.disc-table {
    width: 100%;
    border-collapse: collapse;
    margin: var(--space-md) 0;
    font-size: 0.78rem;
}
.disc-table thead th {
    background: var(--bg-header);
    color: var(--text-primary);
    font-size: 0.6rem; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.06em;
    padding: var(--space-sm) var(--space-md);
    text-align: left;
}
.disc-table tbody td {
    padding: 10px var(--space-md);
    border-bottom: 1px solid var(--border);
    color: var(--text-secondary);
    vertical-align: top;
}
.disc-table tbody tr:nth-child(even) { background: var(--bg-surface-alt); }
.disc-high { color: var(--signal-red); font-weight: 700; }
.disc-med { color: var(--signal-amber); font-weight: 700; }

/* --- Identity Table --- */
.identity-table {
    width: 100%;
    border-collapse: collapse;
    margin: var(--space-md) 0;
    font-size: 0.78rem;
}
.identity-table thead th {
    background: var(--bg-header);
    color: var(--text-primary);
    font-size: 0.6rem; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.06em;
    padding: var(--space-sm) var(--space-md);
    text-align: left;
}
.identity-table tbody td {
    padding: var(--space-sm) var(--space-md);
    border-bottom: 1px solid var(--border);
    color: var(--text-secondary);
}
.identity-table tbody tr:nth-child(even) { background: var(--bg-surface-alt); }
.identity-table .td-label { font-weight: 600; color: var(--text-primary); }
.identity-table .td-mono {
    font-family: var(--font-data);
    font-size: 0.75rem;
}
.td-green { color: var(--signal-green); }
.td-red { color: var(--signal-red); }
.td-amber { color: var(--signal-amber); }

/* --- About Page --- */
.about-content {
    max-width: 720px;
    margin: 0 auto;
    padding: var(--space-3xl) var(--space-lg);
}
.about-title {
    font-family: var(--font-narrative);
    font-size: 2rem; font-weight: 700;
    color: var(--text-primary);
    margin-bottom: var(--space-lg);
}
.about-subtitle {
    font-family: var(--font-narrative);
    font-size: 1.2rem; font-weight: 600;
    color: var(--accent-teal);
    margin-top: var(--space-xl);
    margin-bottom: var(--space-md);
}
.about-text {
    font-size: 0.92rem;
    line-height: 1.8;
    color: var(--text-secondary);
    margin-bottom: var(--space-md);
}
.about-text strong { color: var(--text-primary); }

/* ============================================================================
   THESIS COMPARATOR STYLES
   ============================================================================ */

.tc-section {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: var(--space-xl) var(--space-lg);
}

.tc-hero {
    text-align: center;
    padding: var(--space-2xl) 0;
}

.tc-hero-tagline {
    font-size: 0.7rem;
    font-weight: 600;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--accent-teal);
    margin-bottom: var(--space-md);
}

.tc-hero-title {
    font-family: var(--font-narrative);
    font-size: 2.2rem;
    font-weight: 700;
    margin-bottom: var(--space-md);
}

.tc-hero-subtitle {
    font-size: 1rem;
    color: var(--text-secondary);
    max-width: 600px;
    margin: 0 auto;
}

.tc-card-container {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: var(--space-xl);
    margin-bottom: var(--space-xl);
}

.tc-step-label {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: var(--space-md);
    display: block;
}

.tc-stock-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: var(--space-sm);
}

.tc-stock-card {
    padding: var(--space-md);
    background: var(--bg-elevated);
    border: 2px solid transparent;
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    transition: all 150ms ease;
}

.tc-stock-card:hover {
    border-color: var(--border-light);
    background: var(--bg-card);
}

.tc-stock-card.selected {
    border-color: var(--accent-teal);
    background: rgba(26, 158, 143, 0.1);
}

.tc-stock-ticker {
    font-family: var(--font-data);
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: var(--space-xs);
}

.tc-stock-name {
    font-size: 0.7rem;
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.tc-input-step {
    display: none;
    border-top: 1px solid var(--border);
    padding-top: var(--space-xl);
    margin-top: var(--space-xl);
}

.tc-input-step.active { display: block; }

.tc-textarea {
    width: 100%;
    min-height: 200px;
    padding: var(--space-md);
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-primary);
    font-family: var(--font-narrative);
    font-size: 0.95rem;
    line-height: 1.7;
    resize: vertical;
    transition: border-color 150ms ease;
}

.tc-textarea:focus {
    outline: 3px solid var(--accent-teal);
    outline-offset: -1px;
    border-color: var(--accent-teal);
}

.tc-analyze-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    margin-top: var(--space-lg);
    padding: 14px 32px;
    background: var(--accent-teal);
    border: none;
    border-radius: 8px;
    color: white;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 150ms ease;
}

.tc-analyze-btn:hover {
    background: #158a7d;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(26, 158, 143, 0.3);
}

/* Results */
.tc-results { display: none; }
.tc-results.active { display: block; }

.tc-banner {
    border-radius: 12px;
    padding: var(--space-xl);
    margin-bottom: var(--space-xl);
    text-align: center;
    border: 2px solid;
}

.tc-banner.n1 { background: rgba(61, 170, 109, 0.1); border-color: var(--signal-green); }
.tc-banner.n2 { background: rgba(212, 160, 60, 0.1); border-color: var(--signal-amber); }
.tc-banner.n3 { background: rgba(212, 85, 85, 0.1); border-color: var(--signal-red); }
.tc-banner.n4 { background: rgba(74, 142, 204, 0.1); border-color: var(--signal-blue); }
.tc-banner.uphill { background: var(--bg-warning); border-color: var(--signal-amber); border-style: dashed; }

.tc-banner-label {
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: var(--space-sm);
}

.tc-banner.n1 .tc-banner-label { color: var(--signal-green); }
.tc-banner.n2 .tc-banner-label { color: var(--signal-amber); }
.tc-banner.n3 .tc-banner-label { color: var(--signal-red); }
.tc-banner.n4 .tc-banner-label { color: var(--signal-blue); }
.tc-banner.uphill .tc-banner-label { color: var(--signal-amber); }

.tc-banner-hypothesis {
    font-family: var(--font-narrative);
    font-size: 1.6rem;
    font-weight: 600;
    margin-bottom: var(--space-sm);
}

.tc-banner.n1 .tc-banner-hypothesis { color: var(--signal-green); }
.tc-banner.n2 .tc-banner-hypothesis { color: var(--signal-amber); }
.tc-banner.n3 .tc-banner-hypothesis { color: var(--signal-red); }
.tc-banner.n4 .tc-banner-hypothesis { color: var(--signal-blue); }
.tc-banner.uphill .tc-banner-hypothesis { color: var(--signal-amber); }

.tc-banner-desc {
    font-size: 0.95rem;
    line-height: 1.6;
    max-width: 600px;
    margin: 0 auto;
    color: var(--text-secondary);
}

/* Hypothesis Map */
.tc-map {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: var(--space-xl);
    margin-bottom: var(--space-xl);
}

.tc-map-header {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-md);
    border-bottom: 1px solid var(--border);
}

.tc-row {
    display: flex;
    align-items: center;
    padding: var(--space-md) 0;
    border-bottom: 1px solid var(--border);
}

.tc-row:last-child { border-bottom: none; }

.tc-indicator {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--font-data);
    font-size: 0.85rem;
    font-weight: 700;
    margin-right: var(--space-md);
    flex-shrink: 0;
}

.tc-indicator.n1 { background: rgba(61, 170, 109, 0.2); color: var(--signal-green); border: 2px solid var(--signal-green); }
.tc-indicator.n2 { background: rgba(212, 160, 60, 0.2); color: var(--signal-amber); border: 2px solid var(--signal-amber); }
.tc-indicator.n3 { background: rgba(212, 85, 85, 0.2); color: var(--signal-red); border: 2px solid var(--signal-red); }
.tc-indicator.n4 { background: rgba(74, 142, 204, 0.2); color: var(--signal-blue); border: 2px solid var(--signal-blue); }
.tc-indicator.match { box-shadow: 0 0 16px currentColor; }

.tc-info { flex: 1; }

.tc-name {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 2px;
}

.tc-prob {
    font-family: var(--font-data);
    font-size: 0.75rem;
    color: var(--text-muted);
}

.tc-stance {
    padding: 5px 12px;
    border-radius: 6px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.02em;
}

.tc-stance.supports { background: rgba(61, 170, 109, 0.15); color: var(--signal-green); border: 1px solid rgba(61, 170, 109, 0.3); }
.tc-stance.contradicts { background: rgba(212, 85, 85, 0.15); color: var(--signal-red); border: 1px solid rgba(212, 85, 85, 0.3); }
.tc-stance.neutral { background: rgba(100, 116, 139, 0.15); color: var(--text-muted); border: 1px solid rgba(100, 116, 139, 0.3); }

/* Analysis Section */
.tc-analysis {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: var(--space-xl);
}

.tc-analysis-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: var(--space-md);
}

.tc-analysis-text {
    font-size: 0.9rem;
    color: var(--text-secondary);
    line-height: 1.7;
}

.tc-analysis-text strong { color: var(--text-primary); }

.tc-evidence-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-lg);
    margin-top: var(--space-lg);
}

.tc-evidence-col {
    padding: var(--space-md);
    background: var(--bg-elevated);
    border-radius: 8px;
}

.tc-evidence-header {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    margin-bottom: var(--space-md);
}

.tc-evidence-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
}

.tc-evidence-item {
    display: flex;
    align-items: flex-start;
    gap: var(--space-sm);
    padding: var(--space-sm);
    background: var(--bg-surface);
    border-radius: 6px;
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.tc-evidence-icon {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.65rem;
    flex-shrink: 0;
}

.tc-evidence-icon.support { background: rgba(61, 170, 109, 0.2); color: var(--signal-green); }
.tc-evidence-icon.contradict { background: rgba(212, 85, 85, 0.2); color: var(--signal-red); }

@media (max-width: 768px) {
    .tc-hero-title { font-size: 1.6rem; }
    .tc-stock-grid { grid-template-columns: repeat(3, 1fr); }
    .tc-banner-hypothesis { font-size: 1.3rem; }
    .tc-row { flex-wrap: wrap; gap: var(--space-sm); }
    .tc-evidence-grid { grid-template-columns: 1fr; }
}

.about-cred {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-left: 3px solid var(--accent-gold);
    padding: var(--space-lg);
    border-radius: 0 6px 6px 0;
    margin: var(--space-xl) 0;
}
.about-cred p {
    font-family: var(--font-narrative);
    font-size: 0.95rem;
    color: var(--accent-gold);
    line-height: 1.6;
    margin: 0;
}
.about-disclaimer {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: var(--space-lg);
    margin-top: var(--space-xl);
}
.about-disclaimer h4 {
    font-size: 0.65rem; font-weight: 700;
    letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: var(--space-sm);
}
.about-disclaimer p {
    font-size: 0.75rem;
    line-height: 1.7;
    color: var(--text-muted);
    margin: 0;
}

/* --- Report Footer --- */
.report-footer-section {
    background: var(--bg-surface);
    border-top: 1px solid var(--border);
    padding: var(--space-lg) 0;
    margin-top: var(--space-2xl);
}
.rf-inner {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 0 var(--space-lg);
}
.rf-disclaimer-text {
    font-size: 0.65rem; line-height: 1.7;
    color: var(--text-muted);
    margin-bottom: var(--space-md);
}
.rf-meta-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: var(--space-md);
    border-top: 1px solid var(--border);
    flex-wrap: wrap; gap: var(--space-sm);
}
.rf-meta-item {
    font-family: var(--font-data);
    font-size: 0.58rem;
    color: var(--text-muted);
}
.rf-brand {
    font-size: 0.65rem; font-weight: 700;
    letter-spacing: 0.12em; text-transform: uppercase;
    color: var(--text-muted);
}

/* ============================================================
   PDF REPORT DOWNLOAD
   ============================================================ */
.report-download-section {
    background: var(--bg-surface);
    border-top: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
    padding: var(--space-xl) 0;
    margin-top: var(--space-xl);
}
.report-download-inner {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 0 var(--space-lg);
    text-align: center;
}
.report-download-title {
    font-family: var(--font-narrative);
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: var(--space-xs);
}
.report-download-subtitle {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-bottom: var(--space-lg);
}
.report-download-buttons {
    display: flex;
    justify-content: center;
    gap: var(--space-md);
    flex-wrap: wrap;
}
.btn-pdf-download {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    padding: 14px 28px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--bg-elevated);
    cursor: pointer;
    transition: all 0.2s;
    min-width: 220px;
    font-family: var(--font-ui);
}
.btn-pdf-download:hover {
    background: var(--bg-surface-alt);
    border-color: var(--accent-sage);
    transform: translateY(-1px);
}
.btn-pdf-download.institutional { border-left: 3px solid var(--accent-sage); }
.btn-pdf-download.retail { border-left: 3px solid var(--accent-gold); }
.btn-pdf-label {
    font-size: 0.85rem;
    font-weight: 700;
    color: var(--text-primary);
}
.btn-pdf-sub {
    font-size: 0.65rem;
    color: var(--text-muted);
    margin-top: 4px;
}
.btn-pdf-spinner {
    display: none;
    width: 14px; height: 14px;
    border: 2px solid var(--text-muted);
    border-top-color: var(--accent-sage);
    border-radius: 50%;
    animation: pdf-spin 0.8s linear infinite;
    margin-left: 8px;
    vertical-align: middle;
}
.btn-pdf-download.generating .btn-pdf-spinner { display: inline-block; }
.btn-pdf-download.generating { opacity: 0.7; pointer-events: none; }
@keyframes pdf-spin { to { transform: rotate(360deg); } }

/* Narrative dislocation alert CSS removed  --  consolidated into NFI dislocation indicator */

/* ============================================================
   EPISTEMIC BADGES: Leadership & Ownership
   ============================================================ */
.ep-governance { background: rgba(201, 169, 110, 0.15); color: var(--accent-gold); }
.ep-registry { background: rgba(61, 170, 109, 0.12); color: var(--signal-green); }

/* ============================================================
   PORTFOLIO PAGE
   ============================================================ */

/* Upload Zone */
.portfolio-upload-zone {
    border: 2px dashed var(--border-light);
    border-radius: 8px;
    padding: var(--space-2xl) var(--space-xl);
    text-align: center;
    background: var(--bg-surface);
    transition: border-color 0.2s, background 0.2s;
    cursor: pointer;
    margin-bottom: var(--space-xl);
}
.portfolio-upload-zone:hover,
.portfolio-upload-zone.dragover {
    border-color: var(--accent-teal);
    background: var(--bg-surface-alt);
}
.portfolio-upload-zone .upload-icon {
    font-size: 2rem;
    color: var(--text-muted);
    margin-bottom: var(--space-sm);
}
.portfolio-upload-zone .upload-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-xs);
}
.portfolio-upload-zone .upload-subtitle {
    font-size: 0.72rem;
    color: var(--text-muted);
    line-height: 1.5;
}
.portfolio-upload-zone .upload-format {
    display: inline-block;
    margin-top: var(--space-md);
    font-size: 0.6rem;
    font-family: var(--font-data);
    color: var(--text-muted);
    background: var(--bg-elevated);
    padding: 4px 10px;
    border-radius: 3px;
}
.portfolio-upload-zone input[type="file"] { display: none; }

/* Summary Bar */
.portfolio-summary-bar {
    display: flex;
    gap: var(--space-md);
    flex-wrap: wrap;
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: var(--space-md) var(--space-lg);
    margin-bottom: var(--space-xl);
}
.portfolio-summary-item {
    flex: 1;
    min-width: 140px;
    padding: var(--space-sm) 0;
}
.portfolio-summary-label {
    font-size: 0.55rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-bottom: 2px;
}
.portfolio-summary-value {
    font-size: 1.1rem;
    font-weight: 700;
    font-family: var(--font-data);
    color: var(--text-primary);
}
.portfolio-summary-value.positive { color: var(--signal-green); }
.portfolio-summary-value.negative { color: var(--signal-red); }

/* Portfolio Table */
.portfolio-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.78rem;
}
.portfolio-table thead th {
    padding: 10px 12px;
    text-align: left;
    font-size: 0.55rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
}
.portfolio-table tbody tr {
    cursor: pointer;
    transition: background 0.15s;
}
.portfolio-table tbody tr:hover { background: var(--bg-surface-alt); }
.portfolio-table tbody td {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    color: var(--text-secondary);
}
.portfolio-table .td-ticker {
    font-family: var(--font-data);
    font-weight: 700;
    color: var(--accent-teal);
    letter-spacing: 0.03em;
}
.portfolio-table .td-mono {
    font-family: var(--font-data);
    font-size: 0.74rem;
}
.portfolio-table .td-pnl-pos { color: var(--signal-green); font-family: var(--font-data); font-weight: 600; }
.portfolio-table .td-pnl-neg { color: var(--signal-red); font-family: var(--font-data); font-weight: 600; }

/* Alignment Badge */
.alignment-badge {
    display: inline-block;
    font-size: 0.5rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    padding: 3px 8px;
    border-radius: 3px;
    white-space: nowrap;
}
.alignment-badge.aligned {
    background: rgba(61, 170, 109, 0.12);
    color: var(--signal-green);
}
.alignment-badge.contradicts {
    background: rgba(212, 85, 85, 0.12);
    color: var(--signal-red);
}
.alignment-badge.neutral {
    background: rgba(212, 160, 60, 0.1);
    color: var(--signal-amber);
}
.alignment-badge.exceeds {
    background: rgba(212, 85, 85, 0.18);
    color: var(--signal-red);
    border: 1px solid rgba(212, 85, 85, 0.25);
}
.alignment-badge.not-covered {
    background: rgba(86, 104, 130, 0.12);
    color: var(--text-muted);
}

/* Portfolio Actions */
.portfolio-actions {
    display: flex;
    gap: var(--space-sm);
    margin-bottom: var(--space-lg);
}
.portfolio-btn {
    font-size: 0.65rem;
    font-weight: 600;
    padding: 6px 14px;
    border-radius: 4px;
    border: 1px solid var(--border);
    background: var(--bg-surface);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.15s;
}
.portfolio-btn:hover {
    background: var(--bg-surface-alt);
    color: var(--text-primary);
    border-color: var(--border-light);
}
.portfolio-btn.primary {
    background: var(--accent-teal);
    color: #fff;
    border-color: var(--accent-teal);
}
.portfolio-btn.primary:hover {
    background: #1ab8a7;
}

/* ============================================================
   PORTFOLIO DIAGNOSTICS & CHANGE DETECTION
   ============================================================ */

/* Portfolio Diagnostics Section */
.port-diag-section {
    margin-top: var(--space-2xl);
}

/* Hypothesis DNA Bar */
.port-dna-card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: var(--space-xl);
    margin-bottom: var(--space-xl);
}

.port-dna-header {
    margin-bottom: var(--space-lg);
}

.port-dna-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-xs);
}

.port-dna-subtitle {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.port-dna-bar {
    display: flex;
    height: 48px;
    border-radius: 8px;
    overflow: hidden;
    background: var(--bg-elevated);
    margin-bottom: var(--space-lg);
}

.port-dna-segment {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 40px;
    transition: width 0.5s ease;
    position: relative;
}

.port-dna-segment.n1 { background: var(--signal-green); }
.port-dna-segment.n2 { background: var(--signal-amber); }
.port-dna-segment.n3 { background: var(--signal-red); }
.port-dna-segment.n4 { background: var(--signal-blue); }

.port-dna-label {
    font-family: var(--font-data);
    font-size: 0.75rem;
    font-weight: 700;
    color: #fff;
    white-space: nowrap;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

.port-dna-legend {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-md);
}

.port-dna-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.port-dna-dot {
    width: 12px;
    height: 12px;
    border-radius: 3px;
}

.port-dna-dot.n1 { background: var(--signal-green); }
.port-dna-dot.n2 { background: var(--signal-amber); }
.port-dna-dot.n3 { background: var(--signal-red); }
.port-dna-dot.n4 { background: var(--signal-blue); }

/* Insights Grid */
.port-insights-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-lg);
}

.port-insight-card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: var(--space-lg);
}

.port-insight-header {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
}

.port-insight-icon {
    font-size: 1.2rem;
}

.port-insight-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
}

.port-insight-content {
    font-size: 0.85rem;
    color: var(--text-secondary);
    line-height: 1.6;
}

.port-insight-content strong {
    color: var(--text-primary);
}

.port-insight-content .alert-highlight {
    color: var(--signal-red);
    font-weight: 600;
}

.port-insight-content .success-highlight {
    color: var(--signal-green);
    font-weight: 600;
}

/* Change Detection Section */
.change-alerts-section {
    margin-top: var(--space-2xl);
}

.change-alerts-feed {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
}

.change-alert-item {
    display: flex;
    gap: var(--space-md);
    padding: var(--space-lg);
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    border-left: 4px solid var(--accent-teal);
    transition: transform 0.2s, box-shadow 0.2s;
}

.change-alert-item:hover {
    transform: translateX(4px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.change-alert-item.critical {
    border-left-color: var(--signal-red);
    background: rgba(212, 85, 85, 0.05);
}

.change-alert-item.warning {
    border-left-color: var(--signal-amber);
    background: rgba(212, 160, 60, 0.05);
}

.change-alert-item.info {
    border-left-color: var(--signal-blue);
    background: rgba(74, 142, 204, 0.05);
}

.change-alert-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
    background: var(--bg-elevated);
}

.change-alert-content {
    flex: 1;
}

.change-alert-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-xs);
}

.change-alert-text {
    font-size: 0.85rem;
    color: var(--text-secondary);
    line-height: 1.5;
    margin-bottom: var(--space-sm);
}

.change-alert-meta {
    display: flex;
    gap: var(--space-md);
    font-size: 0.75rem;
    color: var(--text-muted);
}

.change-alert-meta span {
    display: flex;
    align-items: center;
    gap: 4px;
}

.change-alert-ticker {
    font-family: var(--font-data);
    font-weight: 600;
    color: var(--accent-teal);
    background: rgba(26, 158, 143, 0.1);
    padding: 2px 8px;
    border-radius: 4px;
}

.change-alerts-empty {
    text-align: center;
    padding: var(--space-2xl);
    background: var(--bg-surface);
    border: 1px dashed var(--border);
    border-radius: 10px;
}

.change-empty-icon {
    font-size: 2rem;
    margin-bottom: var(--space-md);
    opacity: 0.5;
}

.change-empty-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-xs);
}

.change-empty-text {
    font-size: 0.85rem;
    color: var(--text-muted);
}

/* --- Evidence-Aligned Reweighting --- */
.port-reweight-section { margin-top: var(--space-xl); }
.port-reweight-body {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
}
.rw-table { width: 100%; border-collapse: collapse; }
.rw-table thead th {
    font-size: 0.65rem; font-weight: 700;
    letter-spacing: 0.06em; text-transform: uppercase;
    color: var(--text-muted);
    padding: 10px 14px;
    text-align: left;
    border-bottom: 1px solid var(--border);
    background: var(--bg-surface);
}
.rw-table tbody td {
    padding: 10px 14px;
    font-size: 0.82rem;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
}
.rw-table tbody tr:last-child td { border-bottom: none; }
.rw-table tbody tr:hover { background: var(--bg-elevated); }
.rw-ticker { font-family: var(--font-data); font-weight: 700; color: var(--accent-teal); }
.rw-bar-container {
    display: flex; align-items: center; gap: 8px;
}
.rw-bar {
    flex: 1; height: 8px;
    background: rgba(255,255,255,0.06);
    border-radius: 4px; overflow: hidden;
    position: relative;
}
.rw-bar-current {
    height: 100%; border-radius: 4px;
    background: var(--text-muted);
    position: absolute; left: 0; top: 0;
}
.rw-bar-suggested {
    height: 100%; border-radius: 4px;
    background: var(--accent-teal);
    position: absolute; left: 0; top: 0;
    opacity: 0.6;
}
.rw-pct { font-family: var(--font-data); font-size: 0.75rem; width: 42px; text-align: right; }
.rw-delta { font-family: var(--font-data); font-size: 0.75rem; font-weight: 600; }
.rw-delta.increase { color: var(--signal-green); }
.rw-delta.reduce { color: var(--signal-red); }
.rw-delta.hold { color: var(--text-muted); }
.rw-action { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }
.rw-action.increase { color: var(--signal-green); }
.rw-action.reduce { color: var(--signal-red); }
.rw-action.hold { color: var(--text-muted); }
.port-reweight-disclaimer {
    font-size: 0.72rem;
    color: var(--text-muted);
    padding: var(--space-md);
    line-height: 1.5;
}

/* Light Theme Overrides */
[data-theme="light"] .port-dna-card,
[data-theme="light"] .port-insight-card,
[data-theme="light"] .change-alert-item,
[data-theme="light"] .change-alerts-empty {
    background: #FFFFFF;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
}

[data-theme="light"] .change-alert-item.critical {
    background: rgba(197, 48, 48, 0.05);
}

[data-theme="light"] .change-alert-item.warning {
    background: rgba(183, 121, 31, 0.05);
}

[data-theme="light"] .change-alert-item.info {
    background: rgba(43, 108, 176, 0.05);
}

[data-theme="light"] .change-alert-icon {
    background: #F7F8FA;
}

[data-theme="light"] .port-dna-bar {
    background: #F0F1F4;
}

@media (max-width: 768px) {
    .port-dna-legend {
        grid-template-columns: repeat(2, 1fr);
    }
    .port-insights-grid {
        grid-template-columns: 1fr;
    }
    .change-alert-item {
        flex-direction: column;
        gap: var(--space-sm);
    }
}

/* ============================================================
   TECHNICAL ANALYSIS  --  Section Styles
   ============================================================ */

/* Container */
.ta-section { margin-top: var(--space-lg); }

/* TA Chart */
.ta-chart-container {
    margin-bottom: var(--space-lg);
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: var(--space-md) var(--space-sm) var(--space-sm);
    overflow: hidden;
}
.ta-chart-title {
    font-family: var(--font-ui);
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-muted);
    margin-bottom: var(--space-sm);
    padding-left: var(--space-xs);
}
.ta-chart-svg {
    width: 100%;
    height: auto;
    display: block;
}
.ta-chart-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: var(--space-sm); padding: 0 var(--space-xs);
}
.ta-chart-live-badge {
    font-family: var(--font-data); font-size: 0.55rem; font-weight: 700;
    letter-spacing: 0.08em; color: #0B1220; background: var(--signal-green);
    padding: 2px 8px; border-radius: 3px; animation: livePulse 2s ease-in-out infinite;
}
.ta-chart-static-badge {
    font-family: var(--font-data); font-size: 0.55rem; font-weight: 700;
    letter-spacing: 0.08em; color: var(--text-muted); background: var(--bg-elevated);
    padding: 2px 8px; border-radius: 3px; border: 1px solid var(--border);
}
@keyframes livePulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}
.ta-chart-loading {
    display: flex; align-items: center; justify-content: center;
    height: auto; color: var(--text-muted); font-family: var(--font-ui);
    font-size: 0.75rem; gap: var(--space-sm); background: rgba(11,18,32,0.75);
}
[data-theme="light"] .ta-chart-loading { background: rgba(245,246,248,0.75); }
.ta-chart-loading .spinner {
    width: 18px; height: 18px; border: 2px solid var(--border);
    border-top-color: var(--accent-teal); border-radius: 50%;
    animation: spin 0.8s linear infinite;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}
.rh-live-indicator {
    display: inline-flex; align-items: center; gap: 4px;
    font-family: var(--font-data); font-size: 0.55rem; font-weight: 600;
    letter-spacing: 0.06em; color: var(--text-muted); margin-left: var(--space-sm);
}
.rh-live-indicator .live-dot {
    width: 6px; height: 6px; border-radius: 50%; background: var(--signal-green);
    animation: livePulse 2s ease-in-out infinite;
}
.rh-price-change { font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; font-family: var(--font-data); }
.rh-price-change.positive { color: var(--signal-green); }
.rh-price-change.negative { color: var(--signal-red); }

/* Dynamic adjustment indicators */
.dynamic-adj { font-size: 0.75em; color: var(--text-muted); font-style: italic; }
.dynamic-badge {
    display: inline-flex; align-items: center; gap: 4px;
    font-family: var(--font-data); font-size: 0.55rem; font-weight: 600;
    letter-spacing: 0.06em; color: var(--accent-teal); margin-left: var(--space-sm);
    background: rgba(26, 158, 143, 0.1); padding: 2px 8px; border-radius: 3px;
}
.dynamic-badge .dynamic-dot {
    width: 5px; height: 5px; border-radius: 50%; background: var(--accent-teal);
}

/* Regime / Clarity / Key Level badges at top */
.ta-regime-bar {
    display: flex; gap: var(--space-md); flex-wrap: wrap;
    padding: var(--space-md) 0; margin-bottom: var(--space-md);
    border-bottom: 1px solid var(--border);
}
.ta-regime-item {
    display: flex; flex-direction: column; gap: 2px;
}
.ta-regime-label {
    font-size: 0.55rem; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.08em; color: var(--text-muted);
}
.ta-regime-value {
    font-family: var(--font-data); font-size: 0.88rem; font-weight: 600;
    color: var(--text-primary);
}
.ta-regime-value.ta-down { color: var(--signal-red); }
.ta-regime-value.ta-up { color: var(--signal-green); }
.ta-regime-value.ta-neutral { color: var(--signal-amber); }

/* Moving Average table */
.ta-ma-table {
    width: 100%; border-collapse: collapse; font-size: 0.75rem;
    margin-bottom: var(--space-md);
}
.ta-ma-table th {
    text-align: left; font-size: 0.6rem; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.06em;
    color: var(--text-muted); padding: 8px 12px;
    border-bottom: 2px solid var(--border);
}
.ta-ma-table td {
    padding: 8px 12px; border-bottom: 1px solid var(--border);
    font-family: var(--font-data); font-size: 0.78rem;
    color: var(--text-secondary);
}
.ta-ma-table tr:last-child td { border-bottom: none; }
.ta-ma-table .ta-label-cell { font-family: var(--font-ui); font-weight: 600; color: var(--text-primary); }

/* Inflection points timeline */
.ta-inflection-table {
    width: 100%; border-collapse: collapse; font-size: 0.75rem;
    margin-bottom: var(--space-md);
}
.ta-inflection-table th {
    text-align: left; font-size: 0.6rem; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.06em;
    color: var(--text-muted); padding: 8px 12px;
    border-bottom: 2px solid var(--border);
}
.ta-inflection-table td {
    padding: 8px 12px; border-bottom: 1px solid var(--border);
    font-size: 0.75rem; color: var(--text-secondary);
}
.ta-inflection-table tr:last-child td { border-bottom: none; }
.ta-inflection-table .ta-date-cell { font-family: var(--font-data); font-weight: 500; white-space: nowrap; color: var(--text-primary); }
.ta-inflection-table .ta-price-cell { font-family: var(--font-data); font-weight: 600; }
.ta-inflection-table .ta-event-cell { font-family: var(--font-ui); color: var(--text-secondary); }

/* Volume & Volatility metrics grid */
.ta-metrics-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md);
    margin-bottom: var(--space-md);
}
.ta-metric-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 4px; padding: var(--space-md);
}
.ta-metric-card-title {
    font-size: 0.6rem; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.08em; color: var(--accent-teal); margin-bottom: var(--space-sm);
}
.ta-metric-row {
    display: flex; justify-content: space-between; align-items: baseline;
    padding: 4px 0; border-bottom: 1px solid var(--border);
}
.ta-metric-row:last-child { border-bottom: none; }
.ta-metric-name { font-size: 0.72rem; color: var(--text-secondary); }
.ta-metric-val {
    font-family: var(--font-data); font-size: 0.78rem; font-weight: 600;
    color: var(--text-primary);
}
.ta-metric-val.ta-neg { color: var(--signal-red); }
.ta-metric-val.ta-pos { color: var(--signal-green); }

/* Mean Reversion positioning bar */
.ta-mr-container {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 4px; padding: var(--space-md); margin-bottom: var(--space-md);
}
.ta-mr-title {
    font-size: 0.6rem; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.08em; color: var(--accent-teal); margin-bottom: var(--space-sm);
}
.ta-mr-bar-track {
    height: 24px; background: var(--bg-surface); border-radius: 3px;
    position: relative; margin-bottom: var(--space-sm); overflow: visible;
}
.ta-mr-marker {
    position: absolute; top: -2px; width: 4px; height: 28px;
    background: var(--signal-red); border-radius: 2px;
    transform: translateX(-50%);
}
.ta-mr-ma50-marker, .ta-mr-ma200-marker {
    position: absolute; top: 0; width: 2px; height: 24px;
    opacity: 0.6; transform: translateX(-50%);
}
.ta-mr-ma50-marker { background: var(--signal-amber); }
.ta-mr-ma200-marker { background: var(--signal-blue); }
.ta-mr-bar-labels {
    display: flex; justify-content: space-between;
    font-family: var(--font-data); font-size: 0.6rem; color: var(--text-muted);
}
.ta-mr-legend {
    display: flex; gap: var(--space-md); margin-top: var(--space-sm); flex-wrap: wrap;
}
.ta-mr-legend-item {
    display: flex; align-items: center; gap: 4px;
    font-size: 0.6rem; color: var(--text-muted);
}
.ta-mr-legend-dot {
    width: 8px; height: 3px; border-radius: 1px;
}

/* Relative performance */
.ta-rel-table {
    width: 100%; border-collapse: collapse; font-size: 0.75rem;
}
.ta-rel-table th {
    text-align: left; font-size: 0.6rem; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.06em;
    color: var(--text-muted); padding: 8px 12px;
    border-bottom: 2px solid var(--border);
}
.ta-rel-table td {
    padding: 8px 12px; border-bottom: 1px solid var(--border);
    font-family: var(--font-data); font-size: 0.78rem;
    color: var(--text-secondary);
}
.ta-rel-table tr:last-child td { border-bottom: none; }

/* TA Crossover callout */
.ta-crossover-callout {
    background: rgba(212,85,85,0.06); border: 1px solid rgba(212,85,85,0.15);
    border-radius: 4px; padding: 10px 14px; margin-bottom: var(--space-md);
    display: flex; gap: var(--space-sm); align-items: baseline;
}
.ta-crossover-label {
    font-family: var(--font-data); font-size: 0.65rem; font-weight: 700;
    color: var(--signal-red); white-space: nowrap;
}
.ta-crossover-text { font-size: 0.72rem; color: var(--text-secondary); }

/* ============================================================
   RESPONSIVE
   ============================================================ */
@media (max-width: 1024px) {
    .rh-main { flex-direction: column; align-items: flex-start; }
    .rh-right { text-align: left; }
    .rh-metrics { justify-content: flex-start; }
    .verdict-inner { flex-direction: column; }
    .verdict-scores { justify-content: flex-start; }
    .tw-conditions { grid-template-columns: 1fr; }
    .ta-metrics-grid { grid-template-columns: 1fr; }
}
@media (max-width: 768px) {
    :root { --space-lg: 16px; --space-xl: 24px; --space-2xl: 32px; --space-3xl: 48px; }
    .hero-title { font-size: 1.8rem; }
    .featured-grid { grid-template-columns: 1fr; }
    .nav-links { gap: var(--space-md); }
    .fc-metrics { flex-wrap: wrap; gap: var(--space-sm); }
    .rh-ticker { font-size: 1.6rem; }
    .rh-price { font-size: 1.4rem; }
    .footer-top { flex-direction: column; }
    .footer-links { flex-direction: column; gap: var(--space-lg); }
    .portfolio-table { display: block; overflow-x: auto; white-space: nowrap; }
    .portfolio-summary-bar { gap: var(--space-sm); }
    .portfolio-summary-item { min-width: 100px; }
}
@media (max-width: 480px) {
    .nav-links a { font-size: 0.65rem; }
    .hero-title { font-size: 1.4rem; }
    .hero-subtitle { font-size: 0.88rem; }
    .coverage-table { font-size: 0.72rem; }
    .coverage-table thead th { padding: 6px 8px; }
    .coverage-table tbody td { padding: 8px; }
}

/* ============================================================
   PAGE-SCOPED OVERRIDES
   Use these selectors when you need to style a shared class
   (.hero, .site-footer, .section-header, .skew-badge, etc.)
   differently on ONE page without affecting others.

   RULE: When editing shared classes, always scope with the
   page ID. Never edit the base shared class directly unless
   you intend to change ALL pages.

   Example:
     #page-home .hero-title { font-size: 2.8rem; }  <-- SAFE
     .hero-title { font-size: 2.8rem; }              <-- DANGEROUS
   ============================================================ */

/* --- Home Page Scoped Overrides --- */
/* Uncomment and customise any of these to change ONLY the home page */
/* #page-home .hero { } */
/* #page-home .hero-title { } */
/* #page-home .hero-subtitle { } */
/* #page-home .hero-tagline { } */
/* #page-home .hero-cred { } */
/* #page-home .site-footer { } */
/* #page-home .footer-top { } */
/* #page-home .footer-bottom { } */
/* #page-home .section-header { } */
/* #page-home .section-title { } */
/* #page-home .skew-badge { } */
/* #page-home .skew-bar-track { } */
/* #page-home .skew-bar-bull { } */
/* #page-home .skew-bar-bear { } */
/* #page-home .skew-score { } */

/* --- Snapshots Page Scoped Overrides --- */
/* #page-snapshots .hero { } */
/* #page-snapshots .hero-title { } */
/* #page-snapshots .hero-subtitle { } */
/* #page-snapshots .site-footer { } */

/* --- Portfolio Page Scoped Overrides --- */
/* #page-portfolio .hero { } */
/* #page-portfolio .hero-title { } */
/* #page-portfolio .hero-subtitle { } */

/* --- About Page Scoped Overrides --- */
/* #page-about .hero-tagline { } */
/* #page-about .site-footer { } */

/* ============================================================
   SNAPSHOT  --  Design System (adapted for site integration)
   ============================================================ */

/* --- Snapshot Grid (listing page) --- */
.snapshot-grid,
#snapshot-grid {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 20px !important;
    width: 100% !important;
    padding: 20px 0 !important;
}

/* Snapshot container is a wrapper  --  grid is on .snap-grid child */
#snapshot-container {
    width: 100%;
    padding: 20px 0;
}

@media (max-width: 1024px) {
    .snapshot-grid,
    #snapshot-grid {
        grid-template-columns: repeat(2, 1fr) !important;
    }
}

@media (max-width: 600px) {
    .snapshot-grid,
    #snapshot-grid {
        grid-template-columns: 1fr !important;
    }
}

.snapshot-card,
[class*="snapshot-card"] {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px;
    padding: var(--space-lg); cursor: pointer; transition: border-color 0.2s, transform 0.15s;
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
}
.snapshot-card:hover { border-color: var(--accent-teal); transform: translateY(-2px); }
.snapshot-card .sc-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-sm); }
.snapshot-card .sc-ticker { font-size: 1.1rem; font-weight: 800; letter-spacing: -0.02em; }
.snapshot-card .sc-company { font-size: 0.78rem; color: var(--text-secondary); margin-bottom: var(--space-xs); }
.snapshot-card .sc-sector { font-size: 0.65rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--accent-teal); background: rgba(26,158,143,0.15); padding: 3px 8px; border-radius: 3px; display: inline-block; margin-bottom: var(--space-sm); }
.snapshot-card .sc-price { font-family: var(--font-data); font-size: 1.2rem; font-weight: 700; }
.snapshot-card .sc-price-currency { font-size: 0.75rem; color: var(--text-muted); }
.snapshot-card .sc-meta { display: flex; gap: var(--space-md); margin-top: var(--space-sm); flex-wrap: wrap; }
.snapshot-card .sc-meta-item { font-size: 0.68rem; color: var(--text-muted); }
.snapshot-card .sc-meta-value { font-family: var(--font-data); font-weight: 600; color: var(--text-secondary); }
.snapshot-card .sc-skew { margin-top: var(--space-md); padding-top: var(--space-sm); border-top: 1px solid var(--border); display: flex; align-items: center; gap: var(--space-sm); }
.snapshot-card .sc-skew-rationale { font-size: 0.7rem; color: var(--text-secondary); line-height: 1.4; }

/* --- Snapshot Report Page --- */
.snap-page { max-width: 1240px; margin: 0 auto; padding: var(--space-md); }
.snap-back { font-size: 0.78rem; color: var(--accent-teal); cursor: pointer; display: inline-block; margin-bottom: var(--space-md); }
.snap-back:hover { color: var(--text-primary); }

.snap-header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 10px; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
.snap-header-left { display: flex; align-items: baseline; gap: 14px; flex-wrap: wrap; }
.snap-ticker { font-size: 1.6rem; font-weight: 800; letter-spacing: -0.02em; }
.snap-company-name { font-size: 0.85rem; color: var(--text-secondary); }
.snap-sector-tag { font-size: 0.65rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--accent-teal); background: rgba(26,158,143,0.15); padding: 3px 8px; border-radius: 3px; }
.snap-header-right { display: flex; align-items: center; gap: 20px; }
.snap-logo-mark { font-size: 0.7rem; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-muted); }
.snap-logo-mark .brand-green { color: #3DAA6D; }
.snap-report-date { font-family: var(--font-data); font-size: 0.65rem; color: var(--text-muted); }

.snap-price-bar { display: flex; align-items: baseline; gap: 24px; padding: 8px 0 10px; border-bottom: 1px solid var(--border); margin-bottom: 10px; flex-wrap: wrap; }
.snap-price-main { font-family: var(--font-data); font-size: 1.8rem; font-weight: 700; }
.snap-price-currency { font-size: 0.8rem; color: var(--text-muted); font-weight: 400; }
.snap-price-meta { display: flex; gap: 20px; flex-wrap: wrap; }
.snap-pm-item { display: flex; flex-direction: column; gap: 1px; }
.snap-pm-label { font-size: 0.55rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); }
.snap-pm-value { font-family: var(--font-data); font-size: 0.8rem; font-weight: 500; color: var(--text-secondary); }
.snap-pm-value.premium { color: var(--accent-gold); }
.snap-pm-value.negative { color: var(--signal-red); }
.snap-pm-value.positive { color: var(--signal-green); }

.snap-risk-skew-bar { display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--border); margin-bottom: 10px; flex-wrap: wrap; }
.snap-risk-skew-label { font-size: 0.55rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); }
.snap-risk-skew-badge { font-family: var(--font-data); font-size: 0.85rem; font-weight: 800; letter-spacing: 0.04em; padding: 4px 14px; border-radius: 3px; }
.snap-risk-skew-badge.downside { background: rgba(212,85,85,0.12); color: var(--signal-red); border: 1px solid rgba(212,85,85,0.3); }
.snap-risk-skew-badge.upside { background: rgba(61,170,109,0.12); color: var(--signal-green); border: 1px solid rgba(61,170,109,0.3); }
.snap-risk-skew-badge.balanced { background: rgba(212,160,60,0.12); color: var(--signal-amber); border: 1px solid rgba(212,160,60,0.3); }
.snap-risk-skew-rationale { font-size: 0.65rem; color: var(--text-secondary); line-height: 1.4; flex: 1; min-width: 200px; }

.snap-main-grid { display: grid; grid-template-columns: 280px 1fr 280px; gap: 10px; }
.snap-col { display: flex; flex-direction: column; gap: 8px; }
.snap-section-label { font-size: 0.55rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent-teal); margin-bottom: 4px; }

/* Narrative box */
.snap-narrative-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 10px; }
.snap-narrative-text { font-size: 0.75rem; line-height: 1.55; color: var(--text-secondary); }
.snap-narrative-text strong { color: var(--text-primary); font-weight: 600; }
.snap-narrative-verdict { margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 0.7rem; font-weight: 600; color: var(--signal-amber); line-height: 1.5; }

/* Hypothesis cards */
.snap-hyp-stack { display: flex; flex-direction: column; gap: 4px; }
.snap-hyp-card { background: var(--bg-card); border: 1px solid var(--border); border-left: 3px solid var(--border); border-radius: 4px; padding: 8px 10px; display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; }
.snap-hyp-card.snap-upside { border-left-color: var(--signal-green); }
.snap-hyp-card.snap-downside { border-left-color: var(--signal-red); }
.snap-hyp-card.snap-neutral { border-left-color: var(--signal-amber); }
.snap-hyp-info { flex: 1; }
.snap-hyp-label { font-size: 0.6rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 2px; }
.snap-hyp-desc { font-size: 0.6rem; color: var(--text-muted); line-height: 1.35; }
.snap-hyp-score-container { display: flex; flex-direction: column; align-items: center; gap: 2px; min-width: 42px; }
.snap-hyp-score { font-family: var(--font-data); font-size: 1rem; font-weight: 700; }
.snap-hyp-score.high { color: var(--signal-red); }
.snap-hyp-score.medium { color: var(--signal-amber); }
.snap-hyp-score.low { color: var(--text-muted); }
.snap-hyp-score.priced { color: var(--signal-green); }
.snap-hyp-direction { font-size: 0.55rem; font-weight: 600; }
.snap-hyp-direction.up { color: var(--signal-red); }
.snap-hyp-direction.down { color: var(--signal-green); }
.snap-hyp-direction.flat { color: var(--text-muted); }
.snap-hyp-status-tag { font-size: 0.5rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; padding: 1px 5px; border-radius: 2px; }
.snap-tag-priced { background: rgba(61,170,109,0.15); color: var(--signal-green); }
.snap-tag-accumulating { background: rgba(212,85,85,0.12); color: var(--signal-red); }
.snap-tag-tail { background: rgba(212,160,60,0.12); color: var(--signal-amber); }
.snap-tag-minimal { background: rgba(86,104,130,0.2); color: var(--text-muted); }

/* Survival bar */
.snap-survival-bar-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 8px 10px; }
.snap-survival-bar-label { font-size: 0.5rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 6px; }
.snap-survival-bar { display: flex; height: 20px; border-radius: 3px; overflow: hidden; gap: 2px; }
.snap-sb-segment { display: flex; align-items: center; justify-content: center; font-family: var(--font-data); font-size: 0.55rem; font-weight: 700; color: var(--text-primary); }
.snap-sb-upside { background: var(--signal-green); }
.snap-sb-downside { background: var(--signal-red); }
.snap-sb-neutral { background: var(--signal-amber); }
.snap-survival-legend { display: flex; justify-content: space-between; margin-top: 4px; flex-wrap: wrap; gap: 2px; }
.snap-sl-item { display: flex; align-items: center; gap: 4px; font-size: 0.48rem; color: var(--text-muted); }
.snap-sl-dot { width: 6px; height: 6px; border-radius: 1px; }

/* Evidence matrix */
.snap-evidence-matrix { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; overflow: hidden; }
.snap-ev-matrix-header { display: grid; grid-template-columns: 120px repeat(4, 1fr); background: var(--bg-surface); border-bottom: 1px solid var(--border); }
.snap-ev-matrix-header .snap-ev-cell { font-size: 0.48rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); padding: 5px; text-align: center; }
.snap-ev-matrix-header .snap-ev-cell:first-child { text-align: left; }
.snap-ev-matrix-row { display: grid; grid-template-columns: 120px repeat(4, 1fr); border-bottom: 1px solid var(--border); }
.snap-ev-matrix-row:last-child { border-bottom: none; }
.snap-ev-cell { padding: 4px 5px; font-size: 0.6rem; display: flex; align-items: center; }
.snap-ev-domain { font-weight: 600; color: var(--text-secondary); gap: 4px; }
.snap-ev-epistemic { font-size: 0.42rem; font-weight: 500; color: var(--text-muted); font-style: italic; }
.snap-ev-signal { justify-content: center; font-size: 0.8rem; }
.snap-signal-strong-support { color: var(--signal-green); }
.snap-signal-support { color: rgba(61,170,109,0.55); }
.snap-signal-contradict { color: var(--signal-red); }
.snap-signal-neutral { color: var(--text-muted); }

/* Discriminating evidence */
.snap-discrim-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 10px; flex: 1; }
.snap-discrim-item { display: flex; gap: 8px; align-items: flex-start; padding: 4px 0; border-bottom: 1px solid var(--border); }
.snap-discrim-item:last-child { border-bottom: none; }
.snap-discrim-tag { font-family: var(--font-data); font-size: 0.5rem; font-weight: 700; padding: 2px 5px; border-radius: 2px; white-space: nowrap; margin-top: 1px; }
.snap-discrim-tag.high { background: rgba(212,85,85,0.12); color: var(--signal-red); }
.snap-discrim-tag.medium { background: rgba(212,160,60,0.12); color: var(--signal-amber); }
.snap-discrim-text { font-size: 0.6rem; color: var(--text-secondary); line-height: 1.4; }
.snap-discrim-text strong { color: var(--text-primary); font-weight: 600; }
.snap-non-discrim { margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border); }
.snap-non-discrim-label { font-size: 0.5rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); margin-bottom: 3px; }
.snap-non-discrim-items { display: flex; flex-wrap: wrap; gap: 4px; }
.snap-nd-chip { font-size: 0.5rem; color: var(--text-muted); background: var(--bg-surface); padding: 2px 6px; border-radius: 2px; text-decoration: line-through; text-decoration-color: rgba(86,104,130,0.4); }

/* Tripwires */
.snap-tripwire-list { display: flex; flex-direction: column; gap: 4px; }
.snap-tripwire-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 8px 10px; }
.snap-tw-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.snap-tw-date { font-family: var(--font-data); font-size: 0.6rem; font-weight: 600; color: var(--accent-gold); }
.snap-tw-test-name { font-size: 0.53rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.04em; }
.snap-tw-conditions { display: flex; flex-direction: column; gap: 3px; }
.snap-tw-if { font-size: 0.58rem; color: var(--text-secondary); line-height: 1.35; display: flex; gap: 4px; }
.snap-tw-if-icon { font-family: var(--font-data); font-weight: 700; flex-shrink: 0; width: 10px; }
.snap-tw-if-icon.up { color: var(--signal-green); }
.snap-tw-if-icon.down { color: var(--signal-red); }

/* Gaps & Coverage */
.snap-gaps-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 10px; }
.snap-gap-row { display: flex; justify-content: space-between; align-items: center; padding: 3px 0; border-bottom: 1px solid var(--border); }
.snap-gap-row:last-child { border-bottom: none; }
.snap-gap-domain { font-size: 0.58rem; font-weight: 500; color: var(--text-secondary); }
.snap-gap-status { font-size: 0.5rem; font-weight: 600; padding: 1px 5px; border-radius: 2px; }
.snap-gap-full { background: rgba(61,170,109,0.12); color: var(--signal-green); }
.snap-gap-partial { background: rgba(212,160,60,0.12); color: var(--signal-amber); }
.snap-gap-limited { background: rgba(86,104,130,0.2); color: var(--text-muted); }

/* Unanswered questions */
.snap-questions-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 10px; }
.snap-question-item { font-size: 0.58rem; color: var(--text-secondary); line-height: 1.4; padding: 3px 0 3px 10px; position: relative; }
.snap-question-item::before { content: '?'; position: absolute; left: 0; font-family: var(--font-data); font-weight: 700; color: var(--accent-teal); font-size: 0.58rem; }

/* Snapshot footer */
.snap-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 6px; border-top: 1px solid var(--border); margin-top: 10px; flex-wrap: wrap; gap: 8px; }
.snap-footer-left { font-size: 0.48rem; color: var(--text-muted); font-style: italic; max-width: 60%; line-height: 1.4; }
.snap-footer-right { display: flex; gap: 16px; }
.snap-footer-meta { font-family: var(--font-data); font-size: 0.48rem; color: var(--text-muted); }

/* Link to full report */
.snap-view-full { display: inline-block; margin-top: var(--space-sm); font-size: 0.65rem; font-weight: 600; color: var(--accent-teal); cursor: pointer; }
.snap-view-full:hover { color: var(--text-primary); }

/* Responsive adjustments */
@media (max-width: 1280px) {
    .snap-main-grid { grid-template-columns: 260px 1fr 260px; }
}
@media (max-width: 960px) {
    .snap-main-grid { grid-template-columns: 1fr; }
    .snap-page { padding: var(--space-sm); }
    .snap-price-bar { gap: 12px; }
}

/* ============================================================
   MARKET STATUS BAR & LIVE PRICE FEED
   ============================================================ */
.market-status-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    margin-bottom: var(--space-md);
    font-family: var(--font-data);
    font-size: 0.65rem;
    color: var(--text-muted);
    gap: var(--space-sm);
    flex-wrap: wrap;
}
.market-status-bar .msb-left {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}
.market-status-bar .msb-right {
    display: flex;
    align-items: center;
    gap: var(--space-md);
}
.msb-dot {
    width: 7px; height: 7px; border-radius: 50%;
    display: inline-block;
    flex-shrink: 0;
}
.msb-dot.open { background: var(--signal-green); animation: livePulse 2s ease-in-out infinite; }
.msb-dot.pre-open, .msb-dot.pre-market { background: var(--signal-amber); animation: livePulse 2s ease-in-out infinite; }
.msb-dot.auction { background: var(--signal-amber); }
.msb-dot.closed { background: var(--text-muted); opacity: 0.5; }
.msb-label { font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; }
.msb-label.open { color: var(--signal-green); }
.msb-label.pre-open, .msb-label.pre-market { color: var(--signal-amber); }
.msb-label.auction { color: var(--signal-amber); }
.msb-label.closed { color: var(--text-muted); }
.msb-updated { color: var(--text-muted); opacity: 0.8; }
.msb-refresh-btn {
    background: none; border: 1px solid var(--border); color: var(--text-muted);
    padding: 2px 8px; border-radius: 3px; cursor: pointer;
    font-family: var(--font-data); font-size: 0.6rem; font-weight: 600;
    letter-spacing: 0.04em; transition: all 0.15s ease;
}
.msb-refresh-btn:hover { border-color: var(--accent-teal); color: var(--accent-teal); }
.msb-refresh-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.msb-refresh-btn.spinning { animation: spin 0.8s linear infinite; }

/* Featured card live price enhancements */
.fc-price .fc-live-dot {
    display: inline-block;
    width: 5px; height: 5px; border-radius: 50%;
    background: var(--signal-green);
    margin-left: 4px; vertical-align: middle;
    animation: livePulse 2s ease-in-out infinite;
}
.fc-price-change {
    font-family: var(--font-data);
    font-size: 0.55rem;
    font-weight: 600;
    margin-top: 1px;
    text-align: right;
}
.fc-price-change.positive { color: var(--signal-green); }
.fc-price-change.negative { color: var(--signal-red); }

/* Price flash animation */
@keyframes priceFlashGreen {
    0% { background-color: transparent; }
    15% { background-color: rgba(61, 170, 109, 0.15); }
    100% { background-color: transparent; }
}
@keyframes priceFlashRed {
    0% { background-color: transparent; }
    15% { background-color: rgba(212, 85, 85, 0.15); }
    100% { background-color: transparent; }
}
.fc-price.flash-green { animation: priceFlashGreen 1.2s ease-out; }
.fc-price.flash-red { animation: priceFlashRed 1.2s ease-out; }

/* Price ticker strip (scrolling prices below nav) */
.price-ticker-strip {
    display: flex;
    align-items: center;
    gap: 0;
    overflow: hidden;
    background: var(--bg-primary);
    border-bottom: 1px solid var(--border);
    padding: 4px 0;
    font-family: var(--font-data);
    font-size: 0.6rem;
    white-space: nowrap;
    position: relative;
}
.price-ticker-inner {
    display: flex;
    gap: 0;
    animation: tickerScroll 40s linear infinite;
    will-change: transform;
}
.price-ticker-inner:hover { animation-play-state: paused; }
@keyframes tickerScroll {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
}
.pt-item {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 0 16px;
    border-right: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.15s;
}
.pt-item:hover { background: var(--surface); }
.pt-ticker { font-weight: 700; color: var(--text-primary); }
.pt-price { color: var(--text-secondary); }
.pt-change { font-weight: 600; }
.pt-change.positive { color: var(--signal-green); }
.pt-change.negative { color: var(--signal-red); }

/* Announcements panel */
.announcements-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: var(--space-md);
    margin-bottom: var(--space-lg);
}
.ann-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-sm);
}
.ann-title {
    font-family: var(--font-data);
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-secondary);
}
.ann-list { list-style: none; padding: 0; margin: 0; }
.ann-item {
    display: flex;
    align-items: flex-start;
    gap: var(--space-sm);
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 0.7rem;
}
.ann-item:last-child { border-bottom: none; }
.ann-ticker {
    font-family: var(--font-data);
    font-weight: 700;
    color: var(--accent-teal);
    min-width: 32px;
    flex-shrink: 0;
}
.ann-headline { color: var(--text-primary); flex: 1; line-height: 1.4; }
.ann-time {
    font-family: var(--font-data);
    font-size: 0.6rem;
    color: var(--text-muted);
    white-space: nowrap;
    flex-shrink: 0;
}
.ann-type {
    font-family: var(--font-data);
    font-size: 0.5rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    padding: 1px 5px;
    border-radius: 2px;
    background: rgba(26, 158, 143, 0.1);
    color: var(--accent-teal);
    white-space: nowrap;
    flex-shrink: 0;
}
.ann-empty {
    text-align: center;
    color: var(--text-muted);
    font-size: 0.7rem;
    padding: var(--space-md);
    font-style: italic;
}

/* ============================================================
   RESEARCH CHAT WIDGET
   ============================================================ */

/* --- FAB (Floating Action Button) --- */
.chat-fab {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 200;
    height: 44px;
    padding: 0 20px 0 16px;
    border-radius: 999px;
    background: var(--accent-teal);
    color: #fff;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.35);
    transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
    font-family: var(--font-ui, system-ui, -apple-system, sans-serif);
    font-size: 0.9rem;
    font-weight: 600;
    letter-spacing: 0.01em;
    white-space: nowrap;
}
.chat-fab:hover {
    transform: scale(1.04);
    box-shadow: 0 6px 28px rgba(0,0,0,0.45);
}
.chat-fab svg { width: 18px; height: 18px; flex-shrink: 0; }
.chat-fab.hidden { display: none; }

/* --- Chat Panel --- */
.chat-panel {
    position: fixed;
    bottom: 0;
    right: 24px;
    z-index: 210;
    width: 420px;
    max-height: 600px;
    display: flex;
    flex-direction: column;
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-bottom: none;
    border-radius: 12px 12px 0 0;
    box-shadow: 0 -4px 40px rgba(0,0,0,0.4);
    transform: translateY(100%);
    transition: transform 0.3s ease;
}
.chat-panel.open {
    transform: translateY(0);
}

/* --- Chat Header --- */
.chat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    background: var(--bg-elevated);
    border-radius: 12px 12px 0 0;
    flex-shrink: 0;
}
.chat-header-left {
    display: flex;
    align-items: center;
    gap: 10px;
}
.chat-header-icon {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    background: var(--accent-teal);
    display: flex;
    align-items: center;
    justify-content: center;
}
.chat-header-icon svg { width: 16px; height: 16px; color: #fff; }
.chat-header-title {
    font-size: 0.78rem;
    font-weight: 700;
    letter-spacing: 0.03em;
    color: var(--text-primary);
}
.chat-header-subtitle {
    font-size: 0.65rem;
    color: var(--text-muted);
    margin-top: 1px;
}
.chat-close-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: color 0.2s, background 0.2s;
    display: flex;
    align-items: center;
}
.chat-close-btn:hover {
    color: var(--text-primary);
    background: rgba(255,255,255,0.06);
}
.chat-close-btn svg { width: 18px; height: 18px; }

/* --- Ticker Selector --- */
.chat-ticker-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    background: var(--bg-surface-alt);
    flex-shrink: 0;
}
.chat-ticker-label {
    font-size: 0.68rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    white-space: nowrap;
}
.chat-ticker-select {
    font-family: var(--font-data);
    font-size: 0.78rem;
    font-weight: 600;
    color: var(--text-primary);
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 4px 8px;
    cursor: pointer;
}
.chat-ticker-select:focus {
    outline: 3px solid var(--accent-teal);
    outline-offset: -1px;
    border-color: var(--accent-teal);
}

/* --- Messages Area --- */
.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    min-height: 0;
}
.chat-messages::-webkit-scrollbar { width: 5px; }
.chat-messages::-webkit-scrollbar-track { background: transparent; }
.chat-messages::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 3px; }

/* --- Welcome State --- */
.chat-welcome {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 32px 16px;
    text-align: center;
    flex: 1;
}
.chat-welcome-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: rgba(26,158,143,0.12);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 16px;
}
.chat-welcome-icon svg { width: 24px; height: 24px; color: var(--accent-teal); }
.chat-welcome-title {
    font-size: 0.88rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 6px;
}
.chat-welcome-text {
    font-size: 0.78rem;
    color: var(--text-muted);
    line-height: 1.5;
    max-width: 280px;
}
.chat-suggestions {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-top: 16px;
    width: 100%;
    max-width: 320px;
}
.chat-suggestion-btn {
    font-family: var(--font-ui);
    font-size: 0.72rem;
    color: var(--text-secondary);
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 12px;
    cursor: pointer;
    text-align: left;
    transition: border-color 0.2s, color 0.2s;
}
.chat-suggestion-btn:hover {
    border-color: var(--accent-teal);
    color: var(--text-primary);
}

/* --- Message Bubbles --- */
.chat-msg {
    max-width: 92%;
    font-size: 0.82rem;
    line-height: 1.6;
}
.chat-msg.user {
    align-self: flex-end;
    background: var(--accent-teal);
    color: #fff;
    padding: 10px 14px;
    border-radius: 12px 12px 2px 12px;
}
.chat-msg.assistant {
    align-self: flex-start;
    background: var(--bg-elevated);
    color: var(--text-primary);
    padding: 12px 14px;
    border-radius: 12px 12px 12px 2px;
    border: 1px solid var(--border);
}

/* --- Markdown in assistant messages --- */
.chat-msg.assistant p { margin-bottom: 8px; }
.chat-msg.assistant p:last-child { margin-bottom: 0; }
.chat-msg.assistant strong { color: var(--text-primary); font-weight: 600; }
.chat-msg.assistant ul, .chat-msg.assistant ol { padding-left: 18px; margin-bottom: 8px; }
.chat-msg.assistant li { margin-bottom: 3px; }
.chat-msg.assistant code {
    font-family: var(--font-data);
    font-size: 0.76rem;
    background: rgba(255,255,255,0.06);
    padding: 1px 5px;
    border-radius: 3px;
}
.chat-msg.assistant h3, .chat-msg.assistant h4 {
    font-size: 0.82rem;
    font-weight: 700;
    margin-bottom: 4px;
    margin-top: 8px;
    color: var(--accent-teal);
}
.chat-msg.assistant h3:first-child, .chat-msg.assistant h4:first-child {
    margin-top: 0;
}

/* --- Sources toggle --- */
.chat-sources-toggle {
    font-family: var(--font-ui);
    font-size: 0.68rem;
    font-weight: 600;
    color: var(--accent-teal);
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px 0;
    margin-top: 6px;
    display: flex;
    align-items: center;
    gap: 4px;
}
.chat-sources-toggle:hover { text-decoration: underline; }
.chat-sources-list {
    display: none;
    margin-top: 6px;
    padding-top: 6px;
    border-top: 1px solid var(--border);
}
.chat-sources-list.open { display: block; }
.chat-source-item {
    font-size: 0.68rem;
    color: var(--text-muted);
    margin-bottom: 6px;
    padding-left: 8px;
    border-left: 2px solid var(--border-light);
    line-height: 1.5;
}
.chat-source-item .cs-label {
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.64rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    display: block;
    margin-bottom: 2px;
}

/* --- Typing indicator --- */
.chat-typing {
    align-self: flex-start;
    display: flex;
    gap: 4px;
    padding: 12px 16px;
    background: var(--bg-elevated);
    border-radius: 12px 12px 12px 2px;
    border: 1px solid var(--border);
}
.chat-typing-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--text-muted);
    animation: chatTyping 1.2s infinite;
}
.chat-typing-dot:nth-child(2) { animation-delay: 0.2s; }
.chat-typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes chatTyping {
    0%, 60%, 100% { opacity: 0.3; transform: scale(0.8); }
    30% { opacity: 1; transform: scale(1); }
}

/* --- Error message --- */
.chat-error {
    align-self: flex-start;
    font-size: 0.75rem;
    color: var(--signal-red);
    background: rgba(212,85,85,0.08);
    border: 1px solid rgba(212,85,85,0.2);
    border-radius: 8px;
    padding: 10px 14px;
}

/* --- Input Area --- */
.chat-input-area {
    display: flex;
    align-items: flex-end;
    gap: 8px;
    padding: 12px 16px;
    border-top: 1px solid var(--border);
    background: var(--bg-surface);
    flex-shrink: 0;
}
.chat-input {
    flex: 1;
    font-family: var(--font-ui);
    font-size: 0.82rem;
    color: var(--text-primary);
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
    resize: none;
    max-height: 100px;
    line-height: 1.5;
    transition: border-color 0.2s;
}
.chat-input::placeholder { color: var(--text-muted); }
.chat-input:focus { outline: 3px solid var(--accent-teal); outline-offset: -1px; border-color: var(--accent-teal); }
.chat-send-btn {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: var(--accent-teal);
    color: #fff;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: opacity 0.2s;
}
.chat-send-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}
.chat-send-btn svg { width: 18px; height: 18px; }

/* --- Light Theme Overrides for Chat --- */
[data-theme="light"] .chat-fab {
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}
[data-theme="light"] .chat-panel {
    box-shadow: 0 -4px 40px rgba(0,0,0,0.12);
}
[data-theme="light"] .chat-msg.assistant {
    background: #F7F8FA;
    border-color: #E2E8F0;
}
[data-theme="light"] .chat-msg.assistant code {
    background: rgba(0,0,0,0.04);
}
[data-theme="light"] .chat-input {
    background: #F7F8FA;
}
[data-theme="light"] .chat-suggestion-btn {
    background: #F7F8FA;
}
[data-theme="light"] .chat-welcome-icon {
    background: rgba(14,138,125,0.08);
}
[data-theme="light"] .chat-close-btn:hover {
    background: rgba(0,0,0,0.04);
}
[data-theme="light"] .chat-ticker-bar {
    background: #F0F1F4;
}
[data-theme="light"] .chat-ticker-select {
    background: #FFFFFF;
}

/* --- Chat FAB and panel restored ---  */

/* --- Inline Research Chat (within report sections) --- */
.chat-inline {
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    background: var(--bg-surface);
    margin-top: var(--space-md);
}
.chat-inline-messages {
    max-height: 420px;
    min-height: 120px;
    overflow-y: auto;
    padding: var(--space-md);
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
}
.chat-inline-welcome {
    text-align: center;
    padding: var(--space-xl) var(--space-md);
    color: var(--text-secondary);
    font-size: 0.82rem;
}
.chat-inline-welcome p { margin-bottom: var(--space-md); }
.chat-inline-suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    justify-content: center;
}
.chat-inline-suggestion {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 14px;
    font-size: 0.75rem;
    font-family: var(--font-ui);
    color: var(--text-secondary);
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s;
}
.chat-inline-suggestion:hover {
    border-color: var(--accent-teal);
    color: var(--accent-teal);
}
.chat-inline-input-area {
    display: flex;
    align-items: flex-end;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    border-top: 1px solid var(--border);
    background: var(--bg-surface-alt);
}
.chat-inline-input {
    flex: 1;
    font-family: var(--font-ui);
    font-size: 0.82rem;
    color: var(--text-primary);
    background: var(--bg-page);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px 14px;
    resize: none;
    max-height: 100px;
    line-height: 1.5;
    transition: border-color 0.2s;
}
.chat-inline-input:focus { outline: 3px solid var(--accent-teal); outline-offset: -1px; border-color: var(--accent-teal); }
.chat-inline-input::placeholder { color: var(--text-muted); }
.chat-inline-input:focus { border-color: var(--accent-teal); }
.chat-inline-send {
    width: 36px;
    height: 36px;
    border-radius: 6px;
    background: var(--accent-teal);
    color: #fff;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.chat-inline-send:disabled { opacity: 0.4; cursor: not-allowed; }
.chat-inline-send svg { width: 16px; height: 16px; }

[data-theme="light"] .chat-inline { border-color: #E2E8F0; }
[data-theme="light"] .chat-inline-input { background: #F7F8FA; }
[data-theme="light"] .chat-inline-suggestion { background: #F7F8FA; }

/* ── Integrations Bar (integ- prefix, fully isolated) ── */

.integrations-bar {
  position: fixed;
  top: 56px;
  left: 0;
  right: 0;
  z-index: 99;
  background: rgba(240, 241, 244, 0.97);
  border-bottom: 1.25px solid rgb(226, 232, 240);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  height: 40px;
  display: flex;
  justify-content: center;
}

[data-theme="dark"] .integrations-bar {
  background: rgba(22, 27, 40, 0.97);
  border-bottom-color: rgba(255, 255, 255, 0.06);
}

.integ-bar-inner {
  display: flex;
  align-items: stretch;
  height: 100%;
}

.integ-tab {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 0 16px;
  font-size: 0.68rem;
  font-weight: 500;
  color: rgb(113, 128, 150);
  background: transparent;
  border: none;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  cursor: default;
  font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  white-space: nowrap;
  transition: color 0.2s, background 0.2s;
  opacity: 0.7;
}

.integ-tab:hover {
  background: rgba(0, 0, 0, 0.03);
  opacity: 1;
}

[data-theme="dark"] .integ-tab {
  color: rgba(200, 210, 225, 0.6);
}

[data-theme="dark"] .integ-tab:hover {
  background: rgba(255, 255, 255, 0.04);
}

.integ-tab svg {
  width: 12px;
  height: 12px;
  opacity: 0.6;
  flex-shrink: 0;
}

.integ-soon-badge {
  font-size: 8px;
  font-weight: 700;
  padding: 1px 4px;
  border-radius: 3px;
  background: rgba(180, 130, 50, 0.08);
  color: rgb(201, 169, 110);
  letter-spacing: 0.05em;
  line-height: 1.4;
}

[data-theme="dark"] .integ-soon-badge {
  background: rgba(201, 169, 110, 0.12);
  color: rgba(201, 169, 110, 0.8);
}

.integ-divider {
  width: 1px;
  height: 20px;
  background: rgb(226, 232, 240);
  align-self: center;
}

[data-theme="dark"] .integ-divider {
  background: rgba(255, 255, 255, 0.08);
}

    </style>
</head>
<body>

<!-- Skip to main content link (A2) -->
<a href="#main-content" class="skip-link">Skip to main content</a>

<!-- Live region for dynamic announcements (A9) -->
<div id="a11y-announcer" class="sr-only" aria-live="polite" aria-atomic="true"></div>

<!-- ============================================================
     NAVIGATION
     ============================================================ -->
<nav class="site-nav" id="siteNav" aria-label="Primary navigation">
    <div class="nav-inner">
        <a class="nav-brand" onclick="navigate('home')">
            <div class="nav-brand-text">Contin<span class="brand-green">uu</span>m Inte<span class="brand-green">ll</span>igence</div>
        </a>
        <div class="nav-links">
            <a href="#home" class="active" data-nav="home">Research</a>
            <a href="#snapshots" data-nav="snapshots">Snapshots</a>
            <a href="#portfolio" data-nav="portfolio">Portfolio</a>
            <a href="#thesis" data-nav="thesis">Comparator</a>
            <a href="#personalisation" data-nav="personalisation">Personalisation</a>
            <a href="#about" data-nav="about">About</a>
            <button class="theme-toggle" id="themeToggle" aria-label="Toggle light/dark mode" title="Toggle light/dark mode">
                <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
            </button>
        </div>
    </div>
</nav>

<!-- Integrations Bar (coming soon tabs) -->
<div class="integrations-bar" id="integrationsBar">
  <div class="integ-bar-inner" role="tablist" aria-label="Platform integrations  --  coming soon">

    <!-- Bloomberg -->
    <button class="integ-tab" role="tab" aria-selected="false" data-integ="bloomberg">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <rect x="2" y="3" width="20" height="14" rx="2"></rect>
        <line x1="8" y1="21" x2="16" y2="21"></line>
        <line x1="12" y1="17" x2="12" y2="21"></line>
      </svg>
      Bloomberg
      <span class="integ-soon-badge">SOON</span>
    </button>

    <div class="integ-divider" aria-hidden="true"></div>

    <!-- Risk -->
    <button class="integ-tab" role="tab" aria-selected="false" data-integ="risk">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
      </svg>
      Risk
      <span class="integ-soon-badge">SOON</span>
    </button>

    <div class="integ-divider" aria-hidden="true"></div>

    <!-- Team Chat -->
    <button class="integ-tab" role="tab" aria-selected="false" data-integ="teamchat">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
        <circle cx="9" cy="7" r="4"></circle>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
      </svg>
      Team Chat
      <span class="integ-soon-badge">SOON</span>
    </button>

    <div class="integ-divider" aria-hidden="true"></div>

    <!-- Trading -->
    <button class="integ-tab" role="tab" aria-selected="false" data-integ="trading">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline>
        <polyline points="16 7 22 7 22 13"></polyline>
      </svg>
      Trading
      <span class="integ-soon-badge">SOON</span>
    </button>

    <div class="integ-divider" aria-hidden="true"></div>

    <!-- Analyst Chat -->
    <button class="integ-tab" role="tab" aria-selected="false" data-integ="analystchat">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <polyline points="22 12 18 12 15 3 9 21 6 12 2 12"></polyline>
      </svg>
      Analyst Chat
      <span class="integ-soon-badge">SOON</span>
    </button>

    <div class="integ-divider" aria-hidden="true"></div>

    <!-- News -->
    <button class="integ-tab" role="tab" aria-selected="false" data-integ="news">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"></path>
        <path d="M18 14h-8"></path>
        <path d="M15 18h-5"></path>
        <path d="M10 6h8v4h-8V6Z"></path>
      </svg>
      News
      <span class="integ-soon-badge">SOON</span>
    </button>

  </div>
</div>

<!-- ============================================================
     MAIN CONTENT
     ============================================================ -->
<main id="main-content">

<!-- ============================================================
     PAGE: HOME
     ============================================================ -->
<div class="page active" id="page-home">

    <div class="page-inner">
        <div class="hero">
            <div class="hero-tagline">Independent Cross-Domain Equity Research</div>
            <h1 class="hero-title">We map evidence, not opinions.</h1>
            <p class="hero-subtitle">Systematic analysis across ten evidence domains using the Analysis of Competing Hypotheses framework. Every claim sourced. Every hypothesis tested.</p>
            <p class="hero-cred">Built by former UBS and Goldman Sachs executives.</p>
        </div>

        <!-- Price Ticker Strip -->
        <div class="price-ticker-strip" id="price-ticker-strip" style="display:none"></div>

        <!-- Market Status Bar -->
        <div class="market-status-bar" id="market-status-bar">
            <div class="msb-left">
                <span class="msb-dot closed" id="msb-dot"></span>
                <span class="msb-label closed" id="msb-label">ASX CLOSED</span>
                <span class="msb-updated" id="msb-updated"></span>
            </div>
            <div class="msb-right">
                <span class="msb-updated" id="msb-feed-status">Loading prices...</span>
                <button class="msb-refresh-btn" id="msb-refresh" onclick="MarketFeed.refreshNow()" title="Refresh prices">REFRESH</button>
            </div>
        </div>

        <!-- Announcements Panel -->
        <div class="announcements-panel" id="announcements-panel" style="display:none">
            <div class="ann-header">
                <div class="ann-title">Latest ASX Announcements</div>
                <span class="msb-updated" id="ann-updated"></span>
            </div>
            <ul class="ann-list" id="ann-list">
                <li class="ann-empty">No announcements loaded yet</li>
            </ul>
        </div>

        <!-- Featured Reports -->
        <div class="section-header">
            <div class="section-title">Latest Research</div>
            <div class="home-search">
                <div class="home-search-wrap">
                    <svg class="home-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    <input type="text" class="home-search-input" id="home-stock-search" placeholder="Search stocks…" autocomplete="off" spellcheck="false">
                </div>
                <div class="home-search-results" id="home-search-results"></div>
            </div>
        </div>

        <div class="featured-grid" id="featured-grid"></div>

        <!-- Coverage Universe -->
        <div class="section-header" style="display:flex;align-items:center;justify-content:space-between">
            <div class="section-title">Coverage Universe</div>
            <button class="btn-refresh-all" id="btn-refresh-all" onclick="triggerRefreshAll()">
                &#8635; Refresh All Research
            </button>
        </div>

        <table class="coverage-table" id="coverage-table">
            <thead>
                <tr>
                    <th>ASX</th>
                    <th>Company</th>
                    <th>Sector</th>
                    <th>Price</th>
                    <th class="sortable" onclick="sortCoverageTable()" id="th-skew">Thesis Skew <span class="sort-arrow" id="skew-sort-arrow">&#9650;</span></th>
                    <th>Updated</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="coverage-body"></tbody>
        </table>
    </div>

    <!-- Home Footer -->
    <footer class="site-footer">
        <div class="footer-inner">
            <div class="footer-top">
                <div>
                    <div class="footer-brand-name">Contin<span class="brand-green">uu</span>m Inte<span class="brand-green">ll</span>igence</div>
                    <div class="footer-tagline">Independent cross-domain equity research. Evidence-driven analysis for institutional and sophisticated investors.</div>
                </div>
                <div class="footer-links">
                    <div class="footer-links-col">
                        <h4>Research</h4>
                        <div id="footer-research-links"></div>
                    </div>
                    <div class="footer-links-col">
                        <h4>Company</h4>
                        <a href="#about" onclick="navigate('about')">About &amp; Methodology</a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <div class="footer-disclaimer">This portal does not constitute personal financial advice. All analysis uses publicly available information and the Analysis of Competing Hypotheses (ACH) methodology. No buy, sell, or hold recommendations are made. Readers should consult their own financial advisors.</div>
                <div class="footer-meta">&copy; 2026 Continuum Intelligence</div>
            </div>
        </div>
    </footer>
</div>

<!-- ============================================================
     PAGE: SNAPSHOTS
     ============================================================ -->
<div class="page" id="page-snapshots">
    <div class="page-inner">
        <div class="hero" style="text-align:left; padding-bottom: var(--space-lg);">
            <div class="hero-tagline">Investment Snapshots</div>
            <h1 class="hero-title" style="font-size:1.6rem">One-page evidence summaries</h1>
            <p class="hero-subtitle" style="text-align:left; margin:0; max-width: none;">Each snapshot condenses a full Continuum research report into a single landscape view: hypotheses, evidence matrix, discriminating data, and tripwires at a glance.</p>
        </div>

        <div id="snapshot-container"></div>
    </div>

    <footer class="site-footer">
        <div class="footer-inner">
            <div class="footer-bottom">
                <div class="footer-disclaimer">This portal does not constitute personal financial advice. All analysis uses publicly available information and the ACH methodology.</div>
                <div class="footer-meta">&copy; 2026 Continuum Intelligence</div>
            </div>
        </div>
    </footer>
</div>

<!-- Snapshot Report Pages (dynamically rendered) -->
<div class="page" id="page-snapshot-WOW"></div>
<div class="page" id="page-snapshot-XRO"></div>
<div class="page" id="page-snapshot-WTC"></div>
<div class="page" id="page-snapshot-DRO"></div>
<div class="page" id="page-snapshot-PME"></div>
<div class="page" id="page-snapshot-GYG"></div>
<div class="page" id="page-snapshot-CSL"></div>
<div class="page" id="page-snapshot-MQG"></div>
<div class="page" id="page-snapshot-GMG"></div>
<div class="page" id="page-snapshot-WDS"></div>
<div class="page" id="page-snapshot-SIG"></div>
<div class="page" id="page-snapshot-FMG"></div>

<!-- ============================================================
     PAGE: PORTFOLIO
     ============================================================ -->
<div class="page" id="page-portfolio">
    <div class="page-inner">

        <!-- Portfolio Header -->
        <div class="hero" style="text-align:left; padding-bottom: var(--space-lg);">
            <div class="hero-tagline">Portfolio Intelligence</div>
            <h1 class="hero-title" style="font-size:1.6rem">Position Alignment Analysis</h1>
            <p class="hero-subtitle" style="text-align:left; margin:0; max-width: none;">Upload your portfolio to see how your positions align with Continuum's evidence-based risk skew assessments across the coverage universe.</p>
        </div>

        <!-- Upload Zone -->
        <div class="portfolio-upload-zone" id="uploadZone">
            <div class="upload-icon">&#8593;</div>
            <div class="upload-title">Drag &amp; drop your portfolio file here</div>
            <div class="upload-subtitle">Or click to browse. Accepts Excel (.xlsx, .xls) and CSV files.</div>
            <div class="upload-format">Expected columns: Ticker | Units | Avg Cost</div>
            <label for="fileInput" class="sr-only">Upload portfolio file (Excel or CSV)</label>
            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" aria-label="Upload portfolio file (Excel or CSV)">
        </div>

        <!-- Portfolio Actions (hidden until data loaded) -->
        <div class="portfolio-actions" id="portfolioActions" style="display:none">
            <button class="portfolio-btn" onclick="document.getElementById('fileInput').click()">&#8593; Upload New File</button>
            <button class="portfolio-btn" onclick="clearPortfolio()">&#10005; Clear Portfolio</button>
        </div>

        <!-- Summary Bar (hidden until data loaded) -->
        <div class="portfolio-summary-bar" id="portfolioSummary" style="display:none">
            <div class="portfolio-summary-item">
                <div class="portfolio-summary-label">Total Value</div>
                <div class="portfolio-summary-value" id="summaryValue">--</div>
            </div>
            <div class="portfolio-summary-item">
                <div class="portfolio-summary-label">Unrealised P&amp;L</div>
                <div class="portfolio-summary-value" id="summaryPnL">--</div>
            </div>
            <div class="portfolio-summary-item">
                <div class="portfolio-summary-label">Aligned Exposure</div>
                <div class="portfolio-summary-value positive" id="summaryAligned">--</div>
            </div>
            <div class="portfolio-summary-item">
                <div class="portfolio-summary-label">Contradicting Exposure</div>
                <div class="portfolio-summary-value negative" id="summaryContra">--</div>
            </div>
            <div class="portfolio-summary-item">
                <div class="portfolio-summary-label">Balanced / Neutral</div>
                <div class="portfolio-summary-value" id="summaryNeutral">--</div>
            </div>
        </div>

        <!-- Portfolio Table (hidden until data loaded) -->
        <table class="portfolio-table" id="portfolioTable" style="display:none">
            <thead>
                <tr>
                    <th>Ticker</th>
                    <th>Company</th>
                    <th>Units</th>
                    <th>Avg Cost</th>
                    <th>Current</th>
                    <th>P&amp;L ($)</th>
                    <th>P&amp;L (%)</th>
                    <th>Weight</th>
                    <th>Risk Skew</th>
                    <th>Alignment</th>
                </tr>
            </thead>
            <tbody id="portfolioBody"></tbody>
        </table>

        <!-- PORTFOLIO DIAGNOSTICS (hidden until data loaded) -->
        <div class="port-diag-section" id="portfolioDiagnostics" style="display:none">
            <div class="section-header" style="margin: var(--space-2xl) 0 var(--space-lg);">
                <div class="section-title">Portfolio Diagnostics</div>
                <span class="step-indicator">Hypothesis Concentration Analysis</span>
            </div>

            <!-- Hypothesis DNA Bar -->
            <div class="port-dna-card">
                <div class="port-dna-header">
                    <div class="port-dna-title">Portfolio Hypothesis DNA</div>
                    <div class="port-dna-subtitle">Where your capital is positioned across Continuum's hypotheses</div>
                </div>
                <div class="port-dna-bar" id="portDnaBar">
                    <div class="port-dna-segment n1" id="dnaN1" style="width:0%"><span class="port-dna-label">N1 <span id="pctN1">0%</span></span></div>
                    <div class="port-dna-segment n2" id="dnaN2" style="width:0%"><span class="port-dna-label">N2 <span id="pctN2">0%</span></span></div>
                    <div class="port-dna-segment n3" id="dnaN3" style="width:0%"><span class="port-dna-label">N3 <span id="pctN3">0%</span></span></div>
                    <div class="port-dna-segment n4" id="dnaN4" style="width:0%"><span class="port-dna-label">N4 <span id="pctN4">0%</span></span></div>
                </div>
                <div class="port-dna-legend">
                    <div class="port-dna-item"><span class="port-dna-dot n1"></span>N1: Growth/Recovery <span id="valN1">$0</span></div>
                    <div class="port-dna-item"><span class="port-dna-dot n2"></span>N2: Managed/Base Case <span id="valN2">$0</span></div>
                    <div class="port-dna-item"><span class="port-dna-dot n3"></span>N3: Risk/Downside <span id="valN3">$0</span></div>
                    <div class="port-dna-item"><span class="port-dna-dot n4"></span>N4: Disruption <span id="valN4">$0</span></div>
                </div>
            </div>

            <!-- Risk Insights Grid -->
            <div class="port-insights-grid">
                <div class="port-insight-card">
                    <div class="port-insight-header">
                        <span class="port-insight-icon">⚠️</span>
                        <span class="port-insight-title">Concentration Alert</span>
                    </div>
                    <div class="port-insight-content" id="portConcentrationAlert">
                        Upload portfolio to see concentration analysis
                    </div>
                </div>
                <div class="port-insight-card">
                    <div class="port-insight-header">
                        <span class="port-insight-icon">&#x1F3AF;</span>
                        <span class="port-insight-title">Contrarian Opportunities</span>
                    </div>
                    <div class="port-insight-content" id="portContrarianOpp">
                        Positions where your view differs from Continuum
                    </div>
                </div>
                <div class="port-insight-card">
                    <div class="port-insight-header">
                        <span class="port-insight-icon">&#x1F6E1;&#xFE0F;</span>
                        <span class="port-insight-title">Hedge Gaps</span>
                    </div>
                    <div class="port-insight-content" id="portHedgeGaps">
                        Hypotheses you're not exposed to
                    </div>
                </div>
                <div class="port-insight-card">
                    <div class="port-insight-header">
                        <span class="port-insight-icon">&#x1F4CA;</span>
                        <span class="port-insight-title">Alignment Score</span>
                    </div>
                    <div class="port-insight-content" id="portAlignmentScore">
                        How closely your book matches Continuum's view
                    </div>
                </div>
            </div>
        </div>

        <!-- CHANGE DETECTION ALERTS -->
        <div class="change-alerts-section" id="changeAlertsSection" style="display:none">
            <div class="section-header" style="margin: var(--space-2xl) 0 var(--space-lg);">
                <div class="section-title">Change Detection Alerts</div>
                <span class="step-indicator">Recent hypothesis shifts affecting your portfolio</span>
            </div>

            <div class="change-alerts-feed" id="changeAlertsFeed">
                <!-- Alerts populated dynamically -->
            </div>

            <div class="change-alerts-empty" id="changeAlertsEmpty">
                <div class="change-empty-icon">&#x1F514;</div>
                <div class="change-empty-title">No active alerts</div>
                <div class="change-empty-text">Recent hypothesis changes will appear here when your portfolio is loaded</div>
            </div>
        </div>

        <!-- EVIDENCE-ALIGNED REWEIGHTING -->
        <div class="port-reweight-section" id="portfolioReweighting" style="display:none">
            <div class="section-header" style="margin: var(--space-2xl) 0 var(--space-lg);">
                <div class="section-title">Evidence-Aligned Reweighting</div>
                <span class="step-indicator">Suggested weights based on Continuum's evidence synthesis</span>
            </div>
            <div class="port-reweight-body" id="reweightBody"></div>
            <div class="port-reweight-disclaimer">
                These suggestions reflect equal-weight allocation adjusted for Continuum's risk skew assessment. They are not investment recommendations. Consult your financial advisor.
            </div>
        </div>

        <!-- Disclaimer -->
        <div class="callout" style="margin-top: var(--space-xl)">
            <div class="callout-label">Important</div>
            <p>Position alignment analysis reflects how your holdings relate to Continuum's evidence-based risk skew assessments. Alignment indicators describe the relationship between your exposure and our analytical view. They are not investment recommendations. "Contradicts skew" does not mean "sell"; it means our evidence synthesis suggests risk is skewed differently to your position. Consult your own financial advisor before making investment decisions.</p>
        </div>
    </div>

    <!-- Portfolio Footer -->
    <footer class="site-footer">
        <div class="footer-inner">
            <div class="footer-bottom">
                <div class="footer-disclaimer">This portal does not constitute personal financial advice. Position alignment analysis uses publicly available information and the Analysis of Competing Hypotheses (ACH) methodology. No buy, sell, or hold recommendations are made.</div>
                <div class="footer-meta">&copy; 2026 Continuum Intelligence</div>
            </div>
        </div>
    </footer>
</div>

<!-- ============================================================
     PAGE: ABOUT
     ============================================================ -->
<div class="page" id="page-about">
    <div class="about-content">
        <div class="hero-tagline" style="text-align:left; margin-bottom: var(--space-lg);">Our Approach</div>
        <h1 class="about-title">Evidence, not opinions.</h1>

        <p class="about-text">Traditional equity research suffers from a structural problem: analysts form a thesis, then seek evidence to support it. This is confirmation bias operating at institutional scale, embedded in the business model of sell-side research.</p>

        <p class="about-text">We do the opposite. We collect evidence across <strong>ten independent domains</strong>, tag each piece with its epistemic quality, and then ask: which competing hypotheses does this evidence support or contradict?</p>

        <h2 class="about-subtitle">Analysis of Competing Hypotheses</h2>

        <p class="about-text">Our methodology is built on the <strong>Analysis of Competing Hypotheses (ACH)</strong> framework, originally developed by Richards Heuer at the CIA for intelligence analysis. ACH forces the analyst to consider multiple explanations simultaneously, rather than anchoring on a single narrative.</p>

        <p class="about-text">For each stock, we define four competing hypotheses about the company's trajectory. We then systematically assess how each piece of evidence supports, contradicts, or is neutral to each hypothesis. The result is not a price target or a recommendation. It is a map of where the evidence actually points, and where the asymmetric risk sits.</p>

        <h2 class="about-subtitle">Ten Evidence Domains</h2>

        <p class="about-text">We assess evidence across <strong>corporate communications</strong> (motivated but primary), <strong>regulatory filings</strong> (statutory, under oath), <strong>broker research</strong> (consensus view), <strong>competitor disclosures</strong> (independent), <strong>economic data</strong> (objective), <strong>alternative data</strong> (behavioural signals), <strong>academic research</strong> (peer-reviewed base rates), <strong>media and social</strong> (noise, but directionally informative), <strong>leadership and governance</strong> (board composition, skin in game, succession), and <strong>ownership and capital flows</strong> (register composition, substantial holder movements, short interest).</p>

        <p class="about-text">Each domain receives an <strong>epistemic tag</strong> reflecting its reliability and motivation. Corporate communications are "Motivated." Regulatory filings are "Under Oath." Media is "Noise." We never treat all evidence as equal.</p>

        <div class="about-subtitle">What We Are Not</div>

        <p class="about-text">We do not make buy, sell, or hold recommendations. We do not set price targets. We do not build valuation models. We do not manage money or take positions. We map the evidence landscape and identify where the asymmetric risk sits. What you do with that is your decision.</p>

        <div class="about-cred">
            <p>Built by former UBS and Goldman Sachs executives with decades of institutional experience across equities, fixed income, and portfolio management. No conflicts of interest. No corporate relationships. No investment banking revenue to protect.</p>
        </div>

        <div class="about-disclaimer">
            <h4>Legal Disclaimer</h4>
            <p>Continuum Intelligence provides general information and analysis only. Nothing published on this portal constitutes personal financial advice under Australian law or any other jurisdiction. All factual claims are sourced from ASX filings, ACCC publications, ABS statistics, RBA data, company investor presentations, broker consensus data, and publicly available information. Hypothesis survival scores reflect editorial assessment based on the Analysis of Competing Hypotheses methodology. Readers should consult their own licensed financial advisors before making any investment decisions. Past performance is not indicative of future results. Continuum Intelligence, its principals, and contributors may hold positions in securities discussed. All content is provided "as is" without warranty of any kind.</p>
        </div>
    </div>

    <footer class="site-footer">
        <div class="footer-inner">
            <div class="footer-bottom">
                <div class="footer-disclaimer">This portal does not constitute personal financial advice. All analysis uses publicly available information and the ACH methodology.</div>
                <div class="footer-meta">&copy; 2026 Continuum Intelligence</div>
            </div>
        </div>
    </footer>
</div>

<!-- ============================================================
     PAGE: THESIS COMPARATOR
     ============================================================ -->
<div class="page" id="page-thesis">
    <div class="tc-section">
        
        <div class="tc-hero">
            <div class="tc-hero-tagline">Validate Your Conviction</div>
            <h1 class="tc-hero-title">Investment Thesis Comparator</h1>
            <p class="tc-hero-subtitle">Discover which of Continuum's four competing hypotheses your investment thesis aligns with  --  or if you're pushing uphill against all of them.</p>
        </div>

        <div class="tc-card-container">
            <div id="tc-step-1">
                <div class="section-header" style="margin-bottom: var(--space-lg);">
                    <h2 class="section-title">Step 1: Select Company</h2>
                    <span class="step-indicator">1 of 2</span>
                </div>
                <label class="tc-step-label">Which stock does your thesis analyze?</label>
                
                <div class="tc-stock-grid" id="tc-stock-grid">
                    <!-- Stock cards generated dynamically from STOCK_DATA -->
                </div>
            </div>

            <div class="tc-input-step" id="tc-step-2">
                <div class="section-header" style="margin-bottom: var(--space-lg);">
                    <h2 class="section-title">Step 2: Your Investment Thesis</h2>
                    <span class="step-indicator">2 of 2</span>
                </div>
                <label for="tc-thesis-input" class="sr-only">Your investment thesis</label>
                <textarea class="tc-textarea" id="tc-thesis-input" placeholder="Paste your investment thesis here..." aria-label="Paste your investment thesis here"></textarea>
                <button class="tc-analyze-btn" onclick="tcAnalyze()">
                    <span>&#128269;</span>
                    <span>Discover Alignment</span>
                </button>
            </div>
        </div>

        <!-- RESULTS -->
        <div class="tc-results" id="tc-results">
            <div class="tc-banner" id="tc-banner">
                <div class="tc-banner-label" id="tc-banner-label">Your thesis aligns most closely with:</div>
                <div class="tc-banner-hypothesis" id="tc-banner-hypothesis"></div>
                <div class="tc-banner-desc" id="tc-banner-desc"></div>
            </div>

            <div class="tc-map">
                <div class="tc-map-header">How Your Thesis Maps to All Four Hypotheses</div>
                <div id="tc-map-rows"></div>
            </div>

            <div class="tc-analysis">
                <div class="tc-analysis-title">Detailed Analysis</div>
                <div class="tc-analysis-text" id="tc-analysis-text"></div>
                <div class="tc-evidence-grid">
                    <div class="tc-evidence-col">
                        <div class="tc-evidence-header">Evidence Supporting Your View</div>
                        <div class="tc-evidence-list" id="tc-supporting"></div>
                    </div>
                    <div class="tc-evidence-col">
                        <div class="tc-evidence-header">Evidence You May Be Missing</div>
                        <div class="tc-evidence-list" id="tc-contradicting"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <footer class="site-footer">
        <div class="footer-inner">
            <div class="footer-bottom">
                <div class="footer-disclaimer">This comparator provides analysis based on publicly available research. It does not constitute investment advice.</div>
                <div class="footer-meta">&copy; 2026 Continuum Intelligence</div>
            </div>
        </div>
    </footer>
</div>

<!-- ============================================================
     PAGE: PERSONALISATION
     ============================================================ -->
<div class="page" id="page-personalisation"></div>

<!-- Report Pages (dynamically rendered) -->
<div class="page" id="page-report-WOW"></div>
<div class="page" id="page-report-XRO"></div>
<div class="page" id="page-report-WTC"></div>
<div class="page" id="page-report-DRO"></div>
<div class="page" id="page-report-PME"></div>
<div class="page" id="page-report-GYG"></div>
<div class="page" id="page-report-CSL"></div>
<div class="page" id="page-report-MQG"></div>
<div class="page" id="page-report-GMG"></div>
<div class="page" id="page-report-WDS"></div>
<div class="page" id="page-report-SIG"></div>
<div class="page" id="page-report-FMG"></div>

<!-- SheetJS for Excel parsing  --  loaded on demand when user uploads portfolio -->
<script id="sheetjs-placeholder" data-src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script>
// Lazy-load SheetJS only when needed (portfolio upload interaction)
window.loadSheetJS = function(callback) {
    if (typeof XLSX !== 'undefined') { if (callback) callback(); return; }
    var placeholder = document.getElementById('sheetjs-placeholder');
    var script = document.createElement('script');
    script.src = placeholder.getAttribute('data-src');
    script.onload = function() { if (callback) callback(); };
    script.onerror = function() { console.error('[SheetJS] Failed to load library'); };
    document.head.appendChild(script);
};
</script>

<!-- ============================================================
     JAVASCRIPT: Router, Interactions, Scroll-spy, Portfolio
     ============================================================ -->
<script>

// ============================================================
// STOCK DATA & RENDER FUNCTIONS (merged from external JS files)
// ============================================================

// ============================================================
// CONTINUUM INTELLIGENCE  --  STOCK DATA & RENDER FUNCTIONS
// Templatised report generation from structured data objects
// ============================================================

const STOCK_DATA = {};

// ============================================================
// WOW  --  Woolworths Group
// ============================================================

// === FRESHNESS_DATA — Auto-generated by research-monitor.js ===
// Last updated: 2026-02-26T08:06:44.389Z
const FRESHNESS_DATA = {};
// === END FRESHNESS_DATA ===

// ============================================================
// REFERENCE_DATA  --  Immutable Anchors for Dynamic Computation
// These values rarely change (updated with earnings releases).
// The ContinuumDynamics engine uses these + live price to
// compute market cap, P/E, drawdown, upside, and more.
// ============================================================
const REFERENCE_DATA = {
  WOW: {
    sharesOutstanding: 1219,   // millions
    analystTarget: 30.45,
    analystBuys: 3, analystHolds: 8, analystSells: 0,
    analystCount: 11,
    epsTrailing: 0.858,        // A$31.41 / 36.6x
    epsForward: 1.336,         // A$31.41 / 23.5x
    divPerShare: 0.84,
    reportingCurrency: 'A$',
    revenue: 69.1,             // A$ billions
    revenueGrowth: 1.7,
    ebitMargin: 4.0,
    roe: 18.1,
    netDebtToEbitda: 2.8,
    fcf: 2.02,                 // A$ billions
    // Narrative anchors: values baked into text at time of writing
    _anchors: { price: 31.96, marketCapStr: '39B', drawdown: 5, pe: 37.2, fwdPE: 23.9, divYield: 2.6 }
  },
  XRO: {
    sharesOutstanding: 154,
    analystTarget: 191,
    analystBuys: 15, analystHolds: 0, analystSells: 0,
    analystCount: 15,
    epsTrailing: 1.899,        // A$77.87 / 41x
    epsForward: null,
    divPerShare: 0,
    reportingCurrency: 'NZ$',
    revenue: 2.10,             // NZ$ billions
    revenueGrowth: 22.7,
    ebitdaMargin: null,
    fcfMargin: 26.9,
    ruleOf40: 44.5,
    subscribers: '4.6M',
    _anchors: { price: 78.5, marketCapStr: '12.1B', drawdown: 60, upsideToTarget: 143, pe: 41.3 }
  },
  WTC: {
    sharesOutstanding: 381,
    analystTarget: 101.21,
    analystBuys: 13, analystHolds: 0, analystSells: 0,
    analystCount: 13,
    epsTrailing: 0.888,        // A$49.30 / 55.5x
    epsForward: null,
    divPerShare: 0,
    reportingCurrency: 'A$',
    revenue: 0.605,            // A$ billions (1H annualised)
    revenueGrowth: 26,
    ebitdaMargin: 53.5,
    _anchors: { price: 47.34, marketCapStr: '18B', drawdown: 62, pe: 53.3 }
  },
  DRO: {
    sharesOutstanding: 917,
    analystTarget: 5.10,
    analystBuys: 2, analystHolds: 0, analystSells: 0,
    analystCount: 2,
    epsTrailing: null,
    epsForward: null,
    divPerShare: 0,
    reportingCurrency: 'A$',
    revenue: 0.0723,           // A$ billions (1H)
    revenueGrowth: 210,
    grossMargin: 65,
    pipeline: 2.09,            // A$ billions
    cash: 0.204,               // A$ billions
    _anchors: { price: 3.25, marketCapStr: '3B', upsideToTarget: 57 }
  },
  PME: {
    sharesOutstanding: 112,
    analystTarget: null,       // no clear consensus
    analystBuys: null, analystHolds: null, analystSells: null,
    analystCount: null,
    epsTrailing: 1.021,        // A$166.35 / 163x
    epsForward: null,
    divPerShare: 0,
    reportingCurrency: 'A$',
    revenue: 0.213,            // A$ billions
    revenueGrowth: 31.9,
    ebitdaMargin: 77.44,
    employees: 132,
    _anchors: { price: 125.96, marketCapStr: '14.1B', drawdown: 62, pe: 123.4 }
  },
  GYG: {
    sharesOutstanding: 102,
    analystTarget: null,
    analystBuys: null, analystHolds: null, analystSells: null,
    analystCount: null,
    epsTrailing: 0.122,        // A$20.30 / 166x
    epsForward: null,
    divPerShare: 0,
    reportingCurrency: 'A$',
    revenue: 0.465,            // A$ billions
    revenueGrowth: 27.4,
    ebitdaMargin: 18.85,
    storeCount: 239,
    ipoPrice: 22.00,
    _anchors: { price: 19.5, marketCapStr: '2B', pe: 159.8 }
  },
  CSL: {
    sharesOutstanding: 483,
    analystTarget: 222,        // midpoint of 215-230 range
    analystBuys: 13, analystHolds: 0, analystSells: 0,
    analystCount: 13,
    epsTrailing: 10.15,        // A$163.44 / 16.1x
    epsForward: 11.27,         // A$163.44 / 14.5x
    divPerShare: 3.92,         // ~2.4% of 163.44
    reportingCurrency: 'US$',
    revenue: 8.3,              // US$ billions (1H annualised)
    revenueGrowth: -4,
    npata: 1.9,                // US$ billions (1H)
    impairments: 1.1,          // US$ billions
    _anchors: { price: 151.56, marketCapStr: '73.2B', drawdown: 44, pe: 14.9, fwdPE: 13.4, divYield: 2.6 }
  },
  MQG: {
    sharesOutstanding: 366,
    analystTarget: 227,
    analystBuys: 8, analystHolds: 0, analystSells: 0,
    analystCount: 8,
    epsTrailing: 10.24,        // A$207.83 / 20.3x
    epsForward: 11.17,         // A$207.83 / 18.6x
    divPerShare: 6.86,         // ~3.3% of 207.83
    reportingCurrency: 'A$',
    revenue: null,
    roe: 11.2,
    aum: 941,                  // A$ billions
    _anchors: { price: 218.36, marketCapStr: '79.9B', pe: 21.3, fwdPE: 19.5, divYield: 3.1 }
  },
  GMG: {
    sharesOutstanding: 2062,
    analystTarget: 37.50,      // midpoint of 37-38 range
    analystBuys: 11, analystHolds: 0, analystSells: 0,
    analystCount: 11,
    epsTrailing: 0.849,        // A$30.55 / 36x
    epsForward: 1.300,         // A$30.55 / 23.5x
    divPerShare: 0.30,
    reportingCurrency: 'A$',
    revenue: 2.311,            // A$ billions
    revenueGrowth: 16.5,
    aum: 86,                   // A$ billions
    powerBank: '5.0 GW',
    _anchors: { price: 30.76, marketCapStr: '63.4B', pe: 36.2, fwdPE: 23.7 }
  },
  WDS: {
    sharesOutstanding: 1899,
    analystTarget: 26.62,
    analystBuys: 3, analystHolds: 6, analystSells: 0,
    analystCount: 9,
    epsTrailing: 2.216,        // A$25.48 / 11.5x
    epsForward: 1.623,         // A$25.48 / 15.7x
    divPerShare: 1.76,         // ~6.9% of 25.48
    reportingCurrency: 'US$',
    revenue: 6.590,            // US$ billions (1H)
    revenueGrowth: 10,
    cashMargin: 82,
    scarboroughComplete: 94,
    _anchors: { price: 25.83, marketCapStr: '49.1B', pe: 11.7, fwdPE: 15.9, divYield: 6.8 }
  },
  SIG: {
    sharesOutstanding: 11540,
    analystTarget: 3.25,       // midpoint of 3.08-3.42
    analystBuys: 5, analystHolds: 4, analystSells: 1,
    analystCount: 10,
    epsTrailing: 0.0515,       // A$3.14 / 61x
    epsForward: 0.0683,        // A$3.14 / 46x
    divPerShare: 0.016,        // ~0.5% of 3.14
    reportingCurrency: 'A$',
    revenue: 6.0,              // A$ billions (merged)
    revenueGrowth: 82,
    escrowShares: 5600,        // millions
    escrowRelease: 'Aug 2026',
    _anchors: { price: 3.02, marketCapStr: '34.9B', pe: 58.6, fwdPE: 44.2, divYield: 0.5 }
  },
  FMG: {
    sharesOutstanding: 3203,
    analystTarget: 19.22,      // midpoint of 18.58-19.86
    analystBuys: 2, analystHolds: 8, analystSells: 2,
    analystCount: 12,
    epsTrailing: 1.633,        // A$21.23 / 13x
    epsForward: null,
    divPerShare: 1.10,
    reportingCurrency: 'US$',
    revenue: 15.5,             // US$ billions
    revenueGrowth: -15,
    ebitdaMargin: 51,
    c1Cost: 18.17,             // US$/wmt
    shipped: 198.4,            // Mt
    _anchors: { price: 20.1, marketCapStr: '64.4B', pe: 12.3, divYield: 5.5 }
  },
  DXS: {
    sharesOutstanding: 1080,   // millions
    analystTarget: 7.60,       // midpoint of analyst range
    analystBuys: 3, analystHolds: 13, analystSells: 3,
    analystCount: 19,
    epsTrailing: 0.15,         // A$6.17 / ~41x
    epsForward: null,
    divPerShare: 0.37,
    reportingCurrency: 'A$',
    revenue: null,
    affo: 0.45,                // A$ per security (FY25)
    aum: 50.1,                 // A$ billions
    listedPortfolio: 14.5,     // A$ billions
    _anchors: { price: 6.3, marketCapStr: '6.8B', pe: 42, divYield: 5.9 }
  },
  NAB: {
    sharesOutstanding: 3056,  // millions
    analystTarget: 39.23,
    analystBuys: null, analystHolds: null, analystSells: null,
    analystCount: 14,
    epsTrailing: 2.21,
    epsForward: null,
    divPerShare: 1.7,
    reportingCurrency: 'A$',
    revenue: null,
    _anchors: { price: 45.34, marketCapStr: '139B', pe: 20.5, divYield: 3.7 }
  },
  BHP: {
    sharesOutstanding: 5078,
    analystTarget: null,
    analystBuys: null,
    analystHolds: null,
    analystSells: null,
    analystCount: null,
    epsTrailing: null,
    epsForward: null,
    divPerShare: null,
    reportingCurrency: 'A$',
    revenue: null,
    _anchors: { price: 52.74, marketCapStr: '268B', pe: null, divYield: null }
  },
  HRZ: {
    sharesOutstanding: 206,
    analystTarget: null,
    analystBuys: null,
    analystHolds: null,
    analystSells: null,
    analystCount: null,
    epsTrailing: null,
    epsForward: null,
    divPerShare: null,
    reportingCurrency: 'A$',
    revenue: null,
    _anchors: { price: 1.24, marketCapStr: '0.3B', pe: null, divYield: null }
  },
  OCL: {
    sharesOutstanding: 96,
    analystTarget: null,
    analystBuys: null,
    analystHolds: null,
    analystSells: null,
    analystCount: null,
    epsTrailing: null,
    epsForward: null,
    divPerShare: null,
    reportingCurrency: 'A$',
    revenue: null,
    _anchors: { price: 13.91, marketCapStr: '1.3B', pe: null, divYield: null }
  },
  RFG: {
    sharesOutstanding: 63,
    analystTarget: null,
    analystBuys: null,
    analystHolds: null,
    analystSells: null,
    analystCount: null,
    epsTrailing: null,
    epsForward: null,
    divPerShare: null,
    reportingCurrency: 'A$',
    revenue: null,
    _anchors: { price: 1.07, marketCapStr: '67M', pe: null, divYield: null }
  }
};
// === END REFERENCE_DATA ===


// ============================================================
// STOCK DATA LOADER  --  loads lightweight index data synchronously
// for home page, then fetches full research data on demand
// ============================================================

// Load lightweight index data synchronously (needed for DOMContentLoaded)
(function() {
  try {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', 'data/research/_index.json', false); // synchronous
    xhr.send();
    if (xhr.status === 200) {
      var indexData = JSON.parse(xhr.responseText);
      var tickers = Object.keys(indexData);
      for (var i = 0; i < tickers.length; i++) {
        var t = tickers[i];
        STOCK_DATA[t] = indexData[t];
        STOCK_DATA[t]._indexOnly = true; // flag: full data not yet loaded
      }
      console.log('[StockDataLoader] Loaded index data for ' + tickers.length + ' tickers');
    } else {
      console.error('[StockDataLoader] Failed to load index data: HTTP ' + xhr.status);
    }
  } catch (err) {
    console.error('[StockDataLoader] Error loading index data:', err);
  }
})();

// Async loader for full research data (called before rendering a report page)
function loadFullResearchData(ticker, callback) {
  if (STOCK_DATA[ticker] && !STOCK_DATA[ticker]._indexOnly) {
    // Already loaded full data
    if (callback) callback(STOCK_DATA[ticker]);
    return;
  }

  // Check localStorage for cached refresh data (persists across page reloads)
  try {
    var cached = localStorage.getItem('ci_research_' + ticker);
    if (cached) {
      var cachedData = JSON.parse(cached);
      // Use cached data if it has a _lastRefreshed timestamp (written by refresh pipeline)
      if (cachedData._lastRefreshed) {
        var livePrice = STOCK_DATA[ticker] ? STOCK_DATA[ticker]._livePrice : undefined;
        var livePriceHistory = STOCK_DATA[ticker] ? STOCK_DATA[ticker].priceHistory : undefined;
        STOCK_DATA[ticker] = cachedData;
        STOCK_DATA[ticker]._indexOnly = false;
        STOCK_DATA[ticker]._fromCache = true;
        if (livePrice !== undefined) {
          STOCK_DATA[ticker]._livePrice = livePrice;
          STOCK_DATA[ticker].price = livePrice;
        }
        if (livePriceHistory) {
          STOCK_DATA[ticker].priceHistory = livePriceHistory;
        }
        if (typeof ContinuumDynamics !== 'undefined' && ContinuumDynamics.hydrate) {
          ContinuumDynamics.hydrate(ticker);
        }
        if (typeof buildSnapshotFromStock === 'function') {
          SNAPSHOT_DATA[ticker] = buildSnapshotFromStock(ticker);
        }
        console.log('[StockDataLoader] Loaded CACHED research for ' + ticker + ' (refreshed ' + cachedData._lastRefreshed + ')');
        if (callback) callback(STOCK_DATA[ticker]);
        return;
      }
    }
  } catch (cacheErr) {
    console.warn('[StockDataLoader] Cache read failed:', cacheErr);
  }

  var url = 'data/research/' + ticker + '.json';
  var xhr = new XMLHttpRequest();
  xhr.open('GET', url, true);
  xhr.onload = function() {
    if (xhr.status === 200) {
      try {
        var fullData = JSON.parse(xhr.responseText);
        // Merge full data into STOCK_DATA, preserving any live price patches
        var livePrice = STOCK_DATA[ticker] ? STOCK_DATA[ticker]._livePrice : undefined;
        var livePriceHistory = STOCK_DATA[ticker] ? STOCK_DATA[ticker].priceHistory : undefined;
        STOCK_DATA[ticker] = fullData;
        STOCK_DATA[ticker]._indexOnly = false;
        // Restore live price if it was patched
        if (livePrice !== undefined) {
          STOCK_DATA[ticker]._livePrice = livePrice;
          STOCK_DATA[ticker].price = livePrice;
        }
        if (livePriceHistory) {
          STOCK_DATA[ticker].priceHistory = livePriceHistory;
        }
        // Re-hydrate with ContinuumDynamics if available
        if (typeof ContinuumDynamics !== 'undefined' && ContinuumDynamics.hydrate) {
          ContinuumDynamics.hydrate(ticker);
        }
        // Re-build snapshot data
        if (typeof buildSnapshotFromStock === 'function') {
          SNAPSHOT_DATA[ticker] = buildSnapshotFromStock(ticker);
        }
        console.log('[StockDataLoader] Loaded full research data for ' + ticker);
        // Also merge signal fields from data/stocks/TICKER.json
        var sigUrl = 'data/stocks/' + ticker + '.json';
        var sigXhr = new XMLHttpRequest();
        sigXhr.open('GET', sigUrl, true);
        sigXhr.onload = function() {
          if (sigXhr.status === 200) {
            try {
              var sd = JSON.parse(sigXhr.responseText);
              if (sd.three_layer_signal) STOCK_DATA[ticker].three_layer_signal = sd.three_layer_signal;
              if (sd.valuation_range)    STOCK_DATA[ticker].valuation_range    = sd.valuation_range;
              if (sd.price_signals && sd.price_signals.length)
                STOCK_DATA[ticker].price_signals = sd.price_signals;
            } catch(e) {}
          }
          if (callback) callback(STOCK_DATA[ticker]);
        };
        sigXhr.onerror = function() { if (callback) callback(STOCK_DATA[ticker]); };
        sigXhr.send();
        return; // callback is called from sigXhr handlers above
      } catch (err) {
        console.error('[StockDataLoader] Error parsing research data for ' + ticker + ':', err);
        if (callback) callback(null);
      }
    } else {
      console.error('[StockDataLoader] Failed to fetch research data for ' + ticker + ': HTTP ' + xhr.status);
      if (callback) callback(null);
    }
  };
  xhr.onerror = function() {
    console.error('[StockDataLoader] Network error fetching research data for ' + ticker);
    if (callback) callback(null);
  };
  xhr.send();
}


// ============================================================
// RENDER FUNCTIONS
// ============================================================

// Normalise raw ACH survival scores to sum to 100%
// v3 framework: enforce floor(5) and ceiling(80) per NARRATIVE_FRAMEWORK_V3.md
// "No hypothesis can show <5% or >80%. After clamping, re-normalise to sum to 100."
function normaliseScores(items) {
  var FLOOR = 5;
  var CEILING = 80;
  var raw = [];
  for (var i = 0; i < items.length; i++) {
    var val = parseInt(items[i].score) || 0;
    raw.push(val);
  }
  if (raw.length === 0) return raw;

  // Step 1: Clamp each score to floor/ceiling
  var clamped = [];
  for (var i = 0; i < raw.length; i++) {
    clamped.push(Math.max(FLOOR, Math.min(CEILING, raw[i])));
  }

  // Step 2: Sum clamped values and proportionally scale to 100
  var sum = 0;
  for (var i = 0; i < clamped.length; i++) sum += clamped[i];
  if (sum === 0) {
    var eq = Math.round(100 / clamped.length);
    var eqResult = [];
    for (var i = 0; i < clamped.length; i++) eqResult.push(eq);
    return eqResult;
  }

  var result = [];
  for (var i = 0; i < clamped.length; i++) {
    result.push(Math.round((clamped[i] / sum) * 100));
  }

  // Step 3: Iterative post-normalisation clamp.
  // Re-normalisation can push values outside [FLOOR, CEILING].
  // We iteratively clamp and redistribute until stable.
  for (var iter = 0; iter < 20; iter++) {
    var overflow = 0;   // total amount over ceiling
    var underflow = 0;  // total amount under floor
    var freeIndices = [];
    for (var i = 0; i < result.length; i++) {
      if (result[i] > CEILING) { overflow += result[i] - CEILING; result[i] = CEILING; }
      else if (result[i] < FLOOR) { underflow += FLOOR - result[i]; result[i] = FLOOR; }
      else { freeIndices.push(i); }
    }
    if (overflow === 0 && underflow === 0) break;

    // Net excess: positive means we need to grow other items, negative means shrink
    var net = overflow - underflow;
    if (net === 0) break;
    if (freeIndices.length === 0) break; // All items are pinned; accept best-effort

    // Distribute net across free items (those not pinned at floor/ceiling)
    if (net > 0) {
      // Overflow: distribute excess to items below ceiling, smallest first
      freeIndices.sort(function(a,b) { return result[a] - result[b]; });
      var remaining = net;
      for (var fi = 0; fi < freeIndices.length && remaining > 0; fi++) {
        var idx = freeIndices[fi];
        var room = CEILING - result[idx];
        var give = Math.min(remaining, room);
        result[idx] += give;
        remaining -= give;
      }
    } else {
      // Underflow: take from items above floor, largest first
      freeIndices.sort(function(a,b) { return result[b] - result[a]; });
      var remaining = -net;
      for (var fi = 0; fi < freeIndices.length && remaining > 0; fi++) {
        var idx = freeIndices[fi];
        var room = result[idx] - FLOOR;
        var take = Math.min(remaining, room);
        result[idx] -= take;
        remaining -= take;
      }
    }
  }

  // Step 4: Fix rounding residual  --  adjust the largest non-ceiling value
  var roundedSum = 0;
  for (var i = 0; i < result.length; i++) roundedSum += result[i];
  if (roundedSum !== 100) {
    var diff = 100 - roundedSum;
    // Find best candidate: largest value that won't breach bounds after adjustment
    var bestIdx = -1;
    for (var i = 0; i < result.length; i++) {
      var candidate = result[i] + diff;
      if (candidate >= FLOOR && candidate <= CEILING) {
        if (bestIdx === -1 || result[i] > result[bestIdx]) bestIdx = i;
      }
    }
    if (bestIdx === -1) {
      // Fallback: just adjust the largest
      bestIdx = 0;
      for (var i = 1; i < result.length; i++) {
        if (result[i] > result[bestIdx]) bestIdx = i;
      }
    }
    result[bestIdx] += diff;
  }

  return result;
}

// Compute skew score from hypothesis weights (v3 framework)
// Returns { bull: 0-100, bear: 0-100, score: -100 to +100, direction: string, hypotheses: [{title, direction, weight}] }
// Principle 5: Thesis Skew is derived mechanically from hypothesis scores and sentiment tags.
// NEUTRAL hypotheses split 50/50 between bull and bear.
// Direction thresholds: >+5 = upside, <-5 = downside, else balanced.
function computeSkewScore(data) {
  if (!data || !data.hypotheses || data.hypotheses.length === 0) {
    return { bull: 50, bear: 50, score: 0, direction: 'balanced', hypotheses: [] };
  }
  var hyps = data.hypotheses;
  var norm = normaliseScores(hyps);
  var bull = 0, bear = 0;
  var breakdown = [];
  for (var i = 0; i < hyps.length; i++) {
    var w = norm[i] || 0;
    var dir = hyps[i].direction || 'downside';
    if (dir === 'upside') {
      bull += w;
    } else if (dir === 'downside') {
      bear += w;
    } else {
      // NEUTRAL/BALANCED: split equally per v3 framework
      bull += w / 2;
      bear += w / 2;
    }
    breakdown.push({ title: hyps[i].title || hyps[i].tier, direction: dir, weight: w });
  }
  // Round to avoid floating point display issues
  bull = Math.round(bull);
  bear = Math.round(bear);
  var score = bull - bear;
  // Derive direction mechanically from score  --  never from static data
  var direction = score > 5 ? 'upside' : score < -5 ? 'downside' : 'balanced';
  return { bull: bull, bear: bear, score: score, direction: direction, hypotheses: breakdown };
}

var RS_CHEVRON = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>';
function RS_HDR(num, title) {
  return '<div class="rs-header"><div class="rs-header-text">' +
    '<div class="rs-number">' + num + '</div>' +
    '<div class="rs-title">' + title + '</div>' +
    '</div><button class="rs-toggle" onclick="toggleSection(this)" aria-label="Toggle section">' + RS_CHEVRON + '</button></div>';
}

function renderSparkline(prices) {
  if (!prices || prices.length < 2) return '';
  var w = 280, h = 88, pad = 4;
  var min = prices[0], max = prices[0];
  for (var i = 1; i < prices.length; i++) {
    if (prices[i] < min) min = prices[i];
    if (prices[i] > max) max = prices[i];
  }
  var range = max - min || 1;
  var stepX = (w - pad * 2) / (prices.length - 1);

  var points = '';
  var fillPoints = pad + ',' + (h - pad);
  for (var i = 0; i < prices.length; i++) {
    var x = pad + i * stepX;
    var y = h - pad - ((prices[i] - min) / range) * (h - pad * 2);
    points += x.toFixed(1) + ',' + y.toFixed(1) + ' ';
    fillPoints += ' ' + x.toFixed(1) + ',' + y.toFixed(1);
  }
  fillPoints += ' ' + (pad + (prices.length - 1) * stepX).toFixed(1) + ',' + (h - pad);

  var color = prices[prices.length - 1] > prices[0] * 1.02 ? '#00c875' :
              prices[prices.length - 1] < prices[0] * 0.98 ? '#e44258' : '#f5a623';
  var id = 'sp' + Math.random().toString(36).substr(2, 6);

  return '<div class="rh-sparkline">' +
    '<svg viewBox="0 0 ' + w + ' ' + h + '" preserveAspectRatio="none">' +
      '<defs><linearGradient id="' + id + '" x1="0" y1="0" x2="0" y2="1">' +
        '<stop offset="0%" stop-color="' + color + '" stop-opacity="0.3"/>' +
        '<stop offset="100%" stop-color="' + color + '" stop-opacity="0.02"/>' +
      '</linearGradient></defs>' +
      '<polygon points="' + fillPoints + '" fill="url(#' + id + ')"/>' +
      '<polyline points="' + points.trim() + '" fill="none" stroke="' + color + '" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>' +
    '</svg>' +
  '</div>';
}

function renderReportHero(data) {
  var metricsHtml = '';
  for (var i = 0; i < data.heroMetrics.length; i++) {
    var m = data.heroMetrics[i];
    var cls = 'rh-metric-value' + (m.colorClass ? ' ' + m.colorClass : '');
    metricsHtml += '<div class="rh-metric"><div class="rh-metric-label">' + m.label + '</div><div class="' + cls + '">' + m.value + '</div></div>';
  }

  var sparklineHtml = data.priceHistory ? renderSparkline(data.priceHistory) : '';

  // "€"€ Spec Section 1.2  --  What the Price Embeds "€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€
  var embeddedThesisHtml = '';
  if (data.hero && data.hero.embedded_thesis) {
    embeddedThesisHtml =
      '<div class="rh-spec-block rh-embedded-thesis">' +
        '<div class="rh-spec-label">WHAT THE PRICE EMBEDS</div>' +
        '<p class="rh-spec-text">' + data.hero.embedded_thesis + '</p>' +
      '</div>';
  }

  // "€"€ Spec Section 1.3  --  Position in Range "€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€
  var positionInRangeHtml = '';
  if (data.hero && data.hero.position_in_range) {
    var pir = data.hero.position_in_range;
    var worlds = pir.worlds;
    var current = parseFloat(data._livePrice || data.price || pir.current_price);
    // Find min/max for bar positioning
    var prices = worlds.map(function(w) { w.price = parseFloat(w.price) || 0; return w.price; });
    prices.push(current);
    var minP = Math.min.apply(null, prices);
    var maxP = Math.max.apply(null, prices);
    var rangeP = maxP - minP || 1;

    var worldMarkersHtml = '';
    for (var i = 0; i < worlds.length; i++) {
      var w = worlds[i];
      var pct = ((w.price - minP) / rangeP * 100).toFixed(1);
      worldMarkersHtml +=
        '<div class="pir-world" style="left:' + pct + '%">' +
          '<div class="pir-world-tick"></div>' +
          '<div class="pir-world-price">A$' + w.price.toFixed(0) + '</div>' +
          '<div class="pir-world-label">' + w.label + '</div>' +
        '</div>';
    }
    var currentPct = ((current - minP) / rangeP * 100).toFixed(1);

    positionInRangeHtml =
      '<div class="rh-spec-block rh-position-range">' +
        '<div class="rh-spec-label">POSITION IN RANGE</div>' +
        '<div class="pir-bar-wrap">' +
          '<div class="pir-bar">' +
            worldMarkersHtml +
            '<div class="pir-current" style="left:' + currentPct + '%">' +
              '<div class="pir-current-dot">&#9679;</div>' +
              '<div class="pir-current-label">A$' + current.toFixed(2) + '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        (pir.note ? '<div class="pir-note">' + pir.note + '</div>' : '') +
      '</div>';
  }

  // "€"€ Spec Section 1.4  --  Valuation Range "€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€
  var valuationRangeHtml = '';
  if (data.hero && data.hero.position_in_range && data.hero.position_in_range.worlds &&
      data.hero.position_in_range.worlds.length >= 4) {
    var vrWorlds = data.hero.position_in_range.worlds;
    var vrCurrent = data._livePrice || data.price || data.hero.position_in_range.current_price;
    vrCurrent = parseFloat(vrCurrent);
    var vrBear    = parseFloat(vrWorlds[1].price) || 0;
    var vrFairLow = (parseFloat(vrWorlds[1].price) + parseFloat(vrWorlds[2].price)) / 2;
    var vrFairHigh= (parseFloat(vrWorlds[2].price) + parseFloat(vrWorlds[3].price)) / 2;
    var vrBull    = parseFloat(vrWorlds[3].price) || 0;
    var vrMin     = parseFloat(vrWorlds[0].price) || 0;
    var vrRange   = vrBull - vrMin || 1;

    var vrBadgeCls   = vrCurrent < vrBear ? 'amber' : vrCurrent > vrFairHigh ? 'positive' : 'neutral';
    var vrBadgeLabel = vrCurrent < vrBear ? 'AMBER'  : vrCurrent > vrFairHigh ? 'POSITIVE' : 'NEUTRAL';

    var vrBearPct    = ((vrBear     - vrMin) / vrRange * 100).toFixed(1);
    var vrFairLowPct = ((vrFairLow  - vrMin) / vrRange * 100).toFixed(1);
    var vrFairHighPct= ((vrFairHigh - vrMin) / vrRange * 100).toFixed(1);
    var vrCurrPct    = Math.min(100, Math.max(0, ((vrCurrent - vrMin) / vrRange * 100))).toFixed(1);

    var vrToFairH = ((vrFairHigh / vrCurrent - 1) * 100).toFixed(1);
    var vrToBull  = ((vrBull     / vrCurrent - 1) * 100).toFixed(1);
    var vrToBear  = ((vrBear     / vrCurrent - 1) * 100).toFixed(1);

    // Extract FWD P/E from heroMetrics if available
    var vrPE = '';
    if (data.heroMetrics) {
      for (var mi = 0; mi < data.heroMetrics.length; mi++) {
        if (data.heroMetrics[mi].label === 'FWD P/E') { vrPE = data.heroMetrics[mi].value; break; }
      }
    }

    valuationRangeHtml =
      '<div class="rh-spec-block vr-block">' +
        '<div class="vr-title-row">' +
          '<span class="rh-spec-label">VALUATION RANGE</span>' +
          '<span class="vr-badge ' + vrBadgeCls + '">' + vrBadgeLabel + '</span>' +
        '</div>' +
        '<div class="vr-bar-wrap">' +
          '<div class="vr-bar">' +
            '<div class="vr-current" style="left:' + vrCurrPct + '%">A$' + vrCurrent.toFixed(2) + '</div>' +
            '<div class="vr-marker" style="left:' + vrBearPct + '%">' +
              '<div class="vr-marker-price">A$' + vrBear.toFixed(2) + '</div>' +
              '<div class="vr-marker-label">Bear</div>' +
            '</div>' +
            '<div class="vr-marker" style="left:' + vrFairLowPct + '%;color:var(--accent-teal)">' +
              '<div class="vr-marker-price" style="color:var(--accent-teal)">A$' + vrFairLow.toFixed(2) + ' &ndash; A$' + vrFairHigh.toFixed(2) + '</div>' +
              '<div class="vr-marker-label">Fair</div>' +
            '</div>' +
            '<div class="vr-marker" style="left:100%">' +
              '<div class="vr-marker-price">A$' + vrBull.toFixed(2) + '</div>' +
              '<div class="vr-marker-label">Bull</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="vr-stats">' +
          '<span class="pos">+' + vrToFairH + '% to fair high</span>' +
          '<span class="pos">+' + vrToBull + '% to bull case</span>' +
          '<span>' + vrToBear + '% to bear case</span>' +
          (vrPE ? '<span>PE FORWARD: ' + vrPE + '</span>' : '') +
        '</div>' +
      '</div>';
  }

  // "€"€ Spec Section 1.5  --  Skew Indicator "€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€
  var skewIndicatorHtml = '';
  if (data.hero && data.hero.skew) {
    var skewCls = data.hero.skew === 'DOWNSIDE' ? 'rh-skew-down' : data.hero.skew === 'UPSIDE' ? 'rh-skew-up' : 'rh-skew-balanced';
    skewIndicatorHtml =
      '<div class="rh-spec-block rh-skew-indicator">' +
        '<span class="rh-spec-label">SKEW: </span>' +
        '<span class="rh-skew-value ' + skewCls + '">' + data.hero.skew + '</span>' +
        (data.hero.skew_description ? '<p class="rh-spec-text">' + data.hero.skew_description + '</p>' : '') +
      '</div>';
  }

  // "€"€ Spec Section 1.5  --  Next Decision Point "€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€
  var nextDecisionHtml = '';
  if (data.hero && data.hero.next_decision_point) {
    var ndp = data.hero.next_decision_point;
    nextDecisionHtml =
      '<div class="rh-spec-block rh-next-decision">' +
        '<div class="rh-spec-label">NEXT DECISION POINT</div>' +
        '<div class="ndp-event">' + ndp.event + ' &middot; <span class="ndp-date">' + ndp.date + '</span></div>' +
        '<p class="rh-spec-text">' + ndp.metric + '. ' + ndp.thresholds + '</p>' +
      '</div>';
  }

  // Prev/next stock navigation
  var _navTickers = (typeof FEATURED_ORDER !== 'undefined') ? FEATURED_ORDER : Object.keys(STOCK_DATA);
  var _navIdx = _navTickers.indexOf(data.ticker);
  var _prevTicker = _navTickers[(_navIdx - 1 + _navTickers.length) % _navTickers.length];
  var _nextTicker = _navTickers[(_navIdx + 1) % _navTickers.length];
  var stockNavHtml = '<div class="rh-stock-nav-bar">' +
    '<div class="rh-stock-nav">' +
      '<a href="#report-' + _prevTicker + '" onclick="navigate(\'report-' + _prevTicker + '\');return false;">&lsaquo; ' + _prevTicker + '</a>' +
      '<a href="#report-' + _nextTicker + '" onclick="navigate(\'report-' + _nextTicker + '\');return false;">' + _nextTicker + ' &rsaquo;</a>' +
    '</div>' +
  '</div>';

  return stockNavHtml +
  '<div class="report-hero">' +
    '<div class="report-hero-inner">' +
      '<a class="report-back" href="#home" onclick="navigate(\'home\')">&larr; Back to Coverage</a>' +
      '<div class="rh-main">' +
        '<div class="rh-left">' +
          '<div class="rh-type">Narrative Intelligence &mdash; Initial Coverage</div>' +
          '<div class="rh-ticker">' + data.company + '</div>' +
          '<div class="rh-company">' + data.tickerFull + ' &bull; ' + data.exchange + ' &bull; ' + data.sector + '</div>' +
          '<div class="rh-sector-tag">' + data.heroDescription + '</div>' +
          (data.heroCompanyDescription ? '<div class="rh-company-desc">' + data.heroCompanyDescription + '</div>' : '') +
          '<div class="refresh-controls">' +
            '<button class="btn-refresh" id="refresh-btn-' + data.ticker + '" onclick="triggerRefresh(\'' + data.ticker + '\')">' +
              '<span class="refresh-icon">&#8635;</span> Update' +
            '</button>' +
            '<span class="refresh-timestamp" id="refresh-ts-' + data.ticker + '">' +
              (data.date ? 'Last updated: ' + data.date : '') +
            '</span>' +
            '<div class="refresh-progress" id="refresh-progress-' + data.ticker + '" style="display:none">' +
              '<div class="progress-bar"><div class="progress-fill" id="refresh-fill-' + data.ticker + '"></div></div>' +
              '<span class="progress-label" id="refresh-label-' + data.ticker + '">Searching for new data...</span>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="rh-right">' +
          sparklineHtml +
          '<div class="rh-price"><span class="rh-price-currency">' + data.currency + '</span>' + data.price + '</div>' +
          '<div class="rh-metrics">' + metricsHtml + '</div>' +
        '</div>' +
      '</div>' +
    '</div>' +
  '</div>' +
  (embeddedThesisHtml || positionInRangeHtml || valuationRangeHtml || skewIndicatorHtml || nextDecisionHtml
    ? '<div class="rh-spec-section"><div class="report-hero-inner">' +
        embeddedThesisHtml +
        positionInRangeHtml +
        valuationRangeHtml +
        skewIndicatorHtml +
        nextDecisionHtml +
      '</div></div>'
    : '');
}

function renderSkewBar(data) {
  var skew = data._skew || computeSkewScore(data);
  var dir = skew.direction;
  var arrow = dir === 'downside' ? '&#9660; DOWNSIDE' : dir === 'upside' ? '&#9650; UPSIDE' : '&#9670; BALANCED';
  var scoreCls = skew.score > 5 ? 'positive' : skew.score < -5 ? 'negative' : 'neutral';
  var scoreLabel = (skew.score > 0 ? '+' : '') + skew.score;

  return '<div class="risk-skew-bar">' +
    '<div class="rsb-inner">' +
      '<span class="rsb-label">Thesis Skew</span>' +
      '<span class="skew-badge ' + dir + '">' + arrow + '</span>' +
      '<div class="skew-bar-track" style="width:80px;height:10px;margin:0 4px">' +
        '<div class="skew-bar-bull" style="width:' + skew.bull + '%"></div>' +
        '<div class="skew-bar-bear" style="width:' + skew.bear + '%"></div>' +
      '</div>' +
      '<span class="skew-score ' + scoreCls + '" style="font-size:0.82rem">' + scoreLabel + '</span>' +
      '<span class="rsb-rationale">' + data.skew.rationale + '</span>' +
    '</div>' +
  '</div>';
}

function renderVerdict(data) {
  var v = data.verdict;
  var borderStyle = v.borderColor ? ' style="border-color: ' + v.borderColor + '"' : '';
  var norm = normaliseScores(v.scores);

  var scoresHtml = '';
  for (var i = 0; i < v.scores.length; i++) {
    var s = v.scores[i];
    var dirStyle = s.dirColor ? ' style="color:' + s.dirColor + '"' : '';
    var dirAttr = data.hypotheses[i] ? ' data-dir="' + (data.hypotheses[i].dirClass || 'dir-neutral') + '"' : '';
    scoresHtml += '<div class="vs-item"' + dirAttr + '>' +
      '<div class="vs-label">' + s.label + '</div>' +
      '<div class="vs-score" style="color:' + s.scoreColor + '">' + norm[i] + '%</div>' +
      '<div class="vs-direction"' + dirStyle + '>' + s.dirArrow + ' ' + s.dirText + '</div>' +
    '</div>';
  }

  return '<div class="verdict-section">' +
    '<div class="verdict-inner"' + borderStyle + '>' +
      '<div class="verdict-text">' + v.text + '</div>' +
      '<div class="verdict-scores">' + scoresHtml + '</div>' +
    '</div>' +
  '</div>';
}

function renderSectionNav(data) {
  var t = data.ticker.toLowerCase();
  var sections = [
    ['identity', 'Identity'],
    ['hypotheses', 'Hypotheses'],
    ['narrative-timeline', 'Timeline'],
    ['narrative', 'Narrative'],
    ['evidence', 'Evidence'],
    ['discriminates', 'Discriminates'],
    ['tripwires', 'Tripwires'],
    ['gaps', 'Gaps'],
    ['technical', 'Technical'],
    ['chat', 'Research Chat']
  ];

  // Only include Technical if data exists
  if (!data.technicalAnalysis) {
    sections.splice(sections.length - 2, 1); // remove technical, keep chat
  }

  var linksHtml = '';
  for (var i = 0; i < sections.length; i++) {
    var activeClass = i === 0 ? ' class="active"' : '';
    linksHtml += '<a href="#' + t + '-' + sections[i][0] + '"' + activeClass + '>' + sections[i][1] + '</a>';
  }

  return '<div class="section-nav">' +
    '<div class="section-nav-inner">' + linksHtml + '</div>' +
  '</div>';
}

function renderIdentity(data) {
  var t = data.ticker.toLowerCase();
  var id = data.identity;

  var rowsHtml = '';
  for (var i = 0; i < id.rows.length; i++) {
    var row = id.rows[i];
    var left = row[0];
    var right = row[1];
    rowsHtml += '<tr>' +
      '<td class="td-label">' + left[0] + '</td>' +
      '<td' + (left[2] ? ' class="' + left[2] + '"' : '') + '>' + left[1] + '</td>' +
      '<td class="td-label">' + right[0] + '</td>' +
      '<td' + (right[2] ? ' class="' + right[2] + '"' : '') + '>' + right[1] + '</td>' +
    '</tr>';
  }

  return '<div class="report-section" id="' + t + '-identity">' +
    RS_HDR('Section 01', 'Identity &amp; Snapshot') +
    '<div class="rs-body">' +
    '<table class="identity-table">' +
      '<thead><tr><th>Metric</th><th>Value</th><th>Metric</th><th>Value</th></tr></thead>' +
      '<tbody>' + rowsHtml + '</tbody>' +
    '</table>' +
    '<p class="rs-text"><strong>Business overview:</strong> ' + id.overview + '</p>' +
  '</div></div>';
}

function renderHypotheses(data) {
  var t = data.ticker.toLowerCase();
  var cardsHtml = '';
  var norm = normaliseScores(data.hypotheses);

  for (var i = 0; i < data.hypotheses.length; i++) {
    var h = data.hypotheses[i];
    var normScore = norm[i] + '%';
    var normWidth = norm[i] + '%';

    // Requires section (only N1 typically has this)
    var requiresHtml = '';
    if (h.requires && h.requires.length > 0) {
      requiresHtml = '<div class="hc-subtitle">Requires</div><ul class="hc-list requires">';
      for (var r = 0; r < h.requires.length; r++) {
        requiresHtml += '<li>' + h.requires[r] + '</li>';
      }
      requiresHtml += '</ul>';
    }

    // Supporting evidence (may be null for some hypotheses)
    var supportHtml = '';
    if (h.supporting && h.supporting.length > 0) {
      supportHtml = '<div class="hc-subtitle">' + h.supportingLabel + '</div><ul class="hc-list supports">';
      for (var s = 0; s < h.supporting.length; s++) {
        supportHtml += '<li>' + h.supporting[s] + '</li>';
      }
      supportHtml += '</ul>';
    }

    // Contradicting evidence (may be null for some hypotheses)
    var contradictHtml = '';
    if (h.contradicting && h.contradicting.length > 0) {
      contradictHtml = '<div class="hc-subtitle">' + h.contradictingLabel + '</div><ul class="hc-list contradicts">';
      for (var c = 0; c < h.contradicting.length; c++) {
        contradictHtml += '<li>' + h.contradicting[c] + '</li>';
      }
      contradictHtml += '</ul>';
    }

    var dominantCls = (i === 0) ? ' dominant' : '';
    cardsHtml += '<div class="hyp-card ' + h.dirClass + dominantCls + '">' +
      '<div class="hc-header"><div class="hc-title">' + h.title + '</div><div class="hc-status ' + h.statusClass + '">' + h.statusText + '</div></div>' +
      '<div class="hc-score-row"><div class="hc-score-number">' + normScore + '</div><div class="hc-score-bar"><div class="hc-score-fill" style="width:' + normWidth + '"></div></div><div class="hc-score-meta">' + h.scoreMeta + '</div></div>' +
      '<p class="hc-desc">' + h.description + '</p>' +
      requiresHtml +
      supportHtml +
      contradictHtml +
    '</div>';
  }

  return '<div class="report-section" id="' + t + '-hypotheses">' +
    RS_HDR('Section 02', 'Competing Hypotheses') +
    '<div class="rs-body">' +
    cardsHtml +
  '</div></div>';
}

function renderNarrative(data) {
  var t = data.ticker.toLowerCase();
  var n = data.narrative;

  return '<div class="report-section" id="' + t + '-narrative">' +
    RS_HDR('Section 03', 'Dominant Narrative') +
    '<div class="rs-body">' +
    '<div class="rs-subtitle">The Narrative</div>' +
    '<p class="rs-text">' + n.theNarrative + '</p>' +
    '<div class="rs-subtitle">The Price Implication</div>' +
    '<div class="callout">' +
      '<div class="callout-label">' + n.priceImplication.label + '</div>' +
      '<p>' + n.priceImplication.content + '</p>' +
    '</div>' +
    '<div class="rs-subtitle">The Evidence Check</div>' +
    '<p class="rs-text">' + n.evidenceCheck + '</p>' +
    '<div class="rs-subtitle">Narrative Stability</div>' +
    '<p class="rs-text">' + n.narrativeStability + '</p>' +
  '</div></div>';
}

function renderEvidenceCard(card) {
  // Table (rendered before finding if present)
  var tableHtml = '';
  if (card.table) {
    var thHtml = '';
    for (var h = 0; h < card.table.headers.length; h++) {
      thHtml += '<th>' + card.table.headers[h] + '</th>';
    }
    var tbHtml = '';
    for (var r = 0; r < card.table.rows.length; r++) {
      tbHtml += '<tr>';
      for (var c = 0; c < card.table.rows[r].length; c++) {
        tbHtml += '<td>' + card.table.rows[r][c] + '</td>';
      }
      tbHtml += '</tr>';
    }
    tableHtml = '<table class="identity-table" style="margin-bottom:var(--space-md)">' +
      '<thead><tr>' + thHtml + '</tr></thead>' +
      '<tbody>' + tbHtml + '</tbody>' +
    '</table>';
  }

  // Tension block
  var tensionHtml = '';
  if (card.tension) {
    tensionHtml = '<div class="ec-tension">' +
      '<div class="ec-tension-label">Key Tension</div>' +
      '<p>' + card.tension + '</p>' +
    '</div>';
  }

  // Tags
  var tagsHtml = '';
  for (var t = 0; t < card.tags.length; t++) {
    tagsHtml += '<span class="ec-tag ' + card.tags[t].class + '">' + card.tags[t].text + '</span>';
  }

  return '<div class="evidence-card">' +
    '<div class="ec-header">' +
      '<div class="ec-title">' + card.title + '</div>' +
      '<div class="ec-header-right">' +
        '<span class="ec-epistemic ' + card.epistemicClass + '">' + card.epistemicLabel + '</span>' +
        '<span class="ec-toggle">&#9660;</span>' +
      '</div>' +
    '</div>' +
    '<div class="ec-body">' +
      tableHtml +
      '<div class="ec-finding">' + card.finding + '</div>' +
      tensionHtml +
      '<div class="ec-footer">' +
        '<div class="ec-tags">' + tagsHtml + '</div>' +
        '<div class="ec-source">' + card.source + '</div>' +
      '</div>' +
    '</div>' +
  '</div>';
}

function renderAlignmentSummary(data) {
  if (!data.evidence.alignmentSummary) return '';

  var as = data.evidence.alignmentSummary;

  // Header row
  var thHtml = '';
  for (var h = 0; h < as.headers.length; h++) {
    thHtml += '<th>' + as.headers[h] + '</th>';
  }

  // Data rows
  var tbHtml = '';
  for (var i = 0; i < as.rows.length; i++) {
    var row = as.rows[i];

    var cellFn = function(cell) {
      var styleAttr = cell.style ? ' style="' + cell.style + '"' : '';
      return '<td class="' + cell.class + '"' + styleAttr + '>' + cell.text + '</td>';
    };

    tbHtml += '<tr>' +
      '<td>' + row.domain + '</td>' +
      '<td style="color:var(--text-muted)">' + row.epistemic + '</td>' +
      cellFn(row.n1) +
      cellFn(row.n2) +
      cellFn(row.n3) +
      cellFn(row.n4) +
    '</tr>';
  }

  // Summary row
  var sum = as.summary;
  tbHtml += '<tr style="font-weight:700">' +
    '<td>Domain Count</td>' +
    '<td></td>' +
    '<td style="font-family:var(--font-data)">' + sum.n1 + '</td>' +
    '<td style="font-family:var(--font-data)' + (sum.n2Color ? ';color:' + sum.n2Color : '') + '">' + sum.n2 + '</td>' +
    '<td style="font-family:var(--font-data)' + (sum.n3Color ? ';color:' + sum.n3Color : '') + '">' + sum.n3 + '</td>' +
    '<td style="font-family:var(--font-data)">' + sum.n4 + '</td>' +
  '</tr>';

  return '<div class="rs-subtitle">Evidence Alignment Summary</div>' +
    '<table class="evidence-table">' +
      '<thead><tr>' + thHtml + '</tr></thead>' +
      '<tbody>' + tbHtml + '</tbody>' +
    '</table>';
}

function renderEvidence(data) {
  var t = data.ticker.toLowerCase();
  var ev = data.evidence;

  var cardsHtml = '';
  for (var i = 0; i < ev.cards.length; i++) {
    cardsHtml += renderEvidenceCard(ev.cards[i]);
  }

  var alignmentHtml = renderAlignmentSummary(data);

  return '<div class="report-section" id="' + t + '-evidence">' +
    RS_HDR('Section 04', 'Cross-Domain Evidence Synthesis') +
    '<div class="rs-body">' +
    '<p class="rs-text">' + ev.intro + '</p>' +
    cardsHtml +
    alignmentHtml +
  '</div></div>';
}

function renderDiscriminators(data) {
  var t = data.ticker.toLowerCase();
  var d = data.discriminators;

  var rowsHtml = '';
  for (var i = 0; i < d.rows.length; i++) {
    var r = d.rows[i];
    rowsHtml += '<tr>' +
      '<td><span class="' + r.diagnosticityClass + '">' + r.diagnosticity + '</span></td>' +
      '<td>' + r.evidence + '</td>' +
      '<td>' + r.discriminatesBetween + '</td>' +
      '<td class="' + r.readingClass + '">' + r.currentReading + '</td>' +
    '</tr>';
  }

  return '<div class="report-section" id="' + t + '-discriminates">' +
    RS_HDR('Section 05', 'What Discriminates') +
    '<div class="rs-body">' +
    '<p class="rs-text">' + d.intro + '</p>' +
    '<table class="disc-table">' +
      '<thead><tr><th>Diagnosticity</th><th>Evidence</th><th>Discriminates Between</th><th>Current Reading</th></tr></thead>' +
      '<tbody>' + rowsHtml + '</tbody>' +
    '</table>' +
    '<div class="callout warn">' +
      '<div class="callout-label">Non-Discriminating Evidence &mdash; Assessed &amp; Discarded</div>' +
      '<p>' + d.nonDiscriminating + '</p>' +
    '</div>' +
  '</div></div>';
}

function renderTripwires(data) {
  var t = data.ticker.toLowerCase();
  var tw = data.tripwires;

  var cardsHtml = '';
  for (var i = 0; i < tw.cards.length; i++) {
    var card = tw.cards[i];

    var conditionsHtml = '';
    for (var c = 0; c < card.conditions.length; c++) {
      var cond = card.conditions[c];
      conditionsHtml += '<div class="tw-condition">' +
        '<div class="tw-cond-if ' + cond.valence + '">' + cond.if + '</div>' +
        '<div class="tw-cond-then">' + cond.then + '</div>' +
      '</div>';
    }

    var resolvedCls = card.name.indexOf('RESOLVED') >= 0 ? ' tw-resolved' : '';

    cardsHtml += '<div class="tw-card' + resolvedCls + '">' +
      '<div class="tw-header"><div class="tw-date">' + card.date + '</div><div class="tw-name">' + card.name + '</div></div>' +
      '<div class="tw-conditions">' + conditionsHtml + '</div>' +
      '<div class="tw-source">' + (card.source || '') + '</div>' +
    '</div>';
  }

  return '<div class="report-section" id="' + t + '-tripwires">' +
    RS_HDR('Section 06', 'What We\'re Watching') +
    '<div class="rs-body">' +
    '<p class="rs-text">' + tw.intro + '</p>' +
    cardsHtml +
  '</div></div>';
}

function renderGaps(data) {
  var t = data.ticker.toLowerCase();
  var g = data.gaps;

  // Coverage table
  var coverageHtml = '';
  for (var i = 0; i < g.coverageRows.length; i++) {
    var r = g.coverageRows[i];
    var confClass = r.confidenceClass ? ' class="' + r.confidenceClass + '"' : '';
    coverageHtml += '<tr>' +
      '<td>' + r.domain + '</td>' +
      '<td><span class="gap-dot ' + r.coverageLevel + '"></span>' + r.coverageLabel + '</td>' +
      '<td style="font-family:var(--font-data)">' + r.freshness + '</td>' +
      '<td' + confClass + '>' + r.confidence + '</td>' +
    '</tr>';
  }

  // Couldn't assess callouts
  var calloutsHtml = '';
  for (var j = 0; j < g.couldntAssess.length; j++) {
    calloutsHtml += '<div class="callout"><p>' + g.couldntAssess[j] + '</p></div>';
  }

  return '<div class="report-section" id="' + t + '-gaps">' +
    RS_HDR('Section 07', 'Evidence Gaps &amp; Integrity Notes') +
    '<div class="rs-body">' +
    '<div class="rs-subtitle">Domain Coverage Assessment</div>' +
    '<table class="gaps-table">' +
      '<thead><tr><th>Domain</th><th>Coverage</th><th>Freshness</th><th>Confidence</th></tr></thead>' +
      '<tbody>' + coverageHtml + '</tbody>' +
    '</table>' +
    '<div class="rs-subtitle">What We Couldn\'t Assess</div>' +
    calloutsHtml +
    '<div class="rs-subtitle">Analytical Limitations</div>' +
    '<p class="rs-text">' + g.analyticalLimitations + '</p>' +
  '</div></div>';
}

function computeMA(arr, period) {
  var result = [];
  for (var i = 0; i < arr.length; i++) {
    if (i < period - 1) { result.push(null); continue; }
    var sum = 0;
    for (var j = i - period + 1; j <= i; j++) sum += arr[j];
    result.push(sum / period);
  }
  return result;
}

function renderTAChart(data) {
  var ta = data.technicalAnalysis;
  var live = data._liveChart;
  var liveTA = data._liveTA;

  // Theme-aware colors
  var isLight = document.documentElement.getAttribute('data-theme') === 'light';
  var C = {
    bg: isLight ? '#FFFFFF' : '#0D1726',
    grid: isLight ? '#E2E8F0' : '#1E3050',
    axisText: isLight ? '#718096' : '#566882',
    price: isLight ? '#1A1F2E' : '#E8EDF4',
    priceGradA: isLight ? '#1A1F2E' : '#E8EDF4',
    hlBand: isLight ? '#1A1F2E' : '#E8EDF4',
    legendText: isLight ? '#4A5568' : '#8B9AB8',
    dot: isLight ? '#1A1F2E' : '#E8EDF4',
    dotStroke: isLight ? '#FFFFFF' : '#0D1726'
  };

  // Determine data source: live OHLCV bars or static priceHistory
  var useLive = live && live.bars && live.bars.length > 100;
  var bars = useLive ? live.bars : null;
  var closes = useLive ? bars.map(function(b){ return b.close; }) : data.priceHistory;
  var highs = useLive ? bars.map(function(b){ return b.high; }) : null;
  var lows = useLive ? bars.map(function(b){ return b.low; }) : null;

  if (!closes || closes.length < 20) return '';

  var n = closes.length;
  var ma50Arr = useLive && liveTA ? liveTA.ma50Arr : computeMA(closes, 50);
  var ma200Arr = useLive && liveTA ? liveTA.ma200Arr : computeMA(closes, 200);

  var chartTitle = useLive ? (n > 500 ? '3' : n > 250 ? '2' : '1') + '-Year Daily Price &amp; Moving Averages' : '12-Month Daily Price &amp; Moving Averages';
  var liveLabel = useLive ? '<span class="ta-chart-live-badge">LIVE</span>' : '<span class="ta-chart-static-badge">STATIC</span>';

  // Chart dimensions
  var W = 960, H = 380;
  var padL = 62, padR = 16, padT = 28, padB = 44;
  var cW = W - padL - padR;
  var cH = H - padT - padB;

  // Price range (include highs/lows/MAs)
  var allVals = closes.slice();
  if (highs) for (var i = 0; i < n; i++) { if (highs[i] != null) allVals.push(highs[i]); }
  if (lows) for (var i = 0; i < n; i++) { if (lows[i] != null) allVals.push(lows[i]); }
  for (var i = 0; i < n; i++) {
    if (ma50Arr[i] !== null) allVals.push(ma50Arr[i]);
    if (ma200Arr[i] !== null) allVals.push(ma200Arr[i]);
  }
  var pMin = Math.min.apply(null, allVals);
  var pMax = Math.max.apply(null, allVals);
  var pRange = pMax - pMin;
  pMin -= pRange * 0.05;
  pMax += pRange * 0.05;
  pRange = pMax - pMin;

  function xPos(idx) { return padL + (idx / (n - 1)) * cW; }
  function yPos(val) { return padT + (1 - (val - pMin) / pRange) * cH; }

  var supportPrice = ta ? parseFloat(ta.keyLevels.support.price) || null : null;
  var resistPrice = ta ? parseFloat(ta.keyLevels.resistance.price) || null : null;
  var curPrice = parseFloat(useLive && live.currentPrice ? live.currentPrice : data.price) || 0;
  var cur = data.currency;

  // Build SVG
  var svg = '<svg class="ta-chart-svg" viewBox="0 0 ' + W + ' ' + H + '" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">';
  svg += '<rect x="' + padL + '" y="' + padT + '" width="' + cW + '" height="' + cH + '" fill="' + C.bg + '" rx="2"/>';

  // Grid lines
  var gridStep = pRange / 5;
  var magnitude = Math.pow(10, Math.floor(Math.log10(gridStep)));
  var niceSteps = [1, 2, 2.5, 5, 10];
  var bestStep = magnitude;
  for (var s = 0; s < niceSteps.length; s++) {
    if (niceSteps[s] * magnitude >= gridStep) { bestStep = niceSteps[s] * magnitude; break; }
  }
  for (var gv = Math.ceil(pMin / bestStep) * bestStep; gv <= pMax; gv += bestStep) {
    var gy = yPos(gv);
    if (gy < padT || gy > padT + cH) continue;
    svg += '<line x1="' + padL + '" y1="' + gy.toFixed(1) + '" x2="' + (padL + cW) + '" y2="' + gy.toFixed(1) + '" stroke="' + C.grid + '" stroke-width="0.5"/>';
    svg += '<text x="' + (padL - 8) + '" y="' + (gy + 3.5).toFixed(1) + '" text-anchor="end" fill="' + C.axisText + '" font-family="JetBrains Mono, monospace" font-size="9">' + cur + gv.toFixed(gv >= 100 ? 0 : 2) + '</text>';
  }

  // Support / Resistance
  if (supportPrice && supportPrice >= pMin && supportPrice <= pMax) {
    var sy = yPos(supportPrice);
    svg += '<line x1="' + padL + '" y1="' + sy.toFixed(1) + '" x2="' + (padL + cW) + '" y2="' + sy.toFixed(1) + '" stroke="#3DAA6D" stroke-width="0.8" stroke-dasharray="6,4" opacity="0.6"/>';
    svg += '<text x="' + (padL + 4) + '" y="' + (sy - 4).toFixed(1) + '" fill="#3DAA6D" font-family="JetBrains Mono, monospace" font-size="7.5" opacity="0.8">S ' + cur + supportPrice.toFixed(2) + '</text>';
  }
  if (resistPrice && resistPrice >= pMin && resistPrice <= pMax) {
    var ry = yPos(resistPrice);
    svg += '<line x1="' + padL + '" y1="' + ry.toFixed(1) + '" x2="' + (padL + cW) + '" y2="' + ry.toFixed(1) + '" stroke="#D45555" stroke-width="0.8" stroke-dasharray="6,4" opacity="0.6"/>';
    svg += '<text x="' + (padL + 4) + '" y="' + (ry - 4).toFixed(1) + '" fill="#D45555" font-family="JetBrains Mono, monospace" font-size="7.5" opacity="0.8">R ' + cur + resistPrice.toFixed(2) + '</text>';
  }

  // High/Low range band (when live OHLCV available)
  if (highs && lows) {
    var hlUpper = '', hlLower = '';
    for (var i = 0; i < n; i++) {
      if (highs[i] == null || lows[i] == null) continue;
      var x = xPos(i).toFixed(1);
      hlUpper += (hlUpper === '' ? 'M' : 'L') + x + ',' + yPos(highs[i]).toFixed(1);
      hlLower = x + ',' + yPos(lows[i]).toFixed(1) + (hlLower === '' ? '' : 'L' + hlLower);
    }
    if (hlUpper && hlLower) {
      svg += '<path d="' + hlUpper + 'L' + hlLower + 'Z" fill="' + C.hlBand + '" opacity="' + (isLight ? '0.08' : '0.06') + '"/>';
    }
  }

  // 200-day MA
  var ma200Path = '';
  for (var i = 0; i < n; i++) {
    if (ma200Arr[i] === null) continue;
    ma200Path += (ma200Path === '' ? 'M' : 'L') + xPos(i).toFixed(1) + ',' + yPos(ma200Arr[i]).toFixed(1);
  }
  if (ma200Path) svg += '<path d="' + ma200Path + '" fill="none" stroke="#4A8ECC" stroke-width="1.3" opacity="0.8"/>';

  // 50-day MA
  var ma50Path = '';
  for (var i = 0; i < n; i++) {
    if (ma50Arr[i] === null) continue;
    ma50Path += (ma50Path === '' ? 'M' : 'L') + xPos(i).toFixed(1) + ',' + yPos(ma50Arr[i]).toFixed(1);
  }
  if (ma50Path) svg += '<path d="' + ma50Path + '" fill="none" stroke="#D4A03C" stroke-width="1.3" opacity="0.8"/>';

  // Price gradient fill
  var pricePath = 'M' + xPos(0).toFixed(1) + ',' + yPos(closes[0]).toFixed(1);
  for (var i = 1; i < n; i++) pricePath += 'L' + xPos(i).toFixed(1) + ',' + yPos(closes[i]).toFixed(1);
  var areaPath = pricePath + 'L' + xPos(n-1).toFixed(1) + ',' + (padT+cH) + 'L' + xPos(0).toFixed(1) + ',' + (padT+cH) + 'Z';
  svg += '<defs><linearGradient id="priceGrad-' + data.ticker + '" x1="0" y1="0" x2="0" y2="1">';
  svg += '<stop offset="0%" stop-color="' + C.priceGradA + '" stop-opacity="' + (isLight ? '0.1' : '0.08') + '"/>';
  svg += '<stop offset="100%" stop-color="' + C.priceGradA + '" stop-opacity="0.01"/>';
  svg += '</linearGradient></defs>';
  svg += '<path d="' + areaPath + '" fill="url(#priceGrad-' + data.ticker + ')"/>';

  // Price line
  svg += '<path d="' + pricePath + '" fill="none" stroke="' + C.price + '" stroke-width="1.4"/>';

  // Current price dot + label
  var lastX = xPos(n - 1), lastY = yPos(closes[n-1]);
  svg += '<circle cx="' + lastX.toFixed(1) + '" cy="' + lastY.toFixed(1) + '" r="3.5" fill="' + C.dot + '" stroke="' + C.dotStroke + '" stroke-width="1.5"/>';
  var labelX = lastX + 8 > W - padR - 60 ? lastX - 65 : lastX + 8;
  svg += '<text x="' + labelX.toFixed(1) + '" y="' + (lastY + 3).toFixed(1) + '" fill="' + C.dot + '" font-family="JetBrains Mono, monospace" font-size="9" font-weight="600">' + cur + curPrice.toFixed(2) + '</text>';

  // X-axis  --  real dates when live, estimated when static
  var monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  if (useLive) {
    // Use actual dates from bars
    var lastMonth = -1, lastYear = -1;
    var step = Math.max(1, Math.floor(n / 36)); // ~36 labels max
    for (var i = 0; i < n; i += step) {
      var d = bars[i].date;
      var mm = d.getMonth(), yy = d.getFullYear();
      if (mm === lastMonth && yy === lastYear) continue;
      lastMonth = mm; lastYear = yy;
      var lx = xPos(i);
      if (lx < padL + 15 || lx > padL + cW - 15) continue;
      var label = monthNames[mm];
      if (mm === 0 || (i < step * 2)) label += " '" + String(yy).slice(2);
      svg += '<text x="' + lx.toFixed(1) + '" y="' + (padT + cH + 22) + '" text-anchor="middle" fill="' + C.axisText + '" font-family="JetBrains Mono, monospace" font-size="7.5">' + label + '</text>';
      svg += '<line x1="' + lx.toFixed(1) + '" y1="' + (padT + cH) + '" x2="' + lx.toFixed(1) + '" y2="' + (padT + cH + 4) + '" stroke="' + C.grid + '" stroke-width="0.5"/>';
    }
  } else {
    // Estimated months from report date
    var reportDate = new Date(data.date);
    var tradingDaysPerMonth = n / 12;
    for (var m = 0; m <= 11; m++) {
      var idx = Math.round(m * tradingDaysPerMonth);
      if (idx >= n) idx = n - 1;
      var labelDate = new Date(reportDate);
      labelDate.setMonth(labelDate.getMonth() - (11 - m));
      var label = monthNames[labelDate.getMonth()];
      if (labelDate.getMonth() === 0) label += " '" + String(labelDate.getFullYear()).slice(2);
      var lx = xPos(idx);
      if (lx < padL + 15 || lx > padL + cW - 15) continue;
      svg += '<text x="' + lx.toFixed(1) + '" y="' + (padT + cH + 22) + '" text-anchor="middle" fill="' + C.axisText + '" font-family="JetBrains Mono, monospace" font-size="7.5">' + label + '</text>';
      svg += '<line x1="' + lx.toFixed(1) + '" y1="' + (padT + cH) + '" x2="' + lx.toFixed(1) + '" y2="' + (padT + cH + 4) + '" stroke="' + C.grid + '" stroke-width="0.5"/>';
    }
  }

  // Legend row
  var lx0 = padL + 8;
  svg += '<circle cx="' + lx0 + '" cy="14" r="3" fill="' + C.dot + '"/>';
  svg += '<text x="' + (lx0+8) + '" y="17" fill="' + C.legendText + '" font-family="Inter, sans-serif" font-size="8">Price</text>';
  if (highs) {
    svg += '<rect x="' + (lx0+44) + '" y="10" width="16" height="8" rx="1" fill="' + C.hlBand + '" opacity="0.12"/>';
    svg += '<text x="' + (lx0+64) + '" y="17" fill="' + C.legendText + '" font-family="Inter, sans-serif" font-size="8">High/Low</text>';
    lx0 += 56;
  }
  svg += '<line x1="' + (lx0+52) + '" y1="14" x2="' + (lx0+68) + '" y2="14" stroke="#D4A03C" stroke-width="1.5"/>';
  svg += '<text x="' + (lx0+72) + '" y="17" fill="' + C.legendText + '" font-family="Inter, sans-serif" font-size="8">50d MA</text>';
  svg += '<line x1="' + (lx0+112) + '" y1="14" x2="' + (lx0+128) + '" y2="14" stroke="#4A8ECC" stroke-width="1.5"/>';
  svg += '<text x="' + (lx0+132) + '" y="17" fill="' + C.legendText + '" font-family="Inter, sans-serif" font-size="8">200d MA</text>';
  svg += '<line x1="' + (lx0+182) + '" y1="14" x2="' + (lx0+198) + '" y2="14" stroke="#3DAA6D" stroke-width="1" stroke-dasharray="4,3"/>';
  svg += '<text x="' + (lx0+202) + '" y="17" fill="' + C.legendText + '" font-family="Inter, sans-serif" font-size="8">Support</text>';
  svg += '<line x1="' + (lx0+242) + '" y1="14" x2="' + (lx0+258) + '" y2="14" stroke="#D45555" stroke-width="1" stroke-dasharray="4,3"/>';
  svg += '<text x="' + (lx0+262) + '" y="17" fill="' + C.legendText + '" font-family="Inter, sans-serif" font-size="8">Resistance</text>';

  svg += '</svg>';

  return '<div class="ta-chart-container">' +
    '<div class="ta-chart-header"><div class="ta-chart-title">' + chartTitle + '</div>' + liveLabel + '</div>' +
    svg +
  '</div>';
}

function renderTechnicalAnalysis(data) {
  if (!data.technicalAnalysis) return '';
  var t = data.ticker.toLowerCase();
  var ta = data.technicalAnalysis;

  // Chart at the top
  var chartHtml = renderTAChart(data);

  // Regime bar  --  categorical labels + key levels
  var regimeHtml = '<div class="ta-regime-bar">' +
    '<div class="ta-regime-item"><div class="ta-regime-label">Regime</div><div class="ta-regime-value">' + ta.regime + '</div></div>' +
    '<div class="ta-regime-item"><div class="ta-regime-label">Clarity</div><div class="ta-regime-value">' + ta.clarity + '</div></div>' +
    '<div class="ta-regime-item"><div class="ta-regime-label">Trend</div><div class="ta-regime-value ' + (/down/i.test(ta.trend.direction) ? 'ta-down' : /up|recover/i.test(ta.trend.direction) ? 'ta-up' : '') + '">' + ta.trend.direction + ' (' + ta.trend.duration + ')</div></div>' +
    '<div class="ta-regime-item"><div class="ta-regime-label">Structure</div><div class="ta-regime-value">' + ta.trend.structure + '</div></div>' +
    '<div class="ta-regime-item"><div class="ta-regime-label">Support</div><div class="ta-regime-value">' + ta.price.currency + ta.keyLevels.support.price.toFixed(2) + '</div></div>' +
    '<div class="ta-regime-item"><div class="ta-regime-label">Resistance</div><div class="ta-regime-value">' + ta.price.currency + ta.keyLevels.resistance.price.toFixed(2) + '</div></div>' +
  '</div>';

  // Moving averages table
  var maHtml = '<div class="rs-subtitle">Moving Averages</div>' +
    '<table class="ta-ma-table"><thead><tr>' +
      '<th>Measure</th><th>Value</th><th>Price vs MA</th><th>Note</th>' +
    '</tr></thead><tbody>' +
    '<tr>' +
      '<td class="ta-label-cell">50-Day MA</td>' +
      '<td>' + ta.price.currency + ta.movingAverages.ma50.value.toFixed(2) + '</td>' +
      '<td style="color:' + (ta.movingAverages.priceVsMa50 >= 0 ? 'var(--signal-green)' : 'var(--signal-red)') + '">' + (ta.movingAverages.priceVsMa50 >= 0 ? '+' : '') + ta.movingAverages.priceVsMa50.toFixed(1) + '%</td>' +
      '<td>As at ' + ta.movingAverages.ma50.date + '</td>' +
    '</tr>' +
    '<tr>' +
      '<td class="ta-label-cell">200-Day MA</td>' +
      '<td>' + ta.price.currency + ta.movingAverages.ma200.value.toFixed(2) + '</td>' +
      '<td style="color:' + (ta.movingAverages.priceVsMa200 >= 0 ? 'var(--signal-green)' : 'var(--signal-red)') + '">' + (ta.movingAverages.priceVsMa200 >= 0 ? '+' : '') + ta.movingAverages.priceVsMa200.toFixed(1) + '%</td>' +
      '<td>As at ' + ta.movingAverages.ma200.date + '</td>' +
    '</tr>' +
    '</tbody></table>';

  // Crossover callout
  var crossoverHtml = '';
  if (ta.movingAverages.crossover) {
    var cx = ta.movingAverages.crossover;
    crossoverHtml = '<div class="ta-crossover-callout">' +
      '<div class="ta-crossover-label">' + cx.type + '</div>' +
      '<div class="ta-crossover-text">' + cx.description + ' &mdash; ' + cx.date + '</div>' +
    '</div>';
  }

  // Inflection points table
  var inflHtml = '';
  if (ta.inflectionPoints && ta.inflectionPoints.length > 0) {
    var inflRows = '';
    for (var i = 0; i < ta.inflectionPoints.length; i++) {
      var ip = ta.inflectionPoints[i];
      inflRows += '<tr>' +
        '<td class="ta-date-cell">' + ip.date + '</td>' +
        '<td class="ta-price-cell">' + ta.price.currency + ip.price.toFixed(2) + '</td>' +
        '<td class="ta-event-cell">' + ip.event + '</td>' +
      '</tr>';
    }
    inflHtml = '<div class="rs-subtitle">Price Inflection Points</div>' +
      '<table class="ta-inflection-table"><thead><tr>' +
        '<th>Date</th><th>Price</th><th>Observation</th>' +
      '</tr></thead><tbody>' + inflRows + '</tbody></table>';
  }

  // Volume & Volatility metrics
  var volHtml = '<div class="ta-metrics-grid">' +
    '<div class="ta-metric-card">' +
      '<div class="ta-metric-card-title">Volume</div>' +
      '<div class="ta-metric-row"><div class="ta-metric-name">Latest vs 20-day avg</div><div class="ta-metric-val">' + ta.volume.latestVs20DayAvg.toFixed(1) + 'x</div></div>' +
      '<div class="ta-metric-row"><div class="ta-metric-name">Date</div><div class="ta-metric-val">' + ta.volume.latestDate + '</div></div>';
  if (ta.volume.priorSpikes) {
    for (var v = 0; v < ta.volume.priorSpikes.length; v++) {
      var sp = ta.volume.priorSpikes[v];
      volHtml += '<div class="ta-metric-row"><div class="ta-metric-name">' + sp.period + '</div><div class="ta-metric-val">' + sp.ratio.toFixed(1) + 'x &mdash; ' + sp.context + '</div></div>';
    }
  }
  volHtml += '</div>' +
    '<div class="ta-metric-card">' +
      '<div class="ta-metric-card-title">Volatility</div>' +
      '<div class="ta-metric-row"><div class="ta-metric-name">Latest daily range</div><div class="ta-metric-val">' + ta.volatility.latestRangePercent.toFixed(1) + '%</div></div>' +
      '<div class="ta-metric-row"><div class="ta-metric-name">30-day avg range</div><div class="ta-metric-val">' + ta.volatility.avgDailyRangePercent30.toFixed(1) + '%</div></div>' +
      '<div class="ta-metric-row"><div class="ta-metric-name">90-day avg range</div><div class="ta-metric-val">' + ta.volatility.avgDailyRangePercent90.toFixed(1) + '%</div></div>' +
      '<div class="ta-metric-row"><div class="ta-metric-name">Latest session</div><div class="ta-metric-val">' + ta.price.currency + ta.volatility.latestDailyRange.high.toFixed(2) + ' &ndash; ' + ta.price.currency + ta.volatility.latestDailyRange.low.toFixed(2) + '</div></div>' +
    '</div>' +
  '</div>';

  // Mean reversion positioning
  var mr = ta.meanReversion;
  var rangeSpan = mr.rangeHigh - mr.rangeLow;
  var pricePct = rangeSpan > 0 ? ((ta.price.current - mr.rangeLow) / rangeSpan) * 100 : 50;
  var ma50Pct = rangeSpan > 0 ? ((ta.movingAverages.ma50.value - mr.rangeLow) / rangeSpan) * 100 : 50;
  var ma200Pct = rangeSpan > 0 ? ((ta.movingAverages.ma200.value - mr.rangeLow) / rangeSpan) * 100 : 50;

  var mrHtml = '<div class="ta-mr-container">' +
    '<div class="ta-mr-title">Mean Reversion Positioning</div>' +
    '<div class="ta-mr-bar-track">' +
      '<div class="ta-mr-ma200-marker" style="left:' + ma200Pct.toFixed(1) + '%"></div>' +
      '<div class="ta-mr-ma50-marker" style="left:' + ma50Pct.toFixed(1) + '%"></div>' +
      '<div class="ta-mr-marker" style="left:' + pricePct.toFixed(1) + '%"></div>' +
    '</div>' +
    '<div class="ta-mr-bar-labels">' +
      '<span>' + ta.price.currency + mr.rangeLow.toFixed(2) + '</span>' +
      '<span>' + ta.price.currency + mr.rangeHigh.toFixed(2) + '</span>' +
    '</div>' +
    '<div class="ta-mr-legend">' +
      '<div class="ta-mr-legend-item"><div class="ta-mr-legend-dot" style="background:var(--signal-red)"></div>Price (' + ta.price.currency + ta.price.current.toFixed(2) + ')</div>' +
      '<div class="ta-mr-legend-item"><div class="ta-mr-legend-dot" style="background:var(--signal-amber)"></div>50-Day MA (' + ta.price.currency + ta.movingAverages.ma50.value.toFixed(2) + ')</div>' +
      '<div class="ta-mr-legend-item"><div class="ta-mr-legend-dot" style="background:var(--signal-blue)"></div>200-Day MA (' + ta.price.currency + ta.movingAverages.ma200.value.toFixed(2) + ')</div>' +
    '</div>' +
    '<table class="ta-ma-table" style="margin-top:var(--space-sm)"><thead><tr><th>Measure</th><th>Value</th></tr></thead><tbody>' +
      '<tr><td class="ta-label-cell">vs 50-Day MA</td><td style="color:var(--signal-red)">' + mr.vsMa50.toFixed(1) + '%</td></tr>' +
      '<tr><td class="ta-label-cell">vs 200-Day MA</td><td style="color:var(--signal-red)">' + mr.vsMa200.toFixed(1) + '%</td></tr>' +
      '<tr><td class="ta-label-cell">12-Month Range Position</td><td>' + (mr.rangePosition <= 50 ? 'Lower ' : 'Upper ') + mr.rangePosition + '%</td></tr>' +
    '</tbody></table>' +
  '</div>';

  // Relative performance table
  var relHtml = '';
  if (ta.relativePerformance) {
    var rp = ta.relativePerformance;
    relHtml = '<div class="rs-subtitle">Relative Performance (' + rp.vsIndex.period + ')</div>' +
      '<table class="ta-rel-table"><thead><tr>' +
        '<th>Benchmark</th><th>Stock Return</th><th>Benchmark Return</th><th>Relative</th>' +
      '</tr></thead><tbody>' +
      '<tr>' +
        '<td style="font-family:var(--font-ui);font-weight:600;color:var(--text-primary)">' + rp.vsIndex.name + '</td>' +
        '<td style="color:' + (rp.vsIndex.stockReturn >= 0 ? 'var(--signal-green)' : 'var(--signal-red)') + '">' + (rp.vsIndex.stockReturn >= 0 ? '+' : '') + rp.vsIndex.stockReturn.toFixed(1) + '%</td>' +
        '<td style="color:' + (rp.vsIndex.indexReturn >= 0 ? 'var(--signal-green)' : 'var(--signal-red)') + '">' + (rp.vsIndex.indexReturn >= 0 ? '+' : '') + rp.vsIndex.indexReturn.toFixed(1) + '%</td>' +
        '<td style="color:' + (rp.vsIndex.relativeReturn >= 0 ? 'var(--signal-green)' : 'var(--signal-red)') + '">' + (rp.vsIndex.relativeReturn >= 0 ? '+' : '') + rp.vsIndex.relativeReturn.toFixed(1) + '%</td>' +
      '</tr>' +
      '<tr>' +
        '<td style="font-family:var(--font-ui);font-weight:600;color:var(--text-primary)">' + rp.vsSector.name + '</td>' +
        '<td style="color:' + (rp.vsSector.stockReturn >= 0 ? 'var(--signal-green)' : 'var(--signal-red)') + '">' + (rp.vsSector.stockReturn >= 0 ? '+' : '') + rp.vsSector.stockReturn.toFixed(1) + '%</td>' +
        '<td style="color:' + (rp.vsSector.sectorReturn >= 0 ? 'var(--signal-green)' : 'var(--signal-red)') + '">' + (rp.vsSector.sectorReturn >= 0 ? '+' : '') + rp.vsSector.sectorReturn.toFixed(1) + '%</td>' +
        '<td style="color:' + (rp.vsSector.relativeReturn >= 0 ? 'var(--signal-green)' : 'var(--signal-red)') + '">' + (rp.vsSector.relativeReturn >= 0 ? '+' : '') + rp.vsSector.relativeReturn.toFixed(1) + '%</td>' +
      '</tr>' +
      '</tbody></table>';
  }

  // Key levels with methodology
  var levelsHtml = '<div class="rs-subtitle">Key Levels</div>' +
    '<table class="ta-ma-table"><thead><tr><th>Level</th><th>Price</th><th>Derivation</th></tr></thead><tbody>' +
    '<tr><td class="ta-label-cell">Support</td><td>' + ta.price.currency + ta.keyLevels.support.price.toFixed(2) + '</td><td style="font-family:var(--font-ui)">' + ta.keyLevels.support.method + '</td></tr>' +
    '<tr><td class="ta-label-cell">Resistance</td><td>' + ta.price.currency + ta.keyLevels.resistance.price.toFixed(2) + '</td><td style="font-family:var(--font-ui)">' + ta.keyLevels.resistance.method + '</td></tr>' +
    '<tr><td class="ta-label-cell">52-Week High</td><td>' + ta.price.currency + ta.keyLevels.fiftyTwoWeekHigh.price.toFixed(2) + '</td><td style="font-family:var(--font-ui)">' + ta.keyLevels.fiftyTwoWeekHigh.date + '</td></tr>' +
    '<tr><td class="ta-label-cell">52-Week Low</td><td>' + ta.price.currency + ta.keyLevels.fiftyTwoWeekLow.price.toFixed(2) + '</td><td style="font-family:var(--font-ui)">' + ta.keyLevels.fiftyTwoWeekLow.date + '</td></tr>' +
    '</tbody></table>';

  // Source & period footer
  var footerHtml = '<div style="font-size:0.6rem;color:var(--text-muted);margin-top:var(--space-md);padding-top:var(--space-sm);border-top:1px solid var(--border)">' +
    'Analysis period: ' + ta.period + ' &bull; Generated: ' + ta.date + ' &bull; Source: ' + (ta.source || 'Continuum Technical Intelligence') +
  '</div>';

  return '<div class="report-section ta-section" id="' + t + '-technical">' +
    RS_HDR('Section 08', 'Technical Structure') +
    '<div class="rs-body">' +
    chartHtml +
    regimeHtml +
    maHtml +
    crossoverHtml +
    levelsHtml +
    inflHtml +
    volHtml +
    mrHtml +
    relHtml +
    footerHtml +
  '</div></div>';
}

function renderReportFooter(data) {
  return '<div class="report-footer-section">' +
    '<div class="rf-inner">' +
      '<div class="rf-disclaimer-text">' + data.footer.disclaimer + '</div>' +
      '<div class="rf-meta-row">' +
        '<div class="rf-brand">Contin<span class="brand-green">uu</span>m Inte<span class="brand-green">ll</span>igence</div>' +
        '<div class="rf-meta-item">ID: ' + data.reportId + '</div>' +
        '<div class="rf-meta-item">Mode: Narrative Intelligence</div>' +
        '<div class="rf-meta-item">Domains: ' + data.footer.domainCount + '</div>' +
        '<div class="rf-meta-item">Hypotheses: ' + data.footer.hypothesesCount + '</div>' +
        '<div class="rf-meta-item">' + data.date + '</div>' +
      '</div>' +
    '</div>' +
  '</div>';
}

function renderPDFDownload(data) {
  var t = data.ticker;
  return '<div class="report-download-section">' +
    '<div class="report-download-inner">' +
      '<div class="report-download-title">Download Research Report</div>' +
      '<div class="report-download-subtitle">' + data.company + ' (' + data.ticker + '.AX) &mdash; ' + data.date + '</div>' +
      '<div class="report-download-buttons">' +
        '<button class="btn-pdf-download institutional" onclick="generatePDFReport(\'' + t + '\', \'institutional\')">' +
          '<span class="btn-pdf-label">Institutional Report <span class="btn-pdf-spinner"></span></span>' +
          '<span class="btn-pdf-sub">Full ACH analysis with evidence matrix</span>' +
        '</button>' +
        '<button class="btn-pdf-download retail" onclick="generatePDFReport(\'' + t + '\', \'retail\')">' +
          '<span class="btn-pdf-label">Investor Briefing <span class="btn-pdf-spinner"></span></span>' +
          '<span class="btn-pdf-sub">Plain-language evidence summary</span>' +
        '</button>' +
      '</div>' +
    '</div>' +
  '</div>';
}

// renderNarrativeAlert removed  --  was duplicate of Risk Skew text

function renderHypSidebar(data) {
  var t = data.ticker.toLowerCase();
  var ticker = data.ticker;

  // ── Hypotheses (prepareHypotheses already ran) ──
  var hypItems = '';
  if (data.hypotheses && data.hypotheses.length > 0) {
    var norm = normaliseScores(data.hypotheses);
    for (var i = 0; i < data.hypotheses.length; i++) {
      var h = data.hypotheses[i];
      var dc = h.dirClass || 'dir-neutral';
      var label = (h.title || '').replace(/^N\d+:\s*/, '');
      hypItems += '<div class="hs-item">' +
        '<div class="hs-dot ' + dc + '"></div>' +
        '<div class="hs-label">' + label + '</div>' +
        '<div class="hs-score ' + dc + '">' + norm[i] + '%</div>' +
      '</div>';
    }
  }

  // ── Skew ──
  var skew = data._skew || computeSkewScore(data);
  var skewDir = skew.direction || 'balanced';
  var skewLabel = skewDir.toUpperCase();
  var skewScoreNum = skew.score || 0;
  var skewScoreStr = (skewScoreNum > 0 ? '+' : '') + skewScoreNum;

  // ── Three-layer signals ──
  var tls = data.three_layer_signal || {};
  var macSig = tls.macro_signal || 0;
  var secSig = tls.sector_signal || 0;
  var macCls = macSig > 10 ? 'dir-up' : macSig < -10 ? 'dir-down' : 'dir-neutral';
  var secCls = secSig > 10 ? 'dir-up' : secSig < -10 ? 'dir-down' : 'dir-neutral';

  // ── P/E and Rev Growth ──
  var ref = (typeof REFERENCE_DATA !== 'undefined') ? REFERENCE_DATA[ticker] : null;
  var peValue = '\u2014';
  var revGrowthValue = '\u2014';
  if (data.heroMetrics) {
    for (var mi = 0; mi < data.heroMetrics.length; mi++) {
      var mLabel = (data.heroMetrics[mi].label || '').toLowerCase();
      if (mLabel === 'fwd p/e' || mLabel === 'p/e') peValue = data.heroMetrics[mi].value;
      if (mLabel === 'rev growth' || mLabel === 'revenue growth') revGrowthValue = data.heroMetrics[mi].value;
    }
  }
  if (ref) {
    if (peValue === '\u2014' && ref.epsForward) {
      var currentP = parseFloat(data._livePrice || data.price || data.current_price || 0);
      if (currentP > 0) peValue = (currentP / ref.epsForward).toFixed(1) + 'x';
    }
    if (revGrowthValue === '\u2014' && ref.revenueGrowth != null) {
      revGrowthValue = (ref.revenueGrowth > 0 ? '+' : '') + ref.revenueGrowth + '%';
    }
  }

  // ── Price and change ──
  var livePrice = parseFloat(data._livePrice || data.price || data.current_price || 0);
  var ph = data.priceHistory;
  var changePct = null;
  if (ph && ph.length >= 2) {
    changePct = ((ph[ph.length - 1] - ph[ph.length - 2]) / ph[ph.length - 2] * 100);
  } else if (data.freshness && data.freshness.pricePctChange != null) {
    changePct = data.freshness.pricePctChange;
  }

  // ── Valuation Range ──
  var vr = null;
  var vrBear = 0, vrFair = 0, vrBull = 0, vrZone = '', vrZoneCls = '';
  var vrToBull = '', vrToBear = '';
  if (data.hero && data.hero.position_in_range && data.hero.position_in_range.worlds &&
      data.hero.position_in_range.worlds.length >= 4) {
    var w = data.hero.position_in_range.worlds;
    vrBear = parseFloat(w[1].price) || 0;
    vrFair = (parseFloat(w[1].price) + parseFloat(w[2].price)) / 2;
    vrBull = parseFloat(w[3].price) || 0;
    vr = { low: vrBear, mid: vrFair, high: vrBull };
  } else if (data.valuation_range) {
    vr = data.valuation_range;
    vrBear = vr.low;
    vrFair = vr.mid;
    vrBull = vr.high;
  }
  if (vr && livePrice > 0) {
    if (livePrice < vrBear)      { vrZone = 'RED';   vrZoneCls = 'red'; }
    else if (livePrice > vrFair) { vrZone = 'GREEN'; vrZoneCls = 'green'; }
    else                         { vrZone = 'AMBER'; vrZoneCls = 'amber'; }
    vrToBull = ((vrBull / livePrice - 1) * 100).toFixed(1);
    vrToBear = ((vrBear / livePrice - 1) * 100).toFixed(1);
  }

  // ── Build HTML ──
  var inner = '';

  // 1. Stock ID
  inner += '<div class="hs-stock-id">' +
    '<div class="hs-stock-ticker">' + (data.tickerFull || data.ticker || ticker) + '</div>' +
    '<div class="hs-price-row">';
  if (livePrice > 0) {
    inner += '<span class="hs-price">A$' + livePrice.toFixed(2) + '</span>';
  }
  if (changePct !== null) {
    var chgCls = changePct >= 0 ? 'pos' : 'neg';
    inner += '<span class="hs-change-badge ' + chgCls + '">' +
      (changePct >= 0 ? '+' : '') + changePct.toFixed(1) + '%</span>';
  }
  inner += '</div>' +
    '<div class="hs-stock-name">' + (data.company || '') + '</div>' +
  '</div>';

  // 2. DRIVER TRACKER + hypothesis items
  inner += '<div class="hs-section-head">Driver Tracker</div>' + hypItems;

  // 3. RISK SKEW
  inner += '<div class="hs-subhead">Risk Skew</div>';
  inner += '<div class="hs-overall-skew">' +
    '<span class="hs-skew-dir ' + skewDir + '">' + skewLabel + '</span>' +
    '<span class="hs-skew-score ' + skewDir + '">' + skewScoreStr + '</span>' +
  '</div>';

  // 4. EXT. ENVIRONMENT
  inner += '<div class="hs-subhead">Ext. Environment</div>' +
    '<div class="hs-env-row">' +
      '<div class="hs-dot ' + macCls + '"></div>' +
      '<span class="hs-env-label">Macro</span>' +
      '<span class="hs-env-score">' + (macSig > 0 ? '+' : '') + macSig + '</span>' +
    '</div>' +
    '<div class="hs-env-row">' +
      '<div class="hs-dot ' + secCls + '"></div>' +
      '<span class="hs-env-label">Sector</span>' +
      '<span class="hs-env-score">' + (secSig > 0 ? '+' : '') + secSig + '</span>' +
    '</div>';

  // 5. COMPANY
  inner += '<div class="hs-subhead">Company</div>' +
    '<div class="hs-company-row">' +
      '<span class="hs-company-label">P/E</span>' +
      '<span class="hs-company-value">' + peValue + '</span>' +
    '</div>' +
    '<div class="hs-company-row">' +
      '<span class="hs-company-label">Rev Growth</span>' +
      '<span class="hs-company-value">' + revGrowthValue + '</span>' +
    '</div>';

  // 6. VALUATION RANGE
  if (vr && livePrice > 0) {
    var vrRange = vrBull - vrBear || 1;
    var vrCurrPct = Math.min(100, Math.max(0, ((livePrice - vrBear) / vrRange * 100))).toFixed(1);
    inner += '<div class="hs-section-head">Valuation Range</div>' +
      '<div class="hs-val-section">' +
        '<div class="hs-val-header">' +
          '<span class="hs-val-zone ' + vrZoneCls + '">' + vrZone + '</span>' +
        '</div>' +
        '<div class="hs-val-levels">' +
          '<span>Bear<br>A$' + vrBear.toFixed(2) + '</span>' +
          '<span>Fair<br>A$' + vrFair.toFixed(2) + '</span>' +
          '<span>Bull<br>A$' + vrBull.toFixed(2) + '</span>' +
        '</div>' +
        '<div class="hs-val-bar">' +
          '<div class="hs-val-marker" style="left:' + vrCurrPct + '%"></div>' +
        '</div>' +
        '<div class="hs-val-distances">' +
          '<span class="neg">' + vrToBear + '% to bear</span>' +
          '<span class="pos">+' + vrToBull + '% to bull</span>' +
        '</div>' +
      '</div>';
  }

  return '<div class="hyp-sidebar" id="' + t + '-sidebar">' + inner + '</div>';
}

function prepareHypotheses(data) {
  // Idempotency guard  --  only process each stock once
  if (data._hypothesesPrepared) return;
  data._hypothesesPrepared = true;

  // v3 framework Principle 1: Rank by fewest inconsistencies, not accumulated support.
  // Primary sort: fewest contradictions (ascending). Tiebreaker: raw score (descending).
  var dirMap = { upside: 'dir-up', downside: 'dir-down', neutral: 'dir-neutral' };
  var colorMap = { 'dir-up': 'var(--signal-green)', 'dir-down': 'var(--signal-red)', 'dir-neutral': 'var(--signal-amber)' };

  var hyps = data.hypotheses;

  // Tag each hypothesis with its original tier number before sorting
  for (var i = 0; i < hyps.length; i++) {
    hyps[i]._origTierNum = hyps[i].tier.replace(/^n/, '');
  }

  // Sort by fewest contradictions (disconfirmation-based ranking), then raw score as tiebreaker
  hyps.sort(function(a, b) {
    var aContra = a.contradicting ? a.contradicting.length : 0;
    var bContra = b.contradicting ? b.contradicting.length : 0;
    if (aContra !== bContra) return aContra - bContra; // fewer inconsistencies first
    return parseFloat(b.score) - parseFloat(a.score); // tiebreaker: higher score first
  });

  // Build tier remapping: old tier number (string) -> new tier number (string)
  var tierMap = {};
  var needsRemap = false;
  for (var i = 0; i < hyps.length; i++) {
    var newNum = String(i + 1);
    var oldNum = hyps[i]._origTierNum;
    tierMap[oldNum] = newNum;
    if (oldNum !== newNum) needsRemap = true;
  }

  // Reassign tiers, dirClass, and title prefixes
  for (var i = 0; i < hyps.length; i++) {
    var h = hyps[i];
    var oldPrefix = /^N\d+:\s*/;
    h.tier = 'n' + (i + 1);
    h.dirClass = dirMap[h.direction] || 'dir-neutral';
    h.title = 'N' + (i + 1) + ': ' + h.title.replace(oldPrefix, '');
  }

  // Reorder verdict scores to match and update colours
  if (data.verdict && data.verdict.scores) {
    var oldScores = data.verdict.scores.slice();
    var newScores = [];
    for (var i = 0; i < hyps.length; i++) {
      var rawScore = hyps[i].score;
      var matched = null;
      for (var j = 0; j < oldScores.length; j++) {
        if (oldScores[j] && oldScores[j].score === rawScore) {
          matched = oldScores[j];
          oldScores[j] = null;
          break;
        }
      }
      if (matched) {
        matched.label = 'N' + (i + 1) + ' ' + matched.label.replace(/^N\d+\s*/, '');
        matched.scoreColor = colorMap[hyps[i].dirClass] || matched.scoreColor;
        newScores.push(matched);
      }
    }
    data.verdict.scores = newScores;
  }

  // Reorder alignment table columns if present
  if (data.evidence && data.evidence.alignmentSummary) {
    var as = data.evidence.alignmentSummary;
    if (as.headers && as.headers.length >= 5 && as.rows) {
      // Rebuild headers: preserve non-N columns, regenerate N-columns from sorted hypotheses
      var nonNCount = as.headers.length - hyps.length;
      var newHeaders = as.headers.slice(0, nonNCount);
      for (var i = 0; i < hyps.length; i++) {
        newHeaders.push('N' + (i + 1) + ' ' + hyps[i].title.replace(/^N\d+:\s*/, '').substring(0, 15));
      }
      as.headers = newHeaders;

      // Reorder row column data (n1/n2/n3/n4 properties) to match new tier order
      if (needsRemap) {
        var inverseTierMap = {};
        for (var old in tierMap) {
          if (tierMap.hasOwnProperty(old)) inverseTierMap[tierMap[old]] = old;
        }
        for (var r = 0; r < as.rows.length; r++) {
          var row = as.rows[r];
          var orig = { n1: row.n1, n2: row.n2, n3: row.n3, n4: row.n4 };
          for (var n = 1; n <= 4; n++) {
            var fromOld = inverseTierMap[String(n)] || String(n);
            row['n' + n] = orig['n' + fromOld];
          }
        }
        // Reorder summary values
        if (as.summary) {
          var sum = as.summary;
          var origSum = {};
          for (var n = 1; n <= 4; n++) {
            origSum['n' + n] = sum['n' + n];
            origSum['n' + n + 'Color'] = sum['n' + n + 'Color'];
          }
          for (var n = 1; n <= 4; n++) {
            var fromOld = inverseTierMap[String(n)] || String(n);
            sum['n' + n] = origSum['n' + fromOld];
            sum['n' + n + 'Color'] = origSum['n' + fromOld + 'Color'];
          }
        }
      }
    }
  }

  // Rebuild analyticalLimitations parenthetical scores
  if (data.gaps && data.gaps.analyticalLimitations) {
    var lim = data.gaps.analyticalLimitations;
    var norm = normaliseScores(hyps);
    var scoreStr = '';
    for (var i = 0; i < hyps.length; i++) {
      if (i > 0) scoreStr += ', ';
      scoreStr += 'N' + (i + 1) + ': ' + norm[i] + '%';
    }
    lim = lim.replace(/\(N1:.*?\)/, '(' + scoreStr + ')');
    data.gaps.analyticalLimitations = lim;
  }

  // Propagate tier remapping to all text fields that reference N1-N4
  if (needsRemap) {
    // Replace N-number references atomically (handles swaps correctly)
    var remapN = function(text) {
      if (!text || typeof text !== 'string') return text;
      return text.replace(/\bN([1-4])\b/g, function(m, n) {
        return 'N' + (tierMap[n] || n);
      });
    };

    // Discriminators (Section 05)
    if (data.discriminators) {
      if (data.discriminators.intro) data.discriminators.intro = remapN(data.discriminators.intro);
      if (data.discriminators.nonDiscriminating) data.discriminators.nonDiscriminating = remapN(data.discriminators.nonDiscriminating);
      if (data.discriminators.rows) {
        for (var i = 0; i < data.discriminators.rows.length; i++) {
          var dRow = data.discriminators.rows[i];
          if (dRow.discriminatesBetween) dRow.discriminatesBetween = remapN(dRow.discriminatesBetween);
          if (dRow.currentReading) dRow.currentReading = remapN(dRow.currentReading);
          if (dRow.evidence) dRow.evidence = remapN(dRow.evidence);
        }
      }
    }

    // Tripwires (Section 06)
    if (data.tripwires) {
      if (data.tripwires.intro) data.tripwires.intro = remapN(data.tripwires.intro);
      if (data.tripwires.cards) {
        for (var i = 0; i < data.tripwires.cards.length; i++) {
          var twCard = data.tripwires.cards[i];
          if (twCard.conditions) {
            for (var c = 0; c < twCard.conditions.length; c++) {
              var cond = twCard.conditions[c];
              if (cond.if) cond.if = remapN(cond.if);
              if (cond.then) cond.then = remapN(cond.then);
            }
          }
        }
      }
    }

    // Evidence cards  --  tags, findings, and tensions may reference N-numbers
    if (data.evidence && data.evidence.cards) {
      for (var i = 0; i < data.evidence.cards.length; i++) {
        var evCard = data.evidence.cards[i];
        if (evCard.tags) {
          for (var t = 0; t < evCard.tags.length; t++) {
            if (evCard.tags[t].text) evCard.tags[t].text = remapN(evCard.tags[t].text);
          }
        }
        if (evCard.finding) evCard.finding = remapN(evCard.finding);
        if (evCard.tension) evCard.tension = remapN(evCard.tension);
      }
    }

    // Gaps  --  couldntAssess items may reference N-numbers
    if (data.gaps && data.gaps.couldntAssess) {
      for (var i = 0; i < data.gaps.couldntAssess.length; i++) {
        data.gaps.couldntAssess[i] = remapN(data.gaps.couldntAssess[i]);
      }
    }

    // Verdict text
    if (data.verdict && data.verdict.text) data.verdict.text = remapN(data.verdict.text);

    // Skew rationale
    if (data.skew && data.skew.rationale) data.skew.rationale = remapN(data.skew.rationale);
  }
}

function renderOvercorrectionBanner(data) {
  var oc = data._overcorrection;
  if (!oc || !oc.active) return '';
  var cls = oc.reviewResult && oc.reviewResult.confirmed ? ' confirmed' : '';
  var label = oc.reviewResult && oc.reviewResult.confirmed
    ? '&#10004; Overcorrection Confirmed'
    : '&#9888; Possible Overcorrection Detected';
  var message = oc.message || 'Price move exceeded threshold  --  scores under review.';
  var reviewHtml = oc.reviewDate
    ? '<div class="oc-review">5-day review scheduled: ' + oc.reviewDate + '</div>'
    : '';
  if (oc.reviewResult) {
    reviewHtml = '<div class="oc-review">' + oc.reviewResult.message + '</div>';
  }
  return '<div class="overcorrection-banner' + cls + '">' +
    '<div class="oc-label">' + label + '</div>' +
    '<div class="oc-message">' + message + '</div>' +
    reviewHtml +
  '</div>';
}

// "€"€ Narrative Timeline Chart (Phase 6) "€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€

// Cache loaded history data
var HISTORY_CACHE = {};

/**
 * Load narrative history data for a ticker.
 * Returns via callback: { ticker, history: [...], flips: [...] }
 */
function loadNarrativeHistory(ticker, callback) {
  if (HISTORY_CACHE[ticker]) {
    callback(HISTORY_CACHE[ticker]);
    return;
  }
  var url = 'data/stocks/' + ticker + '-history.json';
  var xhr = new XMLHttpRequest();
  xhr.open('GET', url, true);
  xhr.onload = function() {
    if (xhr.status === 200) {
      try {
        var data = JSON.parse(xhr.responseText);
        HISTORY_CACHE[ticker] = data;
        callback(data);
      } catch (e) {
        console.warn('[NarrativeTimeline] Failed to parse history for', ticker);
        callback(null);
      }
    } else {
      callback(null);
    }
  };
  xhr.onerror = function() { callback(null); };
  xhr.send();
}

/**
 * Render the narrative timeline HTML placeholder (canvas + loading state).
 * The actual Chart.js init happens after DOM insertion via initNarrativeTimelineChart().
 */
function renderNarrativeTimeline(data) {
  var t = data.ticker.toLowerCase();
  return '<div class="report-section narrative-timeline-section" id="' + t + '-narrative-timeline">' +
    RS_HDR('Timeline', 'Narrative Evolution') +
    '<div class="rs-body">' +
    '<div class="rs-subtitle">How hypothesis survival scores and price have moved over time</div>' +
    '<div class="nt-chart-container">' +
      '<div class="nt-chart-header">' +
        '<div class="nt-chart-title">Price &amp; Hypothesis Survival Scores</div>' +
        '<div class="nt-chart-badge">60-DAY HISTORY</div>' +
      '</div>' +
      '<div class="nt-chart-canvas-wrap" id="nt-wrap-' + data.ticker + '">' +
        '<div class="nt-chart-loading" id="nt-loading-' + data.ticker + '">' +
          '<div class="spinner"></div> Loading timeline data&hellip;' +
        '</div>' +
        '<canvas id="nt-canvas-' + data.ticker + '" style="display:none"></canvas>' +
      '</div>' +
      '<div class="nt-flip-legend" id="nt-legend-' + data.ticker + '"></div>' +
    '</div>' +
  '</div></div>';
}

/**
 * Colour palette for hypothesis lines (consistent across stocks).
 * N1 = teal (dominant), N2 = blue, N3 = amber, N4 = red
 */
var NT_COLORS = {
  price: '#8B95A5',
  hypotheses: [
    { bg: 'rgba(72, 199, 142, 0.15)', border: '#48C78E', label: '#48C78E' },  // N1 teal/green
    { bg: 'rgba(79, 140, 255, 0.12)', border: '#4F8CFF', label: '#4F8CFF' },  // N2 blue
    { bg: 'rgba(255, 183, 77, 0.12)', border: '#FFB74D', label: '#FFB74D' },   // N3 amber
    { bg: 'rgba(239, 83, 80, 0.10)', border: '#EF5350', label: '#EF5350' }     // N4 red
  ],
  flip: '#FFB74D',
  overcorrection: '#EF5350',
  grid: 'rgba(139, 149, 165, 0.1)'
};

/**
 * Initialise a Chart.js narrative timeline for a specific ticker.
 * Called after the report page DOM is rendered.
 */
function initNarrativeTimelineChart(ticker) {
  if (typeof Chart === 'undefined') {
    console.warn('[NarrativeTimeline] Chart.js not loaded yet');
    return;
  }

  // Always destroy existing chart before re-init to prevent memory leaks
  destroyNarrativeTimelineChart(ticker);

  var canvas = document.getElementById('nt-canvas-' + ticker);
  var loading = document.getElementById('nt-loading-' + ticker);
  var legend = document.getElementById('nt-legend-' + ticker);
  if (!canvas) return;

  loadNarrativeHistory(ticker, function(histData) {
    // Guard: canvas may have been removed from DOM during async fetch
    var canvasCheck = document.getElementById('nt-canvas-' + ticker);
    if (!canvasCheck) return;

    if (loading) loading.style.display = 'none';
    canvasCheck.style.display = 'block';

    if (!histData || !histData.history || histData.history.length < 2) {
      // Not enough data  --  show empty state
      var wrap = document.getElementById('nt-wrap-' + ticker);
      if (wrap) {
        wrap.innerHTML = '<div class="nt-chart-empty">Insufficient history data for timeline visualisation.<br>Data accumulates daily via the automated pipeline.</div>';
      }
      return;
    }

    var history = histData.history;
    var flips = histData.flips || [];

    // Extract labels (dates) and datasets
    var labels = [];
    var priceData = [];
    var hypDatasets = {}; // keyed by hypothesis id

    // Discover all hypothesis IDs across ALL entries (handles evolving hypotheses)
    var hypIdSet = {};
    var hypIds = [];
    for (var i = 0; i < history.length; i++) {
      if (history[i].hypotheses) {
        for (var h = 0; h < history[i].hypotheses.length; h++) {
          var hid = history[i].hypotheses[h].id;
          if (!hypIdSet[hid]) {
            hypIdSet[hid] = true;
            hypIds.push(hid);
          }
        }
      }
    }

    for (var i = 0; i < history.length; i++) {
      var entry = history[i];
      // Format date as DD/MM (with validation)
      var parts = (entry.date || '').split('-');
      if (parts.length === 3) {
        labels.push(parts[2] + '/' + parts[1]);
      } else {
        labels.push(entry.date || '?');
      }
      priceData.push(entry.price);

      // Hypothesis scores
      for (var h = 0; h < hypIds.length; h++) {
        var hid = hypIds[h];
        if (!hypDatasets[hid]) hypDatasets[hid] = [];
        var found = null;
        if (entry.hypotheses) {
          for (var j = 0; j < entry.hypotheses.length; j++) {
            if (entry.hypotheses[j].id === hid) { found = entry.hypotheses[j]; break; }
          }
        }
        hypDatasets[hid].push(found ? found.survival_score : null);
      }
    }

    // Build hypothesis names from the last entry (most current)
    var hypNames = {};
    var lastEntry = history[history.length - 1];
    if (lastEntry.hypotheses) {
      for (var h = 0; h < lastEntry.hypotheses.length; h++) {
        hypNames[lastEntry.hypotheses[h].id] = lastEntry.hypotheses[h].name;
      }
    }

    // Build Chart.js datasets
    var datasets = [];

    // Price line (left y-axis)
    datasets.push({
      label: 'Price',
      data: priceData,
      borderColor: NT_COLORS.price,
      backgroundColor: 'transparent',
      borderWidth: 2,
      pointRadius: 0,
      pointHitRadius: 6,
      yAxisID: 'yPrice',
      tension: 0.3,
      order: 0
    });

    // Hypothesis stacked areas (right y-axis)
    for (var h = 0; h < hypIds.length; h++) {
      var hid = hypIds[h];
      var colorSet = NT_COLORS.hypotheses[h] || NT_COLORS.hypotheses[0];
      datasets.push({
        label: hid + ': ' + (hypNames[hid] || hid),
        data: hypDatasets[hid],
        borderColor: colorSet.border,
        backgroundColor: colorSet.bg,
        borderWidth: 1.5,
        pointRadius: 0,
        pointHitRadius: 6,
        yAxisID: 'yScore',
        fill: true,
        tension: 0.3,
        order: h + 1
      });
    }

    // Build vertical marker arrays for flip and overcorrection events
    var flipMarkers = [];
    for (var f = 0; f < flips.length; f++) {
      var flip = flips[f];
      var flipParts = (flip.date || '').split('-');
      if (flipParts.length === 3) {
        var flipLabel = flipParts[2] + '/' + flipParts[1];
        var flipIdx = labels.indexOf(flipLabel);
        if (flipIdx >= 0) {
          flipMarkers.push({ idx: flipIdx, color: NT_COLORS.flip, dash: [4, 3], width: 1.5 });
        }
      }
    }
    for (var i = 0; i < history.length; i++) {
      if (history[i].overcorrection_active) {
        var ocParts = (history[i].date || '').split('-');
        if (ocParts.length === 3) {
          var ocLabel = ocParts[2] + '/' + ocParts[1];
          var ocIdx = labels.indexOf(ocLabel);
          if (ocIdx >= 0) {
            flipMarkers.push({ idx: ocIdx, color: NT_COLORS.overcorrection, dash: [2, 2], width: 2 });
          }
        }
      }
    }

    // Custom plugin to draw vertical marker lines (no external annotation plugin needed)
    var verticalLinePlugin = {
      id: 'ntVerticalLines',
      afterDraw: function(chart) {
        if (!flipMarkers || flipMarkers.length === 0) return;
        var ctx = chart.ctx;
        var xScale = chart.scales.x;
        var yScale = chart.scales.yPrice;
        ctx.save();
        for (var m = 0; m < flipMarkers.length; m++) {
          var marker = flipMarkers[m];
          var xPixel = xScale.getPixelForValue(marker.idx);
          ctx.beginPath();
          ctx.setLineDash(marker.dash);
          ctx.strokeStyle = marker.color;
          ctx.lineWidth = marker.width;
          ctx.moveTo(xPixel, yScale.top);
          ctx.lineTo(xPixel, yScale.bottom);
          ctx.stroke();
        }
        ctx.restore();
      }
    };

    // Theme-aware colours
    var isDark = document.documentElement.getAttribute('data-theme') !== 'light';
    var textColor = isDark ? '#8B95A5' : '#4A5568';
    var gridColor = isDark ? 'rgba(139, 149, 165, 0.1)' : 'rgba(0, 0, 0, 0.06)';

    // Create chart (use canvasCheck which is verified still in DOM)
    var ctx = canvasCheck.getContext('2d');
    try {
    var chart = new Chart(ctx, {
      type: 'line',
      data: { labels: labels, datasets: datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          legend: {
            display: true,
            position: 'bottom',
            labels: {
              color: textColor,
              font: { family: "'JetBrains Mono', 'SF Mono', monospace", size: 10 },
              boxWidth: 12,
              padding: 12,
              usePointStyle: true,
              pointStyle: 'rectRounded'
            }
          },
          tooltip: {
            backgroundColor: isDark ? 'rgba(11, 18, 32, 0.95)' : 'rgba(255, 255, 255, 0.95)',
            titleColor: isDark ? '#E2E8F0' : '#1A202C',
            bodyColor: isDark ? '#A0AEC0' : '#4A5568',
            borderColor: isDark ? 'rgba(139, 149, 165, 0.2)' : 'rgba(0, 0, 0, 0.1)',
            borderWidth: 1,
            titleFont: { family: "'JetBrains Mono', monospace", size: 11, weight: 'bold' },
            bodyFont: { family: "'JetBrains Mono', monospace", size: 10 },
            padding: 10,
            cornerRadius: 4,
            callbacks: {
              label: function(context) {
                var label = context.dataset.label || '';
                var value = context.parsed.y;
                if (context.dataset.yAxisID === 'yPrice') {
                  return label + ': $' + (value !== null ? value.toFixed(2) : ' -- ');
                }
                return label + ': ' + (value !== null ? value + '%' : ' -- ');
              }
            }
          }
        },
        scales: {
          x: {
            grid: { color: gridColor, drawBorder: false },
            ticks: {
              color: textColor,
              font: { family: "'JetBrains Mono', monospace", size: 9 },
              maxRotation: 0,
              autoSkip: true,
              maxTicksLimit: 12
            }
          },
          yPrice: {
            type: 'linear',
            position: 'left',
            grid: { color: gridColor, drawBorder: false },
            ticks: {
              color: textColor,
              font: { family: "'JetBrains Mono', monospace", size: 9 },
              callback: function(value) { return '$' + value.toFixed(0); }
            },
            title: {
              display: true,
              text: 'Price',
              color: textColor,
              font: { family: "'JetBrains Mono', monospace", size: 10, weight: 'bold' }
            }
          },
          yScore: {
            type: 'linear',
            position: 'right',
            min: 0,
            max: 100,
            grid: { display: false },
            ticks: {
              color: textColor,
              font: { family: "'JetBrains Mono', monospace", size: 9 },
              callback: function(value) { return value + '%'; },
              stepSize: 20
            },
            title: {
              display: true,
              text: 'Survival Score',
              color: textColor,
              font: { family: "'JetBrains Mono', monospace", size: 10, weight: 'bold' }
            }
          }
        }
      },
      plugins: [verticalLinePlugin]
    });
    } catch (e) {
      console.error('[NarrativeTimeline] Chart.js init failed for', ticker, e);
      return;
    }

    // Store chart reference for cleanup
    canvasCheck._ntChart = chart;

    // Build flip legend (use DOM methods to avoid XSS from data values)
    var legendEl = document.getElementById('nt-legend-' + ticker);
    if (legendEl && flips.length > 0) {
      legendEl.innerHTML = '';
      for (var f = 0; f < flips.length; f++) {
        var fl = flips[f];
        var item = document.createElement('div');
        item.className = 'nt-flip-item';
        var marker = document.createElement('span');
        marker.className = 'nt-flip-marker';
        item.appendChild(marker);
        item.appendChild(document.createTextNode(
          ' ' + (fl.date || '') + ': ' + (fl.from && fl.from.id || '?') + ' \u2192 ' + (fl.to && fl.to.id || '?')
        ));
        legendEl.appendChild(item);
      }
    } else if (legendEl) {
      legendEl.style.display = 'none';
    }
  });
}

/**
 * Destroy an existing narrative timeline chart (for re-rendering).
 */
function destroyNarrativeTimelineChart(ticker) {
  var canvas = document.getElementById('nt-canvas-' + ticker);
  if (canvas) {
    // Try stored reference first
    if (canvas._ntChart) {
      canvas._ntChart.destroy();
      canvas._ntChart = null;
    }
    // Also check Chart.js global registry (handles DOM replacement cases)
    var existing = (typeof Chart !== 'undefined' && Chart.getChart) ? Chart.getChart(canvas) : null;
    if (existing) {
      existing.destroy();
    }
  }
}

function renderSignalBars(data) {
  var tls = data.three_layer_signal || {};
  var ta  = data.technicalAnalysis;
  var rows = '';

  // ── Row 1: Technical Indicators ───────────────────────────────────────────
  if (ta) {
    var regime     = ta.regime || '';
    var isCritical = /break|bear|crash/i.test(regime);
    var isPositive = /up|bull|accum|recov/i.test(regime);
    var regimeCls  = isCritical ? 'critical' : isPositive ? 'positive' : 'neutral';
    var badgeLabel = isCritical ? 'Critical' : isPositive ? 'Positive' : (regime.split(/[\s—–-]/)[0] || 'Neutral');

    var currentP = parseFloat(data._livePrice || data.price || 0);
    var ph = data.priceHistory;
    var dailyChange = '', dailyCls = '';
    // Prefer live change % from server data; fall back to priceHistory diff
    if (data._liveChangePct != null && !isNaN(data._liveChangePct)) {
      var chg = parseFloat(data._liveChangePct);
      dailyCls    = chg >= 0 ? 'pos' : 'neg';
      dailyChange = (chg >= 0 ? '+' : '') + chg.toFixed(1) + '% today';
    } else if (ph && ph.length >= 2) {
      var last2 = parseFloat(ph[ph.length - 1]);
      var prev2 = parseFloat(ph[ph.length - 2]);
      if (!isNaN(last2) && !isNaN(prev2) && prev2 !== 0) {
        var chg = (last2 - prev2) / prev2 * 100;
        dailyCls    = chg >= 0 ? 'pos' : 'neg';
        dailyChange = (chg >= 0 ? '+' : '') + chg.toFixed(1) + '% today';
      }
    }
    var fromPeak = '', fromPeakCls = '';
    if (ta.trend && ta.trend.drawdown != null) {
      fromPeak    = ta.trend.drawdown.toFixed(1) + '% from peak';
      fromPeakCls = ta.trend.drawdown < 0 ? 'neg' : 'pos';
    }
    rows +=
      '<div class="sb-row">' +
        '<span class="sb-indicator ' + regimeCls + '"></span>' +
        '<span class="sb-row-label">Technical Indicators</span>' +
        '<span class="sb-badge ' + regimeCls + '">' + badgeLabel + '</span>' +
        '<div class="sb-items">' +
          (currentP ? '<span class="sb-item">A$' + currentP.toFixed(2) + '</span><span class="sb-sep">|</span>' : '') +
          (dailyChange ? '<span class="sb-item ' + dailyCls + '">' + dailyChange + '</span>' : '') +
          (fromPeak    ? '<span class="sb-sep">|</span><span class="sb-item ' + fromPeakCls + '">' + fromPeak + '</span>' : '') +
        '</div>' +
      '</div>';
  }

  // "€"€ Row 2: Macro Environment "€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€
  if (tls) {
    var macSig   = tls.macro_signal  || 0;
    var macCls   = macSig >  10 ? 'positive' : macSig < -10 ? 'downside' : 'neutral';
    var macLabel = macSig >  10 ? 'SUPPORTIVE' : macSig < -10 ? 'HEADWIND' : 'NEUTRAL';
    rows +=
      '<div class="sb-row">' +
        '<span class="sb-indicator ' + macCls + '"></span>' +
        '<span class="sb-row-label">Macro Environment</span>' +
        '<span class="sb-badge ' + macCls + '">' + macLabel + '</span>' +
        '<div class="sb-items">' +
          '<span class="sb-item">Signal ' + (macSig > 0 ? '+' : '') + macSig + '</span>' +
          (tls.external_weight ? '<span class="sb-sep">|</span><span class="sb-item">Weight ' + tls.external_weight + '%</span>' : '') +
        '</div>' +
      '</div>';
  }

  // "€"€ Row 3: Sector Narrative "€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€
  if (tls) {
    var secSig   = tls.sector_signal || 0;
    var secCls   = secSig >  10 ? 'positive' : secSig < -10 ? 'downside' : 'neutral';
    var secLabel = secSig >  10 ? 'POSITIVE'  : secSig < -10 ? 'NEGATIVE'  : 'NEUTRAL';
    var secName  = (data.sector || '') + (data.sectorSub ? ' / ' + data.sectorSub : '');
    var secWeight = tls.external_weight || 0;
    rows +=
      '<div class="sb-row">' +
        '<span class="sb-indicator ' + secCls + '"></span>' +
        '<span class="sb-row-label">Sector Narrative</span>' +
        '<span class="sb-badge ' + secCls + '">' + secLabel + '</span>' +
        '<div class="sb-items">' +
          (secName ? '<span class="sb-item">' + secName + '</span><span class="sb-sep">|</span>' : '') +
          '<span class="sb-item">Signal ' + (secSig > 0 ? '+' : '') + secSig + '</span>' +
          '<span class="sb-sep">|</span>' +
          '<span class="sb-item">Weight ' + secWeight + '%</span>' +
          '<span class="sb-sep">|</span>' +
          '<span class="sb-item">Contribs 0</span>' +
        '</div>' +
      '</div>';
  }

  // "€"€ Row 4: Company Research "€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€"€
  var skew     = data._skew || computeSkewScore(data);
  var compCls  = skew.score < -5 ? 'downside' : skew.score > 5 ? 'upside' : 'neutral';
  var compBadge= skew.score < -5 ? 'DOWNSIDE'  : skew.score > 5 ? 'UPSIDE'  : 'NEUTRAL';
  var scoreLbl = (skew.score > 0 ? '+' : '') + skew.score;
  var hyps     = (tls && tls.company_detail && tls.company_detail.hypotheses)
                   ? tls.company_detail.hypotheses
                   : (skew.hypotheses || []);

  var bearCt = 0, bullCt = 0;
  for (var hi = 0; hi < hyps.length; hi++) {
    if      (hyps[hi].direction === 'downside') bearCt++;
    else if (hyps[hi].direction === 'upside')   bullCt++;
  }

  var dominant = null, domMax = -1;
  for (var di = 0; di < hyps.length; di++) {
    var dh = hyps[di], dw = dh.weight || 0;
    if ((skew.score < 0 && dh.direction === 'downside' && dw > domMax) ||
        (skew.score >= 0 && dh.direction === 'upside'  && dw > domMax)) {
      domMax = dw; dominant = dh;
    }
  }

  var sorted = hyps.slice().sort(function(a,b){ return (b.weight||0)-(a.weight||0); });
  var chipsHtml = '';
  for (var ci = 0; ci < sorted.length; ci++) {
    var sh = sorted[ci];
    var chipCls  = sh.direction === 'downside' ? 'downside' : sh.direction === 'upside' ? 'upside' : '';
    var nMatch   = sh.title ? sh.title.match(/^([NT]\d+)/i) : null;
    var nCode    = nMatch ? nMatch[1].toUpperCase() : '';
    var descParts= (sh.title || '').replace(/^[NT]\d+[:\s]*/i,'').split(' ');
    var keyWord  = (descParts[0] || '').toLowerCase() === 'structural' && descParts[1]
                   ? descParts[1] : (descParts[0] || '');
    chipsHtml +=
      '<span class="sb-hyp-chip ' + chipCls + '">' +
        nCode + (keyWord ? ' ' + keyWord.toUpperCase() : '') +
        '<span class="chip-pct">' + (sh.weight || 0) + '%</span>' +
      '</span>';
  }

  rows +=
    '<div class="sb-row">' +
      '<span class="sb-indicator ' + compCls + '"></span>' +
      '<span class="sb-row-label">Company Research</span>' +
      '<span class="sb-badge ' + compCls + '">' + compBadge + '</span>' +
      '<div class="sb-company-body">' +
        '<div class="sb-score-line">' +
          '<span class="sb-score ' + compCls + '">' + scoreLbl + ' &#9660;</span>' +
          '<div class="sb-score-track">' +
            '<div class="skew-bar-bull" style="width:' + skew.bull + '%"></div>' +
            '<div class="skew-bar-bear" style="width:' + skew.bear + '%"></div>' +
          '</div>' +
        '</div>' +
        (hyps.length
          ? '<div class="sb-desc">' +
              bearCt + ' bear / ' + bullCt + ' bull' +
              (dominant ? ' &bull; Dominant: ' + dominant.title + ' (' + dominant.direction.toUpperCase() + ')' : '') +
            '</div>'
          : '') +
        (chipsHtml ? '<div class="sb-hyp-chips">' + chipsHtml + '</div>' : '') +
      '</div>' +
    '</div>';

  return '<div class="signal-bars-section">' +
    '<div class="report-hero-inner">' + rows + '</div>' +
  '</div>';
}

function renderReportPage(data) {
  prepareHypotheses(data);
  var t = data.ticker.toLowerCase();

  var mainContent =
    renderOvercorrectionBanner(data) +
    renderIdentity(data) +
    renderHypotheses(data) +
    renderNarrativeTimeline(data) +
    renderNarrative(data) +
    renderEvidence(data) +
    renderDiscriminators(data) +
    renderTripwires(data) +
    renderGaps(data) +
    renderTechnicalAnalysis(data) +
    '<div class="report-section" id="' + t + '-chat">' +
      RS_HDR('Research', 'Research Chat') +
      '<div class="rs-body">' +
      '<div class="rs-subtitle">Ask questions about ' + data.company + ' grounded in structured research data</div>' +
      '<div class="chat-inline" data-ticker="' + data.ticker + '">' +
        '<div class="chat-inline-messages" id="chat-inline-' + data.ticker + '" aria-live="polite" aria-relevant="additions"></div>' +
        '<div class="chat-inline-input-area">' +
          '<textarea class="chat-inline-input" placeholder="Ask about ' + data.company + '..." rows="1" aria-label="Ask a question about ' + data.company + '"></textarea>' +
          '<button class="chat-inline-send" disabled aria-label="Send">' +
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>' +
          '</button>' +
        '</div>' +
      '</div>' +
    '</div></div>';

  var floatingToggle =
    '<button class="sections-float-toggle" onclick="toggleAllSections(this)" data-state="expanded" aria-label="Collapse all sections">' +
      '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" width="13" height="13"><polyline points="18 15 12 9 6 15"/></svg>' +
      '<span>Collapse All</span>' +
    '</button>';

  return renderReportHero(data) +
    renderSignalBars(data) +
    renderSkewBar(data) +
    renderVerdict(data) +
    renderSectionNav(data) +
    '<div class="report-content">' +
      '<div class="report-main">' + mainContent + '</div>' +
      renderHypSidebar(data) +
    '</div>' +
    renderPDFDownload(data) +
    renderReportFooter(data) +
    floatingToggle;
}

// ============================================================
// SECTION ACCORDION
// ============================================================
function toggleSection(btn) {
  var section = btn.closest('.report-section');
  if (!section) return;
  var body = section.querySelector('.rs-body');
  if (!body) return;
  var isCollapsed = section.classList.toggle('collapsed');
  btn.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');
  body.style.display = isCollapsed ? 'none' : '';
  var sectionId = section.id;
  var ticker = sectionId.split('-')[0];
  var key = 'sec-state-' + ticker;
  var state = {};
  try { state = JSON.parse(localStorage.getItem(key) || '{}'); } catch(e) {}
  state[sectionId] = isCollapsed;
  try { localStorage.setItem(key, JSON.stringify(state)); } catch(e) {}
}

function initSectionToggles(ticker) {
  var key = 'sec-state-' + ticker.toLowerCase();
  var state = {};
  try { state = JSON.parse(localStorage.getItem(key) || '{}'); } catch(e) {}
  var page = document.getElementById('page-report-' + ticker.toUpperCase()) ||
             document.getElementById('page-report-' + ticker.toLowerCase()) ||
             document.getElementById('page-report-' + ticker);
  if (!page) return;
  var sections = page.querySelectorAll('.report-section[id]');
  sections.forEach(function(sec) {
    var body = sec.querySelector('.rs-body');
    var btn = sec.querySelector('.rs-toggle');
    if (state[sec.id]) {
      sec.classList.add('collapsed');
      if (body) body.style.display = 'none';
      if (btn) btn.setAttribute('aria-expanded', 'false');
    } else {
      sec.classList.remove('collapsed');
      if (body) body.style.display = '';
      if (btn) btn.setAttribute('aria-expanded', 'true');
    }
  });
  var allBtn = page.querySelector('.sections-float-toggle');
  if (allBtn) { allBtn.dataset.state = 'expanded'; allBtn.querySelector('span').textContent = 'Collapse All'; allBtn.querySelector('svg polyline').setAttribute('points', '18 15 12 9 6 15'); }
}

function toggleAllSections(btn) {
  var page = btn.closest('.page');
  if (!page) return;
  var ticker = page.id.replace('page-report-', '').toLowerCase();
  var isExpanded = btn.dataset.state === 'expanded';
  var newState = isExpanded ? 'collapsed' : 'expanded';
  page.querySelectorAll('.report-section').forEach(function(section) {
    var body = section.querySelector('.rs-body');
    var toggle = section.querySelector('.rs-toggle');
    if (!body) return;
    if (isExpanded) {
      section.classList.add('collapsed');
      body.style.display = 'none';
      if (toggle) toggle.setAttribute('aria-expanded', 'false');
    } else {
      section.classList.remove('collapsed');
      body.style.display = '';
      if (toggle) toggle.setAttribute('aria-expanded', 'true');
    }
    // Persist per-section state
    var key = 'sec-state-' + ticker;
    var state = {};
    try { state = JSON.parse(localStorage.getItem(key) || '{}'); } catch(e) {}
    state[section.id] = isExpanded;
    try { localStorage.setItem(key, JSON.stringify(state)); } catch(e) {}
  });
  btn.dataset.state = newState;
  var label = isExpanded ? 'Expand All' : 'Collapse All';
  btn.querySelector('span').textContent = label;
  btn.setAttribute('aria-label', label + ' sections');
  var points = isExpanded ? '6 9 12 15 18 9' : '18 15 12 9 6 15';
  btn.querySelector('svg polyline').setAttribute('points', points);
}

// ============================================================
// SNAPSHOT DATA & RENDER FUNCTIONS
// ============================================================

const SNAPSHOT_DATA = {};

// Auto-generate snapshot data from STOCK_DATA
function buildSnapshotFromStock(ticker) {
  var stock = STOCK_DATA[ticker];
  if (!stock) return null;

  // 1. Clone hypotheses  --  already sorted by prepareHypotheses (disconfirmation ranking)
  var hyps = [];
  for (var i = 0; i < stock.hypotheses.length; i++) {
    var h = stock.hypotheses[i];
    hyps.push({
      originalTier: h.tier,
      direction: h.direction,
      title: h.title.replace(/^N\d+:\s*/, ''),
      statusClass: h.statusClass,
      statusText: h.statusText,
      score: parseInt(h.score) || 0,
      scoreMeta: h.scoreMeta,
      description: h.description
    });
  }
  // Note: not re-sorting  --  prepareHypotheses already ranked by fewest contradictions (v3 framework)

  // Build original tier -> new position mapping
  var tierMap = {};
  for (var i = 0; i < hyps.length; i++) {
    tierMap[hyps[i].originalTier] = i;
  }

  // Build N-reference remapper for snapshot text fields
  var snapRemapN = function(text) {
    if (!text || typeof text !== 'string') return text;
    return text.replace(/\bN([1-4])\b/g, function(m, n) {
      var oldTier = 'n' + n;
      var newIdx = tierMap[oldTier];
      return newIdx !== undefined ? 'N' + (newIdx + 1) : m;
    });
  };

  // 2. Normalise scores to 100% with v3 floor/ceiling
  var normScores = normaliseScores(hyps);

  // 3. Direction -> CSS class mappings
  var dirCls = { upside: 'snap-upside', downside: 'snap-downside', neutral: 'snap-neutral' };
  var dirSbCls = { upside: 'snap-sb-upside', downside: 'snap-sb-downside', neutral: 'snap-sb-neutral' };
  var dirColor = { upside: 'var(--signal-green)', downside: 'var(--signal-red)', neutral: 'var(--signal-amber)' };
  var dirScoreCls = { upside: 'priced', downside: 'high', neutral: 'medium' };
  var statusTagMap = { priced: 'snap-tag-priced', accumulating: 'snap-tag-accumulating', active: 'snap-tag-tail', minimal: 'snap-tag-minimal' };

  // Parse direction and label from scoreMeta
  function parseDirMeta(meta) {
    if (!meta) return { direction: 'flat', dirLabel: '&rarr; Steady' };
    var label = meta.replace(/^[^&]*/, '').trim();
    if (!label) label = meta;
    if (meta.indexOf('&uarr;') >= 0) return { direction: 'up', dirLabel: label };
    if (meta.indexOf('&darr;') >= 0) return { direction: 'down', dirLabel: label };
    return { direction: 'flat', dirLabel: label };
  }

  // 4. Build survival bar
  var survivalBar = [];
  var survivalLegend = [];
  for (var i = 0; i < hyps.length; i++) {
    survivalBar.push({
      cls: dirSbCls[hyps[i].direction] || 'snap-sb-neutral',
      width: normScores[i] + '%',
      label: 'N' + (i + 1) + ': ' + normScores[i] + '%'
    });
    survivalLegend.push({
      color: dirColor[hyps[i].direction] || 'var(--signal-amber)',
      label: hyps[i].title
    });
  }

  // 5. Build hypothesis cards
  var snapHyps = [];
  for (var i = 0; i < hyps.length; i++) {
    var dm = parseDirMeta(hyps[i].scoreMeta);
    var desc = hyps[i].description;
    if (desc.length > 200) desc = desc.substring(0, 197) + '...';
    snapHyps.push({
      cls: dirCls[hyps[i].direction] || 'snap-neutral',
      label: 'N' + (i + 1) + ': ' + hyps[i].title,
      statusTag: statusTagMap[hyps[i].statusClass] || 'snap-tag-minimal',
      statusText: hyps[i].statusText,
      desc: desc,
      score: normScores[i] + '%',
      scoreCls: dirScoreCls[hyps[i].direction] || 'medium',
      direction: dm.direction,
      dirLabel: dm.dirLabel
    });
  }

  // 6. Build evidence matrix from evidence card tags
  var matrixHeaders = ['Domain'];
  for (var i = 0; i < hyps.length; i++) {
    matrixHeaders.push('N' + (i + 1) + ' ' + hyps[i].title.substring(0, 12));
  }

  var matrixRows = [];
  var cards = stock.evidence && stock.evidence.cards ? stock.evidence.cards : [];
  var maxCards = Math.min(cards.length, 8);
  for (var c = 0; c < maxCards; c++) {
    var card = cards[c];
    var cells = [];
    for (var h2 = 0; h2 < hyps.length; h2++) {
      cells.push({ cls: 'snap-signal-neutral', text: '&mdash;' });
    }
    if (card.tags) {
      for (var t = 0; t < card.tags.length; t++) {
        var tag = card.tags[t];
        var tierMatch = tag.text.match(/N(\d)/);
        if (tierMatch) {
          var origTier = 'n' + tierMatch[1];
          var newPos = tierMap[origTier];
          if (newPos !== undefined) {
            if (tag.class === 'strong') {
              cells[newPos] = { cls: 'snap-signal-strong-support', text: '&#9650;&#9650;' };
            } else if (tag.class === 'supports') {
              cells[newPos] = { cls: 'snap-signal-support', text: '&#9650;' };
            } else if (tag.class === 'contradicts') {
              cells[newPos] = { cls: 'snap-signal-contradict', text: '&#9660;' };
            }
          }
        }
      }
    }
    var domainName = card.title.replace(/^\d+\.\s*/, '');
    var epistemic = card.epistemicLabel || '';
    if (epistemic.indexOf('/') >= 0) epistemic = epistemic.split('/')[0].trim();
    matrixRows.push({ domain: domainName, epistemic: epistemic, cells: cells });
  }

  // 7. Build discriminators
  var snapDiscrim = [];
  var discRows = stock.discriminators && stock.discriminators.rows ? stock.discriminators.rows : [];
  for (var d = 0; d < Math.min(discRows.length, 4); d++) {
    var disc = discRows[d];
    snapDiscrim.push({
      level: disc.diagnosticity,
      cls: disc.diagnosticityClass.replace('disc-', ''),
      text: snapRemapN(disc.evidence)
    });
  }

  // Non-discriminating chips
  var ndText = stock.discriminators && stock.discriminators.nonDiscriminating ? stock.discriminators.nonDiscriminating : '';
  var ndChips = [];
  if (typeof ndText === 'string') {
    var parts = ndText.split('&bull;');
    for (var p = 0; p < Math.min(parts.length, 5); p++) {
      var chip = parts[p].replace(/<[^>]+>/g, '').trim();
      if (chip) ndChips.push(chip);
    }
  }

  // 8. Build tripwires
  var snapTripwires = [];
  var tripCards = stock.tripwires && stock.tripwires.cards ? stock.tripwires.cards : [];
  for (var tc2 = 0; tc2 < Math.min(tripCards.length, 4); tc2++) {
    var tw = tripCards[tc2];
    var conds = [];
    for (var co = 0; co < tw.conditions.length; co++) {
      var cond = tw.conditions[co];
      var icon = cond.valence === 'positive' ? '&#9650;' : '&#9660;';
      var iconCls = cond.valence === 'positive' ? 'up' : 'down';
      var condText = snapRemapN(cond.if.replace(/^If\s+/i, ''));
      var thenShort = snapRemapN(cond.then.split('.')[0]);
      conds.push({ icon: icon, iconCls: iconCls, text: condText + ' &rarr; ' + thenShort });
    }
    snapTripwires.push({ date: tw.date, name: tw.name.replace(/\s*&mdash;.*/, ''), conditions: conds });
  }

  // 9. Evidence coverage
  var snapCoverage = [];
  var coverageRows = stock.gaps && stock.gaps.coverageRows ? stock.gaps.coverageRows : [];
  for (var g = 0; g < Math.min(coverageRows.length, 8); g++) {
    var gr = coverageRows[g];
    var sCls = gr.coverageLevel === 'full' || gr.coverageLevel === 'good' ? 'snap-gap-full' :
              gr.coverageLevel === 'partial' ? 'snap-gap-partial' : 'snap-gap-limited';
    snapCoverage.push({ domain: gr.domain, status: gr.coverageLabel.toUpperCase(), cls: sCls });
  }

  // 10. Questions from gaps
  var snapQuestions = [];
  var couldntAssess = stock.gaps && stock.gaps.couldntAssess ? stock.gaps.couldntAssess : [];
  for (var q = 0; q < Math.min(couldntAssess.length, 3); q++) {
    snapQuestions.push(couldntAssess[q].replace(/<[^>]+>/g, ''));
  }

  // 11. Price metrics from heroMetrics
  var priceMetrics = [];
  for (var m = 0; m < stock.heroMetrics.length; m++) {
    priceMetrics.push({
      label: stock.heroMetrics[m].label,
      value: stock.heroMetrics[m].value,
      cls: stock.heroMetrics[m].colorClass || ''
    });
  }

  // 12. Skew badge  --  derived from computed score, not static data
  var skewComputed = stock._skew || computeSkewScore(stock);
  var skewBadge = skewComputed.direction === 'downside' ? '&#9660; DOWNSIDE' :
                  skewComputed.direction === 'upside' ? '&#9650; UPSIDE' : '&#9670; BALANCED';

  // 13. Date formatting
  var dateStr = stock.date;
  var dateMatch = dateStr.match(/(\d+)\s+(\w+)\s+(\d+)/);
  if (dateMatch) dateStr = dateMatch[1] + ' ' + dateMatch[2].toUpperCase().substring(0, 3) + ' ' + dateMatch[3];

  return {
    ticker: stock.ticker,
    tickerFull: stock.tickerFull,
    company: stock.company,
    sector: stock.sector,
    sectorSub: stock.sectorSub,
    price: stock._livePrice || stock.price,
    currency: stock.currency,
    date: dateStr,
    version: 'v1.0',
    reportId: stock.reportId,
    priceMetrics: priceMetrics,
    riskSkew: { direction: skewComputed.direction, badge: skewBadge, rationale: stock.skew.rationale, computed: skewComputed },
    narrative: { text: stock.narrative.theNarrative || '', verdict: stock.verdict.text || '' },
    survivalBar: survivalBar,
    survivalLegend: survivalLegend,
    hypotheses: snapHyps,
    evidenceMatrix: { headers: matrixHeaders, rows: matrixRows },
    discriminators: snapDiscrim,
    nonDiscriminating: ndChips,
    tripwires: snapTripwires,
    evidenceCoverage: snapCoverage,
    questions: snapQuestions,
    technicalAnalysis: stock.technicalAnalysis ? {
      regime: stock.technicalAnalysis.regime,
      trend: stock.technicalAnalysis.trend.direction + ' (' + stock.technicalAnalysis.trend.duration + ')',
      ma50: stock.technicalAnalysis.price.currency + stock.technicalAnalysis.movingAverages.ma50.value.toFixed(2),
      ma200: stock.technicalAnalysis.price.currency + stock.technicalAnalysis.movingAverages.ma200.value.toFixed(2),
      vsMa50: stock.technicalAnalysis.movingAverages.priceVsMa50.toFixed(1) + '%',
      vsMa200: stock.technicalAnalysis.movingAverages.priceVsMa200.toFixed(1) + '%',
      support: stock.technicalAnalysis.price.currency + stock.technicalAnalysis.keyLevels.support.price.toFixed(2),
      resistance: stock.technicalAnalysis.price.currency + stock.technicalAnalysis.keyLevels.resistance.price.toFixed(2),
      rangePosition: 'Lower ' + stock.technicalAnalysis.meanReversion.rangePosition + '%',
      crossover: stock.technicalAnalysis.movingAverages.crossover ? stock.technicalAnalysis.movingAverages.crossover.type + ' (' + stock.technicalAnalysis.movingAverages.crossover.date + ')' : null
    } : null,
    footerDisclaimer: 'This report does not constitute personal financial advice. Continuum Intelligence synthesises cross-domain evidence using ACH methodology. All data sourced from ASX filings, broker consensus, and publicly available data as at report date. Hypothesis scores reflect editorial assessment.',
    footerMeta: [
      { label: 'ID: ' + stock.reportId },
      { label: 'MODE: Narrative Intelligence' },
      { label: 'NEXT: Mar 2026' }
    ]
  };
}

function renderSnapshotListCard(data) {
  return '<div class="snapshot-card" onclick="navigate(\'snapshot-' + data.ticker + '\')" tabindex="0" role="link" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();navigate(\'snapshot-' + data.ticker + '\')}">' +
    '<div class="sc-top">' +
      '<div>' +
        '<div class="sc-ticker">' + data.tickerFull + '</div>' +
        '<div class="sc-company">' + data.company + '</div>' +
        '<div class="sc-sector">' + data.sector + ' &bull; ' + data.sectorSub + '</div>' +
      '</div>' +
      '<div class="sc-price"><span class="sc-price-currency">' + data.currency + '</span>' + data.price + '</div>' +
    '</div>' +
    '<div class="sc-meta">' +
      data.priceMetrics.slice(0, 4).map(function(m) {
        return '<div class="sc-meta-item">' + m.label + ': <span class="sc-meta-value">' + m.value + '</span></div>';
      }).join('') +
    '</div>' +
    '<div class="sc-skew">' +
      (data.riskSkew.computed ?
        '<div class="skew-bar-track" style="width:48px;height:6px">' +
          '<div class="skew-bar-bull" style="width:' + data.riskSkew.computed.bull + '%"></div>' +
          '<div class="skew-bar-bear" style="width:' + data.riskSkew.computed.bear + '%"></div>' +
        '</div>' +
        '<span class="skew-score ' + (data.riskSkew.computed.score > 5 ? 'positive' : data.riskSkew.computed.score < -5 ? 'negative' : 'neutral') + '" style="font-size:0.7rem">' + (data.riskSkew.computed.score > 0 ? '+' : '') + data.riskSkew.computed.score + '</span>'
        : '<span class="skew-badge ' + data.riskSkew.direction + '">' + data.riskSkew.badge + '</span>') +
      '<span class="sc-skew-rationale">' + data.riskSkew.rationale.substring(0, 120) + '&hellip;</span>' +
    '</div>' +
  '</div>';
}

function renderSnapshotPage(data) {
  // Price metrics
  var priceMetricsHtml = '';
  for (var i = 0; i < data.priceMetrics.length; i++) {
    var m = data.priceMetrics[i];
    priceMetricsHtml += '<div class="snap-pm-item"><span class="snap-pm-label">' + m.label + '</span><span class="snap-pm-value' + (m.cls ? ' ' + m.cls : '') + '">' + m.value + '</span></div>';
  }

  // Survival bar segments
  var survivalHtml = '';
  for (var i = 0; i < data.survivalBar.length; i++) {
    var s = data.survivalBar[i];
    survivalHtml += '<div class="snap-sb-segment ' + s.cls + '" style="width:' + s.width + '">' + s.label + '</div>';
  }
  var legendHtml = '';
  for (var i = 0; i < data.survivalLegend.length; i++) {
    var l = data.survivalLegend[i];
    legendHtml += '<div class="snap-sl-item"><div class="snap-sl-dot" style="background:' + l.color + '"></div>' + l.label + '</div>';
  }

  // Hypothesis cards
  var hypsHtml = '';
  for (var i = 0; i < data.hypotheses.length; i++) {
    var h = data.hypotheses[i];
    hypsHtml += '<div class="snap-hyp-card ' + h.cls + '">' +
      '<div class="snap-hyp-info">' +
        '<div class="snap-hyp-label">' + h.label + ' <span class="snap-hyp-status-tag ' + h.statusTag + '">' + h.statusText + '</span></div>' +
        '<div class="snap-hyp-desc">' + h.desc + '</div>' +
      '</div>' +
      '<div class="snap-hyp-score-container">' +
        '<div class="snap-hyp-score ' + h.scoreCls + '">' + h.score + '</div>' +
        '<div class="snap-hyp-direction ' + h.direction + '">' + h.dirLabel + '</div>' +
      '</div>' +
    '</div>';
  }

  // Evidence matrix
  var evHeaderHtml = '';
  for (var i = 0; i < data.evidenceMatrix.headers.length; i++) {
    evHeaderHtml += '<div class="snap-ev-cell">' + data.evidenceMatrix.headers[i] + '</div>';
  }
  var evRowsHtml = '';
  for (var i = 0; i < data.evidenceMatrix.rows.length; i++) {
    var row = data.evidenceMatrix.rows[i];
    var cellsHtml = '<div class="snap-ev-cell snap-ev-domain">' + row.domain + ' <span class="snap-ev-epistemic">' + row.epistemic + '</span></div>';
    for (var j = 0; j < row.cells.length; j++) {
      var c = row.cells[j];
      var styleAttr = c.style ? ' style="' + c.style + '"' : '';
      cellsHtml += '<div class="snap-ev-cell snap-ev-signal ' + c.cls + '"' + styleAttr + '>' + c.text + '</div>';
    }
    evRowsHtml += '<div class="snap-ev-matrix-row">' + cellsHtml + '</div>';
  }

  // Discriminators
  var discrimHtml = '';
  for (var i = 0; i < data.discriminators.length; i++) {
    var d = data.discriminators[i];
    discrimHtml += '<div class="snap-discrim-item"><div class="snap-discrim-tag ' + d.cls + '">' + d.level + '</div><div class="snap-discrim-text">' + d.text + '</div></div>';
  }
  var ndChips = '';
  for (var i = 0; i < data.nonDiscriminating.length; i++) {
    ndChips += '<span class="snap-nd-chip">' + data.nonDiscriminating[i] + '</span>';
  }

  // Tripwires
  var tripwiresHtml = '';
  for (var i = 0; i < data.tripwires.length; i++) {
    var tw = data.tripwires[i];
    var condHtml = '';
    for (var j = 0; j < tw.conditions.length; j++) {
      var c = tw.conditions[j];
      condHtml += '<div class="snap-tw-if"><span class="snap-tw-if-icon ' + c.iconCls + '">' + c.icon + '</span><span>' + c.text + '</span></div>';
    }
    tripwiresHtml += '<div class="snap-tripwire-card"><div class="snap-tw-header"><span class="snap-tw-date">' + tw.date + '</span><span class="snap-tw-test-name">' + tw.name + '</span></div><div class="snap-tw-conditions">' + condHtml + '</div></div>';
  }

  // Evidence coverage
  var coverageHtml = '';
  for (var i = 0; i < data.evidenceCoverage.length; i++) {
    var g = data.evidenceCoverage[i];
    coverageHtml += '<div class="snap-gap-row"><span class="snap-gap-domain">' + g.domain + '</span><span class="snap-gap-status ' + g.cls + '">' + g.status + '</span></div>';
  }

  // Questions
  var questionsHtml = '';
  for (var i = 0; i < data.questions.length; i++) {
    questionsHtml += '<div class="snap-question-item">' + data.questions[i] + '</div>';
  }

  // Footer meta
  var footerMetaHtml = '';
  for (var i = 0; i < data.footerMeta.length; i++) {
    footerMetaHtml += '<span class="snap-footer-meta">' + data.footerMeta[i].label + '</span>';
  }

  return '<div class="snap-page">' +
    '<a class="snap-back" href="#snapshots" onclick="navigate(\'snapshots\')">&larr; Back to Snapshots</a>' +
    '<a class="snap-view-full" href="#report-' + data.ticker + '" onclick="navigate(\'report-' + data.ticker + '\')" style="float:right;margin-top:4px">View Full Report &rarr;</a>' +
    '<div class="snap-header">' +
      '<div class="snap-header-left">' +
        '<span class="snap-ticker">' + data.tickerFull + '</span>' +
        '<span class="snap-company-name">' + data.company + '</span>' +
        '<span class="snap-sector-tag">' + data.sector + ' &bull; ' + data.sectorSub + '</span>' +
      '</div>' +
      '<div class="snap-header-right">' +
        '<div class="snap-logo-mark">CONTIN<span class="brand-green">UU</span>M INTE<span class="brand-green">LL</span>IGENCE</div>' +
        '<div class="snap-report-date">' + data.date + ' &bull; ' + data.version + '</div>' +
      '</div>' +
    '</div>' +

    '<div class="snap-price-bar">' +
      '<div><span class="snap-price-currency">' + data.currency + '</span><span class="snap-price-main">' + data.price + '</span></div>' +
      '<div class="snap-price-meta">' + priceMetricsHtml + '</div>' +
    '</div>' +

    '<div class="snap-risk-skew-bar">' +
      '<span class="snap-risk-skew-label">Thesis Skew</span>' +
      '<span class="snap-risk-skew-badge ' + data.riskSkew.direction + '">' + data.riskSkew.badge + '</span>' +
      (data.riskSkew.computed ?
        '<div class="skew-bar-track" style="width:64px;height:7px;margin:0 4px">' +
          '<div class="skew-bar-bull" style="width:' + data.riskSkew.computed.bull + '%"></div>' +
          '<div class="skew-bar-bear" style="width:' + data.riskSkew.computed.bear + '%"></div>' +
        '</div>' +
        '<span class="skew-score ' + (data.riskSkew.computed.score > 5 ? 'positive' : data.riskSkew.computed.score < -5 ? 'negative' : 'neutral') + '" style="font-size:0.78rem">' + (data.riskSkew.computed.score > 0 ? '+' : '') + data.riskSkew.computed.score + '</span>'
        : '') +
      '<span class="snap-risk-skew-rationale">' + data.riskSkew.rationale + '</span>' +
    '</div>' +

    '<div class="snap-main-grid">' +
      // LEFT COLUMN
      '<div class="snap-col">' +
        '<div><div class="snap-section-label">Dominant Narrative</div>' +
          '<div class="snap-narrative-box">' +
            '<div class="snap-narrative-text">' + data.narrative.text + '</div>' +
            '<div class="snap-narrative-verdict">' + data.narrative.verdict + '</div>' +
          '</div>' +
        '</div>' +
        '<div><div class="snap-section-label">Hypothesis Survival</div>' +
          '<div class="snap-survival-bar-container">' +
            '<div class="snap-survival-bar">' + survivalHtml + '</div>' +
            '<div class="snap-survival-legend">' + legendHtml + '</div>' +
          '</div>' +
        '</div>' +
        '<div class="snap-hyp-stack">' + hypsHtml + '</div>' +
      '</div>' +

      // CENTER COLUMN
      '<div class="snap-col">' +
        '<div><div class="snap-section-label">Cross-Domain Evidence Matrix</div>' +
          '<div class="snap-evidence-matrix">' +
            '<div class="snap-ev-matrix-header">' + evHeaderHtml + '</div>' +
            evRowsHtml +
          '</div>' +
        '</div>' +
        '<div><div class="snap-section-label">What Discriminates</div>' +
          '<div class="snap-discrim-box">' +
            discrimHtml +
            '<div class="snap-non-discrim">' +
              '<div class="snap-non-discrim-label">Assessed &amp; Discarded (non-discriminating)</div>' +
              '<div class="snap-non-discrim-items">' + ndChips + '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>' +

      // RIGHT COLUMN
      '<div class="snap-col">' +
        '<div><div class="snap-section-label">What We\'re Watching</div>' +
          '<div class="snap-tripwire-list">' + tripwiresHtml + '</div>' +
        '</div>' +
        '<div><div class="snap-section-label">Evidence Coverage</div>' +
          '<div class="snap-gaps-box">' + coverageHtml + '</div>' +
        '</div>' +
        (data.technicalAnalysis ? '<div><div class="snap-section-label">Technical Structure</div>' +
          '<div class="snap-gaps-box">' +
            '<div class="snap-gap-row"><span class="snap-gap-domain">Regime</span><span class="snap-gap-status snap-gap-full">' + data.technicalAnalysis.regime + '</span></div>' +
            '<div class="snap-gap-row"><span class="snap-gap-domain">Trend</span><span class="snap-gap-status snap-gap-limited">' + data.technicalAnalysis.trend + '</span></div>' +
            '<div class="snap-gap-row"><span class="snap-gap-domain">50-Day MA</span><span style="font-family:var(--font-data);font-size:0.58rem;color:var(--text-secondary)">' + data.technicalAnalysis.ma50 + ' (' + data.technicalAnalysis.vsMa50 + ')</span></div>' +
            '<div class="snap-gap-row"><span class="snap-gap-domain">200-Day MA</span><span style="font-family:var(--font-data);font-size:0.58rem;color:var(--text-secondary)">' + data.technicalAnalysis.ma200 + ' (' + data.technicalAnalysis.vsMa200 + ')</span></div>' +
            '<div class="snap-gap-row"><span class="snap-gap-domain">Support</span><span style="font-family:var(--font-data);font-size:0.58rem;color:var(--signal-green)">' + data.technicalAnalysis.support + '</span></div>' +
            '<div class="snap-gap-row"><span class="snap-gap-domain">Resistance</span><span style="font-family:var(--font-data);font-size:0.58rem;color:var(--signal-red)">' + data.technicalAnalysis.resistance + '</span></div>' +
            '<div class="snap-gap-row"><span class="snap-gap-domain">Range Position</span><span style="font-family:var(--font-data);font-size:0.58rem;color:var(--signal-red)">' + data.technicalAnalysis.rangePosition + '</span></div>' +
            (data.technicalAnalysis.crossover ? '<div class="snap-gap-row"><span class="snap-gap-domain">Crossover</span><span style="font-family:var(--font-data);font-size:0.5rem;color:var(--signal-red)">' + data.technicalAnalysis.crossover + '</span></div>' : '') +
          '</div>' +
        '</div>' : '') +
        '<div><div class="snap-section-label">Unanswered Questions</div>' +
          '<div class="snap-questions-box">' + questionsHtml + '</div>' +
        '</div>' +
      '</div>' +
    '</div>' +

    '<div class="snap-footer">' +
      '<div class="snap-footer-left">' + data.footerDisclaimer + '</div>' +
      '<div class="snap-footer-right">' + footerMetaHtml + '</div>' +
    '</div>' +
    renderPDFDownload(data) +
  '</div>';
}


// ============================================================
// HOME PAGE RENDERERS
// ============================================================

function renderFeaturedCard(data) {
  var skew = data._skew || computeSkewScore(data);
  var dir = skew.direction;
  var scoreCls = skew.score > 5 ? 'positive' : skew.score < -5 ? 'negative' : 'neutral';
  var scoreLabel = (skew.score > 0 ? '+' : '') + skew.score;

  var metricsHtml = '';
  for (var i = 0; i < data.featuredMetrics.length; i++) {
    var m = data.featuredMetrics[i];
    var colorStyle = m.color ? ' style="color:' + m.color + '"' : '';
    metricsHtml += '<div><div class="fc-metric-label">' + m.label + '</div><div class="fc-metric-value"' + colorStyle + '>' + m.value + '</div></div>';
  }

  var priceColor = data.featuredPriceColor || '';
  var priceStyle = priceColor ? ' style="color: ' + priceColor + '"' : '';

  return '<div class="featured-card skew-' + dir + '" data-ticker-card="' + data.ticker + '" onclick="navigate(\'report-' + data.ticker + '\')" tabindex="0" role="link" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();navigate(\'report-' + data.ticker + '\')}">' +
    '<div class="fc-top">' +
      '<div>' +
        '<div class="fc-ticker">' + data.tickerFull + '</div>' +
        '<div class="fc-company">' + data.company + '</div>' +
        '<div class="fc-sector">' + data.sector + ' &bull; ' + data.sectorSub + '</div>' +
      '</div>' +
      '<div class="fc-price"' + priceStyle + '>' +
        '<span style="font-size:0.8rem; color:var(--text-muted)">' + data.currency + '</span>' + data.price +
      '</div>' +
    '</div>' +
    '<div class="fc-metrics">' + metricsHtml + '</div>' +
    '<div class="fc-skew">' +
      '<div class="skew-bar-track" style="width:48px;height:6px">' +
        '<div class="skew-bar-bull" style="width:' + skew.bull + '%"></div>' +
        '<div class="skew-bar-bear" style="width:' + skew.bear + '%"></div>' +
      '</div>' +
      '<span class="skew-score ' + scoreCls + '" style="font-size:0.7rem">' + scoreLabel + '</span>' +
      '<span class="fc-skew-rationale">' + data.featuredRationale + '</span>' +
    '</div>' +
    '<div class="fc-date">' + data.date + renderFreshnessBadge(data.ticker) + renderCatalystTag(data.ticker) + '</div>' +
  '</div>';
}

function renderFreshnessBadge(ticker) {
  if (typeof FRESHNESS_DATA === 'undefined' || !FRESHNESS_DATA[ticker]) return '';
  var f = FRESHNESS_DATA[ticker];
  var cls = 'fb-' + f.badge;
  var label = f.daysSinceReview + 'd ago';
  if (f.badge === 'ok') label = 'Current';
  return ' <span class="freshness-badge ' + cls + '">' + label + '</span>';
}

function renderCatalystTag(ticker) {
  if (typeof FRESHNESS_DATA === 'undefined' || !FRESHNESS_DATA[ticker]) return '';
  var f = FRESHNESS_DATA[ticker];
  if (!f.nearestCatalyst) return '';
  var cls = f.nearestCatalystDays !== null && f.nearestCatalystDays <= 7 ? ' ct-imminent' : '';
  var daysLabel = f.nearestCatalystDays !== null
    ? (f.nearestCatalystDays <= 0 ? 'NOW' : f.nearestCatalystDays + 'd')
    : '';
  return ' <span class="catalyst-tag' + cls + '">' + f.nearestCatalyst + (daysLabel ? ' &bull; ' + daysLabel : '') + '</span>';
}

function renderCoverageRow(data) {
  var skew = data._skew || computeSkewScore(data);
  var scoreCls = skew.score > 5 ? 'positive' : skew.score < -5 ? 'negative' : 'neutral';
  var scoreLabel = (skew.score > 0 ? '+' : '') + skew.score;

  // Tooltip hypothesis breakdown
  var tooltipRows = '';
  for (var i = 0; i < skew.hypotheses.length; i++) {
    var h = skew.hypotheses[i];
    var dotCls = h.direction === 'upside' ? 'up' : h.direction === 'downside' ? 'down' : 'neutral';
    tooltipRows += '<div class="skew-tooltip-row">' +
      '<span class="skew-tooltip-dot ' + dotCls + '"></span>' +
      '<span>' + h.title + '</span>' +
      '<span class="skew-tooltip-weight">' + h.weight + '%</span>' +
    '</div>';
  }
  var tooltipHtml = '<div class="skew-tooltip">' +
    '<div class="skew-tooltip-title">Hypothesis Weights</div>' +
    tooltipRows +
    '<div class="skew-tooltip-rationale">' + data.skew.rationale.substring(0, 160) + (data.skew.rationale.length > 160 ? '&hellip;' : '') + '</div>' +
  '</div>';

  // Format date as short form: "10 Feb 2026"
  var dateParts = data.date.split(' ');
  var shortDate = dateParts[0] + ' ' + (dateParts[1] ? dateParts[1].substring(0, 3) : '') + ' ' + (dateParts[2] || '');

  return '<tr data-skew-score="' + skew.score + '" onclick="navigate(\'report-' + data.ticker + '\')" tabindex="0" role="link" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();navigate(\'report-' + data.ticker + '\')}">' +
    '<td class="td-ticker">' + data.ticker + '</td>' +
    '<td>' + data.company + '</td>' +
    '<td>' + data.sector + '</td>' +
    '<td class="td-price">' + data.currency + (data._livePrice || data.price) + '</td>' +
    '<td>' +
      '<div class="skew-cell">' +
        '<div class="skew-bar-track">' +
          '<div class="skew-bar-bull" style="width:' + skew.bull + '%"></div>' +
          '<div class="skew-bar-bear" style="width:' + skew.bear + '%"></div>' +
        '</div>' +
        '<span class="skew-score ' + scoreCls + '">' + scoreLabel + '</span>' +
        tooltipHtml +
      '</div>' +
    '</td>' +
    '<td class="td-date">' + shortDate + '</td>' +
    '<td>' + renderFreshnessBadge(data.ticker) + renderCatalystTag(data.ticker) + '</td>' +
  '</tr>';
}

function renderComingSoonRow(stub) {
  var dir = stub.skew || 'balanced';
  var bull = dir === 'upside' ? 65 : dir === 'downside' ? 35 : 50;
  var bear = 100 - bull;
  var score = bull - bear;
  var scoreCls = score > 5 ? 'positive' : score < -5 ? 'negative' : 'neutral';
  var scoreLabel = (score > 0 ? '+' : '') + score;

  return '<tr class="stub" data-skew-score="' + score + '">' +
    '<td class="td-ticker">' + stub.ticker + '</td>' +
    '<td>' + stub.company + '</td>' +
    '<td>' + stub.sector + '</td>' +
    '<td class="td-price">' + (stub.currency || 'A$') + stub.price + '</td>' +
    '<td>' +
      '<div class="skew-cell">' +
        '<div class="skew-bar-track">' +
          '<div class="skew-bar-bull" style="width:' + bull + '%"></div>' +
          '<div class="skew-bar-bear" style="width:' + bear + '%"></div>' +
        '</div>' +
        '<span class="skew-score ' + scoreCls + '">' + scoreLabel + '</span>' +
      '</div>' +
    '</td>' +
    '<td><span class="coming-soon">Coming Soon</span></td>' +
    '<td></td>' +
  '</tr>';
}

// Coverage table sort state
var coverageSortDir = 0; // 0 = unsorted (default), 1 = desc (bearish first), -1 = asc (bullish first)

function sortCoverageTable() {
  var tbody = document.getElementById('coverage-body');
  if (!tbody) return;
  var rows = Array.prototype.slice.call(tbody.querySelectorAll('tr'));
  var arrow = document.getElementById('skew-sort-arrow');

  // Cycle: unsorted -> desc (bearish first) -> asc (bullish first) -> unsorted
  coverageSortDir = coverageSortDir === 0 ? 1 : coverageSortDir === 1 ? -1 : 0;

  if (coverageSortDir === 0) {
    // Restore default order: re-render
    if (arrow) { arrow.innerHTML = '&#9650;'; arrow.className = 'sort-arrow'; }
    tbody.innerHTML = '';
    FEATURED_ORDER.forEach(function(ticker) {
      if (STOCK_DATA[ticker]) {
        tbody.innerHTML += renderCoverageRow(STOCK_DATA[ticker]);
      }
    });
    if (typeof COMING_SOON !== 'undefined') {
      COMING_SOON.forEach(function(stub) {
        tbody.innerHTML += renderComingSoonRow(stub);
      });
    }
    return;
  }

  // Sort by data-skew-score attribute
  rows.sort(function(a, b) {
    var sa = parseInt(a.getAttribute('data-skew-score')) || 0;
    var sb = parseInt(b.getAttribute('data-skew-score')) || 0;
    return coverageSortDir === 1 ? sa - sb : sb - sa; // desc: bearish first (lowest score), asc: bullish first (highest score)
  });

  if (arrow) {
    arrow.className = 'sort-arrow active';
    arrow.innerHTML = coverageSortDir === 1 ? '&#9660;' : '&#9650;';
  }

  // Re-append in sorted order
  for (var i = 0; i < rows.length; i++) {
    tbody.appendChild(rows[i]);
  }
}

function buildCoverageData() {
  var coverageData = {};
  var tickers = Object.keys(STOCK_DATA);
  for (var i = 0; i < tickers.length; i++) {
    var t = tickers[i];
    var d = STOCK_DATA[t];
    coverageData[t] = {
      company: d.company,
      price: d._livePrice || d.price,
      skew: (d._skew || computeSkewScore(d)).direction,
      sector: d.sector
    };
  }
  return coverageData;
}

const SNAPSHOT_ORDER = Object.keys(STOCK_DATA);

// Snapshot data is now generated on-demand when full research data is available.
// buildSnapshotFromStock requires full hypothesis/evidence/tripwire data,
// which is only present after loadFullResearchData() resolves.
(function() {
  for (var i = 0; i < SNAPSHOT_ORDER.length; i++) {
    var t = SNAPSHOT_ORDER[i];
    // Only build snapshots for tickers with full research data loaded
    if (!SNAPSHOT_DATA[t] && STOCK_DATA[t] && !STOCK_DATA[t]._indexOnly) {
      SNAPSHOT_DATA[t] = buildSnapshotFromStock(t);
    }
  }
})();


// ============================================================
// CONTINUUM DYNAMICS ENGINE
// Computes derived metrics from live price + REFERENCE_DATA,
// then hydrates STOCK_DATA so all rendered text stays current.
//
// Replaces hardcoded market caps, P/E ratios, drawdowns,
// upside-to-target, and narrative text with live-computed values.
// ============================================================
const ContinuumDynamics = (function() {

  // --- Formatting Helpers ---
  function fmtB(val) {
    // Format billions: 12.05 -> "12.1B", 0.95 -> "950M", 79.3 -> "79B"
    val = parseFloat(val) || 0;
    if (val >= 100) return Math.round(val) + 'B';
    if (val >= 10)  return val.toFixed(1).replace(/\.0$/, '') + 'B';
    if (val >= 1)   return val.toFixed(1).replace(/\.0$/, '') + 'B';
    return Math.round(val * 1000) + 'M';
  }

  function fmtPrice(val, currency) {
    val = parseFloat(val) || 0;
    if (val >= 100) return (currency || 'A$') + val.toFixed(2);
    if (val >= 10)  return (currency || 'A$') + val.toFixed(2);
    return (currency || 'A$') + val.toFixed(2);
  }

  function fmtPct(val) {
    val = parseFloat(val) || 0;
    return Math.round(Math.abs(val)) + '%';
  }

  function fmtPE(val) {
    val = parseFloat(val);
    if (!val || !isFinite(val) || val <= 0) return null;
    if (val >= 100) return '~' + Math.round(val) + 'x';
    return val.toFixed(1).replace(/\.0$/, '') + 'x';
  }

  function signPct(val) {
    return (val >= 0 ? '+' : '') + Math.round(val) + '%';
  }

  // --- Core Computation ---
  function compute(ticker) {
    var stock = STOCK_DATA[ticker];
    var ref = REFERENCE_DATA[ticker];
    if (!stock || !ref) return null;

    var price = parseFloat(stock._livePrice || stock.price) || 0;
    var currency = stock.currency || 'A$';

    // 52-week high/low from priceHistory
    var history = stock.priceHistory || [];
    var h252 = history.slice(-252);
    var high52 = h252.length > 0 ? Math.max.apply(null, h252) : null;
    var low52  = h252.length > 0 ? Math.min.apply(null, h252) : null;

    // Market cap
    var marketCap = ref.sharesOutstanding ? (price * ref.sharesOutstanding / 1000) : null;

    // P/E ratios
    var trailingPE = ref.epsTrailing ? price / ref.epsTrailing : null;
    var forwardPE  = ref.epsForward  ? price / ref.epsForward  : null;

    // Dividend yield
    var divYield = ref.divPerShare ? (ref.divPerShare / price) * 100 : null;

    // Drawdown from 52-week high
    var drawdownFromHigh = high52 ? ((price - high52) / high52) * 100 : null;

    // Upside to analyst target
    var upsideToTarget = ref.analystTarget ? ((ref.analystTarget - price) / price) * 100 : null;

    // Range position (0 = at 52w low, 100 = at 52w high)
    var rangePosition = (high52 && low52 && high52 !== low52) ?
      ((price - low52) / (high52 - low52)) * 100 : null;

    return {
      ticker: ticker,
      price: price,
      currency: currency,
      marketCap: marketCap,
      marketCapStr: marketCap ? fmtB(marketCap) : null,
      trailingPE: trailingPE,
      forwardPE: forwardPE,
      divYield: divYield,
      high52: high52,
      low52: low52,
      drawdownFromHigh: drawdownFromHigh,
      upsideToTarget: upsideToTarget,
      rangePosition: rangePosition,
      // Formatted strings
      fmt: {
        price: fmtPrice(price, currency),
        marketCap: marketCap ? currency + fmtB(marketCap) : null,
        trailingPE: fmtPE(trailingPE),
        forwardPE: fmtPE(forwardPE),
        divYield: divYield ? divYield.toFixed(1) + '%' : null,
        drawdown: drawdownFromHigh != null ? '&darr;' + fmtPct(drawdownFromHigh) : null,
        drawdownClean: drawdownFromHigh != null ? fmtPct(drawdownFromHigh) : null,
        upsideToTarget: upsideToTarget != null ? signPct(upsideToTarget) : null,
        high52: high52 ? fmtPrice(high52, currency) : null,
        low52: low52 ? fmtPrice(low52, currency) : null,
        range52: (high52 && low52) ? fmtPrice(low52, currency) + ' &ndash; ' + fmtPrice(high52, currency) : null,
        analystTarget: ref.analystTarget ? fmtPrice(ref.analystTarget, currency) : null,
        analystTargetWithUpside: (ref.analystTarget && upsideToTarget != null) ?
          fmtPrice(ref.analystTarget, currency) + ' (' + signPct(upsideToTarget) + ')' : null
      }
    };
  }

  // --- Hydration: Patch STOCK_DATA in place ---

  // Update heroMetrics values by label
  function hydrateHeroMetrics(stock, computed) {
    if (!stock.heroMetrics) return;
    for (var i = 0; i < stock.heroMetrics.length; i++) {
      var m = stock.heroMetrics[i];
      var label = m.label.toLowerCase();
      if (label === 'mkt cap' && computed.fmt.marketCap) {
        m.value = computed.fmt.marketCap;
      } else if (label === 'drawdown' && computed.fmt.drawdown) {
        m.value = computed.fmt.drawdown;
        m.colorClass = computed.drawdownFromHigh < -20 ? 'negative' : computed.drawdownFromHigh < -5 ? 'caution' : '';
      } else if (label.indexOf('analyst') >= 0 && label.indexOf('target') >= 0 && computed.fmt.analystTargetWithUpside) {
        m.value = computed.fmt.analystTargetWithUpside;
      } else if ((label === 'fwd p/e' || label === 'p/e') && computed.fmt.forwardPE) {
        m.value = computed.fmt.forwardPE;
      } else if (label === 'div yield' && computed.fmt.divYield) {
        m.value = computed.fmt.divYield;
      } else if (label === 'trailing p/e' && computed.fmt.trailingPE) {
        m.value = computed.fmt.trailingPE;
      }
    }
  }

  // Update featuredMetrics values by label
  function hydrateFeaturedMetrics(stock, computed) {
    if (!stock.featuredMetrics) return;
    for (var i = 0; i < stock.featuredMetrics.length; i++) {
      var m = stock.featuredMetrics[i];
      var label = m.label.toLowerCase();
      if (label === 'mkt cap' && computed.fmt.marketCap) {
        m.value = computed.fmt.marketCap;
      } else if (label === 'drawdown' && computed.fmt.drawdown) {
        m.value = computed.fmt.drawdown;
      } else if (label.indexOf('analyst') >= 0 && label.indexOf('target') >= 0 && computed.fmt.analystTarget) {
        m.value = computed.fmt.analystTarget;
      } else if ((label === 'fwd p/e' || label === 'p/e') && computed.fmt.forwardPE) {
        m.value = computed.fmt.forwardPE;
      } else if (label === 'div yield' && computed.fmt.divYield) {
        m.value = computed.fmt.divYield;
      } else if (label === 'trailing p/e' && computed.fmt.trailingPE) {
        m.value = computed.fmt.trailingPE;
      }
    }
    // Update featured price colour
    if (computed.drawdownFromHigh != null) {
      stock.featuredPriceColor = computed.drawdownFromHigh < -20 ? 'var(--signal-red)' :
        computed.drawdownFromHigh < -5 ? 'var(--signal-amber)' : 'var(--signal-green)';
    }
  }

  // Update identity table rows by label
  function hydrateIdentity(stock, computed) {
    if (!stock.identity || !stock.identity.rows) return;
    for (var r = 0; r < stock.identity.rows.length; r++) {
      for (var c = 0; c < stock.identity.rows[r].length; c++) {
        var cell = stock.identity.rows[r][c];
        var label = cell[0].toLowerCase();
        if (label === 'share price' && computed.fmt.price) {
          cell[1] = computed.fmt.price;
          cell[2] = computed.drawdownFromHigh < -20 ? 'td-mono td-red' :
                    computed.drawdownFromHigh < -5  ? 'td-mono td-amber' : 'td-mono td-green';
        } else if (label === 'market cap' && computed.fmt.marketCap) {
          cell[1] = computed.fmt.marketCap;
        } else if (label === '52-week range' && computed.fmt.range52) {
          cell[1] = computed.fmt.range52;
        } else if (label === 'trailing p/e' && computed.fmt.trailingPE) {
          cell[1] = computed.fmt.trailingPE;
        } else if (label === 'forward p/e' && computed.fmt.forwardPE) {
          cell[1] = computed.fmt.forwardPE;
        } else if ((label === 'drawdown from high' || label === 'drawdown') && computed.fmt.drawdown) {
          cell[1] = computed.fmt.drawdown;
          cell[2] = computed.drawdownFromHigh < -20 ? 'td-mono td-red' : 'td-mono td-amber';
        } else if (label === 'dividend' || label === 'div yield') {
          if (computed.fmt.divYield) {
            cell[1] = cell[1].replace(/[\d.]+%/, computed.fmt.divYield);
          }
        }
      }
    }
  }

  // Smart text replacement: swap old anchored values with new computed values
  function hydrateText(text, ref, computed) {
    if (!text || typeof text !== 'string') return text;
    var anchors = ref._anchors || {};
    var currency = computed.currency || 'A$';

    // Escape currency for regex
    var esc = currency.replace('$', '\\$');

    // Replace price: "A$77.87" -> new price
    if (anchors.price && computed.price !== anchors.price) {
      var oldPrice = parseFloat(anchors.price).toFixed(2);
      var newPrice = parseFloat(computed.price).toFixed(2);
      text = text.split(currency + oldPrice).join(currency + newPrice);
    }

    // Replace market cap: "A$12.0B" -> new market cap
    if (anchors.marketCapStr && computed.marketCapStr && computed.marketCapStr !== anchors.marketCapStr) {
      text = text.split(currency + anchors.marketCapStr).join(currency + computed.marketCapStr);
    }

    // Replace drawdown %: "60%" in drawdown context
    if (anchors.drawdown != null && computed.drawdownFromHigh != null) {
      var oldDd = Math.round(Math.abs(anchors.drawdown));
      var newDd = Math.round(Math.abs(computed.drawdownFromHigh));
      if (oldDd !== newDd) {
        // Target drawdown references with context clues
        text = text.replace(new RegExp('(down |down&nbsp;|drawdown[^\\d]*|\\bdarr;|sell-off[^\\d]*|-|&darr;)' + oldDd + '%', 'gi'),
          function(match) { return match.replace(oldDd + '%', newDd + '%'); });
        // Also replace standalone references like "to -60%" or "deepens to -60%"
        text = text.replace(new RegExp('-' + oldDd + '%', 'g'), '-' + newDd + '%');
      }
    }

    // Replace upside to target: "145%" in upside context
    if (anchors.upsideToTarget != null && computed.upsideToTarget != null) {
      var oldUp = Math.round(Math.abs(anchors.upsideToTarget));
      var newUp = Math.round(Math.abs(computed.upsideToTarget));
      if (oldUp !== newUp) {
        text = text.replace(new RegExp('(\\+|upside[^\\d]*|representing |\\()' + oldUp + '%', 'gi'),
          function(match) { return match.replace(oldUp + '%', newUp + '%'); });
      }
    }

    // Replace P/E: "41x" -> new P/E
    if (anchors.pe && computed.trailingPE) {
      var oldPE = fmtPE(anchors.pe);
      var newPE = fmtPE(computed.trailingPE);
      if (oldPE && newPE && oldPE !== newPE) {
        text = text.split(oldPE).join(newPE);
      }
    }

    // Replace forward P/E
    if (anchors.fwdPE && computed.forwardPE) {
      var oldFPE = fmtPE(anchors.fwdPE);
      var newFPE = fmtPE(computed.forwardPE);
      if (oldFPE && newFPE && oldFPE !== newFPE) {
        text = text.split(oldFPE).join(newFPE);
      }
    }

    // Replace analyst target with upside: "A$191 (+145%)" -> new
    if (anchors.upsideToTarget != null && ref.analystTarget && computed.upsideToTarget != null) {
      var oldTargetStr = currency + Math.round(ref.analystTarget) + ' (+' + Math.round(Math.abs(anchors.upsideToTarget)) + '%)';
      var newTargetStr = currency + Math.round(ref.analystTarget) + ' (' + signPct(computed.upsideToTarget) + ')';
      text = text.split(oldTargetStr).join(newTargetStr);
    }

    return text;
  }

  // Hydrate all text fields in a stock's data recursively
  function hydrateTextFields(obj, ref, computed) {
    if (!obj || typeof obj !== 'object') return;
    for (var key in obj) {
      if (!obj.hasOwnProperty(key)) continue;
      if (typeof obj[key] === 'string') {
        obj[key] = hydrateText(obj[key], ref, computed);
      } else if (Array.isArray(obj[key])) {
        for (var i = 0; i < obj[key].length; i++) {
          if (typeof obj[key][i] === 'string') {
            obj[key][i] = hydrateText(obj[key][i], ref, computed);
          } else if (typeof obj[key][i] === 'object') {
            hydrateTextFields(obj[key][i], ref, computed);
          }
        }
      } else if (typeof obj[key] === 'object' && key !== 'technicalAnalysis' && key !== 'priceHistory') {
        hydrateTextFields(obj[key], ref, computed);
      }
    }
  }

  // Update the featured rationale with dynamic context
  function hydrateFeaturedRationale(stock, computed, ref) {
    if (!stock.featuredRationale) return;
    stock.featuredRationale = hydrateText(stock.featuredRationale, ref, computed);
  }

  // --- Hypothesis Score Adjustment ---
  // Adjust hypothesis scores based on price dislocation from review date
  function adjustHypothesisScores(stock, computed, ref) {
    if (!stock.hypotheses || !ref._anchors || !ref._anchors.price) return;

    var priceDelta = ((computed.price - ref._anchors.price) / ref._anchors.price) * 100;
    var absDelta = Math.abs(priceDelta);

    // Only adjust if price has moved significantly (>5%)
    if (absDelta < 5) return;

    for (var i = 0; i < stock.hypotheses.length; i++) {
      var hyp = stock.hypotheses[i];

      // Save original values on first adjustment — idempotency anchor.
      // All subsequent hydrate() calls adjust from the original, preventing compounding.
      if (hyp._origScore === undefined) {
        hyp._origScore = parseInt(hyp.score) || 0;
        hyp._origScoreMeta = hyp.scoreMeta || '';
      }

      var baseScore = hyp._origScore;
      if (isNaN(baseScore)) continue;

      var adjustment = 0;

      if (hyp.direction === 'upside') {
        // Upside thesis: price drop strengthens it (more upside), price rise weakens it
        if (priceDelta < -20) adjustment = 5;
        else if (priceDelta < -10) adjustment = 3;
        else if (priceDelta > 20) adjustment = -5;
        else if (priceDelta > 10) adjustment = -3;
      } else if (hyp.direction === 'downside') {
        // Downside thesis: price drop strengthens it (being validated), price rise weakens it
        if (priceDelta < -20) adjustment = 5;
        else if (priceDelta < -10) adjustment = 3;
        else if (priceDelta > 20) adjustment = -5;
        else if (priceDelta > 10) adjustment = -3;
      }

      if (adjustment !== 0) {
        var newScore = Math.max(5, Math.min(95, baseScore + adjustment));
        hyp.score = newScore + '%';
        hyp.scoreWidth = newScore + '%';
        // Replace scoreMeta (not append) to prevent tag stacking
        if (adjustment > 0) {
          hyp.scoreMeta = hyp._origScoreMeta + ' <span class="dynamic-adj">(+' + adjustment + ' price move)</span>';
        } else {
          hyp.scoreMeta = hyp._origScoreMeta + ' <span class="dynamic-adj">(' + adjustment + ' price move)</span>';
        }
      }
    }
  }

  // --- Master Hydration ---
  function hydrate(ticker) {
    var stock = STOCK_DATA[ticker];
    var ref = REFERENCE_DATA[ticker];
    if (!stock || !ref) return null;

    var computed = compute(ticker);
    if (!computed) return null;

    // Store computed data on the stock for rendering access
    stock._computed = computed;

    // 1. Structured fields
    hydrateHeroMetrics(stock, computed);
    hydrateFeaturedMetrics(stock, computed);
    hydrateIdentity(stock, computed);

    // 2. Hypothesis scores
    adjustHypothesisScores(stock, computed, ref);

    // 2b. Cache canonical skew score (single source of truth for all renderers)
    stock._skew = computeSkewScore(stock);

    // 2c. Sync hero.skew and skew.direction with computed _skew so all render sites agree
    if (stock.hero) {
      stock.hero.skew = stock._skew.direction.toUpperCase();
    }
    if (stock.skew) {
      stock.skew.direction = stock._skew.direction;
    }

    // 3. All text fields (narrative, descriptions, rationale, evidence)
    // Skip fields that shouldn't be text-replaced
    var textTargets = [
      'heroDescription', 'heroCompanyDescription',
      'featuredRationale'
    ];
    for (var i = 0; i < textTargets.length; i++) {
      if (stock[textTargets[i]]) {
        stock[textTargets[i]] = hydrateText(stock[textTargets[i]], ref, computed);
      }
    }

    // Deep hydrate complex objects
    if (stock.hero) hydrateTextFields(stock.hero, ref, computed);
    if (stock.skew) hydrateTextFields(stock.skew, ref, computed);
    if (stock.verdict) hydrateTextFields(stock.verdict, ref, computed);
    if (stock.narrative) hydrateTextFields(stock.narrative, ref, computed);
    if (stock.evidence) hydrateTextFields(stock.evidence, ref, computed);
    if (stock.hypotheses) hydrateTextFields({ h: stock.hypotheses }, ref, computed);
    if (stock.identity && stock.identity.overview) {
      stock.identity.overview = hydrateText(stock.identity.overview, ref, computed);
    }

    // 4. Update the FRESHNESS_DATA for this ticker
    if (typeof FRESHNESS_DATA !== 'undefined' && FRESHNESS_DATA[ticker]) {
      FRESHNESS_DATA[ticker].pricePctChange =
        Math.round(((computed.price - (FRESHNESS_DATA[ticker].priceAtReview || ref._anchors.price)) /
        (FRESHNESS_DATA[ticker].priceAtReview || ref._anchors.price)) * 1000) / 10;
    }

    if (typeof window.DataEvents !== 'undefined') {
      window.DataEvents.emit('stock:updated', { ticker: ticker, computed: computed });
    }
    return computed;
  }

  function hydrateAll() {
    var tickers = Object.keys(STOCK_DATA);
    var results = {};
    for (var i = 0; i < tickers.length; i++) {
      var t = tickers[i];
      if (REFERENCE_DATA[t]) {
        results[t] = hydrate(t);
      }
    }
    console.log('[ContinuumDynamics] Hydrated ' + Object.keys(results).length + ' stocks');
    return results;
  }

  // Re-hydrate after live price update (called from updateLiveUI)
  function onPriceUpdate(ticker, newPrice) {
    var stock = STOCK_DATA[ticker];
    if (!stock) return;
    stock._livePrice = newPrice;
    return hydrate(ticker);
  }

  return {
    compute: compute,
    hydrate: hydrate,
    hydrateAll: hydrateAll,
    onPriceUpdate: onPriceUpdate,
    fmtB: fmtB,
    fmtPrice: fmtPrice,
    fmtPE: fmtPE
  };
})();

// Run initial hydration immediately after all STOCK_DATA is defined
try { ContinuumDynamics.hydrateAll(); } catch(e) { console.error('[ContinuumDynamics] hydrateAll failed:', e); }


// ============================================================
// LIVE MARKET DATA MODULE
// Fetches 3-year daily OHLCV from Yahoo Finance, caches in
// localStorage, and patches STOCK_DATA with live prices.
// Falls back gracefully to static data if fetch fails.
// ============================================================

const LiveData = (function() {
  const CACHE_KEY = 'continuum_market_data';
  const CACHE_TTL = 4 * 60 * 60 * 1000; // 4 hours
  var _status = {}; // Per-ticker status: 'loading', 'live', 'failed'

  // CORS proxies removed for security  --  third-party proxies can log/modify traffic.
  // Live prices come from data/live-prices.json (updated every 15 min via GitHub Actions).
  // Direct Yahoo Finance calls kept as best-effort fallback only.

  // Yahoo Finance chart URLs (try multiple endpoints)
  function yahooUrls(ticker) {
    return [
      'https://query1.finance.yahoo.com/v8/finance/chart/' + ticker + '?range=3y&interval=1d&includePrePost=false&events=history',
      'https://query2.finance.yahoo.com/v8/finance/chart/' + ticker + '?range=3y&interval=1d&includePrePost=false'
    ];
  }

  function getCache(ticker) {
    try {
      var raw = localStorage.getItem(CACHE_KEY + '_' + ticker);
      if (!raw) return null;
      var cached = JSON.parse(raw);
      if (Date.now() - cached.ts > CACHE_TTL) return null;
      return cached.data;
    } catch(e) { return null; }
  }

  function setCache(ticker, data) {
    try {
      localStorage.setItem(CACHE_KEY + '_' + ticker, JSON.stringify({ ts: Date.now(), data: data }));
    } catch(e) { /* quota exceeded  --  ignore */ }
  }

  function parseYahooResponse(json) {
    var result = json.chart.result[0];
    var meta = result.meta;
    var timestamps = result.timestamp;
    var quote = result.indicators.quote[0];
    var adjclose = result.indicators.adjclose ? result.indicators.adjclose[0].adjclose : null;

    var bars = [];
    for (var i = 0; i < timestamps.length; i++) {
      if (quote.close[i] == null) continue;
      bars.push({
        date: new Date(timestamps[i] * 1000),
        open:  quote.open[i],
        high:  quote.high[i],
        low:   quote.low[i],
        close: quote.close[i],
        volume: quote.volume[i],
        adjclose: adjclose ? adjclose[i] : quote.close[i]
      });
    }

    return {
      ticker: meta.symbol,
      currency: meta.currency === 'AUD' ? 'A$' : meta.currency + ' ',
      currentPrice: meta.regularMarketPrice,
      previousClose: meta.chartPreviousClose,
      bars: bars
    };
  }

  // Timeout wrapper that works in all browsers
  function fetchWithTimeout(url, opts, ms) {
    return new Promise(function(resolve, reject) {
      var controller = new AbortController();
      opts.signal = controller.signal;
      var timer = setTimeout(function() { controller.abort(); }, ms);
      fetch(url, opts).then(function(r) { clearTimeout(timer); resolve(r); })
                       .catch(function(e) { clearTimeout(timer); reject(e); });
    });
  }

  async function fetchTicker(ticker) {
    var cached = getCache(ticker);
    if (cached) {
      _status[ticker] = 'live';
      return cached;
    }

    _status[ticker] = 'loading';
    var urls = yahooUrls(ticker);

    // Direct Yahoo Finance attempt (may work from some origins/browsers)
    for (var u = 0; u < urls.length; u++) {
      try {
        var resp = await fetchWithTimeout(urls[u], {
          headers: { 'Accept': 'application/json' },
          mode: 'cors'
        }, 10000);
        if (resp.ok) {
          var json = await resp.json();
          if (json.chart && json.chart.result) {
            var data = parseYahooResponse(json);
            if (data.bars.length > 100) {
              setCache(ticker, data);
              _status[ticker] = 'live';
              return data;
            }
          }
        }
      } catch(e) { /* expected CORS block */ }
    }

    _status[ticker] = 'failed';
    return null;
  }

  // Compute technical metrics from live bar data
  function computeLiveTA(bars, staticTA) {
    if (!bars || bars.length < 50) return null;
    var n = bars.length;
    var closes = bars.map(function(b) { return b.close; });

    function ma(arr, period) {
      if (arr.length < period) return null;
      var sum = 0;
      for (var i = arr.length - period; i < arr.length; i++) sum += arr[i];
      return sum / period;
    }

    var ma50 = ma(closes, 50);
    var ma200 = ma(closes, 200);
    var price = closes[n - 1];
    var high52 = Math.max.apply(null, closes.slice(-252));
    var low52 = Math.min.apply(null, closes.slice(-252));

    // Full MA arrays for chart
    var ma50Arr = [];
    var ma200Arr = [];
    for (var i = 0; i < n; i++) {
      if (i >= 49) {
        var s = 0; for (var j = i - 49; j <= i; j++) s += closes[j];
        ma50Arr.push(s / 50);
      } else { ma50Arr.push(null); }
      if (i >= 199) {
        var s = 0; for (var j = i - 199; j <= i; j++) s += closes[j];
        ma200Arr.push(s / 200);
      } else { ma200Arr.push(null); }
    }

    return {
      price: price,
      ma50: ma50,
      ma200: ma200,
      ma50Arr: ma50Arr,
      ma200Arr: ma200Arr,
      priceVsMa50: ma50 ? ((price / ma50) - 1) * 100 : null,
      priceVsMa200: ma200 ? ((price / ma200) - 1) * 100 : null,
      high52: high52,
      low52: low52,
      drawdown: ((price - high52) / high52) * 100,
      rangePosition: high52 !== low52 ? ((price - low52) / (high52 - low52)) * 100 : 50,
      bars: bars
    };
  }

  // Patch a STOCK_DATA entry with live data
  function patchStockData(ticker, liveData) {
    var stock = window.STOCK_DATA[ticker];
    if (!stock || !liveData) return;

    // Store live chart data on the stock object
    stock._liveChart = liveData;
    stock._liveTA = computeLiveTA(liveData.bars, stock.technicalAnalysis);

    // Update the displayed price
    if (liveData.currentPrice) {
      stock._livePrice = liveData.currentPrice;
    }
  }

  return {
    fetch: fetchTicker,
    patchStockData: patchStockData,
    getCache: getCache,
    status: function(ticker) { return _status[ticker] || 'idle'; }
  };
})();

// ============================================================
// LIVE DATA WIRING
// Fetches live data for a ticker, patches STOCK_DATA, then
// updates the chart container and hero price in-place.
// ============================================================

const _liveFetched = new Set();

async function fetchAndPatchLive(ticker) {
    if (_liveFetched.has(ticker)) {
        // Already fetched this session  --  just ensure UI is current
        updateLiveUI(ticker);
        return;
    }

    var stock = STOCK_DATA[ticker];
    if (!stock) return;

    // Show loading state in chart container
    var chartContainer = document.querySelector('#page-report-' + ticker + ' .ta-chart-container');
    if (chartContainer && !stock._liveChart) {
        chartContainer.style.position = 'relative';
        var loadingDiv = document.createElement('div');
        loadingDiv.className = 'ta-chart-loading';
        loadingDiv.id = 'chart-loading-' + ticker;
        loadingDiv.innerHTML = '<div class="spinner"></div>Fetching live market data\u2026';
        loadingDiv.style.cssText = 'position:absolute;top:0;left:0;right:0;bottom:0;border-radius:6px;z-index:2';
        chartContainer.appendChild(loadingDiv);
    }

    try {
        var liveData = await LiveData.fetch(stock.tickerFull);
        if (liveData) {
            LiveData.patchStockData(ticker, liveData);
            _liveFetched.add(ticker);
            updateLiveUI(ticker);
        } else {
            _liveFetched.add(ticker);
            showDataStatus(ticker, 'static');
        }
    } catch(e) {
        _liveFetched.add(ticker);
        showDataStatus(ticker, 'static');
    }
}

function showDataStatus(ticker, status) {
    // Remove any loading overlay
    var loader = document.getElementById('chart-loading-' + ticker);
    if (loader) loader.remove();
    // Update badge text if static
    if (status === 'static') {
        var badge = document.querySelector('#page-report-' + ticker + ' .ta-chart-static-badge');
        if (badge) badge.textContent = 'STATIC \u2014 Live feed unavailable';
    }
}

function updateLiveUI(ticker) {
    var stock = STOCK_DATA[ticker];
    if (!stock || stock._indexOnly) return;

    // 0) Re-hydrate STOCK_DATA with new live price  --  updates all metrics and narrative
    if (stock._livePrice && REFERENCE_DATA[ticker]) {
        ContinuumDynamics.onPriceUpdate(ticker, stock._livePrice);

        // Force re-render of the report page with hydrated data
        if (renderedPages.has(ticker)) {
            renderedPages.delete(ticker);
            var container = document.getElementById('page-report-' + ticker);
            if (container) {
                // Destroy Chart.js instances BEFORE DOM replacement
                destroyNarrativeTimelineChart(ticker);
                container.innerHTML = renderReportPage(STOCK_DATA[ticker]);
                initSectionToggles(ticker);
                setupScrollSpy('page-report-' + ticker);
                if (typeof window.initInlineChat === 'function') window.initInlineChat(ticker);
                // Re-apply narrative analysis after re-render
                if (typeof window.applyNarrativeAnalysis === 'function') {
                    window.applyNarrativeAnalysis(ticker);
                }
                // Init narrative timeline chart after DOM render
                initNarrativeTimelineChart(ticker);
            }
            renderedPages.add(ticker);
        }

        // Update home page featured card with hydrated metrics
        var featuredCard = document.querySelector('[data-ticker-card="' + ticker + '"]');
        if (featuredCard) {
            var newCardHtml = renderFeaturedCard(stock);
            var temp = document.createElement('div');
            temp.innerHTML = newCardHtml;
            if (temp.firstElementChild) {
                featuredCard.parentNode.replaceChild(temp.firstElementChild, featuredCard);
            }
        }
    }

    // 1) Re-render the chart with live data
    var chartContainer = document.querySelector('#page-report-' + ticker + ' .ta-chart-container');
    if (chartContainer) {
        var newChartHtml = renderTAChart(stock);
        var temp = document.createElement('div');
        temp.innerHTML = newChartHtml;
        chartContainer.parentNode.replaceChild(temp.firstElementChild, chartContainer);
    }

    // 2) Update hero price with live indicator
    if (stock._livePrice) {
        var priceEl = document.querySelector('#page-report-' + ticker + ' .rh-price');
        if (priceEl) {
            var change = stock._livePrice - stock.price;
            var changePct = (change / stock.price) * 100;
            var sign = change >= 0 ? '+' : '';
            var cls = change >= 0 ? 'positive' : 'negative';
            priceEl.innerHTML = '<span class="rh-price-currency">' + stock.currency + '</span>' +
                stock._livePrice.toFixed(2) +
                '<span class="rh-live-indicator"><span class="live-dot"></span>LIVE</span>' +
                '<div class="rh-price-change ' + cls + '">' + sign + change.toFixed(2) + ' (' + sign + changePct.toFixed(1) + '%)</div>';
        }
    }

    // 3) Update featured card price on home page
    var homeCard = document.querySelector('[data-ticker-card="' + ticker + '"] .fc-price');
    if (homeCard && stock._livePrice) {
        homeCard.textContent = stock.currency + stock._livePrice.toFixed(2);
    }
}

// Prefetch live data for all tickers on page load (background, staggered)
function prefetchAllLiveData() {
    var tickers = Object.keys(STOCK_DATA);
    var delay = 0;
    tickers.forEach(function(ticker) {
        setTimeout(function() {
            var stock = STOCK_DATA[ticker];
            if (stock && stock.tickerFull) {
                LiveData.fetch(stock.tickerFull).then(function(liveData) {
                    if (liveData) {
                        LiveData.patchStockData(ticker, liveData);
                        _liveFetched.add(ticker);

                        // Re-hydrate with live price  --  updates metrics, narrative, everything
                        if (REFERENCE_DATA[ticker]) {
                            ContinuumDynamics.onPriceUpdate(ticker, liveData.currentPrice);
                        }

                        // Update home card with fully hydrated data
                        var featuredCard = document.querySelector('[data-ticker-card="' + ticker + '"]');
                        if (featuredCard) {
                            var newCardHtml = renderFeaturedCard(stock);
                            var temp = document.createElement('div');
                            temp.innerHTML = newCardHtml;
                            if (temp.firstElementChild) {
                                featuredCard.parentNode.replaceChild(temp.firstElementChild, featuredCard);
                            }
                        }
                    }
                }).catch(function() {});
            }
        }, delay);
        delay += 500; // Stagger by 500ms to avoid rate limiting
    });
}

// ============================================================
// MARKET FEED  --  Live Price Polling & Market Status Engine
// ============================================================
const MarketFeed = (function() {
    var _pollTimer = null;
    var _lastPrices = {};        // Previous prices for flash detection
    var _lastFetchTime = null;
    var _isPolling = false;
    var _pollCount = 0;
    var _errorCount = 0;

    // Polling intervals (ms)
    var INTERVAL_MARKET_OPEN = 60 * 1000;     // 60s during trading
    var INTERVAL_PRE_MARKET = 120 * 1000;     // 2 min pre-market
    var INTERVAL_CLOSED = 15 * 60 * 1000;     // 15 min when closed
    var INTERVAL_ERROR_BACKOFF = 30 * 1000;   // 30s after error

    // Detect ASX market status (AEDT = UTC+11, AEST = UTC+10)
    // We use UTC+11 as default (covers most of trading year)
    function getMarketStatus() {
        var now = new Date();
        var day = now.getUTCDay();
        if (day === 0 || day === 6) return 'closed';

        var aedt = new Date(now.getTime() + 11 * 60 * 60 * 1000);
        var h = aedt.getUTCHours();
        var m = aedt.getUTCMinutes();
        var t = h * 60 + m;

        if (t < 590) return 'pre-market';   // Before 9:50 AM
        if (t < 600) return 'pre-open';      // 9:50 - 10:00 AM
        if (t < 960) return 'open';          // 10:00 AM - 4:00 PM
        if (t < 972) return 'auction';       // 4:00 - 4:12 PM
        return 'closed';
    }

    function getNextMarketOpen() {
        var now = new Date();
        var aedt = new Date(now.getTime() + 11 * 60 * 60 * 1000);
        var day = aedt.getUTCDay();
        var h = aedt.getUTCHours();

        // If before 10 AM on a weekday, opens today
        if (day >= 1 && day <= 5 && h < 10) {
            return 'today at 10:00 AM AEDT';
        }
        // Otherwise, next weekday
        var daysUntil = day === 5 ? 3 : day === 6 ? 2 : 1;
        return 'Monday at 10:00 AM AEDT';
    }

    function getPollInterval() {
        if (_errorCount >= 3) return INTERVAL_ERROR_BACKOFF;
        var status = getMarketStatus();
        if (status === 'open' || status === 'auction') return INTERVAL_MARKET_OPEN;
        if (status === 'pre-market' || status === 'pre-open') return INTERVAL_PRE_MARKET;
        return INTERVAL_CLOSED;
    }

    // Update the market status bar UI
    function updateStatusBar(feedStatus) {
        var status = getMarketStatus();
        var dot = document.getElementById('msb-dot');
        var label = document.getElementById('msb-label');
        var updated = document.getElementById('msb-updated');
        var feedEl = document.getElementById('msb-feed-status');

        if (dot) {
            dot.className = 'msb-dot ' + status;
        }
        if (label) {
            var labels = {
                'open': 'ASX OPEN',
                'pre-open': 'ASX PRE-OPEN',
                'pre-market': 'ASX PRE-MARKET',
                'auction': 'CLOSING AUCTION',
                'closed': 'ASX CLOSED'
            };
            label.textContent = labels[status] || 'ASX CLOSED';
            label.className = 'msb-label ' + status;
        }
        if (updated && _lastFetchTime) {
            var ago = Math.round((Date.now() - _lastFetchTime) / 1000);
            var agoStr = ago < 60 ? ago + 's ago' : Math.round(ago / 60) + 'm ago';
            updated.textContent = 'Updated ' + agoStr;
        }
        if (feedEl) {
            if (feedStatus) {
                feedEl.textContent = feedStatus;
            } else if (_isPolling) {
                var ms = getMarketStatus();
                if (ms === 'open') feedEl.textContent = 'Live feed active';
                else if (ms === 'pre-open' || ms === 'pre-market') feedEl.textContent = 'Pre-market monitoring';
                else feedEl.textContent = 'After-hours  --  polling every 15m';
            }
        }
    }

    // Fetch from server-side live-prices.json (fast, reliable, no CORS issues)
    async function fetchServerPrices() {
        try {
            var resp = await fetch('data/live-prices.json?t=' + Date.now(), {
                cache: 'no-store'
            });
            if (!resp.ok) return null;
            var data = await resp.json();
            if (!data || !data.prices) return null;
            return data;
        } catch(e) {
            return null;
        }
    }

    // Apply price updates from the server JSON to STOCK_DATA and UI
    function applyServerPrices(data) {
        var prices = data.prices;
        var updated = 0;

        for (var ticker in prices) {
            var p = prices[ticker];
            var stock = STOCK_DATA[ticker];
            if (!stock) continue;

            var oldPrice = _lastPrices[ticker] || stock.price;
            var newPrice = p.p;

            // Update STOCK_DATA with server price
            if (newPrice && newPrice > 0) {
                stock._livePrice = newPrice;
                stock._livePrevClose = p.pc;
                stock._liveChange = p.c;
                stock._liveChangePct = p.cp;
                stock._liveVolume = p.v;

                // Detect price direction for flash animation
                var direction = null;
                if (Math.abs(newPrice - oldPrice) > 0.005) {
                    direction = newPrice > oldPrice ? 'up' : 'down';
                }

                // Update featured card on home page
                updateHomeCardPrice(ticker, newPrice, p.c, p.cp, p.cur || stock.currency, direction);

                // Hydrate metrics if ContinuumDynamics is available
                if (typeof ContinuumDynamics !== 'undefined' && REFERENCE_DATA[ticker]) {
                    ContinuumDynamics.onPriceUpdate(ticker, newPrice);
                }

                _lastPrices[ticker] = newPrice;
                updated++;
            }
        }

        return updated;
    }

    // Update a single featured card's price display
    function updateHomeCardPrice(ticker, price, change, changePct, currency, direction) {
        var card = document.querySelector('[data-ticker-card="' + ticker + '"]');
        if (!card) return;

        var priceEl = card.querySelector('.fc-price');
        if (!priceEl) return;

        // Build price HTML with live dot
        var sign = change >= 0 ? '+' : '';
        var cls = change >= 0 ? 'positive' : 'negative';
        priceEl.innerHTML =
            '<span style="font-size:0.8rem; color:var(--text-muted)">' + currency + '</span>' +
            price.toFixed(2) +
            '<span class="fc-live-dot"></span>' +
            '<div class="fc-price-change ' + cls + '">' + sign + change.toFixed(2) + ' (' + sign + changePct.toFixed(1) + '%)</div>';

        // Flash animation on price change
        if (direction) {
            priceEl.classList.remove('flash-green', 'flash-red');
            void priceEl.offsetWidth; // Force reflow for re-trigger
            priceEl.classList.add(direction === 'up' ? 'flash-green' : 'flash-red');
        }
    }

    // Render the scrolling price ticker strip
    function renderTickerStrip(data) {
        var strip = document.getElementById('price-ticker-strip');
        if (!strip || !data || !data.prices) return;

        var prices = data.prices;
        var items = '';

        // Build items for all tickers (doubled for infinite scroll effect)
        var tickers = Object.keys(STOCK_DATA);
        for (var pass = 0; pass < 2; pass++) {
            tickers.forEach(function(ticker) {
                var p = prices[ticker];
                if (!p) return;
                var sign = p.c >= 0 ? '+' : '';
                var cls = p.c >= 0 ? 'positive' : 'negative';
                items += '<span class="pt-item" onclick="navigate(\'report-' + ticker + '\')">' +
                    '<span class="pt-ticker">' + ticker + '</span>' +
                    '<span class="pt-price">' + (p.cur || 'A$') + p.p.toFixed(2) + '</span>' +
                    '<span class="pt-change ' + cls + '">' + sign + p.cp.toFixed(1) + '%</span>' +
                '</span>';
            });
        }

        strip.innerHTML = '<div class="price-ticker-inner">' + items + '</div>';
        strip.style.display = 'flex';
    }

    // Main poll function
    async function poll() {
        _pollCount++;
        updateStatusBar('Refreshing...');

        // Strategy 1: Try server-side live-prices.json first (fast, reliable)
        var serverData = await fetchServerPrices();
        if (serverData && serverData.prices && Object.keys(serverData.prices).length > 0) {
            var updated = applyServerPrices(serverData);
            _lastFetchTime = new Date(serverData.updated).getTime();
            _errorCount = 0;
            renderTickerStrip(serverData);
            updateStatusBar(updated + ' prices updated');

            // Also update report pages if they're rendered
            for (var ticker in serverData.prices) {
                if (_liveFetched.has(ticker)) {
                    updateLiveUI(ticker);
                }
            }
            return;
        }

        // Strategy 2: Fall back to client-side Yahoo Finance fetch via CORS proxies
        // (This uses the existing LiveData module)
        try {
            var tickers = Object.keys(STOCK_DATA);
            var fetched = 0;
            for (var i = 0; i < tickers.length; i++) {
                var ticker = tickers[i];
                var stock = STOCK_DATA[ticker];
                if (!stock || !stock.tickerFull) continue;

                // Override cache TTL during market hours
                var status = getMarketStatus();
                if (status === 'open' || status === 'pre-open') {
                    // Clear stale cache for this ticker during market hours
                    try {
                        var cacheKey = 'continuum_market_data_' + stock.tickerFull;
                        var cached = localStorage.getItem(cacheKey);
                        if (cached) {
                            var parsed = JSON.parse(cached);
                            // Expire cache after 2 minutes during market hours
                            if (Date.now() - parsed.ts > 2 * 60 * 1000) {
                                localStorage.removeItem(cacheKey);
                            }
                        }
                    } catch(e) {}
                }

                var liveData = await LiveData.fetch(stock.tickerFull);
                if (liveData && liveData.currentPrice) {
                    LiveData.patchStockData(ticker, liveData);
                    _liveFetched.add(ticker);

                    var oldPrice = _lastPrices[ticker] || stock.price;
                    var newPrice = liveData.currentPrice;
                    var change = newPrice - (liveData.previousClose || stock.price);
                    var changePct = liveData.previousClose ? ((newPrice - liveData.previousClose) / liveData.previousClose) * 100 : 0;
                    var direction = Math.abs(newPrice - oldPrice) > 0.005 ? (newPrice > oldPrice ? 'up' : 'down') : null;

                    updateHomeCardPrice(ticker, newPrice, change, changePct, stock.currency, direction);

                    if (typeof ContinuumDynamics !== 'undefined' && REFERENCE_DATA[ticker]) {
                        ContinuumDynamics.onPriceUpdate(ticker, newPrice);
                    }

                    _lastPrices[ticker] = newPrice;
                    fetched++;
                }
            }
            if (fetched > 0) {
                _lastFetchTime = Date.now();
                _errorCount = 0;
                updateStatusBar(fetched + ' prices via live feed');
            } else {
                _errorCount++;
                updateStatusBar('Using cached prices');
            }
        } catch(e) {
            _errorCount++;
            updateStatusBar('Feed error  --  retrying');
        }
    }

    // Start the polling loop
    function start() {
        if (_isPolling) return;
        _isPolling = true;

        // Initial fetch
        poll().then(function() {
            scheduleNext();
        });

        // Update the "X seconds ago" display every 10s
        setInterval(function() {
            updateStatusBar();
        }, 10000);

        // Listen for page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Pause polling when tab is hidden
                if (_pollTimer) {
                    clearTimeout(_pollTimer);
                    _pollTimer = null;
                }
            } else {
                // Resume immediately when tab becomes visible
                poll().then(function() {
                    scheduleNext();
                });
            }
        });
    }

    function scheduleNext() {
        if (_pollTimer) clearTimeout(_pollTimer);
        var interval = getPollInterval();
        _pollTimer = setTimeout(function() {
            poll().then(function() {
                scheduleNext();
            });
        }, interval);
    }

    // Manual refresh
    function refreshNow() {
        var btn = document.getElementById('msb-refresh');
        if (btn) {
            btn.disabled = true;
            btn.textContent = '...';
        }
        poll().then(function() {
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'REFRESH';
            }
            scheduleNext();
        });
    }

    // Load and display announcements
    async function loadAnnouncements() {
        try {
            var resp = await fetch('data/announcements.json?t=' + Date.now(), { cache: 'no-store' });
            if (!resp.ok) return;
            var data = await resp.json();
            if (!data || !data.announcements) return;

            var panel = document.getElementById('announcements-panel');
            var list = document.getElementById('ann-list');
            var updatedEl = document.getElementById('ann-updated');
            if (!panel || !list) return;

            var anns = data.announcements;
            var allItems = [];

            // Flatten all announcements across tickers
            for (var ticker in anns) {
                var items = anns[ticker];
                if (!Array.isArray(items)) continue;
                items.forEach(function(item) {
                    allItems.push(Object.assign({ ticker: ticker }, item));
                });
            }

            if (allItems.length === 0) return;

            // Sort by date descending
            allItems.sort(function(a, b) {
                return new Date(b.date || 0) - new Date(a.date || 0);
            });

            // Show latest 8
            var html = '';
            allItems.slice(0, 8).forEach(function(item) {
                var timeStr = item.date ? new Date(item.date).toLocaleDateString('en-AU', { day: 'numeric', month: 'short' }) : '';
                html += '<li class="ann-item">' +
                    '<span class="ann-ticker">' + item.ticker + '</span>' +
                    '<span class="ann-headline">' + (item.headline || item.title || '') + '</span>' +
                    (item.type ? '<span class="ann-type">' + item.type + '</span>' : '') +
                    '<span class="ann-time">' + timeStr + '</span>' +
                '</li>';
            });

            list.innerHTML = html;
            panel.style.display = 'block';

            if (updatedEl && data.updated) {
                updatedEl.textContent = 'Updated ' + new Date(data.updated).toLocaleDateString('en-AU', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
            }
        } catch(e) {
            // Announcements are optional  --  fail silently
        }
    }

    return {
        start: start,
        refreshNow: refreshNow,
        getMarketStatus: getMarketStatus,
        loadAnnouncements: loadAnnouncements,
        updateStatusBar: updateStatusBar
    };
})();

// Featured card display order
const FEATURED_ORDER = Object.keys(STOCK_DATA).sort();

// Coming soon stubs
const COMING_SOON = [
];

/* --- Hash Router --- */
// Valid static pages for route validation
const VALID_STATIC_PAGES = new Set(['home', 'snapshots', 'portfolio', 'thesis', 'personalisation', 'about']);

function navigate(page) {
    window.location.hash = page;
}

const renderedPages = new Set();
const renderedSnapshots = new Set();

function route() {
    const hash = window.location.hash.slice(1) || 'home';
    const pages = document.querySelectorAll('.page');
    pages.forEach(p => p.classList.remove('active'));

    // Validate hash against allowlist before DOM construction (S5 security fix)
    var isValidRoute = VALID_STATIC_PAGES.has(hash);
    if (!isValidRoute && hash.startsWith('report-')) {
        var ticker = hash.replace('report-', '');
        isValidRoute = typeof STOCK_DATA !== 'undefined' && STOCK_DATA.hasOwnProperty(ticker);
    }
    if (!isValidRoute && hash.startsWith('snapshot-')) {
        var snapTicker = hash.replace('snapshot-', '');
        // Accept if snapshot exists OR if stock data exists (snapshot will be built on demand)
        isValidRoute = (typeof SNAPSHOT_DATA !== 'undefined' && SNAPSHOT_DATA.hasOwnProperty(snapTicker)) ||
                       (typeof STOCK_DATA !== 'undefined' && STOCK_DATA.hasOwnProperty(snapTicker));
    }
    if (!isValidRoute) {
        // Invalid route  --  fall back to home
        document.getElementById('page-home').classList.add('active');
        window.scrollTo(0, 0);
        return;
    }

    // Auto-create page divs for dynamically added stocks (safe  --  validated above)
    if ((hash.startsWith('report-') || hash.startsWith('snapshot-')) && !document.getElementById('page-' + hash)) {
        const div = document.createElement('div');
        div.className = 'page';
        div.id = 'page-' + hash;
        document.getElementById('page-home').parentNode.appendChild(div);
    }

    // Lazy render report pages on first visit
    if (hash.startsWith('report-')) {
        const ticker = hash.replace('report-', '');
        if (!renderedPages.has(ticker) && STOCK_DATA[ticker]) {
            const container = document.getElementById('page-' + hash);
            if (container) {
                // Show loading state
                if (STOCK_DATA[ticker]._indexOnly) {
                    container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;min-height:60vh;color:var(--text-muted)"><div style="text-align:center"><div style="font-size:1.5rem;margin-bottom:0.5rem">Loading Research Data&hellip;</div><div style="font-size:0.9rem">Fetching full report for ' + STOCK_DATA[ticker].company + '</div></div></div>';
                    loadFullResearchData(ticker, function(data) {
                        if (data) {
                            container.innerHTML = renderReportPage(data);
                            initSectionToggles(ticker);
                            renderedPages.add(ticker);
                            setupScrollSpy('page-' + hash);
                            populateSidebar(ticker);
                            if (typeof window.initInlineChat === 'function') window.initInlineChat(ticker);
                            if (typeof window.applyNarrativeAnalysis === 'function') window.applyNarrativeAnalysis(ticker);
                            initNarrativeTimelineChart(ticker);
                            fetchAndPatchLive(ticker);
                        }
                    });
                } else {
                    container.innerHTML = renderReportPage(STOCK_DATA[ticker]);
                    initSectionToggles(ticker);
                    renderedPages.add(ticker);
                    setupScrollSpy('page-' + hash);
                    if (typeof window.initInlineChat === 'function') window.initInlineChat(ticker);
                    initNarrativeTimelineChart(ticker);
                }
            }
        }
        // Apply narrative analysis (alerts, ST/LT weights, market-responsive narrative)
        if (typeof window.applyNarrativeAnalysis === 'function') {
            window.applyNarrativeAnalysis(ticker);
        }
        // Fetch live data asynchronously and update chart + hero price
        if (STOCK_DATA[ticker]) {
            fetchAndPatchLive(ticker);
        }
    }

    // Lazy render personalisation page on first visit
    if (hash === 'personalisation' && !renderedPages.has('_personalisation')) {
        var pnContainer = document.getElementById('page-personalisation');
        if (pnContainer && typeof renderPersonalisationPage === 'function') {
            pnContainer.innerHTML = renderPersonalisationPage();
            initPersonalisationDemo();
            renderedPages.add('_personalisation');
        }
    }
    if (hash === 'personalisation' && renderedPages.has('_personalisation')) {
        if (typeof pnOnRouteEnter === 'function') pnOnRouteEnter();
    }

    // Lazy render snapshot pages on first visit
    if (hash.startsWith('snapshot-')) {
        const ticker = hash.replace('snapshot-', '');
        if (!renderedSnapshots.has(ticker)) {
            const container = document.getElementById('page-' + hash);
            if (container) {
                // If snapshot data already exists, render immediately
                if (SNAPSHOT_DATA[ticker]) {
                    container.innerHTML = renderSnapshotPage(SNAPSHOT_DATA[ticker]);
                    renderedSnapshots.add(ticker);
                } else if (STOCK_DATA[ticker]) {
                    // Need to load full research data first, then build snapshot
                    container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;min-height:60vh;color:var(--text-muted)"><div style="text-align:center"><div style="font-size:1.5rem;margin-bottom:0.5rem">Loading Snapshot&hellip;</div><div style="font-size:0.9rem">Fetching data for ' + STOCK_DATA[ticker].company + '</div></div></div>';
                    loadFullResearchData(ticker, function(data) {
                        if (data) {
                            SNAPSHOT_DATA[ticker] = buildSnapshotFromStock(ticker);
                            if (SNAPSHOT_DATA[ticker]) {
                                container.innerHTML = renderSnapshotPage(SNAPSHOT_DATA[ticker]);
                                renderedSnapshots.add(ticker);
                            }
                        }
                    });
                }
            }
        }
    }

    const target = document.getElementById('page-' + hash);
    if (target) {
        target.classList.add('active');
        window.scrollTo(0, 0);
        // A7: Focus management  --  move focus to the new page content
        // Use requestAnimationFrame to ensure DOM is rendered before focusing
        requestAnimationFrame(function() {
            var focusTarget = target.querySelector('h1, h2, .hero-title, .page-heading');
            if (focusTarget) {
                focusTarget.setAttribute('tabindex', '-1');
                focusTarget.focus({ preventScroll: true });
            } else {
                target.setAttribute('tabindex', '-1');
                target.focus({ preventScroll: true });
            }
        });
    } else {
        document.getElementById('page-home').classList.add('active');
    }

    // Update nav links  --  add aria-current for a11y
    document.querySelectorAll('.nav-links a').forEach(a => {
        a.classList.remove('active');
        a.removeAttribute('aria-current');
        if (a.dataset.nav === hash || (hash.startsWith('report-') && a.dataset.nav === 'home') || (hash.startsWith('snapshot-') && a.dataset.nav === 'snapshots')) {
            a.classList.add('active');
            a.setAttribute('aria-current', 'page');
        }
    });

    // Populate hypothesis sidebar for report pages
    if (hash.startsWith('report-')) {
        const ticker = hash.replace('report-', '');
        populateSidebar(ticker);
    }
}

// A11y announcer  --  announces page changes to screen readers
function announcePageChange(text) {
    var announcer = document.getElementById('a11y-announcer');
    if (announcer) {
        announcer.textContent = '';
        requestAnimationFrame(function() { announcer.textContent = text; });
    }
}

window.addEventListener('hashchange', function() {
    route();
    // Announce the page change
    var hash = window.location.hash.slice(1) || 'home';
    var pageName = hash;
    if (hash.startsWith('report-')) {
        var t = hash.replace('report-', '');
        pageName = STOCK_DATA[t] ? STOCK_DATA[t].company + ' Research Report' : t + ' Report';
    } else if (hash.startsWith('snapshot-')) {
        pageName = hash.replace('snapshot-', '') + ' Snapshot';
    } else {
        var names = { home: 'Research Home', snapshots: 'Investment Snapshots', portfolio: 'Portfolio Intelligence', thesis: 'Investment Thesis Comparator', personalisation: 'Personalisation', about: 'About' };
        pageName = names[hash] || hash;
    }
    announcePageChange('Navigated to ' + pageName);
});
window.addEventListener('DOMContentLoaded', route);

/* --- Sticky Nav Shadow --- */
window.addEventListener('scroll', () => {
    const nav = document.getElementById('siteNav');
    if (window.scrollY > 10) {
        nav.classList.add('scrolled');
    } else {
        nav.classList.remove('scrolled');
    }
});

/* --- Theme Toggle (Light / Dark) --- */
(function() {
    var saved = localStorage.getItem('continuum_theme');
    if (saved === 'light') document.documentElement.setAttribute('data-theme', 'light');

    document.addEventListener('DOMContentLoaded', function() {
        var btn = document.getElementById('themeToggle');
        if (!btn) return;
        btn.addEventListener('click', function() {
            var current = document.documentElement.getAttribute('data-theme');
            var next = current === 'light' ? 'dark' : 'light';
            if (next === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            localStorage.setItem('continuum_theme', next);

            // Re-render any currently visible charts to update colours
            var hash = window.location.hash.slice(1) || 'home';
            if (hash.startsWith('report-')) {
                var ticker = hash.replace('report-', '');
                if (STOCK_DATA[ticker] && !STOCK_DATA[ticker]._indexOnly) {
                    var chartEl = document.querySelector('#page-' + hash + ' .ta-chart-container');
                    if (chartEl) {
                        var temp = document.createElement('div');
                        temp.innerHTML = renderTAChart(STOCK_DATA[ticker]);
                        chartEl.parentNode.replaceChild(temp.firstElementChild, chartEl);
                    }
                    // Re-init narrative timeline chart with new theme colours
                    if (typeof initNarrativeTimelineChart === 'function') {
                        initNarrativeTimelineChart(ticker);
                    }
                }
            }
        });
    });
})();

/* --- Evidence Card Expand/Collapse --- */
document.addEventListener('click', (e) => {
    const header = e.target.closest('.ec-header');
    if (!header) return;
    const card = header.closest('.evidence-card');
    const body = card.querySelector('.ec-body');
    const toggle = card.querySelector('.ec-toggle');
    if (body) {
        body.classList.toggle('open');
        if (toggle) toggle.classList.toggle('open');
    }
});

/* --- Section Nav Scroll-Spy --- */
function setupScrollSpy(pageId) {
    const page = document.getElementById(pageId);
    if (!page) return;
    const navLinks = page.querySelectorAll('.section-nav a');
    const sections = [];
    navLinks.forEach(link => {
        const targetId = link.getAttribute('href');
        if (targetId && targetId.startsWith('#')) {
            const section = document.getElementById(targetId.slice(1));
            if (section) sections.push({ link, section });
        }
    });

    if (sections.length === 0) return;

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                navLinks.forEach(l => l.classList.remove('active'));
                const match = sections.find(s => s.section === entry.target);
                if (match) match.link.classList.add('active');
            }
        });
    }, {
        rootMargin: '-20% 0px -70% 0px',
        threshold: 0
    });

    sections.forEach(s => observer.observe(s.section));
}

/* --- Section Nav Smooth Scroll --- */
document.addEventListener('click', (e) => {
    const link = e.target.closest('.section-nav a');
    if (!link) return;
    e.preventDefault();
    const targetId = link.getAttribute('href');
    if (targetId && targetId.startsWith('#')) {
        const target = document.getElementById(targetId.slice(1));
        if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
});

// Initialize home page content and portfolio
function initHomeSearch() {
    var input = document.getElementById('home-stock-search');
    var results = document.getElementById('home-search-results');
    if (!input || !results) return;

    input.addEventListener('input', function() {
        var q = this.value.trim().toLowerCase();
        if (!q) { results.style.display = 'none'; results.innerHTML = ''; return; }
        var matches = [];
        for (var ticker in STOCK_DATA) {
            var s = STOCK_DATA[ticker];
            if (ticker.toLowerCase().includes(q) ||
                (s.company && s.company.toLowerCase().includes(q)) ||
                (s.tickerFull && s.tickerFull.toLowerCase().includes(q))) {
                matches.push(s);
            }
        }
        if (matches.length === 0) {
            results.innerHTML = '<div class="home-search-empty">No stocks found</div>';
            results.style.display = 'block';
            return;
        }
        var html = '';
        matches.slice(0, 8).forEach(function(s) {
            html += '<div class="home-search-result" onclick="navigate(\'report-' + s.ticker + '\');document.getElementById(\'home-stock-search\').value=\'\';document.getElementById(\'home-search-results\').style.display=\'none\'">' +
                '<span class="home-search-result-ticker">' + (s.tickerFull || s.ticker) + '</span>' +
                '<span class="home-search-result-name">' + (s.company || '') + '</span>' +
            '</div>';
        });
        results.innerHTML = html;
        results.style.display = 'block';
    });

    document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !results.contains(e.target)) {
            results.style.display = 'none';
        }
    });

    input.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') { this.value = ''; results.style.display = 'none'; }
    });
}

window.addEventListener('DOMContentLoaded', () => {
    // Populate featured cards
    const featuredGrid = document.getElementById('featured-grid');
    if (featuredGrid) {
        FEATURED_ORDER.forEach(ticker => {
            if (STOCK_DATA[ticker]) {
                featuredGrid.innerHTML += renderFeaturedCard(STOCK_DATA[ticker]);
            }
        });
    }

    // Populate coverage table
    const coverageBody = document.getElementById('coverage-body');
    if (coverageBody) {
        FEATURED_ORDER.forEach(ticker => {
            if (STOCK_DATA[ticker]) {
                coverageBody.innerHTML += renderCoverageRow(STOCK_DATA[ticker]);
            }
        });
        COMING_SOON.forEach(stub => {
            coverageBody.innerHTML += renderComingSoonRow(stub);
        });
    }

    // Populate footer research links
    const footerLinks = document.getElementById('footer-research-links');
    if (footerLinks) {
        FEATURED_ORDER.forEach(ticker => {
            const d = STOCK_DATA[ticker];
            if (d) {
                footerLinks.innerHTML += '<a href="#report-' + ticker + '" onclick="navigate(\'report-' + ticker + '\')">' + d.company + ' (' + d.tickerFull + ')</a>';
            }
        });
    }

    // Snapshot grid is now populated by snapshot-generator.js
    // via window.addEventListener('load', ...) with 1.5s delay

    // Populate thesis comparator stock cards dynamically
    const tcGrid = document.getElementById('tc-stock-grid');
    if (tcGrid) {
        Object.keys(STOCK_DATA).sort().forEach(function(ticker) {
            var stock = STOCK_DATA[ticker];
            var card = document.createElement('div');
            card.className = 'tc-stock-card';
            card.dataset.ticker = ticker;
            card.onclick = function() { tcSelectStock(ticker); };
            card.innerHTML = '<div class="tc-stock-ticker">' + ticker + '</div>' +
                             '<div class="tc-stock-name">' + (stock.company || ticker) + '</div>';
            tcGrid.appendChild(card);
        });
    }

    // Home stock search
    initHomeSearch();

    // Portfolio initialization
    setupUploadZone();
    const savedPortfolio = loadPortfolio();
    if (savedPortfolio && savedPortfolio.length > 0) {
        renderPortfolioFromSaved(savedPortfolio);
    }

    // Start live market feed with auto-polling (replaces one-shot prefetch)
    setTimeout(function() {
        MarketFeed.start();
        MarketFeed.loadAnnouncements();
    }, 800);

    // Also run the legacy prefetch for full chart data (3-year bars for TA charts)
    setTimeout(prefetchAllLiveData, 3000);

    // --- Data change listeners (parent/dependant pattern) ---

    // Home page: update coverage row + featured card on data change
    window.DataEvents.on('stock:updated', function(evt) {
        var homePage = document.getElementById('page-home');
        if (!homePage || !homePage.classList.contains('active')) return;

        var stock = STOCK_DATA[evt.ticker];
        if (!stock) return;

        // Update coverage table row
        var tbody = document.getElementById('coverage-body');
        if (tbody) {
            var rows = tbody.querySelectorAll('tr');
            for (var i = 0; i < rows.length; i++) {
                var tickerCell = rows[i].querySelector('.td-ticker');
                if (tickerCell && tickerCell.textContent.trim() === evt.ticker) {
                    var temp = document.createElement('tbody');
                    temp.innerHTML = renderCoverageRow(stock);
                    if (temp.firstElementChild) {
                        tbody.replaceChild(temp.firstElementChild, rows[i]);
                    }
                    break;
                }
            }
        }

        // Update featured card
        var card = document.querySelector('[data-ticker-card="' + evt.ticker + '"]');
        if (card) {
            var temp2 = document.createElement('div');
            temp2.innerHTML = renderFeaturedCard(stock);
            if (temp2.firstElementChild) {
                card.parentNode.replaceChild(temp2.firstElementChild, card);
            }
        }
    });

    // Portfolio: invalidate coverage cache + refresh if visible
    window.DataEvents.on('stock:updated', function() {
        COVERAGE_DATA = buildCoverageData();

        var page = document.getElementById('page-portfolio');
        if (!page || !page.classList.contains('active')) return;

        var positions = loadPortfolio();
        if (!positions || positions.length === 0) return;

        for (var i = 0; i < positions.length; i++) {
            var p = positions[i];
            var covered = COVERAGE_DATA[p.ticker];
            if (covered) {
                p.currentPrice = covered.price;
                p.marketValue = p.currentPrice ? p.units * p.currentPrice : null;
                p.costBasis = p.units * p.avgCost;
                p.pnlDollar = p.marketValue !== null ? p.marketValue - p.costBasis : null;
                p.pnlPercent = p.costBasis > 0 && p.pnlDollar !== null ? (p.pnlDollar / p.costBasis) * 100 : null;
                p.skew = covered.skew;
            }
        }
        var totalValue = positions.reduce(function(s, pp) { return s + (pp.marketValue || 0); }, 0);
        positions.forEach(function(pp) {
            pp.weight = totalValue > 0 && pp.marketValue ? (pp.marketValue / totalValue) * 100 : 0;
            pp.alignment = deriveAlignment(pp.skew, pp.weight);
        });
        savePortfolio(positions);
        renderPortfolio(positions, totalValue);
    });

    // Snapshots: rebuild stale snapshot data
    window.DataEvents.on('stock:updated', function(evt) {
        if (!SNAPSHOT_DATA[evt.ticker]) return;
        SNAPSHOT_DATA[evt.ticker] = buildSnapshotFromStock(evt.ticker);
    });
});

/* ============================================================
   DATA EVENTS -- Lightweight event bus for data change propagation
   ============================================================ */
window.DataEvents = (function() {
  var _listeners = {};
  return {
    on: function(event, fn) {
      (_listeners[event] = _listeners[event] || []).push(fn);
    },
    off: function(event, fn) {
      var arr = _listeners[event];
      if (arr) _listeners[event] = arr.filter(function(f) { return f !== fn; });
    },
    emit: function(event, data) {
      var arr = _listeners[event];
      if (arr) {
        for (var i = 0; i < arr.length; i++) {
          try { arr[i](data); } catch(e) { console.warn('[DataEvents]', e); }
        }
      }
    }
  };
})();

/* ============================================================
   PORTFOLIO ENGINE
   ============================================================ */

/* Coverage data matching portal reports (built dynamically from STOCK_DATA) */
var COVERAGE_DATA = buildCoverageData();

/* Upload zone setup */
function setupUploadZone() {
    const zone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    if (!zone || !fileInput) return;

    zone.addEventListener('click', () => fileInput.click());
    zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
    zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) handleFile(file);
    });
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) handleFile(file);
        fileInput.value = '';
    });
}

/* File handler */
function handleFile(file) {
    const ext = file.name.split('.').pop().toLowerCase();
    const reader = new FileReader();

    if (ext === 'csv') {
        reader.onload = function(e) {
            const rows = parseCSV(e.target.result);
            processPortfolioData(rows);
        };
        reader.readAsText(file);
    } else {
        // Lazy-load SheetJS on demand for Excel files
        reader.onload = function(e) {
            var processExcel = function() {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet);
                    processPortfolioData(rows);
                } catch (err) {
                    alert('Could not read Excel file. Please check the format and try again.');
                }
            };
            if (typeof XLSX !== 'undefined') {
                processExcel();
            } else if (typeof window.loadSheetJS === 'function') {
                window.loadSheetJS(processExcel);
            } else {
                alert('Excel parsing library failed to load. Please try a CSV file instead.');
            }
        };
        reader.readAsArrayBuffer(file);
    }
}

/* CSV fallback parser */
function parseCSV(text) {
    const lines = text.trim().split('\n');
    if (lines.length < 2) return [];
    const headers = lines[0].split(',').map(h => h.trim());
    return lines.slice(1).map(line => {
        const vals = line.split(',').map(v => v.trim());
        const obj = {};
        headers.forEach((h, i) => { obj[h] = vals[i] || ''; });
        return obj;
    });
}

/* Normalize ticker: strip .AX, uppercase */
function normalizeTicker(raw) {
    if (!raw) return '';
    return raw.toString().toUpperCase().replace(/\.AX$/i, '').trim();
}

/* Find column value with flexible naming */
function getCol(row, names) {
    for (const n of names) {
        const keys = Object.keys(row);
        const match = keys.find(k => k.toLowerCase().replace(/[^a-z]/g, '') === n.toLowerCase().replace(/[^a-z]/g, ''));
        if (match && row[match] !== undefined && row[match] !== '') return row[match];
    }
    return null;
}

/* Process uploaded data */
function processPortfolioData(rows) {
    const positions = [];
    for (const row of rows) {
        const ticker = normalizeTicker(getCol(row, ['Ticker', 'ASX', 'ASXCode', 'Code', 'Symbol', 'Stock']));
        const units = parseFloat(getCol(row, ['Units', 'Quantity', 'Qty', 'Shares', 'Volume']));
        const avgCost = parseFloat(getCol(row, ['AvgCost', 'AverageCost', 'CostBasis', 'Cost', 'Price', 'BuyPrice', 'AvgPrice']));

        if (!ticker || isNaN(units) || isNaN(avgCost)) continue;

        const covered = COVERAGE_DATA[ticker];
        const currentPrice = covered ? covered.price : null;
        const company = covered ? covered.company : ticker;
        const skew = covered ? covered.skew : null;

        const marketValue = currentPrice ? units * currentPrice : null;
        const costBasis = units * avgCost;
        const pnlDollar = marketValue !== null ? marketValue - costBasis : null;
        const pnlPercent = costBasis > 0 && pnlDollar !== null ? (pnlDollar / costBasis) * 100 : null;

        positions.push({ ticker, company, units, avgCost, currentPrice, marketValue, costBasis, pnlDollar, pnlPercent, skew });
    }

    if (positions.length === 0) {
        alert('No valid positions found. Expected columns: Ticker, Units, Avg Cost');
        return;
    }

    /* Calculate weights */
    const totalValue = positions.reduce((s, p) => s + (p.marketValue || 0), 0);
    positions.forEach(p => {
        p.weight = totalValue > 0 && p.marketValue ? (p.marketValue / totalValue) * 100 : 0;
        p.alignment = deriveAlignment(p.skew, p.weight);
    });

    savePortfolio(positions);
    renderPortfolio(positions, totalValue);
}

/* Derive alignment */
function deriveAlignment(skew, weight) {
    if (!skew) return { label: 'Not covered', cls: 'not-covered' };
    if (skew === 'upside') return { label: 'Aligned with skew', cls: 'aligned' };
    if (skew === 'downside') {
        if (weight > 15) return { label: 'Exposure exceeds conviction', cls: 'exceeds' };
        return { label: 'Contradicts skew', cls: 'contradicts' };
    }
    if (skew === 'balanced') {
        if (weight > 15) return { label: 'Exposure exceeds conviction', cls: 'exceeds' };
        return { label: 'Balanced exposure', cls: 'neutral' };
    }
    return { label: 'N/A', cls: 'not-covered' };
}

/* Render portfolio table */
function renderPortfolio(positions, totalValue) {
    const body = document.getElementById('portfolioBody');
    const table = document.getElementById('portfolioTable');
    const summary = document.getElementById('portfolioSummary');
    const actions = document.getElementById('portfolioActions');
    const zone = document.getElementById('uploadZone');

    body.innerHTML = '';

    positions.sort((a, b) => (b.marketValue || 0) - (a.marketValue || 0));

    for (const p of positions) {
        const tr = document.createElement('tr');
        if (COVERAGE_DATA[p.ticker]) {
            tr.setAttribute('onclick', "navigate('report-" + p.ticker + "')");
        }

        const pnlClass = p.pnlDollar >= 0 ? 'td-pnl-pos' : 'td-pnl-neg';
        const skewBadge = p.skew ? '<span class="skew-badge ' + p.skew + '">' + (p.skew === 'upside' ? '&#9650; UPSIDE' : p.skew === 'downside' ? '&#9660; DOWNSIDE' : '&#9670; BALANCED') + '</span>' : '<span style="color:var(--text-muted)">N/A</span>';

        tr.innerHTML =
            '<td class="td-ticker">' + p.ticker + '</td>' +
            '<td>' + p.company + '</td>' +
            '<td class="td-mono">' + formatNum(p.units, 0) + '</td>' +
            '<td class="td-mono">A$' + formatNum(p.avgCost, 2) + '</td>' +
            '<td class="td-mono">' + (p.currentPrice ? 'A$' + formatNum(p.currentPrice, 2) : 'N/A') + '</td>' +
            '<td class="' + pnlClass + '">' + (p.pnlDollar !== null ? (p.pnlDollar >= 0 ? '+' : '') + 'A$' + formatNum(p.pnlDollar, 0) : 'N/A') + '</td>' +
            '<td class="' + pnlClass + '">' + (p.pnlPercent !== null ? (p.pnlPercent >= 0 ? '+' : '') + formatNum(p.pnlPercent, 1) + '%' : 'N/A') + '</td>' +
            '<td class="td-mono">' + formatNum(p.weight, 1) + '%</td>' +
            '<td>' + skewBadge + '</td>' +
            '<td><span class="alignment-badge ' + p.alignment.cls + '">' + p.alignment.label + '</span></td>';

        body.appendChild(tr);
    }

    /* Summary */
    const totalPnL = positions.reduce((s, p) => s + (p.pnlDollar || 0), 0);
    const totalCost = positions.reduce((s, p) => s + p.costBasis, 0);
    const totalPnLPct = totalCost > 0 ? (totalPnL / totalCost) * 100 : 0;

    let alignedWeight = 0, contraWeight = 0, neutralWeight = 0;
    positions.forEach(p => {
        if (p.alignment.cls === 'aligned') alignedWeight += p.weight;
        else if (p.alignment.cls === 'contradicts' || p.alignment.cls === 'exceeds') contraWeight += p.weight;
        else neutralWeight += p.weight;
    });

    document.getElementById('summaryValue').textContent = 'A$' + formatNum(totalValue, 0);
    const pnlEl = document.getElementById('summaryPnL');
    pnlEl.textContent = (totalPnL >= 0 ? '+' : '') + 'A$' + formatNum(totalPnL, 0) + ' (' + (totalPnLPct >= 0 ? '+' : '') + formatNum(totalPnLPct, 1) + '%)';
    pnlEl.className = 'portfolio-summary-value ' + (totalPnL >= 0 ? 'positive' : 'negative');
    document.getElementById('summaryAligned').textContent = formatNum(alignedWeight, 1) + '%';
    document.getElementById('summaryContra').textContent = formatNum(contraWeight, 1) + '%';
    document.getElementById('summaryNeutral').textContent = formatNum(neutralWeight, 1) + '%';

    /* Show/hide elements */
    zone.style.display = 'none';
    table.style.display = '';
    summary.style.display = '';
    actions.style.display = '';

    /* Render diagnostics, reweighting, and alerts */
    renderPortfolioDiagnostics(positions, totalValue);
    renderReweighting(positions, totalValue);
    renderChangeAlerts(positions);
}

/* Render from saved data */
function renderPortfolioFromSaved(positions) {
    const totalValue = positions.reduce((s, p) => s + (p.marketValue || 0), 0);
    renderPortfolio(positions, totalValue);
}

/* Format numbers */
function formatNum(n, decimals) {
    if (n === null || n === undefined || isNaN(n)) return '--';
    const abs = Math.abs(n);
    if (abs >= 1000000) return (n / 1000000).toFixed(1) + 'M';
    if (abs >= 1000) return n.toLocaleString('en-AU', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    return n.toFixed(decimals);
}

/* Portfolio Diagnostics */
function renderPortfolioDiagnostics(positions, totalValue) {
    const diagnosticsEl = document.getElementById('portfolioDiagnostics');
    if (!diagnosticsEl) return;
    diagnosticsEl.style.display = '';

    const hypothesisValues = { n1: 0, n2: 0, n3: 0, n4: 0, unknown: 0 };
    
    positions.forEach(p => {
        const data = TC_DATA[p.ticker];
        if (!data) {
            hypothesisValues.unknown += (p.marketValue || 0);
            return;
        }
        const tier = data.primary === 'uphill' ? 'n2' : data.primary;
        hypothesisValues[tier] += (p.marketValue || 0);
    });

    const tiers = ['n1', 'n2', 'n3', 'n4'];
    tiers.forEach(tier => {
        const pct = totalValue > 0 ? (hypothesisValues[tier] / totalValue) * 100 : 0;
        const segment = document.getElementById('dna' + tier.toUpperCase());
        const pctEl = document.getElementById('pct' + tier.toUpperCase());
        const valEl = document.getElementById('val' + tier.toUpperCase());
        
        if (segment) {
            segment.style.width = Math.max(pct, 5) + '%';
            segment.style.display = pct > 0 ? 'flex' : 'none';
        }
        if (pctEl) pctEl.textContent = formatNum(pct, 0) + '%';
        if (valEl) valEl.textContent = 'A$' + formatNum(hypothesisValues[tier], 0);
    });

    const maxTier = tiers.reduce((a, b) => hypothesisValues[a] > hypothesisValues[b] ? a : b);
    const maxPct = totalValue > 0 ? (hypothesisValues[maxTier] / totalValue) * 100 : 0;
    const concentrationEl = document.getElementById('portConcentrationAlert');
    
    if (maxPct > 60) {
        concentrationEl.innerHTML = '<span class="alert-highlight">High concentration risk:</span> ' + formatNum(maxPct, 0) + '% of your book aligns with ' + maxTier.toUpperCase() + '. If this hypothesis is wrong, significant downside.';
    } else if (maxPct > 40) {
        concentrationEl.innerHTML = '<span class="alert-highlight">Moderate concentration:</span> ' + formatNum(maxPct, 0) + '% in ' + maxTier.toUpperCase() + '. Consider diversification across other hypotheses.';
    } else {
        concentrationEl.innerHTML = '<span class="success-highlight">Well diversified</span> across hypotheses. No single scenario dominates your portfolio.';
    }

    const contrarianEl = document.getElementById('portContrarianOpp');
    const contrarianPositions = positions.filter(p => {
        const data = TC_DATA[p.ticker];
        return data && data.primary === 'uphill';
    });
    
    if (contrarianPositions.length > 0) {
        const names = contrarianPositions.slice(0, 3).map(p => p.ticker).join(', ');
        const more = contrarianPositions.length > 3 ? ' +' + (contrarianPositions.length - 3) + ' more' : '';
        contrarianEl.innerHTML = '<strong>' + names + more + '</strong>  --  Your view differs from all four Continuum hypotheses. High conviction required, but potential alpha if correct.';
    } else {
        contrarianEl.innerHTML = 'Your positions generally align with at least one Continuum hypothesis. No extreme contrarian bets detected.';
    }

    const hedgeEl = document.getElementById('portHedgeGaps');
    const missingTiers = tiers.filter(tier => hypothesisValues[tier] === 0);
    
    if (missingTiers.length > 0) {
        const tierNames = { n1: 'N1 (Growth/Recovery)', n2: 'N2 (Base Case)', n3: 'N3 (Downside)', n4: 'N4 (Disruption)' };
        hedgeEl.innerHTML = 'You have <strong>zero exposure</strong> to: ' + missingTiers.map(t => tierNames[t]).join(', ') + '. Consider whether this creates blind spots if these scenarios play out.';
    } else {
        hedgeEl.innerHTML = '<span class="success-highlight">Comprehensive coverage.</span> Your portfolio spans all four hypothesis types.';
    }

    const alignmentEl = document.getElementById('portAlignmentScore');
    const alignedWeight = positions.reduce((s, p) => s + (p.alignment.cls === 'aligned' ? p.weight : 0), 0);
    
    if (alignedWeight > 50) {
        alignmentEl.innerHTML = '<span class="success-highlight">' + formatNum(alignedWeight, 0) + '% aligned</span> with Continuum. Your book largely reflects our evidence-based view.';
    } else if (alignedWeight > 25) {
        alignmentEl.innerHTML = '<span class="alert-highlight">' + formatNum(alignedWeight, 0) + '% aligned</span> with Continuum. Mixed positioning  --  some agreement, some divergence.';
    } else {
        alignmentEl.innerHTML = '<span class="alert-highlight">' + formatNum(alignedWeight, 0) + '% aligned</span> with Continuum. Significant divergence. You may see value we do not (or vice versa).';
    }
}

/* Evidence-Aligned Reweighting */
function renderReweighting(positions, totalValue) {
    const sectionEl = document.getElementById('portfolioReweighting');
    const bodyEl = document.getElementById('reweightBody');
    if (!sectionEl || !bodyEl) return;

    // Only show for covered positions
    const covered = positions.filter(p => COVERAGE_DATA[p.ticker]);
    if (covered.length === 0) {
        sectionEl.style.display = 'none';
        return;
    }

    // Calculate evidence scores
    const scores = [];
    const baseWeight = 100 / covered.length;

    covered.forEach(p => {
        const cd = COVERAGE_DATA[p.ticker];
        const tc = TC_DATA[p.ticker];

        // Conviction multiplier based on skew direction
        let multiplier = 1.0;
        if (cd.skew === 'upside') multiplier = 1.3;
        else if (cd.skew === 'downside') multiplier = 0.7;

        // Adjust for hypothesis strength from TC_DATA
        if (tc) {
            const probs = [tc.n1.prob, tc.n2.prob, tc.n3.prob, tc.n4.prob];
            const maxProb = Math.max(...probs);
            // High conviction in dominant thesis = slight boost
            if (maxProb > 40) multiplier *= 1.05;
            // Contrarian / uphill = slight reduction
            if (tc.primary === 'uphill') multiplier *= 0.9;
        }

        scores.push({
            ticker: p.ticker,
            company: p.company,
            currentWeight: p.weight,
            skew: cd.skew,
            rawScore: baseWeight * multiplier
        });
    });

    // Normalize suggested weights to 100%
    const totalScore = scores.reduce((s, x) => s + x.rawScore, 0);
    scores.forEach(s => {
        s.suggestedWeight = (s.rawScore / totalScore) * 100;
    });

    // Sort by largest delta
    scores.sort((a, b) => Math.abs(b.suggestedWeight - b.currentWeight) - Math.abs(a.suggestedWeight - a.currentWeight));

    // Render table
    let rows = '';
    scores.forEach(s => {
        const delta = s.suggestedWeight - s.currentWeight;
        const absDelta = Math.abs(delta);
        let action, actionCls, deltaCls;

        if (delta > 2) {
            action = 'Increase';
            actionCls = 'increase';
            deltaCls = 'increase';
        } else if (delta < -2) {
            action = 'Reduce';
            actionCls = 'reduce';
            deltaCls = 'reduce';
        } else {
            action = 'Hold';
            actionCls = 'hold';
            deltaCls = 'hold';
        }

        const skewArrow = s.skew === 'upside' ? '&#9650; UPSIDE' :
                          s.skew === 'downside' ? '&#9660; DOWNSIDE' : '&#9670; BALANCED';
        const skewCls = s.skew;

        const maxBar = Math.max(s.currentWeight, s.suggestedWeight, 1);

        rows += '<tr>' +
            '<td><span class="rw-ticker">' + s.ticker + '</span></td>' +
            '<td>' + s.company + '</td>' +
            '<td><span class="skew-badge ' + skewCls + '">' + skewArrow + '</span></td>' +
            '<td><span class="rw-pct">' + s.currentWeight.toFixed(1) + '%</span></td>' +
            '<td><span class="rw-pct">' + s.suggestedWeight.toFixed(1) + '%</span></td>' +
            '<td><span class="rw-delta ' + deltaCls + '">' + (delta >= 0 ? '+' : '') + delta.toFixed(1) + '%</span></td>' +
            '<td><span class="rw-action ' + actionCls + '">' + action + '</span></td>' +
        '</tr>';
    });

    bodyEl.innerHTML =
        '<table class="rw-table">' +
            '<thead><tr>' +
                '<th>Ticker</th>' +
                '<th>Company</th>' +
                '<th>Evidence</th>' +
                '<th>Current</th>' +
                '<th>Suggested</th>' +
                '<th>Delta</th>' +
                '<th>Action</th>' +
            '</tr></thead>' +
            '<tbody>' + rows + '</tbody>' +
        '</table>';

    sectionEl.style.display = '';
}

/* Change Detection Alerts */
function renderChangeAlerts(positions) {
    const sectionEl = document.getElementById('changeAlertsSection');
    const feedEl = document.getElementById('changeAlertsFeed');
    const emptyEl = document.getElementById('changeAlertsEmpty');
    
    if (!sectionEl) return;
    sectionEl.style.display = '';
    
    const alerts = [];
    const tickers = positions.map(p => p.ticker);
    
    if (tickers.includes('XRO')) {
        alerts.push({
            type: 'critical',
            icon: '🔴',
            title: 'XRO: N3 Probability Increased',
            text: 'AI disruption thesis strengthened following Claude 4 announcement. N3 (Execution Failure) raised from 35% -> 42%.',
            ticker: 'XRO',
            time: '2 hours ago',
            impact: 'Affects 15% of portfolio'
        });
    }
    
    if (tickers.includes('WOW')) {
        alerts.push({
            type: 'warning',
            icon: '🟡',
            title: 'WOW: Earnings Preview',
            text: 'Q1 FY26 results due Feb 25. Consensus expects 11.8% EBIT growth vs management guidance of "mid-to-high single digits". Watch for N1/N2 inflection.',
            ticker: 'WOW',
            time: '1 day ago',
            impact: 'Affects 12% of portfolio'
        });
    }
    
    if (tickers.includes('CSL')) {
        alerts.push({
            type: 'info',
            icon: '🔵',
            title: 'CSL: Plasma Collection Update',
            text: 'Weekly collection data shows continued normalization. N1 (Recovery) probability stable at 45%. No change to thesis.',
            ticker: 'CSL',
            time: '3 days ago',
            impact: 'Affects 20% of portfolio'
        });
    }
    
    if (tickers.includes('WTC')) {
        alerts.push({
            type: 'critical',
            icon: '🔴',
            title: 'WTC: Governance Concerns Escalate',
            text: 'Additional board member resignation. N3 (Governance Risk) elevated from 30% -> 35%. Review position sizing.',
            ticker: 'WTC',
            time: '4 hours ago',
            impact: 'Affects 8% of portfolio'
        });
    }
    
    if (alerts.length < 2) {
        alerts.push({
            type: 'info',
            icon: '📊',
            title: 'Market: ASX 200 Volatility Elevated',
            text: 'VIX-equivalent at 18-month high. Consider position sizing across all hypotheses.',
            ticker: 'MARKET',
            time: '5 hours ago',
            impact: 'Broad market'
        });
    }
    
    if (alerts.length > 0 && feedEl) {
        feedEl.innerHTML = alerts.map(a => `
            <div class="change-alert-item ${a.type}">
                <div class="change-alert-icon">${a.icon}</div>
                <div class="change-alert-content">
                    <div class="change-alert-title">${a.title}</div>
                    <div class="change-alert-text">${a.text}</div>
                    <div class="change-alert-meta">
                        <span class="change-alert-ticker">${a.ticker}</span>
                        <span>⏱ ${a.time}</span>
                        <span>💼 ${a.impact}</span>
                    </div>
                </div>
            </div>
        `).join('');
        feedEl.style.display = '';
        if (emptyEl) emptyEl.style.display = 'none';
    } else if (emptyEl) {
        if (feedEl) feedEl.style.display = 'none';
        emptyEl.style.display = '';
    }
}

/* LocalStorage */
function savePortfolio(positions) {
    try { localStorage.setItem('continuum-portfolio', JSON.stringify(positions)); } catch(e) {}
}
function loadPortfolio() {
    try { const d = localStorage.getItem('continuum-portfolio'); return d ? JSON.parse(d) : null; } catch(e) { return null; }
}
function clearPortfolio() {
    localStorage.removeItem('continuum-portfolio');
    document.getElementById('uploadZone').style.display = '';
    document.getElementById('portfolioTable').style.display = 'none';
    document.getElementById('portfolioSummary').style.display = 'none';
    document.getElementById('portfolioActions').style.display = 'none';
    document.getElementById('portfolioBody').innerHTML = '';
    
    /* Hide diagnostics, reweighting, and alerts */
    const diag = document.getElementById('portfolioDiagnostics');
    const reweight = document.getElementById('portfolioReweighting');
    const alerts = document.getElementById('changeAlertsSection');
    if (diag) diag.style.display = 'none';
    if (reweight) reweight.style.display = 'none';
    if (alerts) alerts.style.display = 'none';
}

/* --- Hypothesis Sidebar Population --- */
function populateSidebar(ticker) {
    var sidebarId = ticker.toLowerCase() + '-sidebar';
    var sidebar = document.getElementById(sidebarId);
    if (!sidebar) return;

    // Don't re-populate if already filled
    if (sidebar.children.length > 0) return;

    var stock = STOCK_DATA[ticker];
    if (!stock) return;

    // ── Extract N1-N4 directly from STOCK_DATA (not DOM) ──
    var hypotheses = [];
    if (stock.hypotheses && stock.hypotheses.length > 0) {
        var norm = normaliseScores(stock.hypotheses);
        for (var i = 0; i < stock.hypotheses.length; i++) {
            var h = stock.hypotheses[i];
            hypotheses.push({
                dirClass: h.dirClass || 'dir-neutral',
                label: (h.title || '').replace(/^N\d+:\s*/, ''),
                score: norm[i] + '%'
            });
        }
    }

    // ── Compute skew from data ──
    var skew = stock._skew || computeSkewScore(stock);
    var skewDir = skew.direction || 'balanced';
    var skewLabel = skewDir.toUpperCase();
    var skewScoreNum = skew.score || 0;
    var skewScoreStr = (skewScoreNum > 0 ? '+' : '') + skewScoreNum;

    // ── Three-layer signal data ──
    var tls = stock.three_layer_signal || {};
    var macSig = tls.macro_signal || 0;
    var secSig = tls.sector_signal || 0;
    var macCls = macSig > 10 ? 'dir-up' : macSig < -10 ? 'dir-down' : 'dir-neutral';
    var secCls = secSig > 10 ? 'dir-up' : secSig < -10 ? 'dir-down' : 'dir-neutral';

    // ── P/E and Revenue Growth from REFERENCE_DATA / heroMetrics ──
    var ref = (typeof REFERENCE_DATA !== 'undefined') ? REFERENCE_DATA[ticker] : null;
    var peValue = ' -- ';
    var revGrowthValue = ' -- ';

    // Try heroMetrics first (live-hydrated values)
    if (stock.heroMetrics) {
        for (var mi = 0; mi < stock.heroMetrics.length; mi++) {
            var mLabel = (stock.heroMetrics[mi].label || '').toLowerCase();
            if (mLabel === 'fwd p/e' || mLabel === 'p/e') {
                peValue = stock.heroMetrics[mi].value;
            }
            if (mLabel === 'rev growth' || mLabel === 'revenue growth') {
                revGrowthValue = stock.heroMetrics[mi].value;
            }
        }
    }
    // Fallback to REFERENCE_DATA
    if (ref) {
        if (peValue === ' -- ' && ref.epsForward) {
            var currentP = parseFloat(stock._livePrice || stock.price || stock.current_price || 0);
            if (currentP > 0) peValue = (currentP / ref.epsForward).toFixed(1) + 'x';
        }
        if (revGrowthValue === ' -- ' && ref.revenueGrowth != null) {
            revGrowthValue = (ref.revenueGrowth > 0 ? '+' : '') + ref.revenueGrowth + '%';
        }
    }

    // ── Price and change ──
    var livePrice = parseFloat(stock._livePrice || stock.price || stock.current_price || 0);
    var ph = stock.priceHistory;
    var changePct = null;
    if (ph && ph.length >= 2) {
        changePct = ((ph[ph.length - 1] - ph[ph.length - 2]) / ph[ph.length - 2] * 100);
    } else if (stock.freshness && stock.freshness.pricePctChange != null) {
        changePct = stock.freshness.pricePctChange;
    }

    // ── Valuation Range ──
    var vr = null;
    var vrBear = 0, vrFair = 0, vrBull = 0, vrZone = '', vrZoneCls = '';
    var vrToBull = '', vrToBear = '';
    // Prefer hero.position_in_range.worlds (full data)
    if (stock.hero && stock.hero.position_in_range && stock.hero.position_in_range.worlds &&
        stock.hero.position_in_range.worlds.length >= 4) {
        var w = stock.hero.position_in_range.worlds;
        vrBear = parseFloat(w[1].price) || 0;
        vrFair = (parseFloat(w[1].price) + parseFloat(w[2].price)) / 2;
        vrBull = parseFloat(w[3].price) || 0;
        vr = { low: vrBear, mid: vrFair, high: vrBull };
    } else if (stock.valuation_range) {
        vr = stock.valuation_range;
        vrBear = vr.low;
        vrFair = vr.mid;
        vrBull = vr.high;
    }

    if (vr && livePrice > 0) {
        if (livePrice < vrBear)      { vrZone = 'RED';   vrZoneCls = 'red'; }
        else if (livePrice > vrFair) { vrZone = 'GREEN'; vrZoneCls = 'green'; }
        else                         { vrZone = 'AMBER'; vrZoneCls = 'amber'; }

        vrToBull = ((vrBull / livePrice - 1) * 100).toFixed(1);
        vrToBear = ((vrBear / livePrice - 1) * 100).toFixed(1);
    }

    // ── Build HTML ──
    var html = '';

    // 1. Stock ID
    html += '<div class="hs-stock-id">' +
        '<div class="hs-stock-ticker">' + (stock.tickerFull || stock.ticker || ticker) + '</div>' +
        '<div class="hs-price-row">';
    if (livePrice > 0) {
        html += '<span class="hs-price">A$' + livePrice.toFixed(2) + '</span>';
    }
    if (changePct !== null) {
        var chgCls = changePct >= 0 ? 'pos' : 'neg';
        html += '<span class="hs-change-badge ' + chgCls + '">' +
            (changePct >= 0 ? '+' : '') + changePct.toFixed(1) + '%</span>';
    }
    html += '</div>' +
        '<div class="hs-stock-name">' + (stock.company || '') + '</div>' +
    '</div>';

    // 2. DRIVER TRACKER heading + hypothesis items
    html += '<div class="hs-section-head">Driver Tracker</div>';
    hypotheses.forEach(function(h) {
        html += '<div class="hs-item">' +
            '<div class="hs-dot ' + h.dirClass + '"></div>' +
            '<div class="hs-label">' + h.label + '</div>' +
            '<div class="hs-score ' + h.dirClass + '">' + h.score + '</div>' +
        '</div>';
    });

    // 3. RISK SKEW subheading
    html += '<div class="hs-subhead">Risk Skew</div>';

    // 4. OVERALL SKEW
    html += '<div class="hs-overall-skew">' +
        '<span class="hs-skew-dir ' + skewDir + '">' + skewLabel + '</span>' +
        '<span class="hs-skew-score ' + skewDir + '">' + skewScoreStr + '</span>' +
    '</div>';

    // 5. EXT. ENVIRONMENT
    html += '<div class="hs-subhead">Ext. Environment</div>' +
        '<div class="hs-env-row">' +
            '<div class="hs-dot ' + macCls + '"></div>' +
            '<span class="hs-env-label">Macro</span>' +
            '<span class="hs-env-score">' + (macSig > 0 ? '+' : '') + macSig + '</span>' +
        '</div>' +
        '<div class="hs-env-row">' +
            '<div class="hs-dot ' + secCls + '"></div>' +
            '<span class="hs-env-label">Sector</span>' +
            '<span class="hs-env-score">' + (secSig > 0 ? '+' : '') + secSig + '</span>' +
        '</div>';

    // 6. COMPANY
    html += '<div class="hs-subhead">Company</div>' +
        '<div class="hs-company-row">' +
            '<span class="hs-company-label">P/E</span>' +
            '<span class="hs-company-value">' + peValue + '</span>' +
        '</div>' +
        '<div class="hs-company-row">' +
            '<span class="hs-company-label">Rev Growth</span>' +
            '<span class="hs-company-value">' + revGrowthValue + '</span>' +
        '</div>';

    // 7. VALUATION RANGE
    if (vr && livePrice > 0) {
        var vrRange = vrBull - vrBear || 1;
        var vrCurrPct = Math.min(100, Math.max(0, ((livePrice - vrBear) / vrRange * 100))).toFixed(1);

        html += '<div class="hs-section-head">Valuation Range</div>' +
            '<div class="hs-val-section">' +
                '<div class="hs-val-header">' +
                    '<span class="hs-val-zone ' + vrZoneCls + '">' + vrZone + '</span>' +
                '</div>' +
                '<div class="hs-val-levels">' +
                    '<span>Bear<br>A$' + vrBear.toFixed(2) + '</span>' +
                    '<span>Fair<br>A$' + vrFair.toFixed(2) + '</span>' +
                    '<span>Bull<br>A$' + vrBull.toFixed(2) + '</span>' +
                '</div>' +
                '<div class="hs-val-bar">' +
                    '<div class="hs-val-marker" style="left:' + vrCurrPct + '%"></div>' +
                '</div>' +
                '<div class="hs-val-distances">' +
                    '<span class="neg">' + vrToBear + '% to bear</span>' +
                    '<span class="pos">+' + vrToBull + '% to bull</span>' +
                '</div>' +
            '</div>';
    }

    sidebar.innerHTML = html;
}

/* ============================================================
   THESIS COMPARATOR ENGINE
   ============================================================ */

const TC_DATA = {
    WOW: {
        name: 'Woolworths Group', primary: 'n2',
        n1: { name: 'Managed Turnaround', prob: 36, desc: 'New leadership executes turnaround; margins stabilize' },
        n2: { name: 'Structural Margin Erosion', prob: 25, desc: 'Price investment and regulatory pressure permanently compress margins' },
        n3: { name: 'Regulatory Squeeze', prob: 21, desc: 'ACCC/FGCC action intensifies, constraining pricing power' },
        n4: { name: 'Competitive Disruption', prob: 18, desc: 'Aldi and independents take meaningful share' },
        supporting: ['ACCC margin findings', 'FGCC compliance costs', 'Aldi expansion data'],
        contradicting: ['Q1 FY26 trading update', 'NPS improvement', 'Cost-out progress'],
        analysis: "Your thesis <strong>supports N2 and N3</strong>  --  the downside scenarios. You believe margin pressure is structural, not cyclical, and regulatory headwinds are underappreciated. This puts you <strong>against consensus</strong> which prices a Bardwell turnaround (N1)."
    },
    CSL: {
        name: 'CSL Limited', primary: 'n1',
        n1: { name: 'Plasma Recovery & Growth', prob: 45, desc: 'Collections normalize; Behring margins expand; Vifor synergies realized' },
        n2: { name: 'Collection Shortfall', prob: 25, desc: 'US plasma collections fail to recover to target levels' },
        n3: { name: 'Behring Margin Compression', prob: 18, desc: 'Pricing pressure and input costs squeeze Behring profitability' },
        n4: { name: 'Competitive Threat', prob: 12, desc: 'Biosimilar competition emerges faster than expected' },
        supporting: ['Plasma collection trends', 'Behring margin guidance', 'Vifor integration synergies'],
        contradicting: ['Persistent collection challenges', 'Competitive dynamics', 'Pricing pressure signs'],
        analysis: "Your thesis <strong>strongly supports N1</strong>  --  the base case recovery. You believe plasma collections are normalizing and Behring margins will expand. You're <strong>aligned with consensus</strong>. Watch N2 risks."
    },
    XRO: {
        name: 'Xero Limited', primary: 'n1',
        n1: { name: 'AI-Led Growth Recovery', prob: 28, desc: 'AI investments drive subscriber growth; churn reduces' },
        n2: { name: 'Structural Margin Pressure', prob: 22, desc: 'Competition forces sustained price investment' },
        n3: { name: 'Execution Failure', prob: 35, desc: 'Management fails to deliver on AI promises; growth stalls' },
        n4: { name: 'Competitive Disruption', prob: 15, desc: 'QuickBooks or new entrant disrupts with superior AI' },
        supporting: ['AI partnership announcement', 'Subscriber growth momentum', 'US market opportunity'],
        contradicting: ['History of missed guidance', 'QuickBooks AI advancement', 'Microsoft SMB push'],
        analysis: "Your thesis <strong>supports N1</strong>  --  the turnaround narrative. However, you <strong>contradict N3 and N4</strong>, representing 50% of probability. High reward if right; significant risk if execution fails."
    },
    WTC: {
        name: 'WiseTech Global', primary: 'uphill',
        n1: { name: 'Organic Growth & Margins Intact', prob: 30, desc: 'Growth accelerates organically; margins expand' },
        n2: { name: 'Growth Deceleration', prob: 25, desc: 'Customer acquisition slows; revenue growth moderates' },
        n3: { name: 'Governance/Execution Risk', prob: 30, desc: 'Founder departure or governance issues impair execution' },
        n4: { name: 'Competitive Disruption', prob: 15, desc: 'New logistics platform gains traction' },
        supporting: ['CargoWise platform strength', 'Founder vision alignment', 'Global trade recovery'],
        contradicting: ['Governance concerns persist', 'Insider selling patterns', 'Competitive pricing pressure'],
        analysis: "Your thesis is <strong>⚠️ PUSHING UPHILL</strong>. You don't align clearly with N1, yet contradict N2, N3, N4 (70% combined). Requires growth recovery AND governance concerns proving overblown."
    },
    WDS: {
        name: 'Woodside Energy', primary: 'n2',
        n1: { name: 'Energy Transition Delayed', prob: 30, desc: 'Fossil demand persists longer; LNG prices remain elevated' },
        n2: { name: 'Managed Decline', prob: 35, desc: 'Orderly transition; stable cash flows; disciplined capex' },
        n3: { name: 'Stranded Asset Risk', prob: 20, desc: 'Accelerated transition strands LNG assets' },
        n4: { name: 'Execution Failure', prob: 15, desc: 'Scarborough delays; cost overruns; production misses' },
        supporting: ['LNG demand resilience', 'Asian contract pricing', 'Scarborough progress'],
        contradicting: ['Energy transition acceleration', 'EU LNG diversification', 'Cost inflation'],
        analysis: "Your thesis <strong>supports N2</strong>  --  the managed decline scenario. You expect orderly cash flow generation through transition. Watch N1 (upside) and N3 (downside) scenarios."
    },
    MQG: {
        name: 'Macquarie Group', primary: 'n1',
        n1: { name: 'Green Energy Leadership', prob: 40, desc: 'Green investment bank thesis succeeds; asset realizations strong' },
        n2: { name: 'Commodities Normalization', prob: 25, desc: 'Commodity earnings normalize; offset by green growth' },
        n3: { name: 'Asset Realization Shortfall', prob: 20, desc: 'Green asset sales disappoint; valuation gap persists' },
        n4: { name: 'Competitive Pressure', prob: 15, desc: 'Traditional banks compete effectively on green finance' },
        supporting: ['Green asset pipeline', 'Commodity earnings resilience', 'Asset realization track record'],
        contradicting: ['Green asset valuation compression', 'Traditional bank competition', 'Rate headwinds'],
        analysis: "Your thesis <strong>strongly supports N1</strong>  --  the green energy bank narrative. You believe Macquarie can pivot successfully. Watch N3 risk on asset realizations."
    },
    DRO: {
        name: 'Droneshield', primary: 'n3',
        n1: { name: 'Mass Adoption', prob: 15, desc: 'Government contracts scale rapidly; commercial adoption accelerates' },
        n2: { name: 'Defense Budget Dependence', prob: 25, desc: 'Revenue tied to lumpy defense procurement' },
        n3: { name: 'Competitive Threat', prob: 40, desc: 'Larger defense primes enter; pricing pressure emerges' },
        n4: { name: 'Technology Obsolescence', prob: 20, desc: 'New counter-drone tech renders products obsolete' },
        supporting: ['Defense contract wins', 'Counter-drone threat urgency', 'International expansion'],
        contradicting: ['Defense budget volatility', 'Large prime competition', 'Technology cycle risk'],
        analysis: "Your thesis <strong>supports N2</strong> but acknowledges N3 risks. Droneshield operates in a niche vulnerable to larger competitors. High conviction required given N3/N4 probability (60%)."
    },
    PME: {
        name: 'Pro Medicus', primary: 'n1',
        n1: { name: 'Continued Dominance', prob: 50, desc: 'Visage AI maintains technical lead; contract renewals at higher rates' },
        n2: { name: 'Growth Normalization', prob: 25, desc: 'Growth moderates from exceptional to strong levels' },
        n3: { name: 'Competitive Entry', prob: 15, desc: 'Big Tech or med-tech enters radiology AI effectively' },
        n4: { name: 'Valuation Compression', prob: 10, desc: 'Multiple derates despite continued execution' },
        supporting: ['Visage AI technical lead', 'Contract renewal pricing', 'Market expansion'],
        contradicting: ['Big Tech AI capabilities', 'Healthcare IT budgets', 'Multiple sustainability'],
        analysis: "Your thesis <strong>strongly supports N1</strong>  --  the continued dominance scenario. High conviction in technical moat. Watch N3 (competition) as main risk."
    },
    GYG: {
        name: 'Guzman y Gomez', primary: 'n2',
        n1: { name: 'Successful Scale-Up', prob: 25, desc: 'Store rollout succeeds; unit economics improve at scale' },
        n2: { name: 'Growth vs Profitability Tension', prob: 35, desc: 'Expansion costs weigh; path to profit unclear' },
        n3: { name: 'Competitive Response', prob: 25, desc: 'Incumbents respond effectively; differentiation erodes' },
        n4: { name: 'Execution Failure', prob: 15, desc: 'Store openings miss targets; franchisee issues emerge' },
        supporting: ['Store rollout momentum', 'Brand differentiation', 'Australian market opportunity'],
        contradicting: ['Unit economics uncertainty', 'Competitive intensity', 'Franchisee model risks'],
        analysis: "Your thesis <strong>aligns with N2</strong>  --  the growth vs profitability tension. You believe expansion will strain economics. This is the base case for recent IPOs in competitive markets."
    },
    GMG: {
        name: 'Goodman Group', primary: 'n1',
        n1: { name: 'Logistics Megatrend', prob: 45, desc: 'E-commerce growth sustains; development pipeline delivers' },
        n2: { name: 'Cyclical Slowdown', prob: 25, desc: 'Development slows; valuations moderate' },
        n3: { name: 'Oversupply Risk', prob: 18, desc: 'Competitive development creates oversupply' },
        n4: { name: 'Interest Rate Sensitivity', prob: 12, desc: 'Higher rates impair valuations and development returns' },
        supporting: ['E-commerce penetration growth', 'Development pipeline', 'Premium asset quality'],
        contradicting: ['Interest rate environment', 'Development cycle maturity', 'Competitive supply'],
        analysis: "Your thesis <strong>supports N1</strong>  --  the logistics megatrend. You believe e-commerce tailwinds persist. Watch N4 (rates) and N3 (oversupply) as cyclical risks."
    },
    SIG: {
        name: 'Sigma Healthcare', primary: 'n1',
        n1: { name: 'Chemist Warehouse Synergies', prob: 40, desc: 'Merger delivers cost synergies; market position strengthens' },
        n2: { name: 'Integration Challenges', prob: 30, desc: 'Merger execution proves difficult; synergies delayed' },
        n3: { name: 'Regulatory Block', prob: 15, desc: 'ACCC blocks or conditions merger heavily' },
        n4: { name: 'Competitive Response', prob: 15, desc: 'EBOS and independents respond effectively' },
        supporting: ['Synergy targets', 'Market share opportunity', 'Scale advantages'],
        contradicting: ['Integration complexity', 'Regulatory uncertainty', 'Competitive dynamics'],
        analysis: "Your thesis <strong>supports N1</strong>  --  the merger synergy story. You believe Sigma+Chemist Warehouse creates value. Key risk is N2 (integration execution)."
    },
    FMG: {
        name: 'Fortescue', primary: 'n2',
        n1: { name: 'Green Hydrogen Success', prob: 20, desc: 'Fortescue Future Industries becomes viable business' },
        n2: { name: 'Iron Ore Cash Machine', prob: 45, desc: 'Core iron ore generates cash; green projects scaled back' },
        n3: { name: 'Iron Ore Price Collapse', prob: 25, desc: 'Chinese demand weakness crushes iron ore prices' },
        n4: { name: 'Green Capital Destruction', prob: 10, desc: 'Hydrogen investments destroy value with no returns' },
        supporting: ['Iron ore cost position', 'Chinese demand resilience', 'Green hydrogen optionality'],
        contradicting: ['Iron ore price volatility', 'Chinese property weakness', 'Hydrogen economics'],
        analysis: "Your thesis <strong>aligns with N2</strong>  --  the cash machine scenario. You view green hydrogen as optionality, not core value. Watch N3 (China risk) as main downside."
    }
};

let tcSelectedTicker = null;
let tcCurrentAlignment = null;

function tcSelectStock(ticker) {
    tcSelectedTicker = ticker;
    document.querySelectorAll('.tc-stock-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.ticker === ticker);
    });
    document.getElementById('tc-step-2').classList.add('active');
    document.getElementById('tc-step-2').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function tcAnalyze() {
    if (!tcSelectedTicker) { alert('Please select a stock first'); return; }

    const data = TC_DATA[tcSelectedTicker];
    if (!data) {
        document.getElementById('tc-results').innerHTML = '<div class="tc-banner"><div class="tc-banner-label">Thesis comparison not yet available for ' + tcSelectedTicker + '. Full analysis coming soon.</div></div>';
        document.getElementById('tc-results').style.display = 'block';
        return;
    }
    const thesis = document.getElementById('tc-thesis-input').value.toLowerCase();

    let primaryTier = data.primary;
    if (thesis.length > 50) {
        const scores = { n1: 0, n2: 0, n3: 0, n4: 0 };
        if (/growth|recovery|expansion|synergy|dominance|leadership|success/i.test(thesis)) scores.n1 += 2;
        if (/bull|bullish|outperform|buy/i.test(thesis)) scores.n1 += 1;
        if (/normalize|moderate|decline|cyclical|slowdown|steady|base/i.test(thesis)) scores.n2 += 2;
        if (/hold|neutral|fair value/i.test(thesis)) scores.n2 += 1;
        if (/risk|execution|failure|challenge|problem|concern|bear/i.test(thesis)) scores.n3 += 2;
        if (/short|sell|underperform|avoid/i.test(thesis)) scores.n3 += 1;
        if (/disrupt|competition|threat|obsolete|replace/i.test(thesis)) scores.n4 += 2;
        
        const maxScore = Math.max(...Object.values(scores));
        if (maxScore > 0) {
            const winner = Object.entries(scores).find(([k, v]) => v === maxScore)[0];
            primaryTier = winner;
        }
    }
    
    tcCurrentAlignment = primaryTier;
    
    const banner = document.getElementById('tc-banner');
    banner.className = 'tc-banner ' + primaryTier;
    
    const tierData = data[primaryTier];
    if (primaryTier === 'uphill') {
        document.getElementById('tc-banner-label').textContent = 'Your thesis position:';
        document.getElementById('tc-banner-hypothesis').textContent = '⚠️ PUSHING UPHILL';
        document.getElementById('tc-banner-desc').textContent = "Your view doesn't clearly align with any single hypothesis. You're making a contrarian bet.";
    } else {
        document.getElementById('tc-banner-label').textContent = 'Your thesis aligns most closely with:';
        document.getElementById('tc-banner-hypothesis').textContent = primaryTier.toUpperCase() + ': ' + tierData.name;
        document.getElementById('tc-banner-desc').textContent = tierData.desc;
    }
    
    const rowsContainer = document.getElementById('tc-map-rows');
    rowsContainer.innerHTML = ['n1','n2','n3','n4'].map(tier => {
        const tData = data[tier];
        const isMatch = tier === primaryTier;
        const stance = isMatch ? 'supports' : 'contradicts';
        return `
            <div class="tc-row">
                <div class="tc-indicator ${tier} ${isMatch ? 'match' : ''}">${tier.toUpperCase()}</div>
                <div class="tc-info">
                    <div class="tc-name">${tier.toUpperCase()}: ${tData.name}</div>
                    <div class="tc-prob">Continuum: ${tData.prob}% probability</div>
                </div>
                <span class="tc-stance ${stance}">${stance.toUpperCase()}</span>
            </div>
        `;
    }).join('');
    
    document.getElementById('tc-analysis-text').innerHTML = data.analysis;
    document.getElementById('tc-supporting').innerHTML = data.supporting.map(item => 
        `<div class="tc-evidence-item"><span class="tc-evidence-icon support">&#10003;</span><span>${item}</span></div>`
    ).join('');
    document.getElementById('tc-contradicting').innerHTML = data.contradicting.map(item => 
        `<div class="tc-evidence-item"><span class="tc-evidence-icon contradict">!</span><span>${item}</span></div>`
    ).join('');
    
    document.getElementById('tc-results').classList.add('active');
    document.getElementById('tc-results').scrollIntoView({ behavior: 'smooth' });
}

// ============================================================
// REFRESH / UPDATE BUTTON LOGIC
// ============================================================

var REFRESH_API_BASE = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
    ? 'http://localhost:8000'
    : window.location.hostname.includes('github.io')
        ? 'https://imaginative-vision-production-16cb.up.railway.app'
        : '';  // Same origin on Railway

var _refreshPollers = {};

async function triggerRefresh(ticker) {
    ticker = ticker.toUpperCase();
    var btn = document.getElementById('refresh-btn-' + ticker);
    var progress = document.getElementById('refresh-progress-' + ticker);
    var fill = document.getElementById('refresh-fill-' + ticker);
    var label = document.getElementById('refresh-label-' + ticker);
    var ts = document.getElementById('refresh-ts-' + ticker);

    if (!btn) return;

    // Disable button, show progress
    btn.disabled = true;
    btn.classList.add('refreshing');
    if (progress) progress.style.display = 'flex';
    if (fill) fill.style.width = '5%';
    if (label) label.textContent = 'Starting refresh...';

    try {
        // POST to trigger refresh
        var resp = await fetch(REFRESH_API_BASE + '/api/refresh/' + ticker, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        if (resp.status === 409) {
            if (label) label.textContent = 'Refresh already in progress...';
            // Still poll for status
        } else if (!resp.ok) {
            var errData = await resp.json().catch(function() { return {}; });
            throw new Error(errData.detail || 'Refresh failed (' + resp.status + ')');
        }

        // Start polling for status
        _pollRefreshStatus(ticker);

    } catch (err) {
        console.error('Refresh error:', err);
        if (label) label.textContent = 'Error: ' + err.message;
        setTimeout(function() {
            _resetRefreshUI(ticker);
        }, 4000);
    }
}

function _pollRefreshStatus(ticker) {
    // Clear any existing poller
    if (_refreshPollers[ticker]) clearInterval(_refreshPollers[ticker]);

    _refreshPollers[ticker] = setInterval(async function() {
        try {
            var resp = await fetch(REFRESH_API_BASE + '/api/refresh/' + ticker + '/status');
            if (!resp.ok) return;

            var data = await resp.json();
            var fill = document.getElementById('refresh-fill-' + ticker);
            var label = document.getElementById('refresh-label-' + ticker);

            if (fill) fill.style.width = data.progress_pct + '%';
            if (label) label.textContent = data.stage_label;

            if (data.status === 'completed') {
                clearInterval(_refreshPollers[ticker]);
                delete _refreshPollers[ticker];

                // Fetch updated data
                try {
                    var resultResp = await fetch(REFRESH_API_BASE + '/api/refresh/' + ticker + '/result');
                    if (resultResp.ok) {
                        var updatedData = await resultResp.json();
                        // Normalise ISO currency codes to symbols
                        var currencyMap = {'AUD':'A$','USD':'US$','GBP':'£','EUR':'€'};
                        if (updatedData.currency && currencyMap[updatedData.currency]) {
                            updatedData.currency = currencyMap[updatedData.currency];
                        }
                        // Merge into global stock data, preserving live price patches
                        if (typeof STOCK_DATA !== 'undefined') {
                            var livePrice = STOCK_DATA[ticker] ? STOCK_DATA[ticker]._livePrice : undefined;
                            STOCK_DATA[ticker] = updatedData;
                            if (livePrice !== undefined) STOCK_DATA[ticker]._livePrice = livePrice;
                        }
                        // Cache in localStorage so refresh survives page reload
                        try {
                            localStorage.setItem('ci_research_' + ticker.toUpperCase(), JSON.stringify(updatedData));
                            console.log('[RefreshCache] Cached refresh result for ' + ticker);
                        } catch (lsErr) {
                            console.warn('[RefreshCache] localStorage write failed:', lsErr);
                        }
                        // Destroy Chart.js instances before DOM replacement
                        if (typeof destroyNarrativeTimelineChart === 'function') {
                            destroyNarrativeTimelineChart(ticker.toUpperCase());
                        }
                        // Re-render the report page
                        var container = document.getElementById('page-report-' + ticker.toUpperCase());
                        if (container && typeof renderReportPage === 'function') {
                            container.innerHTML = renderReportPage(updatedData);
                            initSectionToggles(ticker);
                            // Re-initialise any chart/interactive elements
                            if (typeof initChartForTicker === 'function') initChartForTicker(ticker);
                            if (typeof initInlineChat === 'function') initInlineChat();
                        }
                    }
                } catch (e) {
                    console.error('Failed to fetch refresh result:', e);
                }

                // Show completion briefly then reset
                if (fill) fill.style.width = '100%';
                if (label) label.textContent = 'Complete!';
                setTimeout(function() { _resetRefreshUI(ticker); }, 2000);
            }

            if (data.status === 'failed') {
                clearInterval(_refreshPollers[ticker]);
                delete _refreshPollers[ticker];
                if (label) label.textContent = 'Failed: ' + (data.error || 'Unknown error');
                setTimeout(function() { _resetRefreshUI(ticker); }, 5000);
            }

        } catch (e) {
            console.error('Status poll error:', e);
        }
    }, 2000);  // Poll every 2 seconds
}

function _resetRefreshUI(ticker) {
    var btn = document.getElementById('refresh-btn-' + ticker);
    var progress = document.getElementById('refresh-progress-' + ticker);
    var fill = document.getElementById('refresh-fill-' + ticker);

    if (btn) {
        btn.disabled = false;
        btn.classList.remove('refreshing');
    }
    if (progress) progress.style.display = 'none';
    if (fill) fill.style.width = '0%';
}
</script>

<!-- ============================================================
     BATCH REFRESH MODAL
     ============================================================ -->
<div id="batch-refresh-modal" class="batch-modal" style="display:none">
  <div class="batch-modal-backdrop" onclick="closeBatchModal()"></div>
  <div class="batch-modal-content">
    <div class="batch-modal-header">
      <h2 class="batch-modal-title">Refreshing All Research</h2>
      <button class="batch-modal-close" onclick="closeBatchModal()">&times;</button>
    </div>
    <div class="batch-overall">
      <div class="batch-progress-track">
        <div class="batch-progress-fill" id="batch-overall-fill" style="width:0%"></div>
      </div>
      <div class="batch-stats" id="batch-stats">Queuing 21 stocks...</div>
    </div>
    <div class="batch-ticker-grid" id="batch-ticker-grid"></div>
    <div class="batch-modal-footer">
      <span class="batch-elapsed" id="batch-elapsed"></span>
      <button class="batch-close-btn" id="batch-close-btn" onclick="closeBatchModal()">Close</button>
    </div>
  </div>
</div>

<style>
/* Refresh All button */
.btn-refresh-all {
  background: linear-gradient(135deg, #0a2f1f 0%, #145a3a 100%);
  color: #00c875;
  border: 1px solid rgba(0,200,117,0.3);
  padding: 8px 18px;
  border-radius: 6px;
  font-size: 0.82rem;
  font-weight: 600;
  letter-spacing: 0.03em;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-refresh-all:hover {
  background: linear-gradient(135deg, #145a3a 0%, #1a7a4e 100%);
  border-color: rgba(0,200,117,0.6);
  box-shadow: 0 0 12px rgba(0,200,117,0.15);
}
.btn-refresh-all:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
[data-theme="light"] .btn-refresh-all {
  background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
  color: #1b5e20;
  border-color: rgba(27,94,32,0.3);
}

/* Batch modal */
.batch-modal {
  position: fixed;
  inset: 0;
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
}
.batch-modal-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(4px);
}
.batch-modal-content {
  position: relative;
  background: #0d1b14;
  border: 1px solid rgba(0,200,117,0.2);
  border-radius: 12px;
  width: 680px;
  max-width: 95vw;
  max-height: 85vh;
  overflow-y: auto;
  padding: 28px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}
[data-theme="light"] .batch-modal-content {
  background: #fff;
  border-color: #ddd;
  box-shadow: 0 20px 60px rgba(0,0,0,0.15);
}
.batch-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}
.batch-modal-title {
  font-size: 1.2rem;
  font-weight: 700;
  color: #e0e0e0;
  margin: 0;
}
[data-theme="light"] .batch-modal-title { color: #1a1a1a; }
.batch-modal-close {
  background: none;
  border: none;
  color: #999;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0 4px;
}
.batch-modal-close:hover { color: #fff; }

/* Overall progress */
.batch-overall { margin-bottom: 20px; }
.batch-progress-track {
  width: 100%;
  height: 8px;
  background: rgba(255,255,255,0.08);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 8px;
}
[data-theme="light"] .batch-progress-track { background: #e0e0e0; }
.batch-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #00c875, #00e68a);
  border-radius: 4px;
  transition: width 0.5s ease;
}
.batch-stats {
  font-size: 0.82rem;
  color: #aaa;
  text-align: center;
}
[data-theme="light"] .batch-stats { color: #666; }

/* Ticker grid */
.batch-ticker-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
  margin-bottom: 20px;
}
@media (max-width: 600px) {
  .batch-ticker-grid { grid-template-columns: repeat(4, 1fr); }
}
.batch-card {
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 8px;
  padding: 10px 6px;
  text-align: center;
  transition: all 0.3s;
}
[data-theme="light"] .batch-card {
  background: #f8f8f8;
  border-color: #e0e0e0;
}
.batch-card.status-queued { opacity: 0.5; }
.batch-card.status-running {
  border-color: rgba(87,155,252,0.5);
  background: rgba(87,155,252,0.08);
}
.batch-card.status-completed {
  border-color: rgba(0,200,117,0.5);
  background: rgba(0,200,117,0.08);
}
.batch-card.status-failed {
  border-color: rgba(228,66,88,0.5);
  background: rgba(228,66,88,0.08);
}
.batch-card-ticker {
  font-size: 0.78rem;
  font-weight: 700;
  font-family: 'JetBrains Mono', 'SF Mono', monospace;
  margin-bottom: 4px;
  color: #e0e0e0;
}
[data-theme="light"] .batch-card-ticker { color: #1a1a1a; }
.batch-card-mini-bar {
  width: 100%;
  height: 3px;
  background: rgba(255,255,255,0.08);
  border-radius: 2px;
  overflow: hidden;
  margin-bottom: 4px;
}
[data-theme="light"] .batch-card-mini-bar { background: #ddd; }
.batch-card-mini-fill {
  height: 100%;
  border-radius: 2px;
  transition: width 0.5s;
  background: #579bfc;
}
.status-completed .batch-card-mini-fill { background: #00c875; width: 100% !important; }
.status-failed .batch-card-mini-fill { background: #e44258; width: 100% !important; }
.batch-card-icon {
  font-size: 0.7rem;
  color: #888;
}
.status-queued .batch-card-icon { color: #666; }
.status-running .batch-card-icon { color: #579bfc; }
.status-completed .batch-card-icon { color: #00c875; }
.status-failed .batch-card-icon { color: #e44258; }

/* Footer */
.batch-modal-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.batch-elapsed {
  font-size: 0.78rem;
  color: #888;
  font-family: 'JetBrains Mono', monospace;
}
.batch-close-btn {
  background: rgba(255,255,255,0.08);
  color: #ccc;
  border: 1px solid rgba(255,255,255,0.12);
  padding: 8px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.82rem;
}
.batch-close-btn:hover { background: rgba(255,255,255,0.15); }
[data-theme="light"] .batch-close-btn {
  background: #f0f0f0;
  color: #333;
  border-color: #ccc;
}
</style>

<script>
// ============================================================
// BATCH REFRESH (Refresh All)
// ============================================================
var _batchPoller = null;
var _batchStartTime = null;
var _batchCachedTickers = {};

async function triggerRefreshAll() {
    var btn = document.getElementById('btn-refresh-all');
    if (btn) { btn.disabled = true; btn.textContent = 'Refreshing...'; }

    try {
        // On retry, send only tickers not already cached this session
        var cachedKeys = Object.keys(_batchCachedTickers).filter(function(k) { return _batchCachedTickers[k]; });
        var bodyPayload = {};
        if (cachedKeys.length > 0) {
            var allTickers = ['BHP','CBA','CSL','DRO','DXS','FMG','GMG','GYG','HRZ','MQG','NAB','OCL','PME','RFG','RIO','SIG','WDS','WOR','WOW','WTC','XRO'];
            var remaining = allTickers.filter(function(t) { return cachedKeys.indexOf(t) === -1; });
            if (remaining.length > 0) bodyPayload.tickers = remaining;
        }

        var resp = await fetch(REFRESH_API_BASE + '/api/refresh-all', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bodyPayload)
        });

        if (resp.status === 409) {
            // Already running — just open modal and start polling
            _showBatchModal();
            _startBatchPolling();
            return;
        }

        if (!resp.ok) {
            var err = await resp.json().catch(function() { return {}; });
            throw new Error(err.detail || 'Batch refresh failed (' + resp.status + ')');
        }

        var data = await resp.json();
        _batchStartTime = Date.now();
        // Don't reset _batchCachedTickers — preserve already-cached from prior run

        // Build the grid showing all 21 tickers (cached ones pre-marked green)
        var allTickers = ['BHP','CBA','CSL','DRO','DXS','FMG','GMG','GYG','HRZ','MQG','NAB','OCL','PME','RFG','RIO','SIG','WDS','WOR','WOW','WTC','XRO'];
        _buildBatchGrid(allTickers);
        _showBatchModal();
        _startBatchPolling();

    } catch (err) {
        console.error('Batch refresh error:', err);
        alert('Failed to start batch refresh: ' + err.message);
        if (btn) { btn.disabled = false; btn.textContent = '\u21BB Refresh All Research'; }
    }
}

function _buildBatchGrid(tickers) {
    var grid = document.getElementById('batch-ticker-grid');
    if (!grid) return;
    var html = '';
    for (var i = 0; i < tickers.length; i++) {
        var t = tickers[i];
        var isCached = _batchCachedTickers[t];
        var statusClass = isCached ? 'status-completed' : 'status-queued';
        var icon = isCached ? '\u2713' : '\u25CB';
        var fill = isCached ? '100' : '0';
        html += '<div class="batch-card ' + statusClass + '" id="batch-card-' + t + '">' +
            '<div class="batch-card-ticker">' + t + '</div>' +
            '<div class="batch-card-mini-bar"><div class="batch-card-mini-fill" style="width:' + fill + '%"></div></div>' +
            '<div class="batch-card-icon">' + icon + '</div>' +
        '</div>';
    }
    grid.innerHTML = html;
}

function _showBatchModal() {
    var modal = document.getElementById('batch-refresh-modal');
    if (modal) modal.style.display = 'flex';
}

function closeBatchModal() {
    var modal = document.getElementById('batch-refresh-modal');
    if (modal) modal.style.display = 'none';
    // Don't stop polling — let it continue in background
}

function _startBatchPolling() {
    if (_batchPoller) clearInterval(_batchPoller);
    _batchPoller = setInterval(_pollBatchStatus, 3000);
    _pollBatchStatus(); // immediate first poll
}

async function _pollBatchStatus() {
    try {
        var resp = await fetch(REFRESH_API_BASE + '/api/refresh-all/status');
        if (resp.status === 404) {
            // Server restarted — batch state lost
            clearInterval(_batchPoller);
            _batchPoller = null;
            var stats = document.getElementById('batch-stats');
            var cachedCount = Object.keys(_batchCachedTickers).filter(function(k) { return _batchCachedTickers[k]; }).length;
            if (stats) stats.textContent = 'Server restarted. ' + cachedCount + ' tickers cached. Close and retry remaining.';
            var btn = document.getElementById('btn-refresh-all');
            if (btn) { btn.disabled = false; btn.textContent = '\u21BB Refresh All Research'; }
            return;
        }
        if (!resp.ok) return;

        var data = await resp.json();

        // Update overall progress
        var fill = document.getElementById('batch-overall-fill');
        if (fill) fill.style.width = data.overall_progress_pct + '%';

        var stats = document.getElementById('batch-stats');
        if (stats) {
            stats.textContent = data.total_completed + '/' + data.total + ' completed' +
                (data.total_failed > 0 ? ', ' + data.total_failed + ' failed' : '') +
                (data.total_in_progress > 0 ? ', ' + data.total_in_progress + ' in progress' : '') +
                (data.total_queued > 0 ? ', ' + data.total_queued + ' queued' : '');
        }

        // Update elapsed time
        if (_batchStartTime) {
            var elapsed = Math.round((Date.now() - _batchStartTime) / 1000);
            var mins = Math.floor(elapsed / 60);
            var secs = elapsed % 60;
            var elapsedEl = document.getElementById('batch-elapsed');
            if (elapsedEl) elapsedEl.textContent = mins + 'm ' + (secs < 10 ? '0' : '') + secs + 's';
        }

        // Update per-ticker cards + incremental caching
        var tickerStatuses = data.per_ticker_status || [];
        for (var i = 0; i < tickerStatuses.length; i++) {
            var ts = tickerStatuses[i];
            _updateBatchCard(ts);

            // Incrementally fetch + cache each ticker as it completes
            if (ts.status === 'completed' && !_batchCachedTickers[ts.ticker]) {
                _batchCachedTickers[ts.ticker] = true;
                _fetchAndCacheSingleTicker(ts.ticker);
            }
        }

        // Check if done
        if (data.status === 'completed' || data.status === 'partially_failed' || data.status === 'failed') {
            clearInterval(_batchPoller);
            _batchPoller = null;

            // Re-enable button
            var btn = document.getElementById('btn-refresh-all');
            if (btn) { btn.disabled = false; btn.textContent = '\u21BB Refresh All Research'; }

            // Final re-render (individual caches already done incrementally)
            if (typeof renderCoverageTable === 'function') renderCoverageTable();
            if (typeof renderFeaturedGrid === 'function') renderFeaturedGrid();
        }

    } catch (e) {
        console.error('Batch poll error:', e);
    }
}

function _updateBatchCard(ts) {
    var card = document.getElementById('batch-card-' + ts.ticker);
    if (!card) return;

    // Determine visual status class
    var statusClass = 'status-queued';
    var icon = '\u25CB'; // circle
    if (ts.status === 'completed') {
        statusClass = 'status-completed';
        icon = '\u2713'; // checkmark
    } else if (ts.status === 'failed') {
        statusClass = 'status-failed';
        icon = '\u2717'; // cross
    } else if (ts.status !== 'queued') {
        statusClass = 'status-running';
        icon = '\u21BB'; // refresh
    }

    card.className = 'batch-card ' + statusClass;

    var miniFill = card.querySelector('.batch-card-mini-fill');
    if (miniFill) miniFill.style.width = ts.progress_pct + '%';

    var iconEl = card.querySelector('.batch-card-icon');
    if (iconEl) {
        iconEl.textContent = icon;
        if (ts.error) iconEl.title = ts.error;
    }
}

async function _fetchAndCacheSingleTicker(ticker) {
    try {
        var resp = await fetch(REFRESH_API_BASE + '/api/refresh/' + ticker + '/result');
        if (!resp.ok) return;

        var updatedData = await resp.json();
        var currencyMap = {'AUD':'A$','USD':'US$','GBP':'\u00A3','EUR':'\u20AC'};

        // Normalise currency
        if (updatedData.currency && currencyMap[updatedData.currency]) {
            updatedData.currency = currencyMap[updatedData.currency];
        }

        // Merge into STOCK_DATA, preserving live prices
        if (typeof STOCK_DATA !== 'undefined') {
            var livePrice = STOCK_DATA[ticker] ? STOCK_DATA[ticker]._livePrice : undefined;
            var livePriceHistory = STOCK_DATA[ticker] ? STOCK_DATA[ticker].priceHistory : undefined;
            STOCK_DATA[ticker] = updatedData;
            if (livePrice !== undefined) {
                STOCK_DATA[ticker]._livePrice = livePrice;
                STOCK_DATA[ticker].price = livePrice;
            }
            if (livePriceHistory) STOCK_DATA[ticker].priceHistory = livePriceHistory;
        }

        // Cache in localStorage
        try {
            localStorage.setItem('ci_research_' + ticker, JSON.stringify(updatedData));
        } catch (lsErr) { /* ignore */ }

        console.log('[BatchRefresh] Cached ' + ticker + ' incrementally');

        // Re-render current page if viewing this ticker
        var hash = window.location.hash || '';
        var reportMatch = hash.match(/^#report-(\w+)/);
        if (reportMatch && reportMatch[1].toUpperCase() === ticker) {
            if (typeof destroyNarrativeTimelineChart === 'function') destroyNarrativeTimelineChart(ticker);
            var container = document.getElementById('page-report-' + ticker);
            if (container && typeof renderReportPage === 'function') {
                container.innerHTML = renderReportPage(STOCK_DATA[ticker]);
                initSectionToggles(ticker);
                if (typeof initChartForTicker === 'function') initChartForTicker(ticker);
                if (typeof initInlineChat === 'function') initInlineChat();
            }
        }
    } catch (e) {
        console.error('[BatchRefresh] Failed to cache ' + ticker + ':', e);
        _batchCachedTickers[ticker] = false; // Allow retry on next poll
    }
}

async function _fetchAndMergeBatchResults() {
    try {
        var resp = await fetch(REFRESH_API_BASE + '/api/refresh-all/results');
        if (!resp.ok) {
            console.error('Failed to fetch batch results:', resp.status);
            return;
        }

        var data = await resp.json();
        var results = data.results || {};
        var currencyMap = {'AUD':'A$','USD':'US$','GBP':'\u00A3','EUR':'\u20AC'};
        var merged = 0;

        for (var ticker in results) {
            if (!results.hasOwnProperty(ticker)) continue;
            var updatedData = results[ticker];

            // Normalise currency
            if (updatedData.currency && currencyMap[updatedData.currency]) {
                updatedData.currency = currencyMap[updatedData.currency];
            }

            // Merge into STOCK_DATA, preserving live prices
            if (typeof STOCK_DATA !== 'undefined') {
                var livePrice = STOCK_DATA[ticker] ? STOCK_DATA[ticker]._livePrice : undefined;
                var livePriceHistory = STOCK_DATA[ticker] ? STOCK_DATA[ticker].priceHistory : undefined;
                STOCK_DATA[ticker] = updatedData;
                if (livePrice !== undefined) {
                    STOCK_DATA[ticker]._livePrice = livePrice;
                    STOCK_DATA[ticker].price = livePrice;
                }
                if (livePriceHistory) STOCK_DATA[ticker].priceHistory = livePriceHistory;
            }

            // Cache in localStorage
            try {
                localStorage.setItem('ci_research_' + ticker, JSON.stringify(updatedData));
            } catch (lsErr) { /* ignore */ }

            merged++;
        }

        console.log('[BatchRefresh] Merged ' + merged + ' tickers into STOCK_DATA');

        // Re-render current page if it's a report page
        var hash = window.location.hash || '';
        var reportMatch = hash.match(/^#report-(\w+)/);
        if (reportMatch) {
            var currentTicker = reportMatch[1].toUpperCase();
            if (STOCK_DATA[currentTicker]) {
                if (typeof destroyNarrativeTimelineChart === 'function') {
                    destroyNarrativeTimelineChart(currentTicker);
                }
                var container = document.getElementById('page-report-' + currentTicker);
                if (container && typeof renderReportPage === 'function') {
                    container.innerHTML = renderReportPage(STOCK_DATA[currentTicker]);
                    initSectionToggles(currentTicker);
                    if (typeof initChartForTicker === 'function') initChartForTicker(currentTicker);
                    if (typeof initInlineChat === 'function') initInlineChat();
                }
            }
        }

        // Re-render coverage table and featured grid if on home page
        if (typeof renderCoverageTable === 'function') renderCoverageTable();
        if (typeof renderFeaturedGrid === 'function') renderFeaturedGrid();

    } catch (e) {
        console.error('Batch result merge error:', e);
    }
}
</script>

</main><!-- /main-content -->

<!-- ============================================================
     RESEARCH CHAT WIDGET
     ============================================================ -->

<!-- FAB Button -->
<button class="chat-fab" id="chatFab" title="Ask the research analyst" aria-label="Open research chat" aria-expanded="false" aria-controls="chatPanel">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
    </svg>
    Analyst
</button>

<!-- Chat Panel -->
<div class="chat-panel" id="chatPanel">
    <div class="chat-header">
        <div class="chat-header-left">
            <div class="chat-header-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
            </div>
            <div>
                <div class="chat-header-title">Research Chat</div>
                <div class="chat-header-subtitle" id="chatSubtitle">Ask about any covered stock</div>
            </div>
        </div>
        <button class="chat-close-btn" id="chatClose" aria-label="Close chat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
    </div>

    <div class="chat-ticker-bar">
        <label for="chatTickerSelect" class="chat-ticker-label">Stock:</label>
        <select class="chat-ticker-select" id="chatTickerSelect" aria-label="Select stock for chat"></select>
    </div>

    <div class="chat-messages" id="chatMessages" aria-live="polite" aria-relevant="additions">
        <!-- Welcome state rendered by JS -->
    </div>

    <div class="chat-input-area">
        <label for="chatInput" class="sr-only">Ask a question about this stock</label>
        <textarea class="chat-input" id="chatInput" placeholder="Ask about this stock..." rows="1" aria-label="Ask a question about this stock"></textarea>
        <button class="chat-send-btn" id="chatSend" disabled aria-label="Send message">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </svg>
        </button>
    </div>
</div>

<script>
/* ============================================================
   RESEARCH CHAT  --  Controller
   ============================================================ */
(function() {
    'use strict';

    // --- Configuration ---
    // API base: auto-detect localhost for dev, Railway API for GitHub Pages, same origin for Railway
    var PRODUCTION_API = 'https://imaginative-vision-production-16cb.up.railway.app';
    var isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    var isFile  = window.location.protocol === 'file:';
    var isGitHubPages = window.location.hostname.indexOf('github.io') !== -1;
    var apiOrigin = window.CHAT_API_URL
        || (isLocal ? 'http://localhost:8000'
            : isFile ? '' // will trigger graceful error below
            : isGitHubPages ? PRODUCTION_API
            : window.location.origin);
    var CHAT_API_BASE = apiOrigin + '/api/research-chat';

    // --- DOM refs ---
    var fab       = document.getElementById('chatFab');
    var panel     = document.getElementById('chatPanel');
    var closeBtn  = document.getElementById('chatClose');
    var messages  = document.getElementById('chatMessages');
    var input     = document.getElementById('chatInput');
    var sendBtn   = document.getElementById('chatSend');
    var select    = document.getElementById('chatTickerSelect');
    var subtitle  = document.getElementById('chatSubtitle');

    // --- State ---
    var isOpen          = false;
    var isLoading       = false;
    var conversations   = {};   // { ticker: [ {role, content}, ... ] }
    var currentTicker   = '';

    // --- Populate ticker dropdown ---
    function populateTickerSelect() {
        var tickers = Object.keys(STOCK_DATA).sort();
        select.innerHTML = '';
        tickers.forEach(function(t) {
            var opt = document.createElement('option');
            opt.value = t;
            opt.textContent = t + '  --  ' + STOCK_DATA[t].company;
            select.appendChild(opt);
        });
        // Try to detect current ticker from route
        var hash = window.location.hash.slice(1) || '';
        var detected = '';
        if (hash.startsWith('report-')) detected = hash.replace('report-', '').toUpperCase();
        if (hash.startsWith('snapshot-')) detected = hash.replace('snapshot-', '').toUpperCase();
        if (detected && STOCK_DATA[detected]) {
            select.value = detected;
        }
        currentTicker = select.value;
    }

    // --- Suggestions per stock ---
    function getSuggestions(ticker) {
        return [
            'What is the bull case for ' + ticker + '?',
            'What are the key risks?',
            'Summarise the competing hypotheses',
            'What catalysts should I watch?'
        ];
    }

    // --- Render welcome state ---
    function renderWelcome() {
        var ticker = currentTicker;
        var company = STOCK_DATA[ticker] ? STOCK_DATA[ticker].company : ticker;
        var html =
            '<div class="chat-welcome">' +
                '<div class="chat-welcome-icon">' +
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">' +
                        '<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>' +
                    '</svg>' +
                '</div>' +
                '<div class="chat-welcome-title">Research Chat</div>' +
                '<div class="chat-welcome-text">Ask questions about <strong>' + company + '</strong> grounded in our structured research data.</div>' +
                '<div class="chat-suggestions">' +
                    getSuggestions(ticker).map(function(s) {
                        return '<button class="chat-suggestion-btn" data-q="' + s.replace(/"/g, '&quot;') + '">' + s + '</button>';
                    }).join('') +
                '</div>' +
            '</div>';
        messages.innerHTML = html;

        // Bind suggestion clicks
        messages.querySelectorAll('.chat-suggestion-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                input.value = btn.getAttribute('data-q');
                sendMessage();
            });
        });
    }

    // --- Render conversation ---
    function renderConversation() {
        var convo = conversations[currentTicker] || [];
        if (convo.length === 0) {
            renderWelcome();
            return;
        }

        var html = '';
        convo.forEach(function(msg) {
            if (msg.role === 'user') {
                html += '<div class="chat-msg user">' + escapeHtml(msg.content) + '</div>';
            } else {
                html += '<div class="chat-msg assistant">' + renderMarkdown(msg.content);
                if (msg.sources && msg.sources.length > 0) {
                    var id = 'src-' + Math.random().toString(36).substr(2, 6);
                    html += '<button class="chat-sources-toggle" data-target="' + id + '">' +
                        msg.sources.length + ' source' + (msg.sources.length === 1 ? '' : 's') + ' &#9662;</button>';
                    html += '<div class="chat-sources-list" id="' + id + '">';
                    msg.sources.forEach(function(s) {
                        html += '<div class="chat-source-item">' +
                            '<span class="cs-label">' + escapeHtml(s.section) + ' / ' + escapeHtml(s.subsection) + '</span>' +
                            escapeHtml(s.content) +
                        '</div>';
                    });
                    html += '</div>';
                }
                html += '</div>';
            }
        });
        messages.innerHTML = html;
        scrollToBottom();
        bindSourceToggles();
    }

    // --- Bind source toggle buttons ---
    function bindSourceToggles() {
        messages.querySelectorAll('.chat-sources-toggle').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var target = document.getElementById(btn.getAttribute('data-target'));
                if (target) target.classList.toggle('open');
            });
        });
    }

    // --- Simple markdown renderer ---
    function renderMarkdown(text) {
        // If marked + DOMPurify available, use them for richer rendering
        if (typeof marked !== 'undefined' && marked.parse && typeof DOMPurify !== 'undefined') {
            return DOMPurify.sanitize(marked.parse(text));
        }
        // Escape HTML first, then apply markdown
        var html = escapeHtml(text);
        // Bold
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        // Italic
        html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
        // Inline code
        html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
        // Headers (### and ####)
        html = html.replace(/^####\s+(.+)$/gm, '<h4>$1</h4>');
        html = html.replace(/^###\s+(.+)$/gm, '<h3>$1</h3>');
        // Unordered list items
        html = html.replace(/^[-*]\s+(.+)$/gm, '<li>$1</li>');
        // Wrap consecutive <li> in <ul>
        html = html.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
        // Paragraphs: split on double newline
        html = html.split(/\n{2,}/).map(function(block) {
            block = block.trim();
            if (!block) return '';
            // Don't wrap if already a block element
            if (/^<(ul|ol|h[1-6]|div|blockquote)/.test(block)) return block;
            return '<p>' + block.replace(/\n/g, '<br>') + '</p>';
        }).join('');
        return html;
    }

    function escapeHtml(str) {
        var d = document.createElement('div');
        d.textContent = str;
        return d.innerHTML;
    }

    // --- Typing indicator ---
    function showTyping() {
        var el = document.createElement('div');
        el.className = 'chat-typing';
        el.id = 'chatTypingIndicator';
        el.innerHTML = '<div class="chat-typing-dot"></div><div class="chat-typing-dot"></div><div class="chat-typing-dot"></div>';
        messages.appendChild(el);
        scrollToBottom();
    }
    function hideTyping() {
        var el = document.getElementById('chatTypingIndicator');
        if (el) el.remove();
    }

    // --- Scroll helpers ---
    function scrollToBottom() {
        messages.scrollTop = messages.scrollHeight;
    }

    // --- Send message ---
    function sendMessage() {
        var question = input.value.trim();
        if (!question || isLoading || !currentTicker) return;

        // Init conversation array for this ticker if needed
        if (!conversations[currentTicker]) {
            conversations[currentTicker] = [];
        }
        var convo = conversations[currentTicker];

        // Add user message
        convo.push({ role: 'user', content: question });
        input.value = '';
        input.style.height = 'auto';
        updateSendButton();
        renderConversation();
        showTyping();

        isLoading = true;
        sendBtn.disabled = true;

        // Build conversation history (exclude current message)
        var history = convo.slice(0, -1).map(function(m) {
            return { role: m.role, content: m.content };
        });

        // Guard: file:// protocol cannot reach the API
        if (isFile) {
            hideTyping();
            var errorEl = document.createElement('div');
            errorEl.className = 'chat-error';
            errorEl.textContent = 'Chat requires the hosted version. Open the Railway / Render URL instead of a local file.';
            messages.appendChild(errorEl);
            scrollToBottom();
            isLoading = false;
            updateSendButton();
            return;
        }

        // API call
        fetch(CHAT_API_BASE, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                ticker: currentTicker,
                question: question,
                conversation_history: history
            })
        })
        .then(function(res) {
            if (!res.ok) {
                return res.text().then(function(body) {
                    var detail = '';
                    try {
                        var parsed = JSON.parse(body);
                        detail = parsed.detail || '';
                    } catch(e) { /* non-JSON response */ }

                    if (res.status === 502 && detail.indexOf('authentication_error') !== -1) {
                        throw new Error('API key error  --  the server\'s Anthropic key may be invalid. Check the ANTHROPIC_API_KEY environment variable.');
                    }
                    if (res.status === 502) {
                        throw new Error('The AI service returned an error. Please try again in a moment.');
                    }
                    throw new Error(detail || 'Request failed (' + res.status + ')');
                });
            }
            return res.json();
        })
        .then(function(data) {
            hideTyping();
            convo.push({
                role: 'assistant',
                content: data.response,
                sources: data.sources || []
            });
            renderConversation();
        })
        .catch(function(err) {
            hideTyping();
            var msg = err.message || 'Something went wrong. Please try again.';
            if (msg === 'Failed to fetch') {
                msg = 'Cannot reach the API. Check that the server is running and accessible.';
            }
            var errorEl = document.createElement('div');
            errorEl.className = 'chat-error';
            errorEl.textContent = msg;
            messages.appendChild(errorEl);
            scrollToBottom();
        })
        .finally(function() {
            isLoading = false;
            updateSendButton();
        });
    }

    // --- Auto-resize textarea ---
    function autoResize() {
        input.style.height = 'auto';
        input.style.height = Math.min(input.scrollHeight, 100) + 'px';
    }

    // --- Enable/disable send button ---
    function updateSendButton() {
        sendBtn.disabled = !input.value.trim() || isLoading;
    }

    // --- Open/Close ---
    function openChat() {
        populateTickerSelect();
        panel.classList.add('open');
        fab.classList.add('hidden');
        fab.setAttribute('aria-expanded', 'true');
        isOpen = true;
        renderConversation();
        input.focus();
        updateSubtitle();
    }
    function closeChat() {
        panel.classList.remove('open');
        fab.classList.remove('hidden');
        fab.setAttribute('aria-expanded', 'false');
        isOpen = false;
        fab.focus(); // Return focus to FAB on close
    }

    function updateSubtitle() {
        var company = STOCK_DATA[currentTicker] ? STOCK_DATA[currentTicker].company : currentTicker;
        subtitle.textContent = company;
    }

    // --- Event listeners ---
    fab.addEventListener('click', openChat);
    closeBtn.addEventListener('click', closeChat);

    input.addEventListener('input', function() {
        autoResize();
        updateSendButton();
    });
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    sendBtn.addEventListener('click', sendMessage);

    select.addEventListener('change', function() {
        currentTicker = select.value;
        renderConversation();
        updateSubtitle();
    });

    // Sync ticker when navigating to a report page
    window.addEventListener('hashchange', function() {
        if (!isOpen) return;
        var hash = window.location.hash.slice(1) || '';
        var detected = '';
        if (hash.startsWith('report-')) detected = hash.replace('report-', '').toUpperCase();
        if (hash.startsWith('snapshot-')) detected = hash.replace('snapshot-', '').toUpperCase();
        if (detected && STOCK_DATA[detected] && detected !== currentTicker) {
            select.value = detected;
            currentTicker = detected;
            renderConversation();
            updateSubtitle();
        }
    });

    // Close on Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && isOpen) closeChat();
    });
})();
</script>

<!-- Chart.js for narrative timeline visualisation -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js" crossorigin="anonymous"></script>

<!-- Markdown parser for chat responses -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
<!-- DOMPurify for sanitizing Markdown-to-HTML output -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

<!-- Inline Research Chat (within report pages) -->
<script>
(function() {
  var PRODUCTION_API = 'https://imaginative-vision-production-16cb.up.railway.app';
  var isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
  var isGitHubPages = window.location.hostname.indexOf('github.io') !== -1;
  var apiOrigin = window.CHAT_API_URL
    || (isLocal ? 'http://localhost:8000'
        : isGitHubPages ? PRODUCTION_API
        : window.location.origin);
  var API_BASE = apiOrigin + '/api/research-chat';

  var inlineConversations = {};
  var inlineLoading = {};

  function escHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function renderMd(text) {
    if (typeof marked !== 'undefined' && marked.parse) {
      var raw = marked.parse(text);
      // Sanitize to prevent XSS from AI responses or compromised backend
      if (typeof DOMPurify !== 'undefined') return DOMPurify.sanitize(raw);
      return raw;
    }
    // Fallback if marked.js hasn't loaded
    return escHtml(text).replace(/\n/g, '<br>');
  }

  function getSuggestions(ticker) {
    return [
      'What is the bull case for ' + ticker + '?',
      'What are the key risks?',
      'Summarise the competing hypotheses',
      'What catalysts should I watch?'
    ];
  }

  function renderInlineMessages(ticker) {
    var el = document.getElementById('chat-inline-' + ticker);
    if (!el) return;
    var convo = inlineConversations[ticker] || [];
    if (convo.length === 0) {
      var company = STOCK_DATA[ticker] ? STOCK_DATA[ticker].company : ticker;
      var sugs = getSuggestions(ticker);
      el.innerHTML =
        '<div class="chat-inline-welcome">' +
          '<p>Ask questions about <strong>' + company + '</strong> grounded in structured research data.</p>' +
          '<div class="chat-inline-suggestions">' +
            sugs.map(function(s) {
              return '<button class="chat-inline-suggestion" data-q="' + s.replace(/"/g, '&quot;') + '">' + s + '</button>';
            }).join('') +
          '</div>' +
        '</div>';
      return;
    }
    var html = '';
    convo.forEach(function(msg) {
      if (msg.role === 'user') {
        html += '<div class="chat-msg user">' + escHtml(msg.content) + '</div>';
      } else {
        html += '<div class="chat-msg assistant">' + renderMd(msg.content) + '</div>';
      }
    });
    el.innerHTML = html;
    el.scrollTop = el.scrollHeight;
  }

  function sendInlineMessage(ticker, question) {
    if (!question || inlineLoading[ticker]) return;
    if (!inlineConversations[ticker]) inlineConversations[ticker] = [];
    var convo = inlineConversations[ticker];
    convo.push({ role: 'user', content: question });
    renderInlineMessages(ticker);
    inlineLoading[ticker] = true;

    // Show typing indicator
    var el = document.getElementById('chat-inline-' + ticker);
    if (el) {
      var typing = document.createElement('div');
      typing.className = 'chat-typing';
      typing.id = 'inline-typing-' + ticker;
      typing.innerHTML = '<div class="chat-typing-dot"></div><div class="chat-typing-dot"></div><div class="chat-typing-dot"></div>';
      el.appendChild(typing);
      el.scrollTop = el.scrollHeight;
    }

    // Disable send button
    var container = document.querySelector('.chat-inline[data-ticker="' + ticker + '"]');
    var sendBtn = container ? container.querySelector('.chat-inline-send') : null;
    if (sendBtn) sendBtn.disabled = true;

    var history = convo.slice(0, -1).map(function(m) {
      return { role: m.role, content: m.content };
    });

    var systemPrompt = 'You are a senior equity research analyst at Continuum Intelligence. You speak in the first person plural ("we", "our analysis", "our framework"). You are direct, precise, and opinionated  --  like a fund manager talking to another fund manager. ' +
      'VOICE RULES: ' +
      'Never use markdown headers (## or ###). Write in flowing paragraphs. ' +
      'Never use bullet point dashes or asterisks for lists. Weave points into natural sentences. ' +
      'Never begin a response with "Based on" or "Here is" or "Sure" or "Great question". ' +
      'Never say "I"  --  always "we" or speak in the declarative. ' +
      'When presenting numbers, weave them into sentences: "At 25x forward earnings on consensus EPS of $1.34, you get to $33.40  --  roughly 5% above the current print" NOT "Forward EPS: A$1.336, multiplied by 25 = A$33.40". ' +
      'Reference specific evidence items and hypothesis labels naturally: "The N2 erosion thesis is gaining weight here  --  margins are the tell." ' +
      'Be opinionated. Take positions. "We think the market is wrong about X" is better than "There are arguments on both sides." ' +
      'Use the vocabulary of an institutional investor: "the print", "the tape", "the multiple", "re-rate", "de-rate", "the street", "consensus", "buy-side", "the name".';

    fetch(API_BASE, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ticker: ticker, question: question, conversation_history: history, system_prompt: systemPrompt })
    })
    .then(function(res) {
      if (!res.ok) throw new Error('Request failed (' + res.status + ')');
      return res.json();
    })
    .then(function(data) {
      var t = document.getElementById('inline-typing-' + ticker);
      if (t) t.remove();
      convo.push({ role: 'assistant', content: data.response });
      renderInlineMessages(ticker);
    })
    .catch(function(err) {
      var t = document.getElementById('inline-typing-' + ticker);
      if (t) t.remove();
      if (el) {
        var errEl = document.createElement('div');
        errEl.className = 'chat-error';
        errEl.textContent = err.message || 'Something went wrong.';
        el.appendChild(errEl);
        el.scrollTop = el.scrollHeight;
      }
    })
    .finally(function() {
      inlineLoading[ticker] = false;
      if (sendBtn) {
        var inp = container ? container.querySelector('.chat-inline-input') : null;
        sendBtn.disabled = !(inp && inp.value.trim());
      }
    });
  }

  // Event delegation for inline chat
  document.addEventListener('click', function(e) {
    // Suggestion button click
    var sugBtn = e.target.closest('.chat-inline-suggestion');
    if (sugBtn) {
      var container = sugBtn.closest('.chat-inline');
      if (container) {
        var ticker = container.getAttribute('data-ticker');
        var q = sugBtn.getAttribute('data-q');
        var inp = container.querySelector('.chat-inline-input');
        if (inp) inp.value = '';
        sendInlineMessage(ticker, q);
      }
      return;
    }

    // Send button click
    var sendBtn = e.target.closest('.chat-inline-send');
    if (sendBtn) {
      var container = sendBtn.closest('.chat-inline');
      if (container) {
        var ticker = container.getAttribute('data-ticker');
        var inp = container.querySelector('.chat-inline-input');
        if (inp && inp.value.trim()) {
          sendInlineMessage(ticker, inp.value.trim());
          inp.value = '';
          inp.style.height = 'auto';
          sendBtn.disabled = true;
        }
      }
      return;
    }
  });

  // Handle input and enter key via delegation
  document.addEventListener('input', function(e) {
    if (e.target.classList.contains('chat-inline-input')) {
      var container = e.target.closest('.chat-inline');
      if (container) {
        var sendBtn = container.querySelector('.chat-inline-send');
        if (sendBtn) sendBtn.disabled = !e.target.value.trim();
        e.target.style.height = 'auto';
        e.target.style.height = Math.min(e.target.scrollHeight, 100) + 'px';
      }
    }
  });

  document.addEventListener('keydown', function(e) {
    if (e.target.classList.contains('chat-inline-input') && e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      var container = e.target.closest('.chat-inline');
      if (container) {
        var ticker = container.getAttribute('data-ticker');
        if (e.target.value.trim()) {
          sendInlineMessage(ticker, e.target.value.trim());
          e.target.value = '';
          e.target.style.height = 'auto';
          var sendBtn = container.querySelector('.chat-inline-send');
          if (sendBtn) sendBtn.disabled = true;
        }
      }
    }
  });

  // Initialize welcome state for any already-rendered inline chats
  document.querySelectorAll('.chat-inline').forEach(function(container) {
    var ticker = container.getAttribute('data-ticker');
    if (ticker) renderInlineMessages(ticker);
  });

  // Expose for dynamic page renders
  window.initInlineChat = function(ticker) {
    renderInlineMessages(ticker);
  };
})();
</script>

<script>
// ============================================================
// PDF REPORT GENERATOR  --  window.open + window.print
// Reads directly from STOCK_DATA[ticker]. ALL inline styles.
// NO html2pdf  --  uses browser print-to-PDF (guaranteed content).
// ============================================================

function pdfEsc(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function stripHtml(str) {
  if (!str) return '';
  var tmp = document.createElement('div');
  tmp.innerHTML = str;
  return tmp.textContent || tmp.innerText || '';
}

function normaliseScoresForPDF(scores) {
  // Delegate to normaliseScores for consistent v3 floor/ceiling enforcement
  var items = scores.map(function(s) { return { score: String(parseFloat(s.score) || 0) }; });
  return normaliseScores(items);
}

function generatePDFReport(ticker, type) {
  var btn = event ? event.currentTarget : null;
  if (btn) btn.classList.add('generating');

  // Institutional reads live DOM; retail reads STOCK_DATA
  var reportHTML = '';
  if (type === 'institutional') {
    // DOM-based: captures NFI overlays, live weight divergences, contradicted badges
    reportHTML = buildInstitutionalHTML(ticker);
    if (!reportHTML) {
      alert('Report page not rendered for ' + ticker + '. Navigate to the report first.');
      if (btn) btn.classList.remove('generating');
      return;
    }
    console.log('[PDF] Institutional snapshot from live DOM for', ticker);
  } else {
    // Retail still reads from STOCK_DATA (simplified view, no NFI overlays)
    var stock = null;
    if (typeof STOCK_DATA !== 'undefined' && STOCK_DATA[ticker]) {
      stock = STOCK_DATA[ticker];
    }
    if (!stock || stock._indexOnly) {
      alert('Full research data not yet loaded for ' + ticker + '. Please wait for the report to finish loading, then try again.');
      if (btn) btn.classList.remove('generating');
      return;
    }
    console.log('[PDF] Retail briefing from STOCK_DATA for', ticker, '- company:', stock.company);
    reportHTML = buildRetailHTML(stock);
  }

  // Open in new window and trigger print dialog
  var win = window.open('', '_blank');
  if (!win) {
    alert('Pop-up blocked. Please allow pop-ups for this site.');
    if (btn) btn.classList.remove('generating');
    return;
  }
  win.document.write(reportHTML);
  win.document.close();
  if (btn) btn.classList.remove('generating');
  setTimeout(function() { win.print(); }, 800);
}

/**
 * buildInstitutionalHTML(ticker)
 *
 * Generates a self-contained HTML document for PDF rendering by extracting
 * content directly from the live rendered DOM, including all NFI overlay
 * modifications (weight breakdowns, contradicted badges, narrative shifts).
 *
 * This is a screen-to-print translation layer. The PDF is a snapshot of the
 * living research document at the moment the user clicks download.
 *
 * Architecture:
 *   - Reads from document.getElementById('page-report-' + ticker)
 *   - Extracts each numbered section by class/ID conventions
 *   - Preserves all NFI-injected content (market-responsive narrative, weight bars)
 *   - Renders to self-contained A4-optimised HTML for headless Chrome / Puppeteer
 *
 * Sections extracted (matching live page order):
 *   1. Verdict banner
 *   2. Section 01: Identity & Snapshot
 *   3. Section 02: Competing Hypotheses (with NFI weight overlays)
 *   4. Section 03: Dominant Narrative (with NFI market-responsive update)
 *   5. Section 04: Cross-Domain Evidence Synthesis (10 domains + matrix)
 *   6. Section 05: What Discriminates
 *   7. Section 06: What We're Watching (tripwires)
 *   8. Section 07: Evidence Gaps & Integrity Notes
 *   9. Section 08: Technical Structure (text only; charts excluded)
 *  10. Disclaimer / methodology
 */
function buildInstitutionalHTML(ticker) {
  if (typeof document === 'undefined') {
    console.error('[PDF] No DOM available. This function must run in the browser.');
    return '';
  }
  var reportPage = document.getElementById('page-report-' + ticker);
  if (!reportPage) {
    console.error('[PDF] No report page found for ticker: ' + ticker);
    return '';
  }
  var now = new Date();
  var timestamp = now.toLocaleString('en-AU', {
    timeZone: 'Australia/Sydney',
    year: 'numeric', month: 'long', day: 'numeric',
    hour: '2-digit', minute: '2-digit', second: '2-digit'
  });
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  // UTILITIES
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  function esc(s) {
    if (s == null) return '';
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }
  /** Extract text from an element, cleaning whitespace */
  function txt(el) {
    if (!el) return '';
    return el.textContent.replace(/\s+/g, ' ').trim();
  }
  /** Find a section by its ID (e.g., 'wow-identity') */
  function getSection(suffix) {
    return reportPage.querySelector('#' + ticker.toLowerCase() + '-' + suffix);
  }
  /** Extract all elements matching a selector within a parent */
  function getAll(parent, selector) {
    if (!parent) return [];
    return Array.from(parent.querySelectorAll(selector));
  }
  /** Extract table as array of row arrays */
  function extractTable(tableEl) {
    if (!tableEl) return { headers: [], rows: [] };
    var headers = [];
    var headerCells = tableEl.querySelectorAll('thead th');
    for (var h = 0; h < headerCells.length; h++) headers.push(txt(headerCells[h]));
    var rows = [];
    var bodyRows = tableEl.querySelectorAll('tbody tr');
    for (var r = 0; r < bodyRows.length; r++) {
      var cells = bodyRows[r].querySelectorAll('td, th');
      var row = [];
      for (var c = 0; c < cells.length; c++) row.push(txt(cells[c]));
      if (row.length) rows.push(row);
    }
    return { headers: headers, rows: rows };
  }
  /** Build an HTML table from headers and rows */
  function buildTable(headers, rows, compact) {
    if (!rows.length && !headers.length) return '';
    var cls = compact ? 'data-table compact' : 'data-table';
    var html = '<table class="' + cls + '">';
    if (headers.length) {
      html += '<thead><tr>';
      for (var h = 0; h < headers.length; h++) {
        html += '<th>' + esc(headers[h]) + '</th>';
      }
      html += '</tr></thead>';
    }
    html += '<tbody>';
    for (var r = 0; r < rows.length; r++) {
      html += '<tr>';
      for (var c = 0; c < rows[r].length; c++) {
        html += '<td>' + esc(rows[r][c]) + '</td>';
      }
      html += '</tr>';
    }
    html += '</tbody></table>';
    return html;
  }
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  // PAGE CHROME
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  function pageHeader(sectionLabel) {
    return '<div class="pdf-header">' +
      '<div class="pdf-brand-block">' +
        '<div class="pdf-brand">CONTINUUM INTELLIGENCE</div>' +
        '<div class="pdf-tag">INDEPENDENT CROSS-DOMAIN EQUITY RESEARCH</div>' +
      '</div>' +
      '<div class="pdf-head-right">' +
        '<span>' + esc(ticker) + '</span>' +
        '<span class="sep">&bull;</span>' +
        '<span>' + esc(sectionLabel) + '</span>' +
        '<span class="sep">&bull;</span>' +
        '<span>' + esc(timestamp) + '</span>' +
      '</div>' +
    '</div>';
  }
  function pageBreak() {
    return '<div class="page-break"></div>';
  }
  function forcedPageBreak() {
    return '<div class="page-break-forced"></div>';
  }
  function sectionTitle(number, title) {
    return '<div class="sec-header">' +
      '<span class="sec-num">Section ' + esc(number) + '</span>' +
      '<span class="sec-title">' + esc(title) + '</span>' +
    '</div>';
  }
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  // EXTRACT: VERDICT BANNER
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  var verdictEl = reportPage.querySelector('.verdict-section');
  var verdictHtml = '';
  if (verdictEl) {
    var verdictTextEl = verdictEl.querySelector('.verdict-text');
    var verdictScoresEl = verdictEl.querySelector('.verdict-scores');
    var vText = verdictTextEl ? txt(verdictTextEl) : txt(verdictEl);
    var vScores = '';
    if (verdictScoresEl) {
      var vsItems = getAll(verdictScoresEl, '.vs-item');
      for (var vi = 0; vi < vsItems.length; vi++) {
        var vsLabel = vsItems[vi].querySelector('.vs-label');
        var vsScore = vsItems[vi].querySelector('.vs-score');
        var vsDir = vsItems[vi].querySelector('.vs-direction');
        vScores += '<span class="pdf-vs-item">' +
          '<span class="pdf-vs-label">' + esc(txt(vsLabel)) + '</span>' +
          '<span class="pdf-vs-score">' + esc(txt(vsScore)) + '</span>' +
          (vsDir ? '<span class="pdf-vs-dir">' + esc(txt(vsDir)) + '</span>' : '') +
        '</span>';
      }
    }
    verdictHtml = '<div class="pdf-verdict">' +
      '<div class="pdf-verdict-text">' + esc(vText) + '</div>' +
      (vScores ? '<div class="pdf-verdict-scores">' + vScores + '</div>' : '') +
    '</div>';
  }
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  // EXTRACT: DISLOCATION ALERT (NFI)
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  var alertEl = reportPage.querySelector('.nfi-alert-banner');
  var alertHtml = '';
  if (alertEl) {
    var alertInner = alertEl.querySelector('.nfi-alert-inner');
    alertHtml = '<div class="pdf-alert">' + esc(txt(alertInner || alertEl)) + '</div>';
  }
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  // EXTRACT: SECTION 01 - IDENTITY & SNAPSHOT
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  var identitySection = getSection('identity');
  var identityHtml = '';
  if (identitySection) {
    // Business overview paragraph
    var overviewP = identitySection.querySelector('.rs-text');
    var overview = overviewP ? txt(overviewP) : '';
    // Metrics table (the identity-table with key-value pairs)
    var metricsTable = identitySection.querySelector('.identity-table');
    var metricsData = extractTable(metricsTable);
    identityHtml = sectionTitle('01', 'Identity & Snapshot') +
      buildTable(metricsData.headers, metricsData.rows, true) +
      (overview ? '<p class="body-text">' + esc(overview) + '</p>' : '');
  }
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  // EXTRACT: SECTION 02 - COMPETING HYPOTHESES
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  var hypSection = getSection('hypotheses');
  var hypHtml = '';
  if (hypSection) {
    var cards = getAll(hypSection, '.hyp-card');
    var cardsHtml = '';
    for (var hi = 0; hi < cards.length; hi++) {
      var card = cards[hi];
      var titleEl = card.querySelector('.hc-title');
      var scoreEl = card.querySelector('.hc-score-number');
      var scoreMetaEl = card.querySelector('.hc-score-meta');
      var statusEl = card.querySelector('.hc-status');
      var descEl = card.querySelector('.hc-desc');
      var dirClass = card.className.indexOf('dir-up') !== -1 ? 'hyp-up' :
                     card.className.indexOf('dir-down') !== -1 ? 'hyp-down' : 'hyp-flat';
      // NFI weight breakdown (if present)
      var nfiWeights = card.querySelector('.nfi-hyp-weights');
      var nfiHtml = '';
      if (nfiWeights) {
        var hwRows = getAll(nfiWeights, '.nfi-hw-row');
        var gapEl = nfiWeights.querySelector('.nfi-hw-gap');
        nfiHtml = '<div class="pdf-weights">';
        for (var w = 0; w < hwRows.length; w++) {
          var label = hwRows[w].querySelector('.nfi-hw-label');
          var value = hwRows[w].querySelector('.nfi-hw-value');
          var bar = hwRows[w].querySelector('.nfi-hw-bar');
          var barWidth = bar ? bar.style.width : '0%';
          var barClass = '';
          if (bar) {
            if (bar.className.indexOf('bar-lt') !== -1) barClass = 'bar-research';
            else if (bar.className.indexOf('bar-st') !== -1) barClass = 'bar-market';
            else if (bar.className.indexOf('bar-blend') !== -1) barClass = 'bar-blended';
          }
          nfiHtml += '<div class="pdf-weight-row">' +
            '<span class="wt-label">' + esc(txt(label)) + '</span>' +
            '<div class="wt-bar-bg"><div class="wt-bar ' + barClass + '" style="width:' + barWidth + '"></div></div>' +
            '<span class="wt-value">' + esc(txt(value)) + '</span>' +
          '</div>';
        }
        if (gapEl) {
          var gapClass = gapEl.className.indexOf('gap-high') !== -1 ? 'gap-high' :
                         gapEl.className.indexOf('gap-medium') !== -1 ? 'gap-medium' : '';
          nfiHtml += '<div class="pdf-gap ' + gapClass + '">' + esc(txt(gapEl)) + '</div>';
        }
        nfiHtml += '</div>';
      }
      // Contradicted badge check
      var contradicted = card.querySelector('.nfi-contradicted-badge');
      var contradictedHtml = contradicted ? ' <span class="pdf-contradicted">CONTRADICTED</span>' : '';
      // Supporting / Contradicting evidence lists
      var listsHtml = '';
      var hcLists = getAll(card, '.hc-list');
      for (var li = 0; li < hcLists.length; li++) {
        var listLabel = hcLists[li].previousElementSibling;
        if (listLabel && listLabel.classList.contains('hc-subtitle')) {
          listsHtml += '<div class="pdf-hyp-list-label">' + esc(txt(listLabel)) + '</div>';
        }
        var listItems = getAll(hcLists[li], 'li');
        listsHtml += '<ul class="pdf-hyp-list">';
        for (var lj = 0; lj < listItems.length; lj++) {
          listsHtml += '<li>' + esc(txt(listItems[lj])) + '</li>';
        }
        listsHtml += '</ul>';
      }
      cardsHtml += '<div class="pdf-hyp-card ' + dirClass + '">' +
        '<div class="pdf-hyp-header">' +
          '<div class="pdf-hyp-title">' + esc(txt(titleEl)) + contradictedHtml + '</div>' +
          '<div class="pdf-hyp-score">' + esc(txt(scoreEl)) +
            (statusEl ? ' <span class="pdf-hyp-status">' + esc(txt(statusEl)) + '</span>' : '') +
          '</div>' +
        '</div>' +
        (scoreMetaEl ? '<div class="pdf-hyp-meta">' + esc(txt(scoreMetaEl)) + '</div>' : '') +
        nfiHtml +
        '<div class="pdf-hyp-body">' + esc(txt(descEl)) + '</div>' +
        listsHtml +
      '</div>';
    }
    hypHtml = sectionTitle('02', 'Competing Hypotheses') + cardsHtml;
  }
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  // EXTRACT: SECTION 03 - DOMINANT NARRATIVE (including NFI overlay)
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  var narrativeSection = getSection('narrative');
  var narrativeHtml = '';
  if (narrativeSection) {
    // NFI Market-Responsive Narrative Update (if present)
    var nfiNarrative = narrativeSection.querySelector('.nfi-market-narrative');
    var nfiNarrHtml = '';
    if (nfiNarrative) {
      var nfiHeader = nfiNarrative.querySelector('.nfi-mn-header');
      var nfiSections = getAll(nfiNarrative, '.nfi-mn-section');
      nfiNarrHtml = '<div class="pdf-nfi-narrative">' +
        '<div class="pdf-nfi-header">' + esc(txt(nfiHeader)) + '</div>';
      for (var ns = 0; ns < nfiSections.length; ns++) {
        var nsLabel = nfiSections[ns].querySelector('.nfi-mn-label');
        var nsText = nfiSections[ns].querySelector('.nfi-mn-text');
        nfiNarrHtml += '<div class="pdf-nfi-section">' +
          (nsLabel ? '<div class="pdf-nfi-label">' + esc(txt(nsLabel)) + '</div>' : '') +
          (nsText ? '<div class="pdf-nfi-text">' + esc(txt(nsText)) + '</div>' : '') +
        '</div>';
      }
      nfiNarrHtml += '</div>';
    }
    // Standard narrative sub-sections
    var subtitles = getAll(narrativeSection, '.rs-subtitle');
    var standardNarr = '';
    for (var si = 0; si < subtitles.length; si++) {
      standardNarr += '<div class="pdf-narr-sub">' + esc(txt(subtitles[si])) + '</div>';
      var nextSibling = subtitles[si].nextElementSibling;
      while (nextSibling && !nextSibling.classList.contains('rs-subtitle')) {
        if (nextSibling.classList.contains('rs-text') || nextSibling.tagName === 'P') {
          standardNarr += '<p class="body-text">' + esc(txt(nextSibling)) + '</p>';
        }
        nextSibling = nextSibling.nextElementSibling;
      }
    }
    narrativeHtml = sectionTitle('03', 'Dominant Narrative') +
      nfiNarrHtml + standardNarr;
  }
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  // EXTRACT: SECTION 04 - EVIDENCE SYNTHESIS
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  var evidenceSection = getSection('evidence');
  var evidenceHtml = '';
  if (evidenceSection) {
    // Intro text
    var evIntro = evidenceSection.querySelector('.rs-text');
    var evIntroHtml = evIntro ? '<p class="body-text italic">' + esc(txt(evIntro)) + '</p>' : '';
    // Evidence cards (10 domains)  --  extract structured content from each card
    var evCards = getAll(evidenceSection, '.evidence-card');
    var evCardsHtml = '';
    for (var ei = 0; ei < evCards.length; ei++) {
      var evCard = evCards[ei];
      var ecTitle = evCard.querySelector('.ec-title');
      var ecEpistemic = evCard.querySelector('.ec-epistemic');
      var ecFinding = evCard.querySelector('.ec-finding');
      var ecSource = evCard.querySelector('.ec-source');
      var ecTags = getAll(evCard, '.ec-tag');
      var tagsStr = '';
      for (var eti = 0; eti < ecTags.length; eti++) {
        tagsStr += '<span class="pdf-ec-tag">' + esc(txt(ecTags[eti])) + '</span>';
      }
      evCardsHtml += '<div class="pdf-ev-card">' +
        '<div class="pdf-ev-header">' +
          '<span class="pdf-ev-title">' + esc(txt(ecTitle)) + '</span>' +
          (ecEpistemic ? '<span class="pdf-ev-epistemic">' + esc(txt(ecEpistemic)) + '</span>' : '') +
        '</div>' +
        (ecFinding ? '<div class="pdf-ev-finding">' + esc(txt(ecFinding)) + '</div>' : '') +
        '<div class="pdf-ev-footer">' +
          (tagsStr ? '<div class="pdf-ev-tags">' + tagsStr + '</div>' : '') +
          (ecSource ? '<div class="pdf-ev-source">' + esc(txt(ecSource)) + '</div>' : '') +
        '</div>' +
      '</div>';
    }
    // Evidence alignment table/matrix
    var evTable = evidenceSection.querySelector('.evidence-table');
    var evTableData = extractTable(evTable);
    var evTableHtml = buildTable(evTableData.headers, evTableData.rows, true);
    var alignSubtitle = '';
    var subs = getAll(evidenceSection, '.rs-subtitle');
    for (var es = 0; es < subs.length; es++) {
      if (txt(subs[es]).indexOf('Alignment') !== -1) {
        alignSubtitle = '<div class="pdf-sub-heading">' + esc(txt(subs[es])) + '</div>';
      }
    }
    evidenceHtml = sectionTitle('04', 'Cross-Domain Evidence Synthesis') +
      evIntroHtml + evCardsHtml + alignSubtitle + evTableHtml;
  }
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  // EXTRACT: SECTION 05 - WHAT DISCRIMINATES
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  var discSection = getSection('discriminates');
  var discHtml = '';
  if (discSection) {
    var discIntro = discSection.querySelector('.rs-text');
    var discTable = discSection.querySelector('.disc-table');
    var discContent = '';
    if (discTable) {
      var dt = extractTable(discTable);
      discContent += buildTable(dt.headers, dt.rows, true);
    }
    // Non-discriminating callout
    var discCallout = discSection.querySelector('.callout');
    if (discCallout) {
      discContent += '<div class="pdf-callout">' + esc(txt(discCallout)) + '</div>';
    }
    discHtml = sectionTitle('05', 'What Discriminates') +
      (discIntro ? '<p class="body-text">' + esc(txt(discIntro)) + '</p>' : '') +
      discContent;
  }
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  // EXTRACT: SECTION 06 - TRIPWIRES
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  var tripSection = getSection('tripwires');
  var tripHtml = '';
  if (tripSection) {
    var tripIntro = tripSection.querySelector('.rs-text');
    var tripCards = getAll(tripSection, '.tw-card');
    var tripContent = '';
    for (var tc = 0; tc < tripCards.length; tc++) {
      var twCard = tripCards[tc];
      var twDate = twCard.querySelector('.tw-date');
      var twName = twCard.querySelector('.tw-name');
      var twSource = twCard.querySelector('.tw-source');
      var twConds = getAll(twCard, '.tw-condition');
      var condsHtml = '';
      for (var tci = 0; tci < twConds.length; tci++) {
        var condIf = twConds[tci].querySelector('.tw-cond-if');
        var condThen = twConds[tci].querySelector('.tw-cond-then');
        var valClass = condIf && condIf.classList.contains('positive') ? 'cond-pos' : 'cond-neg';
        condsHtml += '<div class="pdf-tw-cond">' +
          '<span class="pdf-tw-if ' + valClass + '">' + esc(txt(condIf)) + '</span>' +
          '<span class="pdf-tw-then">' + esc(txt(condThen)) + '</span>' +
        '</div>';
      }
      tripContent += '<div class="pdf-trip-card">' +
        '<div class="pdf-trip-header">' +
          (twDate ? '<span class="pdf-trip-date">' + esc(txt(twDate)) + '</span>' : '') +
          (twName ? '<span class="pdf-trip-name">' + esc(txt(twName)) + '</span>' : '') +
        '</div>' +
        condsHtml +
        (twSource ? '<div class="pdf-trip-source">' + esc(txt(twSource)) + '</div>' : '') +
      '</div>';
    }
    tripHtml = sectionTitle('06', 'What We\'re Watching') +
      (tripIntro ? '<p class="body-text">' + esc(txt(tripIntro)) + '</p>' : '') +
      tripContent;
  }
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  // EXTRACT: SECTION 07 - EVIDENCE GAPS
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  var gapsSection = getSection('gaps');
  var gapsHtml = '';
  if (gapsSection) {
    var gapsContent = '';
    // Coverage table
    var gapsTable = gapsSection.querySelector('.gaps-table');
    if (gapsTable) {
      var gtData = extractTable(gapsTable);
      gapsContent += '<div class="pdf-sub-heading">Domain Coverage Assessment</div>' +
        buildTable(gtData.headers, gtData.rows, true);
    }
    // Couldn't assess callouts
    var gapsCallouts = getAll(gapsSection, '.callout');
    if (gapsCallouts.length) {
      gapsContent += '<div class="pdf-sub-heading">What We Couldn\'t Assess</div>';
      for (var gi = 0; gi < gapsCallouts.length; gi++) {
        gapsContent += '<div class="pdf-callout">' + esc(txt(gapsCallouts[gi])) + '</div>';
      }
    }
    // Analytical limitations
    var gapsSubs = getAll(gapsSection, '.rs-subtitle');
    for (var gsi = 0; gsi < gapsSubs.length; gsi++) {
      if (txt(gapsSubs[gsi]).indexOf('Analytical') !== -1) {
        var limNext = gapsSubs[gsi].nextElementSibling;
        if (limNext) {
          gapsContent += '<div class="pdf-sub-heading">' + esc(txt(gapsSubs[gsi])) + '</div>' +
            '<p class="body-text">' + esc(txt(limNext)) + '</p>';
        }
      }
    }
    gapsHtml = sectionTitle('07', 'Evidence Gaps & Integrity Notes') + gapsContent;
  }
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  // EXTRACT: SECTION 08 - TECHNICAL STRUCTURE (text only)
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  var techSection = getSection('technical');
  var techHtml = '';
  if (techSection) {
    var techSubs = getAll(techSection, '.rs-subtitle');
    var techContent = '';
    for (var tsi = 0; tsi < techSubs.length; tsi++) {
      techContent += '<div class="pdf-sub-heading">' + esc(txt(techSubs[tsi])) + '</div>';
      var nextTech = techSubs[tsi].nextElementSibling;
      while (nextTech && !nextTech.classList.contains('rs-subtitle')) {
        if (nextTech.tagName === 'TABLE') {
          var techTable = extractTable(nextTech);
          techContent += buildTable(techTable.headers, techTable.rows, true);
        } else {
          var techText = txt(nextTech);
          if (techText.length > 5) {
            techContent += '<p class="body-text">' + esc(techText) + '</p>';
          }
        }
        nextTech = nextTech.nextElementSibling;
      }
    }
    // If no subtitles, extract text from ta-text-content area
    if (!techSubs.length) {
      var taTextContent = techSection.querySelector('.ta-text-content');
      if (taTextContent) {
        var taParas = getAll(taTextContent, 'p, .rs-text, .ta-row');
        for (var tap = 0; tap < taParas.length; tap++) {
          var pText = txt(taParas[tap]);
          if (pText.length > 5) techContent += '<p class="body-text">' + esc(pText) + '</p>';
        }
      }
    }
    techHtml = sectionTitle('08', 'Technical Structure') +
      '<p class="body-text italic">Note: Price charts are excluded from the PDF. Refer to the live research page for interactive technical analysis.</p>' +
      techContent;
  }
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  // DISCLAIMER
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  var footerEl = reportPage.querySelector('.report-footer-section');
  var disclaimerText = footerEl ? txt(footerEl) : 'This report does not constitute personal financial advice.';
  var disclaimerHtml = '<div class="pdf-disclaimer">' +
    '<div class="pdf-disc-title">Methodology & Disclaimer</div>' +
    '<p>This report employs the Analysis of Competing Hypotheses (ACH) framework, a structured analytical ' +
      'technique originally developed for intelligence analysis. Rather than seeking evidence to confirm a ' +
      'preferred thesis, ACH systematically evaluates all available evidence against multiple competing ' +
      'explanations, weighting by diagnosticity rather than volume.</p>' +
    '<p>Market-responsive overlays are generated by the Narrative Framework Integration engine, which ' +
      'compares long-term research thesis weights against short-term market-implied weights derived from ' +
      'price action, volume, and drawdown analysis. Divergences are flagged when market positioning ' +
      'contradicts or significantly departs from the research assessment.</p>' +
    '<p>' + esc(disclaimerText) + '</p>' +
    '<p class="pdf-timestamp">Snapshot generated: ' + esc(timestamp) + ' AEST</p>' +
  '</div>';
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  // COMPANY NAME EXTRACTION
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  var companyName = '';
  var heroTitle = reportPage.querySelector('.rh-ticker');
  if (heroTitle) companyName = txt(heroTitle);
  if (!companyName) {
    // Fallback: check download section subtitle
    var dlSection = reportPage.querySelector('.report-download-subtitle');
    if (dlSection) {
      var dlText = txt(dlSection);
      var match = dlText.match(/^([^(]+)\s*\(/);
      if (match) companyName = match[1].trim();
    }
  }
  if (!companyName && typeof STOCK_DATA !== 'undefined' && STOCK_DATA[ticker]) {
    companyName = STOCK_DATA[ticker].company;
  }
  if (!companyName) companyName = ticker;
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  // CSS
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  var css = [
    '*{margin:0;padding:0;box-sizing:border-box;}',
    'body{font-family:Inter,"Segoe UI",Arial,Helvetica,sans-serif;color:#1A1F2E;' +
      'line-height:1.38;max-width:890px;margin:0 auto;padding:22px 26px;background:#FFF;font-size:8.5pt;}',
    /* Page breaks  --  soft breaks allow content to flow naturally; only .page-break-forced creates a new page */
    '.page-break{page-break-before:auto;height:0;margin:0;padding:0;}',
    '.page-break-forced{page-break-before:always;height:0;margin:0;padding:0;}',
    /* Header */
    '.pdf-header{display:flex;justify-content:space-between;align-items:flex-end;' +
      'border-bottom:2px solid #0F2E57;margin-bottom:12px;padding-bottom:6px;}',
    '.pdf-brand{font-size:9pt;font-weight:800;letter-spacing:2.2px;color:#0F2E57;}',
    '.pdf-tag{font-size:6.5pt;color:#52607A;letter-spacing:0.8px;margin-top:1px;}',
    '.pdf-head-right{font-size:7pt;color:#64748B;display:flex;gap:6px;align-items:baseline;}',
    '.pdf-head-right .sep{color:#CBD5E1;}',
    /* Cover title */
    '.pdf-cover-title{font-size:22pt;font-weight:800;color:#102A43;margin:4px 0 2px 0;line-height:1.1;}',
    '.pdf-cover-sub{font-size:9pt;color:#44536A;margin-bottom:12px;}',
    /* Section headers */
    '.sec-header{margin:14px 0 8px 0;padding-bottom:4px;border-bottom:1.5px solid #E2E8F0;page-break-after:avoid;}',
    '.sec-num{font-size:7pt;font-weight:600;color:#94A3B8;letter-spacing:0.6px;text-transform:uppercase;margin-right:8px;}',
    '.sec-title{font-size:10pt;font-weight:800;color:#0F2E57;letter-spacing:0.3px;}',
    /* Body text */
    '.body-text{font-size:8.2pt;color:#334155;line-height:1.5;margin:4px 0 8px 0;}',
    '.italic{font-style:italic;}',
    /* Verdict */
    '.pdf-verdict{background:#F0F4FA;border-left:4px solid #1D4E89;padding:10px 14px;' +
      'font-size:8.5pt;color:#1E3A5F;line-height:1.5;margin-bottom:12px;}',
    '.pdf-verdict-text{margin-bottom:6px;}',
    '.pdf-verdict-scores{display:flex;gap:16px;flex-wrap:wrap;}',
    '.pdf-vs-item{display:inline-flex;gap:4px;align-items:baseline;font-size:7.5pt;}',
    '.pdf-vs-label{color:#64748B;}',
    '.pdf-vs-score{font-weight:800;color:#0F2E57;}',
    '.pdf-vs-dir{color:#64748B;font-size:7pt;}',
    /* Alert */
    '.pdf-alert{background:#FEF3C7;border-left:4px solid #D97706;padding:6px 12px;' +
      'font-size:7.5pt;color:#92400E;margin-bottom:10px;}',
    /* Data tables */
    '.data-table{width:100%;border-collapse:collapse;font-size:7.5pt;margin:4px 0 10px 0;}',
    '.data-table th{background:#EDF2F8;color:#334155;text-align:left;padding:4px 6px;' +
      'border:1px solid #D9E2EF;font-size:6.8pt;text-transform:uppercase;letter-spacing:0.3px;font-weight:700;}',
    '.data-table td{padding:4px 6px;border:1px solid #E2E8F0;vertical-align:top;line-height:1.35;}',
    '.data-table tbody tr:nth-child(even){background:#FAFCFE;}',
    '.compact td,.compact th{padding:3px 5px;font-size:7pt;}',
    /* Sub-headings */
    '.pdf-sub-heading{font-size:8.5pt;font-weight:700;color:#1E3A5F;margin:10px 0 4px 0;}',
    /* Hypothesis cards */
    '.pdf-hyp-card{border:1px solid #DCE3EE;border-radius:4px;padding:10px 12px;' +
      'margin-bottom:8px;}',
    '.hyp-up{border-left:4px solid #0E9F6E;}',
    '.hyp-down{border-left:4px solid #B91C1C;}',
    '.hyp-flat{border-left:4px solid #D97706;}',
    '.pdf-hyp-header{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:4px;}',
    '.pdf-hyp-title{font-size:9pt;font-weight:800;color:#102A43;}',
    '.pdf-hyp-score{font-size:8.5pt;font-weight:700;color:#334155;}',
    '.pdf-hyp-status{font-size:6.5pt;color:#64748B;font-weight:400;margin-left:4px;}',
    '.pdf-hyp-meta{font-size:7pt;color:#94A3B8;margin-bottom:4px;}',
    '.pdf-hyp-body{font-size:7.8pt;color:#475569;line-height:1.45;}',
    '.pdf-hyp-list-label{font-size:7pt;font-weight:700;color:#64748B;text-transform:uppercase;letter-spacing:0.4px;margin:6px 0 2px 0;}',
    '.pdf-hyp-list{font-size:7.5pt;color:#475569;line-height:1.4;margin:0 0 4px 16px;padding:0;}',
    '.pdf-hyp-list li{margin-bottom:2px;}',
    '.pdf-contradicted{display:inline-block;background:#FEE2E2;color:#B91C1C;font-size:6.5pt;' +
      'font-weight:700;padding:1px 6px;border-radius:999px;margin-left:6px;vertical-align:middle;}',
    /* NFI Weight bars (inline in hyp cards) */
    '.pdf-weights{margin:6px 0;padding:6px 0;border-top:1px solid rgba(0,0,0,0.06);}',
    '.pdf-weight-row{display:flex;align-items:center;gap:6px;margin-bottom:3px;}',
    '.wt-label{font-size:6.5pt;color:#6B7280;width:50px;text-align:right;flex-shrink:0;}',
    '.wt-bar-bg{flex:1;height:8px;background:#F1F5F9;border-radius:4px;overflow:hidden;}',
    '.wt-bar{height:100%;border-radius:4px;transition:none;}',
    '.bar-research{background:#2563EB;}',
    '.bar-market{background:#D97706;}',
    '.bar-blended{background:#7C3AED;}',
    '.wt-value{font-size:6.5pt;font-weight:700;color:#334155;width:32px;flex-shrink:0;}',
    '.pdf-gap{font-size:6.5pt;color:#6B7280;margin-top:2px;}',
    '.gap-high{color:#B91C1C;font-weight:600;}',
    '.gap-medium{color:#D97706;font-weight:600;}',
    /* Narrative sub-sections */
    '.pdf-narr-sub{font-size:8.5pt;font-weight:700;color:#1E3A5F;margin:10px 0 3px 0;}',
    /* NFI Narrative section */
    '.pdf-nfi-narrative{background:#FFF7ED;border:1px solid #FED7AA;border-radius:4px;' +
      'padding:10px 12px;margin-bottom:12px;}',
    '.pdf-nfi-header{font-size:8pt;font-weight:800;color:#9A3412;margin-bottom:8px;' +
      'text-transform:uppercase;letter-spacing:0.5px;}',
    '.pdf-nfi-section{margin-bottom:8px;}',
    '.pdf-nfi-label{font-size:7pt;font-weight:700;color:#C2410C;text-transform:uppercase;' +
      'letter-spacing:0.4px;margin-bottom:2px;}',
    '.pdf-nfi-text{font-size:7.8pt;color:#431407;line-height:1.45;}',
    /* Evidence cards */
    '.pdf-ev-card{border:1px solid #E2E8F0;border-radius:4px;padding:8px 10px;' +
      'margin-bottom:6px;}',
    '.pdf-ev-header{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:4px;}',
    '.pdf-ev-title{font-size:8pt;font-weight:700;color:#102A43;}',
    '.pdf-ev-epistemic{font-size:6.5pt;color:#64748B;background:#F1F5F9;padding:1px 6px;border-radius:2px;}',
    '.pdf-ev-finding{font-size:7.5pt;color:#334155;line-height:1.4;margin-bottom:4px;}',
    '.pdf-ev-footer{display:flex;justify-content:space-between;align-items:center;}',
    '.pdf-ev-tags{display:flex;gap:4px;flex-wrap:wrap;}',
    '.pdf-ec-tag{font-size:6pt;color:#64748B;background:#F8FAFC;border:1px solid #E2E8F0;padding:1px 4px;border-radius:2px;}',
    '.pdf-ev-source{font-size:6.5pt;color:#94A3B8;text-align:right;}',
    /* Tripwire cards */
    '.pdf-trip-card{border:1px solid #DCE3EE;border-radius:4px;padding:8px 10px;' +
      'margin-bottom:6px;}',
    '.pdf-trip-header{display:flex;gap:8px;align-items:baseline;margin-bottom:4px;}',
    '.pdf-trip-date{font-size:7pt;color:#64748B;font-weight:600;}',
    '.pdf-trip-name{font-size:8pt;font-weight:700;color:#102A43;}',
    '.pdf-tw-cond{margin:2px 0;font-size:7.5pt;}',
    '.pdf-tw-if{font-weight:600;}',
    '.cond-pos{color:#0E9F6E;}',
    '.cond-neg{color:#B91C1C;}',
    '.pdf-tw-then{color:#475569;margin-left:4px;}',
    '.pdf-trip-source{font-size:6.5pt;color:#94A3B8;margin-top:3px;}',
    /* Callout boxes */
    '.pdf-callout{background:#F8FAFC;border:1px solid #E2E8F0;border-radius:3px;padding:6px 10px;' +
      'font-size:7.5pt;color:#475569;line-height:1.4;margin:4px 0 8px 0;}',
    /* Disclaimer */
    '.pdf-disclaimer{margin-top:16px;padding:12px;background:#F8FAFC;border:1px solid #DCE3EE;' +
      'font-size:7pt;color:#64748B;line-height:1.5;}',
    '.pdf-disc-title{font-size:8pt;font-weight:800;color:#0F2E57;text-transform:uppercase;' +
      'letter-spacing:0.5px;margin-bottom:6px;}',
    '.pdf-disclaimer p{margin:0 0 6px 0;}',
    '.pdf-disclaimer p:last-child{margin:0;}',
    '.pdf-timestamp{font-weight:600;color:#0F2E57;}',
    /* Print */
    '@media print{',
      'body{margin:0;padding:10mm;max-width:none;-webkit-print-color-adjust:exact;print-color-adjust:exact;}',
      '@page{size:A4 portrait;margin:8mm 10mm;}',
      '.page-break{page-break-before:auto;}',
      '.page-break-forced{page-break-before:always;}',
      '.pdf-hyp-card,.pdf-ev-card,.pdf-trip-card{page-break-inside:auto;}',
      '.pdf-disclaimer{page-break-inside:avoid;}',
      '.pdf-nfi-narrative{page-break-inside:auto;}',
      '.sec-header{page-break-after:avoid;}',
      '.data-table{page-break-inside:auto;}',
      '.data-table tr{page-break-inside:avoid;page-break-after:auto;}',
    '}'
  ].join('\n');
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  // ASSEMBLY
  // â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*â*
  return '<!DOCTYPE html>' +
    '<html lang="en">' +
    '<head>' +
      '<meta charset="UTF-8">' +
      '<title>' + esc(ticker) + ' Research Snapshot | Continuum Intelligence</title>' +
      '<style>' + css + '</style>' +
    '</head>' +
    '<body>' +
      /* Cover */
      pageHeader('Research Snapshot') +
      '<div class="pdf-cover-title">' + esc(companyName) + '</div>' +
      '<div class="pdf-cover-sub">' + esc(ticker) + ' | Snapshot as at ' + esc(timestamp) + ' AEST</div>' +
      alertHtml +
      verdictHtml +
      /* Section 01: Identity */
      identityHtml +
      /* Section 02: Hypotheses  --  forced break after cover/identity */
      forcedPageBreak() +
      pageHeader('Competing Hypotheses') +
      hypHtml +
      /* Section 03: Narrative  --  soft break, flows naturally */
      pageBreak() +
      pageHeader('Dominant Narrative') +
      narrativeHtml +
      /* Section 04: Evidence  --  soft break */
      pageBreak() +
      pageHeader('Evidence Synthesis') +
      evidenceHtml +
      /* Section 05: Discriminates  --  soft break */
      pageBreak() +
      pageHeader('Discriminators & Monitoring') +
      discHtml +
      /* Section 06: Tripwires */
      tripHtml +
      /* Section 07: Gaps  --  soft break */
      pageBreak() +
      pageHeader('Integrity & Technical') +
      gapsHtml +
      /* Section 08: Technical */
      techHtml +
      /* Disclaimer  --  forced break to keep it on its own page */
      forcedPageBreak() +
      pageHeader('Disclaimer') +
      disclaimerHtml +
    '</body>' +
    '</html>';
}

function buildRetailHTML(stock) {
  var hyps = stock.hypotheses || [];
  var norm = normaliseScoresForPDF(stock.verdict.scores);
  var verdictText = stripHtml(stock.verdict.text);
  var genDate = new Date().toLocaleString();
  var TIER_COLORS = ['#00C853', '#2979FF', '#FF9100', '#D50000'];

  // Replace jargon with plain English
  function plainify(text) {
    return text
      .replace(/\bEBITDA\b/gi, 'operating profit')
      .replace(/\bROIC\b/gi, 'return on investment')
      .replace(/\bEV\/EBITDA\b/gi, 'company value ratio')
      .replace(/\bbasis points?\b/gi, 'percentage points')
      .replace(/\balpha\b/gi, 'outperformance')
      .replace(/\bbeta\b/gi, 'market sensitivity')
      .replace(/\bNPAT\b/gi, 'net profit');
  }

  // Page header/footer
  function pageHeader() {
    return '<div style="display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #2E5090;padding-bottom:6px;margin-bottom:16px;">' +
      '<span style="font-size:8pt;font-weight:bold;letter-spacing:2px;color:#1B2A4A;">CONTINUUM INTELLIGENCE</span>' +
      '<span style="font-size:8pt;color:#2E5090;font-weight:bold;">Investor Briefing</span>' +
    '</div>';
  }
  function pageFooter(pageNum, totalPages) {
    return '<div style="border-top:1px solid #DDD;padding-top:6px;margin-top:auto;display:flex;justify-content:space-between;font-size:7.5pt;color:#888;">' +
      '<span>Page ' + pageNum + ' of ' + totalPages + '</span>' +
      '<span>' + pdfEsc(genDate) + '</span>' +
    '</div>';
  }

  // Hypothesis bars
  var hypBars = '';
  for (var i = 0; i < hyps.length; i++) {
    var h = hyps[i];
    var dirIcon = h.direction === 'upside' ? '&#9650;' : h.direction === 'downside' ? '&#9660;' : '&#9670;';
    var dirColor = h.direction === 'upside' ? '#00C853' : h.direction === 'downside' ? '#D50000' : '#FF9100';
    var descText = plainify(stripHtml(h.description));
    if (descText.length > 140) descText = descText.substring(0, 137) + '...';
    hypBars += '<div style="margin:8px 0;padding:10px 12px;background:#FAFAFA;border-left:4px solid ' + TIER_COLORS[i] + ';">' +
      '<div style="display:flex;justify-content:space-between;align-items:center;">' +
        '<span style="font-size:10pt;font-weight:bold;color:#1B2A4A;">' + pdfEsc(stripHtml(h.title)) +
          ' <span style="color:' + dirColor + ';font-size:8pt;">' + dirIcon + '</span></span>' +
        '<span style="font-size:14pt;font-weight:bold;color:' + TIER_COLORS[i] + ';">' + norm[i] + '%</span>' +
      '</div>' +
      '<div style="font-size:8pt;color:#555;margin-top:3px;line-height:1.3;">' + pdfEsc(descText) + '</div>' +
    '</div>';
  }

  // Risks (downside hypotheses)
  var risks = '';
  for (var ri = 0; ri < hyps.length; ri++) {
    if (hyps[ri].direction === 'downside') {
      var riskText = plainify(stripHtml(hyps[ri].description));
      if (riskText.length > 200) riskText = riskText.substring(0, 197) + '...';
      risks += '<li style="margin-bottom:6px;font-size:9pt;line-height:1.4;">' + pdfEsc(riskText) + '</li>';
    }
  }

  // Upsides (upside hypotheses)
  var upsides = '';
  for (var ui = 0; ui < hyps.length; ui++) {
    if (hyps[ui].direction === 'upside') {
      var upText = plainify(stripHtml(hyps[ui].description));
      if (upText.length > 200) upText = upText.substring(0, 197) + '...';
      upsides += '<li style="margin-bottom:6px;font-size:9pt;line-height:1.4;">' + pdfEsc(upText) + '</li>';
    }
  }
  if (!upsides) upsides = '<li style="font-size:9pt;">No specific upside scenarios identified in the current evidence.</li>';

  // Tripwires simplified
  var watching = '';
  if (stock.tripwires && stock.tripwires.cards) {
    for (var tw = 0; tw < Math.min(stock.tripwires.cards.length, 4); tw++) {
      var trip = stock.tripwires.cards[tw];
      watching += '<li style="margin-bottom:6px;font-size:9pt;line-height:1.4;"><strong>' + pdfEsc(trip.date || '') + ':</strong> ' + pdfEsc(plainify(stripHtml(trip.name))) + '</li>';
    }
  }

  // Page 1: Summary + Hypotheses
  var page1 = pageHeader() +
    '<h1 style="font-size:20pt;font-weight:bold;color:#1B2A4A;margin:0 0 4px 0;">' + pdfEsc(stock.company) + '</h1>' +
    '<div style="font-size:10pt;color:#666;margin-bottom:16px;">' + pdfEsc(stock.tickerFull || stock.ticker + '.AX') + ' &bull; Current price: <strong>' + pdfEsc(stock.currency) + stock.price + '</strong></div>' +
    // What the evidence says
    '<div style="background:#F5F7FA;padding:12px;border-radius:6px;margin-bottom:16px;border-left:3px solid #2E5090;">' +
      '<div style="font-size:10pt;font-weight:bold;color:#1B2A4A;margin-bottom:6px;">What the evidence says</div>' +
      '<div style="font-size:9pt;color:#555;line-height:1.5;">' + pdfEsc(plainify(verdictText)) + '</div>' +
    '</div>' +
    // Hypothesis bars
    '<div style="font-size:12pt;font-weight:bold;color:#2E5090;border-bottom:2px solid #2E5090;padding-bottom:4px;margin-bottom:6px;">The four competing stories</div>' +
    '<div style="font-size:8pt;color:#888;margin-bottom:6px;">Each company has four possible futures. We weigh the evidence for each.</div>' +
    hypBars +
    pageFooter(1, 3);

  // Page 2: Risks, Upsides, Watching
  var page2 = pageHeader() +
    '<div style="font-size:12pt;font-weight:bold;color:#D50000;margin-bottom:8px;">What could go wrong</div>' +
    '<ul style="color:#555;padding-left:20px;margin-bottom:20px;">' + (risks || '<li style="font-size:9pt;">No major risks identified in current evidence.</li>') + '</ul>' +
    '<div style="font-size:12pt;font-weight:bold;color:#00C853;margin-bottom:8px;">What could go right</div>' +
    '<ul style="color:#555;padding-left:20px;margin-bottom:20px;">' + upsides + '</ul>' +
    '<div style="font-size:12pt;font-weight:bold;color:#2E5090;margin-bottom:8px;">What we are watching</div>' +
    '<ul style="color:#555;padding-left:20px;margin-bottom:20px;">' + (watching || '<li style="font-size:9pt;">No specific events being tracked.</li>') + '</ul>' +
    // How to read
    '<div style="background:#FFF8E1;padding:12px;border-radius:6px;margin-top:16px;">' +
      '<div style="font-size:9pt;font-weight:bold;color:#1B2A4A;margin-bottom:4px;">How to read this briefing</div>' +
      '<div style="font-size:8pt;color:#666;line-height:1.5;">' +
        'We do not predict share prices or tell you what to buy. We systematically weigh evidence for and against four competing stories ' +
        'about each company, then tell you which story the evidence best supports right now. The percentages show how much evidence ' +
        'supports each story. What you do with that information is your decision.' +
      '</div>' +
    '</div>' +
    pageFooter(2, 3);

  // Page 3: Disclaimer
  var page3 = pageHeader() +
    '<div style="font-size:12pt;font-weight:bold;color:#2E5090;border-bottom:2px solid #2E5090;padding-bottom:4px;margin-bottom:16px;">Important Information</div>' +
    '<div style="font-size:7.5pt;color:#888;line-height:1.6;">' +
      '<p style="margin-bottom:10px;">This briefing is produced by Continuum Intelligence for informational purposes only. It does not constitute personal financial advice or a recommendation to buy, sell, or hold any investment.</p>' +
      '<p style="margin-bottom:10px;">We use a method called Analysis of Competing Hypotheses to weigh evidence for and against different possible outcomes for each company. This is a structured way of thinking about investments  --  it is not a prediction of what will happen.</p>' +
      '<p style="margin-bottom:10px;">All information comes from public sources including company announcements, regulatory filings, and market data. We do not have access to inside information.</p>' +
      '<p style="margin-bottom:10px;">Before making any investment decision, you should do your own research and speak with a licensed financial adviser who understands your personal circumstances.</p>' +
      '<p style="margin-bottom:10px;">&copy; 2026 Continuum Intelligence. All rights reserved.</p>' +
      '<p>Generated: ' + pdfEsc(genDate) + '</p>' +
    '</div>' +
    pageFooter(3, 3);

  return '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>' + pdfEsc(stock.ticker) + ' Investor Briefing  --  Continuum Intelligence</title>' +
    '<style>' +
      'body{font-family:Arial,Helvetica,sans-serif;color:#333;line-height:1.3;max-width:750px;margin:0 auto;padding:30px 40px;}' +
      '.page{min-height:calc(100vh - 60px);display:flex;flex-direction:column;padding-bottom:10px;}' +
      '.page-content{flex:1;}' +
      '@media print{' +
        'body{margin:0;padding:0;max-width:none;}' +
        '@page{margin:15mm 20mm;size:A4 portrait;}' +
        '.page{min-height:auto;page-break-after:always;padding:0;}' +
        '.page:last-child{page-break-after:avoid;}' +
      '}' +
    '</style></head><body>' +
    '<div class="page"><div class="page-content">' + page1 + '</div></div>' +
    '<div class="page"><div class="page-content">' + page2 + '</div></div>' +
    '<div class="page"><div class="page-content">' + page3 + '</div></div>' +
  '</body></html>';
}
</script>

<script src="scripts/price-narrative-engine.js"></script>
<script src="scripts/institutional-commentary-engine.js"></script>
<!-- Narrative Framework v2.0  --  Dislocation Alerts & Dynamic Weights -->
<script src="scripts/narrative-framework-integration.js"></script>
<script src="js/personalisation.js"></script>
<!-- Snapshot Generator v2  --  runs after NFI + personalisation -->
<script src="scripts/snapshot-generator.js"></script>
<script>
window.addEventListener('load', function() {
  setTimeout(function() { initSnapshots('snapshot-container'); }, 1500);
});
</script>

<!-- Service Worker Registration -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('./sw.js')
      .then(function(reg) {
        console.log('[SW] Registered, scope:', reg.scope);
      })
      .catch(function(err) {
        console.warn('[SW] Registration failed:', err);
      });
  });
}
</script>

</body>
</html>

