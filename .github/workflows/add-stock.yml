name: Add Stock to Coverage

on:
  workflow_dispatch:
    inputs:
      ticker:
        description: 'ASX ticker code (e.g. DXS, BHP, CBA â€” without .AX suffix)'
        required: true
      company:
        description: 'Company name (e.g. "Dexus", "BHP Group")'
        required: true
      sector:
        description: 'Sector (e.g. "Real Estate", "Materials", "Healthcare")'
        required: true
        default: 'Unknown'
      sector_sub:
        description: 'Sub-sector (optional, e.g. "Office REIT", "Iron Ore")'
        required: false
        default: ''

jobs:
  add-stock:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.DEPLOY_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate ticker not already in coverage
        run: |
          TICKER="${{ github.event.inputs.ticker }}"
          TICKER_UPPER=$(echo "$TICKER" | tr '[:lower:]' '[:upper:]')

          if grep -q "'${TICKER_UPPER}.AX'" scripts/update-prices.js; then
            echo "::error::${TICKER_UPPER} is already in the coverage universe!"
            exit 1
          fi
          echo "TICKER_UPPER=${TICKER_UPPER}" >> "$GITHUB_ENV"

      - name: Add stock to coverage
        env:
          STOCK_TICKER: ${{ github.event.inputs.ticker }}
          STOCK_COMPANY: ${{ github.event.inputs.company }}
          STOCK_SECTOR: ${{ github.event.inputs.sector }}
          STOCK_SECTOR_SUB: ${{ github.event.inputs.sector_sub }}
        run: node scripts/add-stock.js

      - name: Commit and push to platform
        run: |
          git config user.name "Continuum Bot"
          git config user.email "bot@continuum-intelligence.dev"

          TICKER=$(echo "${{ github.event.inputs.ticker }}" | tr '[:lower:]' '[:upper:]')
          COMPANY="${{ github.event.inputs.company }}"

          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add ${COMPANY} (${TICKER}.AX) to coverage universe [auto]"
            git push origin main
          fi

  deploy:
    needs: add-stock
    runs-on: ubuntu-latest

    steps:
      - name: Checkout continuum-platform (latest main, including new stock)
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.DEPLOY_TOKEN }}
          path: platform

      - name: Checkout continuum-intelligence
        uses: actions/checkout@v4
        with:
          repository: marcjduncan-sys/continuum-intelligence
          token: ${{ secrets.DEPLOY_TOKEN }}
          path: intelligence

      - name: Sync files to continuum-intelligence
        run: |
          cp platform/index.html intelligence/index.html
          rsync -av platform/scripts/ intelligence/scripts/
          mkdir -p intelligence/data
          rsync -av platform/data/ intelligence/data/

      - name: Commit and deploy
        working-directory: intelligence
        run: |
          git config user.name "Continuum Bot"
          git config user.email "bot@continuum-intelligence.dev"

          TICKER=$(echo "${{ github.event.inputs.ticker }}" | tr '[:lower:]' '[:upper:]')
          COMPANY="${{ github.event.inputs.company }}"

          git add -A
          if git diff --cached --quiet; then
            echo "No changes to deploy"
          else
            git commit -m "Add ${COMPANY} (${TICKER}.AX) to live site [auto-deploy]"
            git push origin main
            echo "Deployed ${TICKER}.AX to live site!"
          fi
