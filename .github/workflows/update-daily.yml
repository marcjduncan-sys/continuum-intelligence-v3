name: Daily Close Update

on:
  schedule:
    # 06:20 UTC Mon-Fri
    # AEDT (Oct-Apr): 5:20 PM local — 70 min post-ASX close
    # AEST (Apr-Oct): 4:20 PM local — 8 min post-closing auction
    - cron: '20 6 * * 1-5'
  workflow_dispatch:
    inputs:
      skip_prices:
        description: 'Skip price fetching (use existing data)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "daily-update"
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Check if ASX traded today
        id: market-check
        run: |
          DAY_OF_WEEK=$(TZ='Australia/Sydney' date +%u)
          if [ "$DAY_OF_WEEK" -gt 5 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Weekend in Sydney — skipping"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Trading day confirmed (day $DAY_OF_WEEK)"
          fi

      - name: Checkout
        if: steps.market-check.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.DEPLOY_TOKEN }}

      - name: Setup Node.js
        if: steps.market-check.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch macro factors
        if: steps.market-check.outputs.skip != 'true'
        run: |
          set +e
          node scripts/fetch-macro-factors.js
          MACRO_EXIT=$?
          set -e
          if [ $MACRO_EXIT -ne 0 ]; then
            echo "::warning::Macro factor fetch failed — downstream signals will use stale data"
          fi

      - name: Run orchestrator pipeline
        if: steps.market-check.outputs.skip != 'true'
        id: orchestrator
        run: |
          SKIP_FLAG=""
          if [ "${{ inputs.skip_prices }}" = "true" ]; then
            SKIP_FLAG="--skip-prices"
          fi
          set +e
          node scripts/update-orchestrator.js $SKIP_FLAG
          EXIT_CODE=$?
          set -e
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          if [ $EXIT_CODE -eq 1 ]; then
            echo "::warning::Orchestrator failed — retrying in 60s"
            sleep 60
            set +e
            node scripts/update-orchestrator.js $SKIP_FLAG
            RETRY_CODE=$?
            set -e
            if [ $RETRY_CODE -eq 1 ]; then
              echo "::error::Orchestrator failed on retry"
              exit 1
            fi
          fi

      - name: Update latest-prices.json (event scraper)
        if: steps.market-check.outputs.skip != 'true'
        run: |
          set +e
          node scripts/event-scraper.js
          SCRAPER_EXIT=$?
          set -e
          if [ $SCRAPER_EXIT -eq 1 ]; then
            echo "::warning::Event scraper failed"
          elif [ $SCRAPER_EXIT -eq 100 ]; then
            echo "Event scraper: narrative updates detected"
          fi

      - name: Run narrative analysis
        if: steps.market-check.outputs.skip != 'true'
        run: |
          set +e
          node scripts/run-automated-analysis.js
          ANALYSIS_EXIT=$?
          set -e
          if [ $ANALYSIS_EXIT -ne 0 ]; then
            echo "::warning::Narrative analysis exited with code $ANALYSIS_EXIT"
          fi

      - name: Run price-as-evidence engine
        if: steps.market-check.outputs.skip != 'true'
        run: |
          set +e
          node scripts/price-evidence-engine.js
          PEE_EXIT=$?
          set -e
          if [ $PEE_EXIT -ne 0 ]; then
            echo "::warning::Price-evidence engine exited with code $PEE_EXIT"
          fi

      - name: Log daily narrative history
        if: steps.market-check.outputs.skip != 'true'
        run: |
          DATE=$(TZ='Australia/Sydney' date +%Y-%m-%d)
          set +e
          node scripts/log-daily-history.js --date "$DATE"
          HISTORY_EXIT=$?
          set -e
          if [ $HISTORY_EXIT -ne 0 ]; then
            echo "::warning::History logger exited with code $HISTORY_EXIT"
          fi

      - name: Commit and push changes
        if: steps.market-check.outputs.skip != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add index.html \
                  data/macro-factors.json \
                  data/live-prices.json \
                  data/latest-prices.json \
                  data/narrative-analysis.json \
                  data/announcements.json \
                  data/events/ \
                  data/stocks/*.json \
                  data/stocks/*-history.json \
                  data/research/*.json || true

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            DATE=$(TZ='Australia/Sydney' date +%Y-%m-%d)
            git commit -m "Daily update: ASX close ${DATE} [automated]"
            git push
          fi
